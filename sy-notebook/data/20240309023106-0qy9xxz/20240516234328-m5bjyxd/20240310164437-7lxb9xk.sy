{"ID":"20240310164437-7lxb9xk","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f1e8","id":"20240310164437-7lxb9xk","title":"多线程","type":"doc","updated":"20240516234356"},"Children":[{"ID":"20240503154120-77crpw6","Type":"NodeParagraph","Properties":{"id":"20240503154120-77crpw6","updated":"20240503154129"},"Children":[{"Type":"NodeText","Data":"线程模型位于 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::therad"},{"Type":"NodeText","Data":"​，支持 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"join"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"detach"},{"Type":"NodeText","Data":"​，还包括了线程id、cpu个数、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"thread_handle"},{"Type":"NodeText","Data":"​ 休眠等功能。"}]},{"ID":"20240503154120-ao73ae9","Type":"NodeList","ListData":{},"Properties":{"id":"20240503154120-ao73ae9","updated":"20240503154120"},"Children":[{"ID":"20240503154120-6ry6b70","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154120-6ry6b70","updated":"20240503154120"},"Children":[{"ID":"20240503154120-vb80jv6","Type":"NodeParagraph","Properties":{"id":"20240503154120-vb80jv6","updated":"20240503154120"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"join()"},{"Type":"NodeText","Data":"​：保证线程函数生命周期与线程对象生命周期相同"}]}]},{"ID":"20240503154120-m4q2q5z","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154120-m4q2q5z","updated":"20240503154120"},"Children":[{"ID":"20240503154120-0801wbt","Type":"NodeParagraph","Properties":{"id":"20240503154120-0801wbt","updated":"20240503154120"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"detach()"},{"Type":"NodeText","Data":"​：将线程与线程对象分离，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"无法再次通过"},{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","TextMarkType":"strong code","TextMarkTextContent":"join"},{"Type":"NodeText","Data":"​ "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"等待线程完成"}]}]}]},{"ID":"20240503154120-gc7gx8x","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240503154120-gc7gx8x","updated":"20240503154120"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"int main() {\n    thread t([] {\n        for (int i = 0; i \u003c 10; ++i) {\n            cout \u003c\u003c \" t: \" \u003c\u003c i \u003c\u003c endl;\n        }\n    });\n    if (t.joinable()) {\n        t.detach();\n    }\n\n    thread tt([](int k) {\n        for (int i = 0; i \u003c k; ++i) {\n            cout \u003c\u003c \"tt: \" \u003c\u003c i \u003c\u003c endl;\n        }\n    }, 20);\n    if (t.joinable()) {\n        t.join();\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240503154120-0gq799b","Type":"NodeParagraph","Properties":{"id":"20240503154120-0gq799b","updated":"20240503154120"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"Pasted image 20230104221906"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/Pasted image 20230104221906-20240310164617-3ca8ce7.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240503160035-rqd43fi","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240503160035-rqd43fi","updated":"20240503160056"},"Children":[{"Type":"NodeText","Data":"自动合流"}]},{"ID":"20240503160054-62q71z1","Type":"NodeParagraph","Properties":{"id":"20240503160054-62q71z1","updated":"20240503160056"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::jthread"},{"Type":"NodeText","Data":"​ 提供 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std:thread"},{"Type":"NodeText","Data":"​ 的一个变种"}]},{"ID":"20240503160035-pzdo2ds","Type":"NodeList","ListData":{},"Properties":{"id":"20240503160035-pzdo2ds","updated":"20240503160056"},"Children":[{"ID":"20240503160035-j04txts","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503160035-j04txts","updated":"20240503160035"},"Children":[{"ID":"20240503160035-p2mr355","Type":"NodeParagraph","Properties":{"id":"20240503160035-p2mr355","updated":"20240503160035"},"Children":[{"Type":"NodeText","Data":"析构函数调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"stop_source.request_stop()"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240503160035-zfz01qb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503160035-zfz01qb","updated":"20240503160035"},"Children":[{"ID":"20240503160035-l2rydzy","Type":"NodeParagraph","Properties":{"id":"20240503160035-l2rydzy","updated":"20240503160035"},"Children":[{"Type":"NodeText","Data":"析构函数自动调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"join()"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20240503160035-zotd6rs","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240503160035-zotd6rs","updated":"20240503160056"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"void Test() {\n    std::jthread th;\n    {\n        th = std::jthread([]() {\n            for (unsigned i = 1; i \u003c 10; ++i) {\n                std::cout \u003c\u003c i \u003c\u003c \" \";\n                Sleep(500);\n            }\n        });\n    }\n    // 没有使用join也不会崩溃,因为std::jthread的析构函数默认调用join()\n}\n\nint main(int argc, char* argv[]) {\n    Test();\n    return 0;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240503160153-vx4b2cr","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240503160153-vx4b2cr","updated":"20240503160155"},"Children":[{"Type":"NodeText","Data":"可协作中断"}]},{"ID":"20240503160203-hyzx507","Type":"NodeParagraph","Properties":{"id":"20240503160203-hyzx507","updated":"20240503160203"},"Children":[{"Type":"NodeText","Data":"通过外部请求，影响线程内部是否中断并退出"}]},{"ID":"20240503160203-8g89cug","Type":"NodeList","ListData":{},"Properties":{"id":"20240503160203-8g89cug","updated":"20240503160203"},"Children":[{"ID":"20240503160203-r7mdq9v","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503160203-r7mdq9v","updated":"20240503160203"},"Children":[{"ID":"20240503160203-idr9n6x","Type":"NodeParagraph","Properties":{"id":"20240503160203-idr9n6x","updated":"20240503160203"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::stop_token"},{"Type":"NodeText","Data":"​：查询线程是否中断"}]}]},{"ID":"20240503160203-fg2a15b","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503160203-fg2a15b","updated":"20240503160203"},"Children":[{"ID":"20240503160203-c5x9308","Type":"NodeParagraph","Properties":{"id":"20240503160203-c5x9308","updated":"20240503160203"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::stop_source"},{"Type":"NodeText","Data":"​：请求线程停止运行"}]}]},{"ID":"20240503160203-ejknlwk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503160203-ejknlwk","updated":"20240503160203"},"Children":[{"ID":"20240503160203-7f9swmm","Type":"NodeParagraph","Properties":{"id":"20240503160203-7f9swmm","updated":"20240503160203"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::stop_callback"},{"Type":"NodeText","Data":"​：终止时触发的回调函数"}]}]}]},{"ID":"20240503160203-gap4q8k","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240503160203-gap4q8k","updated":"20240503160203"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"void Test() {\n    std::jthread th;\n    {\n        th = std::jthread([](const std::stop_token st) {\n            while (!st.stop_requested()) {\n                // 没有收到中断请求，则执行\n                std::cout \u003c\u003c \"1\";\n                Sleep(500);\n            }\n        });\n    }\n    Sleep(10 * 1000);\n    // 外部发起中断请求\n    auto ret = th.request_stop();\n}\n\nint main(int argc, char* argv[]) {\n    Test();\n    std::cout \u003c\u003c std::endl;\n    return 0;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240503160102-wu9xeld","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240503160102-wu9xeld","updated":"20240503160105"},"Children":[{"Type":"NodeText","Data":"任务调度"}]},{"ID":"20240503154542-93gy7zd","Type":"NodeList","ListData":{},"Properties":{"id":"20240503154542-93gy7zd","updated":"20240503160126"},"Children":[{"ID":"20240503154540-o76gket","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154540-o76gket"},"Children":[{"ID":"20240503154540-acfs4fm","Type":"NodeParagraph","Properties":{"id":"20240503154540-acfs4fm","updated":"20240503155732"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240310164937-57put31","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"std::future"},{"Type":"NodeText","Data":"​ 用于异步任务包装"}]}]},{"ID":"20240503154652-9lh8mjo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154652-9lh8mjo"},"Children":[{"ID":"20240503154652-hau4h7u","Type":"NodeParagraph","Properties":{"id":"20240503154652-hau4h7u","updated":"20240503155735"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240310165018-lcm7c9t","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"std::launch::async"},{"Type":"NodeText","Data":"​ 用于对异步任务的进一步包赚"}]}]},{"ID":"20240503155722-b5zze8x","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503155722-b5zze8x"},"Children":[{"ID":"20240503155722-i5ha76d","Type":"NodeParagraph","Properties":{"id":"20240503155722-i5ha76d","updated":"20240503155822"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240310164730-h9uh6un","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"std::call_once"},{"Type":"NodeText","Data":"​ 可以保证一个方法只被执行一次"}]}]}]},{"ID":"20240503160105-lj4kopj","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240503160105-lj4kopj","updated":"20240503160108"},"Children":[{"Type":"NodeText","Data":"数据共享"}]},{"ID":"20240503154447-adwswhi","Type":"NodeParagraph","Properties":{"id":"20240503154447-adwswhi","updated":"20240503160129"},"Children":[{"Type":"NodeText","Data":"数据共享：解决多线程共同访问同一块内存（同一组数据）的数据安全性和一致性"}]},{"ID":"20240503154823-kr3nhyf","Type":"NodeList","ListData":{},"Properties":{"id":"20240503154823-kr3nhyf","updated":"20240503160129"},"Children":[{"ID":"20240503154822-r018s4y","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154822-r018s4y"},"Children":[{"ID":"20240503154822-314ggae","Type":"NodeParagraph","Properties":{"id":"20240503154822-314ggae","updated":"20240503154823"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"volatile"},{"Type":"NodeText","Data":"​ 关键字修饰可建立内存屏障，保证主内存与各线程缓存（工作内存）数据的一致性。"}]}]},{"ID":"20240503155022-7frlykl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503155022-7frlykl"},"Children":[{"ID":"20240503155022-2ztv6bt","Type":"NodeParagraph","Properties":{"id":"20240503155022-2ztv6bt","updated":"20240503155548"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::mutex"},{"Type":"NodeText","Data":"​ 表示一个"},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20240310164621-s03rwum","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"互斥量"},{"Type":"NodeText","Data":"。当互斥量位于 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lock"},{"Type":"NodeText","Data":"​ 状态时阻塞其他需要访问该数据的线程"}]},{"ID":"20240503155555-34qnffj","Type":"NodeList","ListData":{},"Properties":{"id":"20240503155555-34qnffj"},"Children":[{"ID":"20240503155548-2exppxy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503155548-2exppxy"},"Children":[{"ID":"20240503155548-glz39me","Type":"NodeParagraph","Properties":{"id":"20240503155548-glz39me","updated":"20240503155635"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::lock"},{"Type":"NodeText","Data":"​ 锁可以防止由于编程时的错误，在线程结束时忘记释放互斥量"}]}]},{"ID":"20240503155907-4amtpye","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503155907-4amtpye"},"Children":[{"ID":"20240503155907-vzjpe1j","Type":"NodeParagraph","Properties":{"id":"20240503155907-vzjpe1j","updated":"20240503155915"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240310164830-ffyo691","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"std::condition_variable"},{"Type":"NodeText","Data":"​ 可以实现阻塞一个线程，并在满足某些条件或超时时唤醒线程"}]}]}]}]},{"ID":"20240503154844-jij0e5f","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154844-jij0e5f"},"Children":[{"ID":"20240503154844-s5r21sh","Type":"NodeParagraph","Properties":{"id":"20240503154844-s5r21sh","updated":"20240503154959"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::atomic"},{"Type":"NodeText","Data":"​ 提供原子类，在读写时候保证自身的原子性，数据本身是原子性时"},{"Type":"NodeTextMark","TextMarkType":"inline-memo","TextMarkInlineMemoContent":"数据本身实现更细粒度的锁","TextMarkTextContent":"不需要锁"},{"Type":"NodeText","Data":"。"}]}]},{"ID":"20240503160000-6e7fylp","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503160000-6e7fylp"},"Children":[{"ID":"20240503160000-v5ytsho","Type":"NodeParagraph","Properties":{"id":"20240503160000-v5ytsho","updated":"20240503160019"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240310165042-exqca6z","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"thread-local"},{"Type":"NodeText","Data":"​ 关键字声明一个线程相关的值，常用于静态或全局成员"}]}]}]}]}