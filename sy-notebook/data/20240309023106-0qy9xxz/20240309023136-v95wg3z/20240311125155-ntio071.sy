{"ID":"20240311125155-ntio071","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f1e8","id":"20240311125155-ntio071","tags":"C++20","title":"协程","type":"doc","updated":"20240311125211"},"Children":[{"ID":"20240503153949-c8evro6","Type":"NodeBlockQueryEmbed","Properties":{"id":"20240503153949-c8evro6","updated":"20240503153949"},"Children":[{"Type":"NodeOpenBrace"},{"Type":"NodeOpenBrace"},{"Type":"NodeBlockQueryEmbedScript","Data":"select * from blocks where id='20240503153826-pkpqicf'"},{"Type":"NodeCloseBrace"},{"Type":"NodeCloseBrace"}]},{"ID":"20240311125211-nv5al9e","Type":"NodeParagraph","Properties":{"id":"20240311125211-nv5al9e","updated":"20240503153556"},"Children":[{"Type":"NodeText","Data":"C++20 开始引入协程，带有 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​ 任意关键字的函数称为协程函数,通常配合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"future"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generator"},{"Type":"NodeText","Data":"​ 标准库使用。"}]},{"ID":"20240311125211-7il49xt","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-7il49xt","updated":"20240311125211"},"Children":[{"ID":"20240311125211-x5fp6ov","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-x5fp6ov","updated":"20240311125211"},"Children":[{"ID":"20240311125211-p0k61zn","Type":"NodeParagraph","Properties":{"id":"20240311125211-p0k61zn","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"协程函数不能是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"main"},{"Type":"NodeText","Data":"​ 函数，构造函数，析构函数，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"consteval"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"constexpr"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-hoyol4i","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-hoyol4i","updated":"20240311125211"},"Children":[{"ID":"20240311125211-26rt08c","Type":"NodeParagraph","Properties":{"id":"20240311125211-26rt08c","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"协程函数不能使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"return"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-y4g8505","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-y4g8505","updated":"20240311125211"},"Children":[{"ID":"20240311125211-kxiie0l","Type":"NodeParagraph","Properties":{"id":"20240311125211-kxiie0l","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"协程函数不能使用变长参数"}]}]}]},{"ID":"20240311125211-43joueo","Type":"NodeParagraph","Properties":{"id":"20240311125211-43joueo","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240311125232"},"Children":[{"Type":"NodeText","Data":"注意：协程由于不需要操作系统参与调度，可以节省切换线程的开销。但协程不一定比线程快，协程程序根本上还是单线程，在做 IO 相关或类似的需要 CPU 等待的任务时有优势，但在做 CPU 运算密集型程序时，多线程通常比协程优势更大，此时线程切换开销相比硬件上的并行运算节省的时间可以忽略。"}]},{"ID":"20240311125211-7yeio2f","Type":"NodeParagraph","Properties":{"id":"20240311125211-7yeio2f","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"有关协程的三个关键字："}]},{"ID":"20240311125211-uuhfeq5","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-uuhfeq5","updated":"20240311125211"},"Children":[{"ID":"20240311125211-zy3ds8i","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-zy3ds8i","updated":"20240311125211"},"Children":[{"ID":"20240311125211-iafpkxu","Type":"NodeParagraph","Properties":{"id":"20240311125211-iafpkxu","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​ 触发一个挂起点。开始执行任务，后接一个等待器（任务）。"}]}]},{"ID":"20240311125211-4on4b5l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-4on4b5l","updated":"20240311125211"},"Children":[{"ID":"20240311125211-cw4swfc","Type":"NodeParagraph","Properties":{"id":"20240311125211-cw4swfc","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 触发一个挂起点。方法执行完成"}]}]},{"ID":"20240311125211-htiijly","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-htiijly","updated":"20240311125211"},"Children":[{"ID":"20240311125211-gly0msn","Type":"NodeParagraph","Properties":{"id":"20240311125211-gly0msn","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​ 触发一个挂起点。暂停执行并返回一个值\n设普通函数 A 调用了协程函数 B，B 中 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​ 触发一个耗时任务并返回 A，等待任务完成后重新回到 B；"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 表示 B 执行完成，设置返回值后回到 A。"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​ 表示 B 产生了一个新的值并返回 A，但 B 还未完全完成。"}]}]}]},{"ID":"20240503154026-y36lks8","Type":"NodeParagraph","Properties":{"id":"20240503154026-y36lks8","updated":"20240503154026"},"Children":[{"Type":"NodeText","Data":"规则："}]},{"ID":"20240503154026-lqbgifn","Type":"NodeList","ListData":{},"Properties":{"id":"20240503154026-lqbgifn","updated":"20240503154026"},"Children":[{"ID":"20240503154026-kr2dgqt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154026-kr2dgqt","updated":"20240503154026"},"Children":[{"ID":"20240503154026-y5p3j1j","Type":"NodeParagraph","Properties":{"id":"20240503154026-y5p3j1j","updated":"20240503154026"},"Children":[{"Type":"NodeText","Data":"一个线程只能有一个协程，即同时只能运行一个协程程序"}]}]},{"ID":"20240503154026-u884u27","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154026-u884u27","updated":"20240503154026"},"Children":[{"ID":"20240503154026-ou929wg","Type":"NodeParagraph","Properties":{"id":"20240503154026-ou929wg","updated":"20240503154026"},"Children":[{"Type":"NodeText","Data":"协程返回值应为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Promise"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240503154026-teex1zr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154026-teex1zr","updated":"20240503154026"},"Children":[{"ID":"20240503154026-b6t9axk","Type":"NodeParagraph","Properties":{"id":"20240503154026-b6t9axk","updated":"20240503154026"},"Children":[{"Type":"NodeText","Data":"协程控制关键字只能在协程中使用"}]}]},{"ID":"20240503154026-emopf93","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154026-emopf93","updated":"20240503154026"},"Children":[{"ID":"20240503154026-tsks0ep","Type":"NodeParagraph","Properties":{"id":"20240503154026-tsks0ep","updated":"20240503154026"},"Children":[{"Type":"NodeText","Data":"可将异步函数包装在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Awaitable"},{"Type":"NodeText","Data":"​ 类中，使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_wait"},{"Type":"NodeText","Data":"​ 关键字调度"}]}]},{"ID":"20240503154026-j5p7v1o","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240503154026-j5p7v1o","updated":"20240503154026"},"Children":[{"ID":"20240503154026-jlna5f2","Type":"NodeParagraph","Properties":{"id":"20240503154026-jlna5f2","updated":"20240503154026"},"Children":[{"Type":"NodeText","Data":"无栈协程：所有局部状态都在方法栈中，协程没有分配独立的栈空间"}]}]}]},{"ID":"20240311125211-lxuosl0","Type":"NodeParagraph","Properties":{"id":"20240311125211-lxuosl0","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240311125241"},"Children":[{"Type":"NodeText","Data":"就 C++20 来说，标准库中还未有现成的用于返回的类型，需要自定义"}]},{"ID":"20240311125211-yznwn6t","Type":"NodeParagraph","Properties":{"id":"20240311125211-yznwn6t","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​ 后接一个等待器（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"awaiter"},{"Type":"NodeText","Data":"​），要求存在以下成员："}]},{"ID":"20240311125211-dnokjtu","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-dnokjtu","updated":"20240311125211"},"Children":[{"ID":"20240311125211-mqmtnwt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-mqmtnwt","updated":"20240311125211"},"Children":[{"ID":"20240311125211-m6l81r6","Type":"NodeParagraph","Properties":{"id":"20240311125211-m6l81r6","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bool await_ready()"},{"Type":"NodeText","Data":"​：当该函数返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"true"},{"Type":"NodeText","Data":"​ 时，表示数据已经准备好，无需继续等待"}]}]},{"ID":"20240311125211-i4v0zf0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-i4v0zf0","updated":"20240311125211"},"Children":[{"ID":"20240311125211-1ha16lw","Type":"NodeParagraph","Properties":{"id":"20240311125211-1ha16lw","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h)"},{"Type":"NodeText","Data":"​：当数据未准备好时，执行此函数"}]},{"ID":"20240311125211-57acn21","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-57acn21","updated":"20240311125211"},"Children":[{"ID":"20240311125211-fuudjtw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-fuudjtw","updated":"20240311125211"},"Children":[{"ID":"20240311125211-s3g559e","Type":"NodeParagraph","Properties":{"id":"20240311125211-s3g559e","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::coroutine_handle"},{"Type":"NodeText","Data":"​：协程句柄，可用于控制协程流程，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"operator()"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resume()"},{"Type":"NodeText","Data":"​ 函数可以用于恢复协程"}]}]},{"ID":"20240311125211-e6gjtw5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-e6gjtw5","updated":"20240311125211"},"Children":[{"ID":"20240311125211-ewnzg9w","Type":"NodeParagraph","Properties":{"id":"20240311125211-ewnzg9w","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"允许返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bool"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"coroutine_handle"},{"Type":"NodeText","Data":"​ 类型"}]},{"ID":"20240311125211-48vhbnf","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-48vhbnf","updated":"20240311125211"},"Children":[{"ID":"20240311125211-iankmgn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-iankmgn","updated":"20240311125211"},"Children":[{"ID":"20240311125211-fmup3c4","Type":"NodeParagraph","Properties":{"id":"20240311125211-fmup3c4","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"true"},{"Type":"NodeText","Data":"​：将执行权交给调用者，协程保持挂起"}]}]},{"ID":"20240311125211-b74akob","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-b74akob","updated":"20240311125211"},"Children":[{"ID":"20240311125211-tyjsh7f","Type":"NodeParagraph","Properties":{"id":"20240311125211-tyjsh7f","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"false"},{"Type":"NodeText","Data":"​：恢复当前协程运行"}]}]},{"ID":"20240311125211-o77m71d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-o77m71d","updated":"20240311125211"},"Children":[{"ID":"20240311125211-xt4oeqx","Type":"NodeParagraph","Properties":{"id":"20240311125211-xt4oeqx","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"coroutine_handle"},{"Type":"NodeText","Data":"​：恢复 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"handle"},{"Type":"NodeText","Data":"​ 对应的协程"}]}]}]}]}]}]},{"ID":"20240311125211-xj86sja","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-xj86sja","updated":"20240311125211"},"Children":[{"ID":"20240311125211-i2ud3ca","Type":"NodeParagraph","Properties":{"id":"20240311125211-i2ud3ca","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"T await_resume()"},{"Type":"NodeText","Data":"​：返回协程执行结果，该结果称为可等待体"}]}]}]},{"ID":"20240311125211-eg88ccm","Type":"NodeParagraph","Properties":{"id":"20240311125211-eg88ccm","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 要求函数返回类型是一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::coroutine_trait\u0026lt;T\u0026gt;"},{"Type":"NodeText","Data":"​ 的一个子类，并有一个嵌套类型 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"promise_type"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240311125211-y3vx1l5","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-y3vx1l5","updated":"20240311125211"},"Children":[{"ID":"20240311125211-mzab9vh","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-mzab9vh","updated":"20240311125211"},"Children":[{"ID":"20240311125211-unqzll5","Type":"NodeParagraph","Properties":{"id":"20240311125211-unqzll5","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"promise_type"},{"Type":"NodeText","Data":"​：用于存放数据的类型"}]},{"ID":"20240311125211-71iznda","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-71iznda","updated":"20240311125211"},"Children":[{"ID":"20240311125211-hg43msa","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-hg43msa","updated":"20240311125211"},"Children":[{"ID":"20240311125211-wgt8kqg","Type":"NodeParagraph","Properties":{"id":"20240311125211-wgt8kqg","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"T get_return_object()"},{"Type":"NodeText","Data":"​：设协程函数 B 在 A 中调用，该函数的返回值就是调用后返回给 A 的值"}]}]},{"ID":"20240311125211-vtw0vwi","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-vtw0vwi","updated":"20240311125211"},"Children":[{"ID":"20240311125211-gl05ha2","Type":"NodeParagraph","Properties":{"id":"20240311125211-gl05ha2","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"awaiter initial_suspend()"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"awaiter final_suspend()"},{"Type":"NodeText","Data":"​：用于给库代码编写者在协程前后挂起机会的等待器，通常返回："}]},{"ID":"20240311125211-rvk7ehi","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-rvk7ehi","updated":"20240311125211"},"Children":[{"ID":"20240311125211-mc9m6c4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-mc9m6c4","updated":"20240311125211"},"Children":[{"ID":"20240311125211-561fgdt","Type":"NodeParagraph","Properties":{"id":"20240311125211-561fgdt","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"suspend_always"},{"Type":"NodeText","Data":"​：必然挂起，常用于 initial。final 使用这个时需要手动销毁协程句柄"}]}]},{"ID":"20240311125211-bg6qvu4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-bg6qvu4","updated":"20240311125211"},"Children":[{"ID":"20240311125211-qddv29s","Type":"NodeParagraph","Properties":{"id":"20240311125211-qddv29s","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"suspend_never"},{"Type":"NodeText","Data":"​：从不挂起，常用于 final"}]}]}]}]},{"ID":"20240311125211-w04syu9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-w04syu9","updated":"20240311125211"},"Children":[{"ID":"20240311125211-8uzoi2d","Type":"NodeParagraph","Properties":{"id":"20240311125211-8uzoi2d","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"yield_value(T value)"},{"Type":"NodeText","Data":"​：保存操作数的值，并返回等待器，通常返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"suspend_always"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-yqo7sah","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-yqo7sah","updated":"20240311125211"},"Children":[{"ID":"20240311125211-a94vw3u","Type":"NodeParagraph","Properties":{"id":"20240311125211-a94vw3u","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void return_void()"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void return_value(T value)"},{"Type":"NodeText","Data":"​：二选一，后者对应 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 有值的情况"}]}]},{"ID":"20240311125211-h08n6f4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-h08n6f4","updated":"20240311125211"},"Children":[{"ID":"20240311125211-240e37e","Type":"NodeParagraph","Properties":{"id":"20240311125211-240e37e","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"可选："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"V await_transform(expr e)"},{"Type":"NodeText","Data":"​，使 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await expr"},{"Type":"NodeText","Data":"​ 转变为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await await_transform(expr)"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-7s0g2ax","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-7s0g2ax","updated":"20240311125211"},"Children":[{"ID":"20240311125211-9hdj3v0","Type":"NodeParagraph","Properties":{"id":"20240311125211-9hdj3v0","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void unhandled_exception()"},{"Type":"NodeText","Data":"​：产生异常时调用"}]}]}]}]}]},{"ID":"20240310165136-2nq79d9","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240310165136-2nq79d9","updated":"20240503154038"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"#include \u003cthread\u003e\n#include \u003ccoroutine\u003e\n#include \u003cfunctional\u003e\n#include \u003cwindows.h\u003e\n\n// 给协程体使用的承诺特征类型\nstruct  CoroutineTraits {        // 名称自定义 |Test|\n    struct promise_type {        // 名称必须为 |promise_type|\n        // 必须实现此接口。(协程体被创建时被调用)\n        auto get_return_object() {\n            return CoroutineTraits{};\n        };\n\n        // 必须实现此接口, 返回值必须为awaitable类型。(get_return_object之后被调用)\n        auto initial_suspend() {\n            return std::suspend_never{};   // never表示继续运行\n            //return std::suspend_always{}; // always表示协程挂起\n        }\n\n        // 必须实现此接口, 返回值必须为awaitable类型。(return_void之后被调用)\n        // MSVC需要声明为noexcept，否则报错\n        auto final_suspend() noexcept {\n            return std::suspend_never{};\n        }\n\n        // 必须实现此接口, 用于处理协程函数内部抛出错误\n        void unhandled_exception() {\n            std::terminate();\n        }\n\n        // 如果协程函数内部无关键字co_return则必须实现此接口。(协程体执行完之后被调用)\n        void return_void() {}\n\n        // 注意：|return_void|和|return_value| 是互斥的。\n        // 如果协程函数内部有关键字co_return则必须实现此接口。(协程体执行完之后被调用)\n        //void return_value() {}\n\n        // 如果协程函数内部有关键字co_yield则必须实现此接口, 返回值必须为awaitable类型\n        auto yield_value(int value) {\n            // _valu=value;     // 可对|value|做一些保存或其他处理\n            return std::suspend_always{};\n        }\n    };\n};\n\n// 协程使用的await对象\nstruct CoroutineAwaitObj {  // 名称自定义 |CoroutineAwaitObj|\n    // await是否已经计算完成，如果返回true，则co_await将直接在当前线程返回\n    bool await_ready() const {\n        return false;\n    }\n\n    // await对象计算完成之后返回结果\n    std::string await_resume() const {\n        return _result;\n    }\n\n    // await对象真正调异步执行的地方，异步完成之后通过handle.resume()来是await返回\n    void await_suspend(const std::coroutine_handle\u003c\u003e handle) {\n        std::jthread([handle, this]() {\n            // 其他操作处理\n            _result = \"Test\";\n\n            // 恢复协程\n            handle.resume();\n                     }).detach();\n    }\n\n    // 将返回值存在这里\n    std::string _result;\n};\n\n// 协程体\n// |CoroutineTraits| 并不是返回值，而是协程的特征类型；不可以是void、string等返回类型\nCoroutineTraits CoroutineFunc() {\n    std::cout \u003c\u003c \"Start CoroutineFunc\" \u003c\u003c std::endl;\n\n    auto ret = co_await CoroutineAwaitObj();\n    std::cout \u003c\u003c \"Return:\" \u003c\u003c ret \u003c\u003c std::endl;\n\n    std::cout \u003c\u003c \"Finish CoroutineFunc\" \u003c\u003c std::endl;\n}\n\nint main(int argc, char* argv[]) {\n    CoroutineFunc();\n\n    Sleep(10*1000);\n\n    return 0;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}