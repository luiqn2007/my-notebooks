{"ID":"20240404161523-notkp1n","Spec":"1","Type":"NodeDocument","Properties":{"icon":"2615","id":"20240404161523-notkp1n","tags":"Java21,实验性功能","title":"Foreign Function \u0026amp; Memory API","type":"doc","updated":"20240404161535"},"Children":[{"ID":"20240404161535-c8mneas","Type":"NodeParagraph","Properties":{"id":"20240404161535-c8mneas","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"Pamana 子项目，JEP442，与 Java 运行时之外的代码和数据进行互操作，高效调用外部函数，安全访问外部内存，调用本机库并处理本机数据，而不会像 JNI 那样危险和脆弱。"}]},{"ID":"20240404161535-mnrw0ys","Type":"NodeList","ListData":{},"Properties":{"id":"20240404161535-mnrw0ys","updated":"20240404161535"},"Children":[{"ID":"20240404161535-k7bik12","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-k7bik12","updated":"20240404161535"},"Children":[{"ID":"20240404161535-zz1vx05","Type":"NodeParagraph","Properties":{"id":"20240404161535-zz1vx05","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"分配外部内存 ："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MemorySegment"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SegmentAllocator"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240404161535-7hutltb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-7hutltb","updated":"20240404161535"},"Children":[{"ID":"20240404161535-ohn53gw","Type":"NodeParagraph","Properties":{"id":"20240404161535-ohn53gw","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"操作和访问结构化的外部内存： "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MemoryLayout"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VarHandle"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240404161535-hnjpu5w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-hnjpu5w","updated":"20240404161535"},"Children":[{"ID":"20240404161535-xc6d5or","Type":"NodeParagraph","Properties":{"id":"20240404161535-xc6d5or","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"控制外部内存的分配和释放："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Arena"},{"Type":"NodeText","Data":"​ 与 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SegmentScope"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240404161535-53oevpj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-53oevpj","updated":"20240404161535"},"Children":[{"ID":"20240404161535-awbahj0","Type":"NodeParagraph","Properties":{"id":"20240404161535-awbahj0","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"调用外部函数："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Linker"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FunctionDescriptor"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SymbolLookup"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20240404161535-59wl59d","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240404161535-59wl59d","updated":"20240404161535"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"// 初始化环境\nLinker linker = Linker.nativeLinker();\n// or SymbolLookup.loaderLookup();\nSymbolLookup stdlib = linker.defaultLookup();\n// 查找函数\n// void radixsort(char* s[], int length)\nMemorySegment segment = stdlib.find(\"radixsort\").orElseThrow();\nFunctionDescriptor desc = FunctionDescriptor.ofVoid(  \n        MemoryLayout.paddingLayout(ValueLayout.ADDRESS.byteSize()),  \n        MemoryLayout.paddingLayout(ValueLayout.JAVA_INT.byteSize())  \n);\nMethodHandle radixSort = linker.downcallHandle(segment, desc);\n// 分配内存\nString[] strs = {\"mouse\", \"cat\", \"dog\", \"car\"};\ntry (Arena offHeap = Arena.openConfined()) {\n    MemorySegment pointers = offHeap.allocateArray(ValueLayout.ADDRESS, strs.length);\n    for (int i = 0; i \u003c strs.length; i++) {\n        MemorySegment cstr = offHeap.allocateUtf8String(strs[i]);\n        pointers.setAtIndex(ValueLayout.ADDRESS, i, cstr);\n    }\n    // 调用函数\n    radixSort.invoke(pointers, strs.length, MemorySegment.NULL, '\\0');\n    // 将结果复制回 JVM 堆\n    for (int i = 0; i \u003c strs.length; i++) {\n        MemorySegment cstr = pointers.getAtIndex(ValueLayout.ADDRESS, i);\n        strs[i] = cstr.getUtf8String(0);\n    }\n} catch (Throwable e) {\n    throw new RuntimeException(e);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240404161535-an4dbm8","Type":"NodeList","ListData":{},"Properties":{"id":"20240404161535-an4dbm8","updated":"20240404161535"},"Children":[{"ID":"20240404161535-tor76ce","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-tor76ce","updated":"20240404161535"},"Children":[{"ID":"20240404161535-rmb1jer","Type":"NodeParagraph","Properties":{"id":"20240404161535-rmb1jer","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Linker"},{"Type":"NodeText","Data":"​：提供 Java 代码与外部函数之间互相访问的功能"}]},{"ID":"20240404161535-jltfc6m","Type":"NodeList","ListData":{},"Properties":{"id":"20240404161535-jltfc6m","updated":"20240404161535"},"Children":[{"ID":"20240404161535-9zh83uy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-9zh83uy","updated":"20240404161535"},"Children":[{"ID":"20240404161535-fdbkxqb","Type":"NodeParagraph","Properties":{"id":"20240404161535-fdbkxqb","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"downcall"},{"Type":"NodeText","Data":"​ 允许 Java 链接到外部函数"}]}]},{"ID":"20240404161535-l1h99b8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-l1h99b8","updated":"20240404161535"},"Children":[{"ID":"20240404161535-e449wls","Type":"NodeParagraph","Properties":{"id":"20240404161535-e449wls","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"upcall"},{"Type":"NodeText","Data":"​ 允许外部函数调用 Java 方法"}]}]}]}]},{"ID":"20240404161535-aqavmyc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-aqavmyc","updated":"20240404161535"},"Children":[{"ID":"20240404161535-h8ynx6r","Type":"NodeParagraph","Properties":{"id":"20240404161535-h8ynx6r","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SymbolLookup"},{"Type":"NodeText","Data":"​：检索一个或多个库中的符号地址"}]}]},{"ID":"20240404161535-9j3l96h","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-9j3l96h","updated":"20240404161535"},"Children":[{"ID":"20240404161535-evoq351","Type":"NodeParagraph","Properties":{"id":"20240404161535-evoq351","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Arena"},{"Type":"NodeText","Data":"​：竞技场范围，控制内存段的生命周期，实现了 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"AutoClosable"},{"Type":"NodeText","Data":"​ 且关闭后不可再访问"}]}]},{"ID":"20240404161535-l7h8iv6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-l7h8iv6","updated":"20240404161535"},"Children":[{"ID":"20240404161535-db5737u","Type":"NodeParagraph","Properties":{"id":"20240404161535-db5737u","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MemorySegment"},{"Type":"NodeText","Data":"​：提供对连续内存区域的访问"}]},{"ID":"20240404161535-qd9c7yh","Type":"NodeList","ListData":{},"Properties":{"id":"20240404161535-qd9c7yh","updated":"20240404161535"},"Children":[{"ID":"20240404161535-mbwy5mr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-mbwy5mr","updated":"20240404161535"},"Children":[{"ID":"20240404161535-4hqnhwl","Type":"NodeParagraph","Properties":{"id":"20240404161535-4hqnhwl","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"heap segments"},{"Type":"NodeText","Data":"​：分配于 Java 堆中"}]}]},{"ID":"20240404161535-mzedxd7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-mzedxd7","updated":"20240404161535"},"Children":[{"ID":"20240404161535-3nny6s0","Type":"NodeParagraph","Properties":{"id":"20240404161535-3nny6s0","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"native segments"},{"Type":"NodeText","Data":"​：分配于 Java 堆外"}]}]}]}]},{"ID":"20240404161535-e6ru243","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240404161535-e6ru243","updated":"20240404161535"},"Children":[{"ID":"20240404161535-mwyq2xz","Type":"NodeParagraph","Properties":{"id":"20240404161535-mwyq2xz","updated":"20240404161535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ValueLayout"},{"Type":"NodeText","Data":"​：对基本数据类型进行建模，且对 Java 原始类型和地址定义了有用的布局常量"}]}]}]}]}