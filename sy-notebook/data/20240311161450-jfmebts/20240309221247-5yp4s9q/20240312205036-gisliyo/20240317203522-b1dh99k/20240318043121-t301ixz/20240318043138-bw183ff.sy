{"ID":"20240318043138-bw183ff","Spec":"1","Type":"NodeDocument","Properties":{"icon":"jclasslib256x256.png","id":"20240318043138-bw183ff","title":"ASM 增加 try-catch","type":"doc","updated":"20240318121914"},"Children":[{"ID":"20240318043138-bhftep0","Type":"NodeParagraph","Properties":{"id":"20240318043138-bhftep0","updated":"20240318115120"},"Children":[{"Type":"NodeText","Data":"如果想给方法增加 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"try-catch"},{"Type":"NodeText","Data":"​ 块，使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"visitTryCatchBlock"},{"Type":"NodeText","Data":"​ 增加异常表，并通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Label"},{"Type":"NodeText","Data":"​ 对象定位"}]},{"ID":"20240318115027-argc5z1","Type":"NodeSuperBlock","Properties":{"id":"20240318115027-argc5z1","updated":"20240318121722"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20240318113849-rtjiqdg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240318113849-rtjiqdg","updated":"20240318115042"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"// 原始方法\npublic void foo() {\n    System.out.println(\"Step 1\");\n    int a = 1 / 0;\n    System.out.println(\"Step 2\");\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240318114515-csmvcwa","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240318114515-csmvcwa","updated":"20240318121722"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"// 目标方法\npublic void foo() {\n    System.out.println(\"enter foo\");\n    try {\n        System.out.println(\"Step 1\");\n        int a = 1 / 0;\n        System.out.println(\"Step 2\");\n        System.out.println(\"normal exit foo\");\n    } catch (Exception e) {\n        System.out.println(\"err exit foo\");\n        throw e;\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"Type":"NodeSuperBlockCloseMarker"}]},{"ID":"20240318115043-inwqay4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240318115043-inwqay4","updated":"20240318121914"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"ClassReader cr = new ClassReader(bytes);\nClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_MAXS | ClassWriter.COMPUTE_FRAMES);\nClassVisitor cv = new ClassVisitor(ASM9, cw) {\n    @Override\n    public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) {\n        MethodVisitor method = super.visitMethod(access, name, descriptor, signature, exceptions);\n        if (\"foo\".equals(name)) {\n            return new AdviceAdapter(api, method, access, name, descriptor) {\n                static final String System = \"java/lang/System\";\n                static final String PrintStream = \"java/io/PrintStream\";\n                static final String PrintStreamDesc = \"Ljava/io/PrintStream;\";\n                static final String StringDesc = \"Ljava/util/String;\";\n                static final String printlnDesc = \"(\" + StringDesc + \")V\";\n              \n                private final Label start = new Label();\n\n                @Override\n                protected void onMethodEnter() {\n                    super.onMethodEnter();\n                    // System.out.println(\"enter foo\");\n                    mv.visitFieldInsn(GETSTATIC, System, \"out\", PrintStreamDesc);\n                    mv.visitLdcInsn(\"enter \" + name);\n                    mv.visitMethodInsn(INVOKEVIRTUAL, PrintStream, \"println\", printlnDesc, false);\n                    // [start] {\n                    mv.visitLabel(start);\n                }\n                @Override\n                protected void onMethodExit(int opcode) {\n                    super.onMethodExit(opcode);\n                    // System.out.println(\"normal exit foo\");\n                    if (opcode != ATHROW) onFinally(opcode);\n                }\n                @Override\n                public void visitMaxs(int maxStack, int maxLocals) {\n                    Label end = new Label();\n                    mv.visitTryCatchBlock(start, end, end, null);\n                    mv.visitLabel(end);\n                    // } [end]\n                    // System.out.println(\"err exit foo\");\n                    onFinally(ATHROW);\n                    // throw e;\n                    mv.visitInsn(ATHROW);\n                    super.visitMaxs(maxStack, maxLocals);\n                }\n\n                private void onFinally(int opcode) {\n                    mv.visitFieldInsn(GETSTATIC, System, \"out\", PrintStreamDesc);\n                    String str = opcode == ATHROW ? \"err exit \" + name : \"normal exit \" + name;\n                    mv.visitLdcInsn(str);\n                    mv.visitMethodInsn(INVOKEVIRTUAL, PrintStream, \"println\", printlnDesc, false);\n                }\n            };\n        }\n        return method;\n    }\n};\ncr.accept(cv, 0);\nreturn cw.toByteArray();\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}