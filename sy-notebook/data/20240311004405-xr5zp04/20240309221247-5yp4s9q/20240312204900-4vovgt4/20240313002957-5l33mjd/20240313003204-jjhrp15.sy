{"ID":"20240313003204-jjhrp15","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f630","id":"20240313003204-jjhrp15","title":"synchronized 实现原理","updated":"20240317095216"},"Children":[{"ID":"20240313003204-92gjgy4","Type":"NodeParagraph","Properties":{"id":"20240313003204-92gjgy4","updated":"20240317094041"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"synchronized"},{"Type":"NodeText","Data":"​ 定义了一个临界区，保证方法和代码块在同一时刻只有一个线程可以进入临界区。"}]},{"ID":"20240317094109-puuvm9j","Type":"NodeParagraph","Properties":{"id":"20240317094109-puuvm9j","updated":"20240317094210"},"Children":[{"Type":"NodeText","Data":"JVM 不会使用任何特殊字节码指令处理同步方法，只会增加一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"flag"},{"Type":"NodeText","Data":"​，判断方法是否是同步的。"}]},{"ID":"20240317094005-cl4defq","Type":"NodeSuperBlock","Properties":{"id":"20240317094005-cl4defq","updated":"20240317094006"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20240317093417-8tb5r4u","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240317093417-8tb5r4u","updated":"20240317094006"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"int count = 0;\npublic synchronized void increase() {\n    count++;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240317093434-j0xe8pq","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240317093434-j0xe8pq","updated":"20240317094006"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"flags: 0x0021 (ACC_PUBLIC | ACC_SYNCHRONIZED)\n  aload_0\n  dup\n  getfield #7 // Field: count: I\n  iconst_1\n  iadd\n  putfield #7 // Field: count: I\n  return\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"Type":"NodeSuperBlockCloseMarker"}]},{"ID":"20240317093957-9y00xii","Type":"NodeParagraph","Properties":{"id":"20240317093957-9y00xii","updated":"20240317094235"},"Children":[{"Type":"NodeText","Data":"将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"synchronized"},{"Type":"NodeText","Data":"​ 修饰替换成等效的关键字，可以看到其中的细节："}]},{"ID":"20240317094641-z6yd83p","Type":"NodeSuperBlock","Properties":{"id":"20240317094641-z6yd83p","updated":"20240317095216"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20240317094235-p79k158","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240317094235-p79k158","updated":"20240317095216"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"int count = 0;\npublic void increase() {\n    synchronized(this) {\n        count++;\n    }\n}\n\n// 大致等价于\n// 这里将 monitorenter 和 monitorexit 视作函数\npublic void increase() {\n    monitorenter(this);\n    try {\n        count++;\n    } finally {\n        monitorexit(this);\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240317094410-tur9y3n","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240317094410-tur9y3n","updated":"20240317094845"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"Code: \n   aload_0\n   dup\n   astore_1\n   monitorenter\n   // 本段与上面的相同，省略\n4  aload_0\n   ...\n   putfield #7\n   // 相同部分结束\n   aload_1\n   monitorexit\n16 goto 24\n19 astore_2\n   aload_1\n   monitorexit\n22 aload_2\n   athrow\n24 return\n\nException Table:\n  from  4 to 16, target 19, type any\n  from 19 to 22, target 19, type any\n  \n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"Type":"NodeSuperBlockCloseMarker"}]},{"ID":"20240317094457-gevf3gm","Type":"NodeParagraph","Properties":{"id":"20240317094457-gevf3gm"}}]}