{"ID":"20240515025905-bzmnlh2","Spec":"1","Type":"NodeDocument","Properties":{"icon":"mysql.ico","id":"20240515025905-bzmnlh2","title":"多版本并发控制","type":"doc","updated":"20240515025917"},"Children":[{"ID":"20240515025917-041wow6","Type":"NodeParagraph","Properties":{"id":"20240515025917-041wow6","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"MVCC，Multiple Version Concurrency Control，维护一个数据的多个版本，使读写无冲突"}]},{"ID":"20240515025917-dti0zxp","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-dti0zxp","updated":"20240515025917"},"Children":[{"ID":"20240515025917-45f133c","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-45f133c","updated":"20240515025917"},"Children":[{"ID":"20240515025917-tt6gz17","Type":"NodeParagraph","Properties":{"id":"20240515025917-tt6gz17","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"当前读：读取操作读的是记录的最新版本，且保证其他并发事务不能修改当前记录，需要对读取的事务加锁，包括："}]},{"ID":"20240515025917-2gehoc5","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-2gehoc5","updated":"20240515025917"},"Children":[{"ID":"20240515025917-0t96r88","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-0t96r88","updated":"20240515025917"},"Children":[{"ID":"20240515025917-94ifxzv","Type":"NodeParagraph","Properties":{"id":"20240515025917-94ifxzv","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"共享锁：select ... lock in share mode"}]}]},{"ID":"20240515025917-m5vw468","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-m5vw468","updated":"20240515025917"},"Children":[{"ID":"20240515025917-3x2w97v","Type":"NodeParagraph","Properties":{"id":"20240515025917-3x2w97v","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"排他锁：select ... for update, update, insert, delete"}]}]}]}]},{"ID":"20240515025917-5o0uabv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-5o0uabv","updated":"20240515025917"},"Children":[{"ID":"20240515025917-dj3gv4a","Type":"NodeParagraph","Properties":{"id":"20240515025917-dj3gv4a","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"快照读：读取的是当前数据的可见版本，不加锁，但不一定是最新版本，主要是简单的 select"}]},{"ID":"20240515025917-ltnvhm9","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-ltnvhm9","updated":"20240515025917"},"Children":[{"ID":"20240515025917-9dv3imj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-9dv3imj","updated":"20240515025917"},"Children":[{"ID":"20240515025917-7wgvaor","Type":"NodeParagraph","Properties":{"id":"20240515025917-7wgvaor","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"Read Committed：每次 select 生成一个快照读"}]}]},{"ID":"20240515025917-8qwykdz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-8qwykdz","updated":"20240515025917"},"Children":[{"ID":"20240515025917-s0je127","Type":"NodeParagraph","Properties":{"id":"20240515025917-s0je127","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"Repeatable Read：每次事务第一个 select 生成一个快照读"}]}]},{"ID":"20240515025917-rq5a0pd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-rq5a0pd","updated":"20240515025917"},"Children":[{"ID":"20240515025917-pb4mgbn","Type":"NodeParagraph","Properties":{"id":"20240515025917-pb4mgbn","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"Serializable：快照读退化为当前读"}]}]}]}]}]},{"ID":"20240515025917-x04oijt","Type":"NodeParagraph","Properties":{"id":"20240515025917-x04oijt","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"MVCC 依赖于数据库的三个隐式字段、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":"​ 日志和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"readView"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240515025917-a795sg2","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240515025917-a795sg2","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"原理"}]},{"ID":"20240515025917-onruqty","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-onruqty","updated":"20240515025917"},"Children":[{"ID":"20240515025917-ouiylc6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-ouiylc6","updated":"20240515025917"},"Children":[{"ID":"20240515025917-i7wv53z","Type":"NodeParagraph","Properties":{"id":"20240515025917-i7wv53z","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"隐藏字段：InnoDB 每条数据都有三个隐藏字段："}]},{"ID":"20240515025917-o6zogv3","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-o6zogv3","updated":"20240515025917"},"Children":[{"ID":"20240515025917-wp2ul7h","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-wp2ul7h","updated":"20240515025917"},"Children":[{"ID":"20240515025917-to29x74","Type":"NodeParagraph","Properties":{"id":"20240515025917-to29x74","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"db_trx_id"},{"Type":"NodeText","Data":"​：最近修改的事务 id，表示插入或最后一次修改该记录的事务 id"}]}]},{"ID":"20240515025917-jyylz8j","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-jyylz8j","updated":"20240515025917"},"Children":[{"ID":"20240515025917-icg6t4o","Type":"NodeParagraph","Properties":{"id":"20240515025917-icg6t4o","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"db_roll_ptr"},{"Type":"NodeText","Data":"​：回滚指针，指向记录的上个版本，通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":"​ 可快速回滚"}]}]},{"ID":"20240515025917-l8mgb5x","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-l8mgb5x","updated":"20240515025917"},"Children":[{"ID":"20240515025917-4z2nbx9","Type":"NodeParagraph","Properties":{"id":"20240515025917-4z2nbx9","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"db_row_id"},{"Type":"NodeText","Data":"​：隐藏主键，当表结构无主键时自动生成（仅无主键时产生）"}]}]}]}]},{"ID":"20240515025917-qdarjyq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-qdarjyq","updated":"20240515025917"},"Children":[{"ID":"20240515025917-lkjyjxf","Type":"NodeParagraph","Properties":{"id":"20240515025917-lkjyjxf","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"回滚日志"}]},{"ID":"20240515025917-5nkjb0o","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-5nkjb0o","updated":"20240515025917"},"Children":[{"ID":"20240515025917-uga2not","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-uga2not","updated":"20240515025917"},"Children":[{"ID":"20240515025917-ons3s7r","Type":"NodeParagraph","Properties":{"id":"20240515025917-ons3s7r","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"当执行 insert 语句时，undo log 只在回滚时需要，可以在事务提交后立即删除"}]}]},{"ID":"20240515025917-pg4y9wf","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-pg4y9wf","updated":"20240515025917"},"Children":[{"ID":"20240515025917-rhy2k0x","Type":"NodeParagraph","Properties":{"id":"20240515025917-rhy2k0x","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"当执行 update，delete 语句时，undo log 需要在快照读中发挥作用，不能被立即删除"}]}]},{"ID":"20240515025917-7175kva","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-7175kva","updated":"20240515025917"},"Children":[{"ID":"20240515025917-usg6kce","Type":"NodeParagraph","Properties":{"id":"20240515025917-usg6kce","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"undo log 版本链：不同事务对相同记录进行修改，产生的 undo log 是一个链表结构，头部为最新的纪录，尾部是最早的记录"}]}]}]}]},{"ID":"20240515025917-qa45ukr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-qa45ukr","updated":"20240515025917"},"Children":[{"ID":"20240515025917-rkdc36l","Type":"NodeParagraph","Properties":{"id":"20240515025917-rkdc36l","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"readView：快照读 SQL 执行时 MVCC 提取数据的依据，记录并维护系统当前活跃（未提交）的事务 id，主要字段包括："}]}]}]},{"ID":"20240515025917-aiqnd8y","Type":"NodeTable","TableAligns":[0,0],"Properties":{"colgroup":"|","id":"20240515025917-aiqnd8y","updated":"20240515025917"},"Children":[{"Type":"NodeTableHead","Data":"thead","Children":[{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"字段"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"含义"}]}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"m_ids"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"当前活跃事务 id 集合"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"min_trx_id"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"最小活跃事务 id"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"max_trx_id"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"预分配事务 id（当前最大事务 id +1）"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"creator_trx_id"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"ReadView 创建者事务 id"}]}]}]},{"ID":"20240515025917-oillz0o","Type":"NodeParagraph","Properties":{"id":"20240515025917-oillz0o","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"访问规则：trx_id 表示待检查 db_trx_id 值"}]},{"ID":"20240515025917-l3gxfqz","Type":"NodeList","ListData":{},"Properties":{"id":"20240515025917-l3gxfqz","updated":"20240515025917"},"Children":[{"ID":"20240515025917-k91d12o","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-k91d12o","updated":"20240515025917"},"Children":[{"ID":"20240515025917-04q05ry","Type":"NodeParagraph","Properties":{"id":"20240515025917-04q05ry","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"trx_id == creator_trx_id：可访问该版本，数据是当前事务更改的"}]}]},{"ID":"20240515025917-fc2jqha","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-fc2jqha","updated":"20240515025917"},"Children":[{"ID":"20240515025917-f71w024","Type":"NodeParagraph","Properties":{"id":"20240515025917-f71w024","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"trx_id \u003c min_trx_id：可访问该版本，数据已经提交"}]}]},{"ID":"20240515025917-imabk62","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-imabk62","updated":"20240515025917"},"Children":[{"ID":"20240515025917-szuc0qd","Type":"NodeParagraph","Properties":{"id":"20240515025917-szuc0qd","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"trx_id \u003e max_trx_id：不可访问版本，当前事务在 ReadView 生成后才开启"}]}]},{"ID":"20240515025917-j1q6o27","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240515025917-j1q6o27","updated":"20240515025917"},"Children":[{"ID":"20240515025917-ld5kwdn","Type":"NodeParagraph","Properties":{"id":"20240515025917-ld5kwdn","updated":"20240515025917"},"Children":[{"Type":"NodeText","Data":"min_trx_id \u003c= trx_id \u003c= max_trx_id 且 trx_id 不在 m_ids 中：可访问该版本，数据已提交"}]}]}]}]}