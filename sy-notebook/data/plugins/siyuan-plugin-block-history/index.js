"use strict";var rt=Object.defineProperty;var at=(o,c,i)=>c in o?rt(o,c,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[c]=i;var W=(o,c,i)=>(at(o,typeof c!="symbol"?c+"":c,i),i);const v=require("siyuan");window.Lute.New();let j;function ct(o){j=o}var lt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ut(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var K={exports:{}};(function(o,c){(function(i,u){o.exports=u()})(lt,function(){var i=1e3,u=6e4,b=36e5,M="millisecond",p="second",O="minute",T="hour",_="day",z="week",w="month",J="quarter",D="year",C="date",Z="Invalid Date",nt=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,it=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,ot={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(s){var n=["th","st","nd","rd"],t=s%100;return"["+s+(n[(t-20)%10]||n[t]||n[0])+"]"}},F=function(s,n,t){var r=String(s);return!r||r.length>=n?s:""+Array(n+1-r.length).join(t)+s},st={s:F,z:function(s){var n=-s.utcOffset(),t=Math.abs(n),r=Math.floor(t/60),e=t%60;return(n<=0?"+":"-")+F(r,2,"0")+":"+F(e,2,"0")},m:function s(n,t){if(n.date()<t.date())return-s(t,n);var r=12*(t.year()-n.year())+(t.month()-n.month()),e=n.clone().add(r,w),l=t-e<0,a=n.clone().add(r+(l?-1:1),w);return+(-(r+(t-e)/(l?e-a:a-e))||0)},a:function(s){return s<0?Math.ceil(s)||0:Math.floor(s)},p:function(s){return{M:w,y:D,w:z,d:_,D:C,h:T,m:O,s:p,ms:M,Q:J}[s]||String(s||"").toLowerCase().replace(/s$/,"")},u:function(s){return s===void 0}},I="en",x={};x[I]=ot;var N=function(s){return s instanceof A},B=function s(n,t,r){var e;if(!n)return I;if(typeof n=="string"){var l=n.toLowerCase();x[l]&&(e=l),t&&(x[l]=t,e=l);var a=n.split("-");if(!e&&a.length>1)return s(a[0])}else{var d=n.name;x[d]=n,e=d}return!r&&e&&(I=e),e||!r&&I},m=function(s,n){if(N(s))return s.clone();var t=typeof n=="object"?n:{};return t.date=s,t.args=arguments,new A(t)},h=st;h.l=B,h.i=N,h.w=function(s,n){return m(s,{locale:n.$L,utc:n.$u,x:n.$x,$offset:n.$offset})};var A=function(){function s(t){this.$L=B(t.locale,null,!0),this.parse(t)}var n=s.prototype;return n.parse=function(t){this.$d=function(r){var e=r.date,l=r.utc;if(e===null)return new Date(NaN);if(h.u(e))return new Date;if(e instanceof Date)return new Date(e);if(typeof e=="string"&&!/Z$/i.test(e)){var a=e.match(nt);if(a){var d=a[2]-1||0,y=(a[7]||"0").substring(0,3);return l?new Date(Date.UTC(a[1],d,a[3]||1,a[4]||0,a[5]||0,a[6]||0,y)):new Date(a[1],d,a[3]||1,a[4]||0,a[5]||0,a[6]||0,y)}}return new Date(e)}(t),this.$x=t.x||{},this.init()},n.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},n.$utils=function(){return h},n.isValid=function(){return this.$d.toString()!==Z},n.isSame=function(t,r){var e=m(t);return this.startOf(r)<=e&&e<=this.endOf(r)},n.isAfter=function(t,r){return m(t)<this.startOf(r)},n.isBefore=function(t,r){return this.endOf(r)<m(t)},n.$g=function(t,r,e){return h.u(t)?this[r]:this.set(e,t)},n.unix=function(){return Math.floor(this.valueOf()/1e3)},n.valueOf=function(){return this.$d.getTime()},n.startOf=function(t,r){var e=this,l=!!h.u(r)||r,a=h.p(t),d=function(L,$){var S=h.w(e.$u?Date.UTC(e.$y,$,L):new Date(e.$y,$,L),e);return l?S:S.endOf(_)},y=function(L,$){return h.w(e.toDate()[L].apply(e.toDate("s"),(l?[0,0,0,0]:[23,59,59,999]).slice($)),e)},f=this.$W,g=this.$M,H=this.$D,k="set"+(this.$u?"UTC":"");switch(a){case D:return l?d(1,0):d(31,11);case w:return l?d(1,g):d(0,g+1);case z:var Y=this.$locale().weekStart||0,E=(f<Y?f+7:f)-Y;return d(l?H-E:H+(6-E),g);case _:case C:return y(k+"Hours",0);case T:return y(k+"Minutes",1);case O:return y(k+"Seconds",2);case p:return y(k+"Milliseconds",3);default:return this.clone()}},n.endOf=function(t){return this.startOf(t,!1)},n.$set=function(t,r){var e,l=h.p(t),a="set"+(this.$u?"UTC":""),d=(e={},e[_]=a+"Date",e[C]=a+"Date",e[w]=a+"Month",e[D]=a+"FullYear",e[T]=a+"Hours",e[O]=a+"Minutes",e[p]=a+"Seconds",e[M]=a+"Milliseconds",e)[l],y=l===_?this.$D+(r-this.$W):r;if(l===w||l===D){var f=this.clone().set(C,1);f.$d[d](y),f.init(),this.$d=f.set(C,Math.min(this.$D,f.daysInMonth())).$d}else d&&this.$d[d](y);return this.init(),this},n.set=function(t,r){return this.clone().$set(t,r)},n.get=function(t){return this[h.p(t)]()},n.add=function(t,r){var e,l=this;t=Number(t);var a=h.p(r),d=function(g){var H=m(l);return h.w(H.date(H.date()+Math.round(g*t)),l)};if(a===w)return this.set(w,this.$M+t);if(a===D)return this.set(D,this.$y+t);if(a===_)return d(1);if(a===z)return d(7);var y=(e={},e[O]=u,e[T]=b,e[p]=i,e)[a]||1,f=this.$d.getTime()+t*y;return h.w(f,this)},n.subtract=function(t,r){return this.add(-1*t,r)},n.format=function(t){var r=this,e=this.$locale();if(!this.isValid())return e.invalidDate||Z;var l=t||"YYYY-MM-DDTHH:mm:ssZ",a=h.z(this),d=this.$H,y=this.$m,f=this.$M,g=e.weekdays,H=e.months,k=function($,S,q,P){return $&&($[S]||$(r,l))||q[S].slice(0,P)},Y=function($){return h.s(d%12||12,$,"0")},E=e.meridiem||function($,S,q){var P=$<12?"AM":"PM";return q?P.toLowerCase():P},L={YY:String(this.$y).slice(-2),YYYY:h.s(this.$y,4,"0"),M:f+1,MM:h.s(f+1,2,"0"),MMM:k(e.monthsShort,f,H,3),MMMM:k(H,f),D:this.$D,DD:h.s(this.$D,2,"0"),d:String(this.$W),dd:k(e.weekdaysMin,this.$W,g,2),ddd:k(e.weekdaysShort,this.$W,g,3),dddd:g[this.$W],H:String(d),HH:h.s(d,2,"0"),h:Y(1),hh:Y(2),a:E(d,y,!0),A:E(d,y,!1),m:String(y),mm:h.s(y,2,"0"),s:String(this.$s),ss:h.s(this.$s,2,"0"),SSS:h.s(this.$ms,3,"0"),Z:a};return l.replace(it,function($,S){return S||L[$]||a.replace(":","")})},n.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},n.diff=function(t,r,e){var l,a=h.p(r),d=m(t),y=(d.utcOffset()-this.utcOffset())*u,f=this-d,g=h.m(this,d);return g=(l={},l[D]=g/12,l[w]=g,l[J]=g/3,l[z]=(f-y)/6048e5,l[_]=(f-y)/864e5,l[T]=f/b,l[O]=f/u,l[p]=f/i,l)[a]||f,e?g:h.a(g)},n.daysInMonth=function(){return this.endOf(w).$D},n.$locale=function(){return x[this.$L]},n.locale=function(t,r){if(!t)return this.$L;var e=this.clone(),l=B(t,r,!0);return l&&(e.$L=l),e},n.clone=function(){return h.w(this.$d,this)},n.toDate=function(){return new Date(this.valueOf())},n.toJSON=function(){return this.isValid()?this.toISOString():null},n.toISOString=function(){return this.$d.toISOString()},n.toString=function(){return this.$d.toUTCString()},s}(),G=A.prototype;return m.prototype=G,[["$ms",M],["$s",p],["$m",O],["$H",T],["$W",_],["$M",w],["$y",D],["$D",C]].forEach(function(s){G[s[1]]=function(n){return this.$g(n,s[0],s[1])}}),m.extend=function(s,n){return s.$i||(s(n,A,m),s.$i=!0),m},m.locale=B,m.isDayjs=N,m.unix=function(s){return m(1e3*s)},m.en=x[I],m.Ls=x,m.p={},m})})(K);var ht=K.exports;const U=ut(ht),Q=function(o){const c={};return function(...i){const u=JSON.stringify(i);return c[u]||(c[u]=o.apply(o,i))}};async function X(o,c=1){let i=await v.fetchSyncPost("/api/history/searchHistory",{query:o,page:c,op:"all",type:3});if(i.code===0){if(i.data.pageCount<=c)return i.data.histories;let u=await X(o,c+1);return i.data.histories.concat(u)}}async function dt(o,c){let i=await v.fetchSyncPost("/api/history/getHistoryItems",{query:o,op:"all",type:3,created:c});if(i.code===0)return i.data.items[0].path}const ft=Q(dt);async function yt(o){let c=document.createElement("div"),i=await v.fetchSyncPost("/api/history/getDocHistoryContent",{historyPath:o});return i.code===0&&(c.innerHTML=i.data.content),c}const mt=Q(yt);function gt(o,c){return o.querySelector(`[data-node-id='${c}']`)}function tt(o){return o.getAttribute("updated")}function pt(o){return o.getAttribute("data-node-id").substring(0,14)}function $t(o,c){return U(o).isAfter(U(parseInt(c)*1e3))}async function vt(o,c,i){let u=await ft(o,c),b=await mt(u);return gt(b,i)}function bt(o){return`
<li class="b3-list-item b3-list-item--hide-action" style='background-color: var(--b3-theme-surface);'>
    <span class="b3-list-item__text" title="">${U(o).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>
`}function Mt(o){let c="";for(let i of o){let u=tt(i);u===null&&(u=pt(i)),c+=bt(u),i.style="margin:5px 20px",c+=i.outerHTML}return c}async function wt(o,c){let i="20500101000000",u=[],b=await X(o);for(let M of b){if(!$t(i,M))continue;let p=await vt(o,M,c);if(p===null||(i=tt(p),u.push(p),i===null))break}return u}async function kt(o,c){let i=await wt(o,c);return Mt(i)}async function _t(o,c){let i=await et(o,c);new v.Dialog({title:j.showDialog,content:i,width:"750px"})}async function et(o,c,i="40em"){let u=await kt(o,c);return`
    <div class="protyle fn__flex-1">
        <div class="protyle-content" style="user-select: text;max-height: ${i};">
            <div class="protyle-wysiwyg protyle-wysiwyg--attr" style="
            padding: 10px 0px;
        ">
            <div class="backlinkList fn__flex-1"><ul class="b3-list b3-list--background">
            
                ${u}
            </ul>
            </div>
    
        </div>
    </div>`}const R="menu-config",V="block_history_dock";class Dt extends v.Plugin{constructor(){super(...arguments);W(this,"customTab");W(this,"isMobile");W(this,"that",this)}async onload(){this.data[R]={readonlyText:"Readonly"},ct(this.i18n),console.log("loading plugin-sample",this.i18n);const i=v.getFrontend();this.isMobile=i==="mobile"||i==="browser-mobile",this.addIcons(`<symbol id="iconFace" viewBox="0 0 32 32">
<path d="M13.667 17.333c0 0.92-0.747 1.667-1.667 1.667s-1.667-0.747-1.667-1.667 0.747-1.667 1.667-1.667 1.667 0.747 1.667 1.667zM20 15.667c-0.92 0-1.667 0.747-1.667 1.667s0.747 1.667 1.667 1.667 1.667-0.747 1.667-1.667-0.747-1.667-1.667-1.667zM29.333 16c0 7.36-5.973 13.333-13.333 13.333s-13.333-5.973-13.333-13.333 5.973-13.333 13.333-13.333 13.333 5.973 13.333 13.333zM14.213 5.493c1.867 3.093 5.253 5.173 9.12 5.173 0.613 0 1.213-0.067 1.787-0.16-1.867-3.093-5.253-5.173-9.12-5.173-0.613 0-1.213 0.067-1.787 0.16zM5.893 12.627c2.28-1.293 4.040-3.4 4.88-5.92-2.28 1.293-4.040 3.4-4.88 5.92zM26.667 16c0-1.040-0.16-2.040-0.44-2.987-0.933 0.2-1.893 0.32-2.893 0.32-4.173 0-7.893-1.92-10.347-4.92-1.4 3.413-4.187 6.093-7.653 7.4 0.013 0.053 0 0.12 0 0.187 0 5.88 4.787 10.667 10.667 10.667s10.667-4.787 10.667-10.667z"></path>
</symbol>
<symbol id="iconSaving" viewBox="0 0 32 32">
<path d="M20 13.333c0-0.733 0.6-1.333 1.333-1.333s1.333 0.6 1.333 1.333c0 0.733-0.6 1.333-1.333 1.333s-1.333-0.6-1.333-1.333zM10.667 12h6.667v-2.667h-6.667v2.667zM29.333 10v9.293l-3.76 1.253-2.24 7.453h-7.333v-2.667h-2.667v2.667h-7.333c0 0-3.333-11.28-3.333-15.333s3.28-7.333 7.333-7.333h6.667c1.213-1.613 3.147-2.667 5.333-2.667 1.107 0 2 0.893 2 2 0 0.28-0.053 0.533-0.16 0.773-0.187 0.453-0.347 0.973-0.427 1.533l3.027 3.027h2.893zM26.667 12.667h-1.333l-4.667-4.667c0-0.867 0.12-1.72 0.347-2.547-1.293 0.333-2.347 1.293-2.787 2.547h-8.227c-2.573 0-4.667 2.093-4.667 4.667 0 2.507 1.627 8.867 2.68 12.667h2.653v-2.667h8v2.667h2.68l2.067-6.867 3.253-1.093v-4.707z"></path>
</symbol>
<symbol id="showHistory" lass="icon icon-tabler icon-tabler-clock-edit" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
<path d="M21 12a9 9 0 1 0 -9.972 8.948c.32 .034 .644 .052 .972 .052"></path>
<path d="M12 7v5l2 2"></path>
<path d="M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z"></path></symbol>`),this.addDock({config:{position:"LeftBottom",size:{width:200,height:0},icon:"showHistory",title:"show History"},data:{text:"This is my custom dock"},type:V,init(){this.element.innerHTML=`<div class="fn__flex-1 fn__flex-column">
    <div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#showHistory"></use></svg>
        Block History
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="Min ${v.adaptHotkey("⌘W")}"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__flex-1 plugin-block-hisory__custom-dock">
    </div>
    </div>`},destroy(){console.log("destroy dock:",V)}}),this.eventBus.on("click-blockicon",this.blockIconEvent),this.eventBus.on("click-editorcontent",this.dockEvent),console.log(this.i18n.helloPlugin)}onLayoutReady(){this.loadData(R),console.log(`frontend: ${v.getFrontend()}; backend: ${v.getBackend()}`)}onunload(){console.log(this.i18n.byePlugin),v.showMessage("Goodbye SiYuan Plugin"),console.log("onunload")}dockEvent({detail:i}){setTimeout(()=>{const u=document.querySelector(".fn__flex-1:not(.fn__none)>[data-type] .plugin-block-hisory__custom-dock");if(!u)return;let b=i.protyle.block.id,M=i.protyle.breadcrumb.id;et(b,M,"unset").then(p=>{u.innerHTML=p})},100)}blockIconEvent({detail:i}){const u=[];if(i.blockElements.forEach(p=>{u.push(p.getAttribute("data-node-id"))}),u.length===0||u.length>1)return;let b=i.protyle.block.parentID,M=u[0];i.menu.addItem({icon:"showHistory",label:j.blockHistory,click:()=>{v.showMessage(j.loadingHistory,2e3),_t(b,M)}})}showDialog(){new v.Dialog({title:"Hello World",content:'<div id="helloPanel" class="b3-dialog__content"></div>',width:this.isMobile?"92vw":"720px",destroyCallback(i){}})}}module.exports=Dt;
