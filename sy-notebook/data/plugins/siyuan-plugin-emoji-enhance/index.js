"use strict";var w=Object.defineProperty;var j=(c,r,e)=>r in c?w(c,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[r]=e;var y=(c,r,e)=>(j(c,typeof r!="symbol"?r+"":r,e),e);const p=require("siyuan");class E extends p.Plugin{constructor(){super(...arguments);y(this,"unloadActions",[])}onload(){this.addIcons('<symbol id="iconRandom" viewBox="0 0 1024 1024"><path d="M753.564731 337.471035c-45.8697 0-160.259984 113.849978-243.789399 194.548928C383.134027 654.383848 263.508509 773.284865 167.764911 773.284865l-58.892295 0c-24.068162 0-43.581588-19.526729-43.581588-43.581588s19.513426-43.581588 43.581588-43.581588l58.892295 0c60.504002 0 183.002964-121.68134 281.432741-216.784348 119.79641-115.744117 223.254713-219.029482 304.368102-219.029482l56.209186 0-59.641355-57.828057c-17.033955-16.993023-17.060561-42.902112-0.057305-59.927881 17.002232-17.030885 44.596707-17.064654 61.631686-0.065492l134.207631 133.874033c8.192589 8.172123 12.794397 19.238157 12.794397 30.803563 0 11.564383-4.601808 22.604834-12.794397 30.776957L811.706943 461.72599c-8.505721 8.486278-19.646456 12.522198-30.78719 12.522198-11.166317 0-22.333658-4.676509-30.844495-13.199627-17.003256-17.025769-16.975627-45.432749 0.057305-62.425771l59.641355-61.151755L753.564731 337.471035zM811.706943 561.66105c-17.034978-16.999163-44.629453-16.972557-61.631686 0.058328-17.003256 17.024745-16.975627 46.257533 0.057305 63.250556l59.641355 61.150732-56.209186 0c-35.793204 0-95.590102-52.946886-154.87637-108.373243-17.576307-16.435321-45.161572-16.3422-61.594847 1.226944-16.444531 17.568121-15.523555 46.393633 2.053776 62.823837 90.322122 84.458577 151.246703 131.484613 214.417441 131.484613l56.209186 0-59.641355 57.824987c-17.033955 16.993023-17.060561 43.736107-0.057305 60.761875 8.511861 8.523117 19.678178 12.369725 30.844495 12.369725 11.140735 0 22.281469-4.453429 30.78719-12.939707L945.914574 757.311055c8.192589-8.173147 12.794397-19.315928 12.794397-30.881334 0-11.564383-4.601808-22.682605-12.794397-30.855752L811.706943 561.66105zM108.871593 337.471035l58.892295 0c45.932122 0 114.40154 58.455343 168.915108 107.942431 8.352225 7.576559 18.832927 12.140505 29.29214 12.140505 11.852956 0 23.673166-4.394077 32.270984-13.857613 16.182564-17.807574 14.859429-46.823422-2.958378-62.998823-85.247546-77.381391-156.561755-130.388652-227.519854-130.388652l-58.892295 0c-24.068162 0-43.581588 19.526729-43.581588 43.581588S84.804455 337.471035 108.871593 337.471035z" p-id="2326"></path></symbol>')}onLayoutReady(){const e=new MutationObserver(s=>{for(const i of s)if(i.addedNodes.length)for(const o of i.addedNodes){const a=o;if(a.getAttribute("data-key")==="dialog-emojis"){const h=a.querySelector(".emojis");this.setupContainer(h)}}}),t={attributes:!1,childList:!0,subtree:!1};e.observe(document.body,t),this.unloadActions.push(()=>e.disconnect());const n=new MutationObserver(s=>{for(const i of s)for(const o of i.addedNodes){const a=o;a.classList.contains("emojis")&&this.setupContainer(a)}});this.eventBus.on("loaded-protyle-static",s=>{const i=s.detail.protyle.hint;i&&(n.observe(i.element,t),this.unloadActions.push(()=>n.disconnect))})}unloadListeners(){this.unloadActions.forEach(e=>e())}onunload(){this.unloadListeners()}setupContainer(e){let t,n,s;if(e.children.length===3&&(t=e.children[0]),n=e.querySelector(".emojis__panel"),s=n.nextElementSibling,t){t.querySelectorAll(".block__icon")[0].querySelector("use").setAttribute("xlink:href","#iconRandom"),t.insertAdjacentHTML("beforeend",`
        <span id="uploadButton" class="block__icon1 block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.upload}"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="fn__space"></span>
        <input type="file" id="uploadEmoji" multiple accept="image/*" style="display:none" />
        <span id="refreshButton" class="block__icon1 block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="fn__space"></span>
        <span id="urlButton" class="block__icon1 block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${this.i18n.loadFromUrl}"><svg><use xlink:href="#iconLanguage"></use></svg></span>
        <span class="fn__space"></span>`),t.querySelector("#urlButton").addEventListener("click",async l=>{const u=await this.readUrlFromDialog(l);if(!u)return;const f=u.value,m=await this.downloadImage(f);if(!m||!await this.saveImage(m))return;await this.refreshEmojis();const g=n.querySelector('div[data-type="1"]').nextElementSibling;await this.updateCustomEmojiPanel(g)}),t.querySelector("#refreshButton").addEventListener("click",async()=>{const l=n.querySelector('div[data-type="1"]').nextElementSibling;await this.updateCustomEmojiPanel(l,!0)});const h=t.querySelector("#uploadButton"),d=t.querySelector("#uploadEmoji");h.addEventListener("click",()=>{d.click()}),d.addEventListener("change",async()=>{const l=[...d.files];d.value="",await this.uploadEmoji(l),await this.refreshEmojis();const u=n.querySelector('div[data-type="1"]').nextElementSibling;await this.updateCustomEmojiPanel(u)})}const i=this.sortGroups(n.querySelector('div[data-type="1"]').nextElementSibling);n&&s&&this.setBottomGroup(s,i)}uploadEmoji(e){return Promise.all(e.map(t=>{const n=new FormData;return n.append("path","/data/emojis/"+t.name),n.append("isDir","false"),n.append("file",t),fetch("/api/file/putFile",{method:"POST",body:n}).then(s=>s.json())}))}async updateCustomEmojiPanel(e,t=!1){t&&await this.refreshEmojis();const s=window.siyuan.emojis.find(i=>i.id==="custom");if(this.resetCustomGroups(e),s.items.length===0)e.setAttribute("style","min-height: 28px"),e.innerHTML=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`;else{e.setAttribute("style",""),e.innerHTML=s.items.map(o=>`<button class="emojis__item ariaLabel" aria-label="${o.description}" data-unicode="${o.unicode}"><img src="/emojis/${o.unicode}" /></button>`).join("");const i=this.sortGroups(e);this.setBottomGroup(e.parentElement.nextElementSibling,i)}}async refreshEmojis(){return fetch("/api/system/getEmojiConf",{method:"POST"}).then(e=>e.json()).then(e=>{window.siyuan.emojis=e.data})}resetCustomGroups(e){e.parentElement.querySelectorAll(".custom-group").forEach(t=>{t.nextElementSibling.remove(),t.remove()})}sortGroups(e){const t=new Map;return e.querySelectorAll("button").forEach(n=>{const i=n.getAttribute("data-unicode").split("/");if(i.length===2){const o=i[0];t.has(o)?t.get(o).push(n):t.set(o,[n])}}),t.size===0?null:(t.forEach((n,s)=>{const i=document.createElement("div");i.classList.add("emojis__title","custom-group"),i.setAttribute("data-type",s),i.textContent=s;const o=document.createElement("div");o.classList.add("emojis__content"),n.forEach(a=>o.appendChild(a)),e.insertAdjacentElement("afterend",o),e.insertAdjacentElement("afterend",i)}),t)}setBottomGroup(e,t){if(!e||(e.querySelectorAll(".custom-emoji-type").forEach(s=>s.remove()),!t))return;const n=e.querySelector('.emojis__type[data-type="1"]');t.forEach((s,i)=>{const o=document.createElement("div");o.classList.add("emojis__type","ariaLabel","custom-emoji-type"),o.setAttribute("data-type",i),o.setAttribute("aria-label",i);const l=`<img src="${`/emojis/${(s.find(u=>{const m=u.getAttribute("data-unicode").split("/")[1].split(".");return m.splice(m.length-1,1).join("")==="thumb"})||s[0]).getAttribute("data-unicode")}`}">`;o.innerHTML=l,n.insertAdjacentElement("afterend",o)})}async readUrlFromDialog(e){return new Promise(t=>{const n=new p.Dialog({transparent:!0,content:`<div class="b3-dialog-content" style="padding: 12px"><input id="emojiUrl" type="text" class="b3-text-field" style="width: 300px; margin-right: 8px"><button class="b3-button" id="confirm">${this.i18n.confirm}</button></div>`,disableAnimation:!0,destroyCallback(o){t(o)}}),s=n.element.querySelector("#emojiUrl");s.focus(),s.addEventListener("keyup",o=>{o.key.toLowerCase()==="enter"&&n.destroy({value:s.value})}),n.element.querySelector("#confirm").addEventListener("click",()=>{n.destroy({value:s.value})})})}async downloadImage(e){return e?fetch(e).then(t=>{if(t.headers.get("Content-Type").startsWith("image/"))return t.blob();throw Error(this.i18n.notAnImage)}).then(t=>{const n=t.type;return new File([t],window.Lute.NewNodeID()+"."+n.split("/")[1])}).catch(t=>(p.showMessage(this.name+":"+this.i18n.downloadFailed+`:
`+t),null)):null}async saveImage(e){const t=new FormData;return t.append("file",e),t.append("isDir","false"),t.append("path","/data/emojis/"+e.name),fetch("/api/file/putFile",{method:"POST",body:t}).then(n=>n.json()).then(n=>n.code!==0?(p.showMessage(this.name+":"+this.i18n.saveFailed),!1):!0).catch(n=>(p.showMessage(this.name+":"+this.i18n.saveFailed+`:
`+n),!1))}}module.exports=E;
