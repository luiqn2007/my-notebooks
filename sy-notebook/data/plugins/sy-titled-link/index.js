"use strict";var E=Object.defineProperty;var w=(a,e,t)=>e in a?E(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var h=(a,e,t)=>(w(a,typeof e!="symbol"?e+"":e,t),t);const k=require("siyuan");function _(a){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const t in a)if(t!=="default"){const l=Object.getOwnPropertyDescriptor(a,t);Object.defineProperty(e,t,l.get?l:{enumerable:!0,get:()=>a[t]})}}return e.default=a,Object.freeze(e)}const T=_(k);async function L(a,e){let t=await k.fetchSyncPost(a,e);return t.code===0?t.data:null}async function B(a,e="GET",t={},l=[],i=7e3,c="text/html"){return L("/api/network/forwardProxy",{url:a,method:e,timeout:i,contentType:c,headers:l,payload:t})}class S{constructor(e,t,l,i,c){h(this,"plugin");h(this,"name");h(this,"file");h(this,"settings",new Map);h(this,"elements",new Map);this.name=t??"settings",this.plugin=e,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.plugin.setting=new k.Setting({width:i,height:c,confirmCallback:()=>{for(let s of this.settings.keys())this.updateValueFromElement(s);let n=this.dump();l!=null?l(n):(this.plugin.data[this.name]=n,this.save())},destroyCallback:()=>{for(let n of this.settings.keys())this.updateElementFromValue(n)}})}async load(){let e=await this.plugin.loadData(this.file);if(console.debug("Load config:",e),e)for(let[t,l]of this.settings)l.value=(e==null?void 0:e[t])??l.value;return this.plugin.data[this.name]=this.dump(),e}async save(){let e=this.dump();return await this.plugin.saveData(this.file,this.dump()),console.debug("Save config:",e),e}get(e){var t;return(t=this.settings.get(e))==null?void 0:t.value}set(e,t){let l=this.settings.get(e);l&&(l.value=t,this.updateElementFromValue(e))}dump(){let e={};for(let[t,l]of this.settings)l.type!=="button"&&(e[t]=l.value);return e}addItem(e){var l,i,c,n,s;this.settings.set(e.key,e);let t;switch(e.type){case"checkbox":let o=document.createElement("input");o.type="checkbox",o.checked=e.value,o.className="b3-switch fn__flex-center",t=o;break;case"select":let u=document.createElement("select");u.className="b3-select fn__flex-center fn__size200";let m=(e==null?void 0:e.options)??{};for(let y in m){let g=document.createElement("option"),x=m[y];g.value=y,g.text=x,u.appendChild(g)}u.value=e.value,t=u;break;case"slider":let r=document.createElement("input");r.type="range",r.className="b3-slider fn__size200 b3-tooltips b3-tooltips__n",r.ariaLabel=e.value,r.min=((l=e.slider)==null?void 0:l.min.toString())??"0",r.max=((i=e.slider)==null?void 0:i.max.toString())??"100",r.step=((c=e.slider)==null?void 0:c.step.toString())??"1",r.value=e.value,r.onchange=()=>{r.ariaLabel=r.value},t=r;break;case"textinput":let b=document.createElement("input");b.className="b3-text-field fn__flex-center fn__size200",b.value=e.value,t=b;break;case"textarea":let f=document.createElement("textarea");f.className="b3-text-field fn__block",f.value=e.value,t=f;break;case"number":let p=document.createElement("input");p.type="number",p.className="b3-text-field fn__flex-center fn__size200",p.value=e.value,t=p;break;case"button":let d=document.createElement("button");d.className="b3-button b3-button--outline fn__flex-center fn__size200",d.innerText=((n=e.button)==null?void 0:n.label)??"Button",d.onclick=((s=e.button)==null?void 0:s.callback)??(()=>{}),t=d;break;case"hint":let v=document.createElement("div");v.className="b3-label fn__flex-center",t=v;break}this.elements.set(e.key,t),this.plugin.setting.addItem({title:e.title,description:e==null?void 0:e.description,createActionElement:()=>this.getElement(e.key)})}getElement(e){let t=this.settings.get(e),l=this.elements.get(e);switch(t.type){case"checkbox":l.checked=t.value;break;case"select":l.value=t.value;break;case"slider":l.value=t.value,l.ariaLabel=t.value;break;case"textinput":l.value=t.value;break;case"textarea":l.value=t.value;break}return l}updateValueFromElement(e){let t=this.settings.get(e),l=this.elements.get(e);switch(t.type){case"checkbox":t.value=l.checked;break;case"select":t.value=l.value;break;case"slider":t.value=l.value;break;case"textinput":t.value=l.value;break;case"textarea":t.value=l.value;break}}updateElementFromValue(e){let t=this.settings.get(e),l=this.elements.get(e);switch(t.type){case"checkbox":l.checked=t.value;break;case"select":l.value=t.value;break;case"slider":l.value=t.value;break;case"textinput":l.value=t.value;break;case"textarea":l.value=t.value;break}}}const A=`
<symbol id="iconUrl" viewBox="0 0 1024 1024"><path d="M578.133 675.627c-3.306-3.307-8.746-3.307-12.053 0L442.133 799.573c-57.386 57.387-154.24 63.467-217.6 0-63.466-63.466-57.386-160.213 0-217.6L348.48 458.027c3.307-3.307 3.307-8.747 0-12.054l-42.453-42.453c-3.307-3.307-8.747-3.307-12.054 0L170.027 527.467c-90.24 90.24-90.24 236.266 0 326.4s236.266 90.24 326.4 0L620.373 729.92c3.307-3.307 3.307-8.747 0-12.053l-42.24-42.24z m275.84-505.6c-90.24-90.24-236.266-90.24-326.4 0L403.52 293.973c-3.307 3.307-3.307 8.747 0 12.054l42.347 42.346c3.306 3.307 8.746 3.307 12.053 0l123.947-123.946c57.386-57.387 154.24-63.467 217.6 0 63.466 63.466 57.386 160.213 0 217.6L675.52 565.973c-3.307 3.307-3.307 8.747 0 12.054l42.453 42.453c3.307 3.307 8.747 3.307 12.054 0l123.946-123.947c90.134-90.24 90.134-236.266 0-326.506z"></path><path d="M616.64 362.987c-3.307-3.307-8.747-3.307-12.053 0l-241.6 241.493c-3.307 3.307-3.307 8.747 0 12.053l42.24 42.24c3.306 3.307 8.746 3.307 12.053 0L658.773 417.28c3.307-3.307 3.307-8.747 0-12.053l-42.133-42.24z"></path>
</symbol>
`,M=async a=>{console.log(a);let e=null;if(a.startsWith("www.")&&(a="http://"+a),a.startsWith("http")){let t=await B(a,"GET",null,[{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36 Edg/116.0.1938.76"}],5e3,"text/html");if(!t||t.status/100!==2)return null;let l=t==null?void 0:t.body,i=/<meta\b[^>]*charset=['"]?([^'"]*)['"]?[^>]*>/,c=/<title\b[^>]*>(.*?)<\/title>/,n=l==null?void 0:l.match(c);n&&(e=n[1],e=window.Lute.UnEscapeHTMLStr(e),n=l==null?void 0:l.match(i),(n?n[1]:"utf-8").toLowerCase()!=="utf-8"&&(e=null))}return e},I="config.json";class U extends T.Plugin{constructor(){super(...arguments);h(this,"onOpenMenuLinkBindThis",this.onOpenMenuLink.bind(this));h(this,"onClickBlockIconBindThis",this.onClickBlockIcon.bind(this));h(this,"settingUtils")}onload(){this.addIcons(A),this.eventBus.on("open-menu-link",this.onOpenMenuLinkBindThis),this.eventBus.on("click-blockicon",this.onClickBlockIconBindThis),this.settingUtils=new S(this,I,null,null,"300px"),this.settingUtils.addItem({key:"replaceTitle",value:!0,type:"checkbox",title:this.i18n.replaceTitle.title,description:this.i18n.replaceTitle.description});try{this.settingUtils.load()}catch(t){console.error("Error loading settings storage, probably empty config json:",t)}}onunload(){this.eventBus.off("open-menu-link",this.onOpenMenuLinkBindThis),this.eventBus.off("click-blockicon",this.onClickBlockIconBindThis)}async onClickBlockIcon({detail:t}){let l=t.menu,i=t.blockElements,c=t.protyle,n=!1;for(let s of i)if(s.querySelector('span[data-type="a"]')){n=!0;break}n&&l.addItem({icon:"iconUrl",label:this.i18n.GetTitle,click:async()=>{let s=[];for(let o of i)s.push(...o.querySelectorAll('span[data-type="a"]'));this.replaceHrefAnchor(c,...s)}})}async onOpenMenuLink({detail:t}){let l=t.menu,i=t.protyle;const c=t.element;let n=c.getAttribute("data-href");!(n!=null&&n.startsWith("http"))&&!(n!=null&&n.startsWith("www."))||l.addItem({icon:"iconUrl",label:this.i18n.GetTitle,click:async()=>{this.replaceHrefAnchor(i,c)}})}async replaceHrefAnchor(t,...l){const i=()=>{let s=new Event("input");t.wysiwyg.element.dispatchEvent(s)},c=async s=>{let o=s.getAttribute("data-href"),u=await M(o);console.log("Title:",u,`
	=>`,o),u&&(s.innerText=u,this.settingUtils.get("replaceTitle")&&s.setAttribute("data-title",u))};let n=[];for(let s of l)n.push(c(s));await Promise.all(n),i()}}module.exports=U;
