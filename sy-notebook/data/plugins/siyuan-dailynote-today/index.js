"use strict";var wi=Object.defineProperty;var bi=(n,e,t)=>e in n?wi(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var I=(n,e,t)=>(bi(n,typeof e!="symbol"?e+"":e,t),t);const F=require("siyuan");function ne(){}function Ti(n){return!!n&&(typeof n=="object"||typeof n=="function")&&typeof n.then=="function"}function Un(n){return n()}function jt(){return Object.create(null)}function oe(n){n.forEach(Un)}function Ln(n){return typeof n=="function"}function Pe(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function vi(n){return Object.keys(n).length===0}function p(n,e){n.appendChild(e)}function Z(n,e,t){n.insertBefore(e,t||null)}function K(n){n.parentNode&&n.parentNode.removeChild(n)}function ze(n,e){for(let t=0;t<n.length;t+=1)n[t]&&n[t].d(e)}function v(n){return document.createElement(n)}function ie(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}function ye(n){return document.createTextNode(n)}function Y(){return ye(" ")}function It(){return ye("")}function z(n,e,t,i){return n.addEventListener(e,t,i),()=>n.removeEventListener(e,t,i)}function g(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function De(n,e,t){n.setAttributeNS("http://www.w3.org/1999/xlink",e,t)}function ki(n){return Array.from(n.childNodes)}function Ve(n,e){e=""+e,n.wholeText!==e&&(n.data=e)}function zt(n,e){n.value=e??""}function He(n,e,t,i){t===null?n.style.removeProperty(e):n.style.setProperty(e,t,i?"important":"")}function Vt(n,e,t){for(let i=0;i<n.options.length;i+=1){const s=n.options[i];if(s.__value===e){s.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function Di(n){const e=n.querySelector(":checked");return e&&e.__value}function qt(n,e,t){n.classList[t?"add":"remove"](e)}function Ei(n,e,{bubbles:t=!1,cancelable:i=!1}={}){const s=document.createEvent("CustomEvent");return s.initCustomEvent(n,t,i,e),s}class $i{constructor(e=!1){this.is_svg=!1,this.is_svg=e,this.e=this.n=null}c(e){this.h(e)}m(e,t,i=null){this.e||(this.is_svg?this.e=ie(t.nodeName):this.e=v(t.nodeType===11?"TEMPLATE":t.nodeName),this.t=t.tagName!=="TEMPLATE"?t:t.content,this.c(e)),this.i(i)}h(e){this.e.innerHTML=e,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(e){for(let t=0;t<this.n.length;t+=1)Z(this.t,this.n[t],e)}p(e){this.d(),this.h(e),this.i(this.a)}d(){this.n.forEach(K)}}let qe;function Te(n){qe=n}function pt(){if(!qe)throw new Error("Function called outside component initialization");return qe}function Hn(n){pt().$$.on_mount.push(n)}function Si(n){pt().$$.on_destroy.push(n)}function Bt(){const n=pt();return(e,t,{cancelable:i=!1}={})=>{const s=n.$$.callbacks[e];if(s){const a=Ei(e,t,{cancelable:i});return s.slice().forEach(r=>{r.call(n,a)}),!a.defaultPrevented}return!0}}const Ue=[],Ke=[];let Le=[];const Rt=[],Mi=Promise.resolve();let Nt=!1;function Oi(){Nt||(Nt=!0,Mi.then(Ut))}function ft(n){Le.push(n)}function Ai(n){Rt.push(n)}const vt=new Set;let Ie=0;function Ut(){if(Ie!==0)return;const n=qe;do{try{for(;Ie<Ue.length;){const e=Ue[Ie];Ie++,Te(e),Pi(e.$$)}}catch(e){throw Ue.length=0,Ie=0,e}for(Te(null),Ue.length=0,Ie=0;Ke.length;)Ke.pop()();for(let e=0;e<Le.length;e+=1){const t=Le[e];vt.has(t)||(vt.add(t),t())}Le.length=0}while(Ue.length);for(;Rt.length;)Rt.pop()();Nt=!1,vt.clear(),Te(n)}function Pi(n){if(n.fragment!==null){n.update(),oe(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(ft)}}function Ri(n){const e=[],t=[];Le.forEach(i=>n.indexOf(i)===-1?e.push(i):t.push(i)),t.forEach(i=>i()),Le=e}const ut=new Set;let Oe;function Je(){Oe={r:0,c:[],p:Oe}}function Xe(){Oe.r||oe(Oe.c),Oe=Oe.p}function re(n,e){n&&n.i&&(ut.delete(n),n.i(e))}function he(n,e,t,i){if(n&&n.o){if(ut.has(n))return;ut.add(n),Oe.c.push(()=>{ut.delete(n),i&&(t&&n.d(1),i())}),n.o(e)}else i&&i()}function Ni(n,e){const t=e.token={};function i(s,a,r,o){if(e.token!==t)return;e.resolved=o;let l=e.ctx;r!==void 0&&(l=l.slice(),l[r]=o);const c=s&&(e.current=s)(l);let f=!1;e.block&&(e.blocks?e.blocks.forEach((d,m)=>{m!==a&&d&&(Je(),he(d,1,1,()=>{e.blocks[m]===d&&(e.blocks[m]=null)}),Xe())}):e.block.d(1),c.c(),re(c,1),c.m(e.mount(),e.anchor),f=!0),e.block=c,e.blocks&&(e.blocks[a]=c),f&&Ut()}if(Ti(n)){const s=pt();if(n.then(a=>{Te(s),i(e.then,1,e.value,a),Te(null)},a=>{if(Te(s),i(e.catch,2,e.error,a),Te(null),!e.hasCatch)throw a}),e.current!==e.pending)return i(e.pending,0),!0}else{if(e.current!==e.then)return i(e.then,1,e.value,n),!0;e.resolved=n}}function xi(n,e,t){const i=e.slice(),{resolved:s}=n;n.current===n.then&&(i[n.value]=s),n.current===n.catch&&(i[n.error]=s),n.block.p(i,t)}function Ci(n,e){n.d(1),e.delete(n.key)}function Ii(n,e){he(n,1,1,()=>{e.delete(n.key)})}function Fn(n,e,t,i,s,a,r,o,l,c,f,d){let m=n.length,u=a.length,h=m;const k={};for(;h--;)k[n[h].key]=h;const M=[],b=new Map,q=new Map,x=[];for(h=u;h--;){const S=d(s,a,h),B=t(S);let E=r.get(B);E?i&&x.push(()=>E.p(S,e)):(E=c(B,S),E.c()),b.set(B,M[h]=E),B in k&&q.set(B,Math.abs(h-k[B]))}const A=new Set,C=new Set;function T(S){re(S,1),S.m(o,f),r.set(S.key,S),f=S.first,u--}for(;m&&u;){const S=M[u-1],B=n[m-1],E=S.key,$=B.key;S===B?(f=S.first,m--,u--):b.has($)?!r.has(E)||A.has(E)?T(S):C.has($)?m--:q.get(E)>q.get($)?(C.add(E),T(S)):(A.add($),m--):(l(B,r),m--)}for(;m--;){const S=n[m];b.has(S.key)||l(S,r)}for(;u;)T(M[u-1]);return oe(x),M}function Bi(n,e,t){const i=n.$$.props[e];i!==void 0&&(n.$$.bound[i]=t,t(n.$$.ctx[i]))}function mt(n){n&&n.c()}function Qe(n,e,t,i){const{fragment:s,after_update:a}=n.$$;s&&s.m(e,t),i||ft(()=>{const r=n.$$.on_mount.map(Un).filter(Ln);n.$$.on_destroy?n.$$.on_destroy.push(...r):oe(r),n.$$.on_mount=[]}),a.forEach(ft)}function et(n,e){const t=n.$$;t.fragment!==null&&(Ri(t.after_update),oe(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Ui(n,e){n.$$.dirty[0]===-1&&(Ue.push(n),Oi(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function Re(n,e,t,i,s,a,r,o=[-1]){const l=qe;Te(n);const c=n.$$={fragment:null,ctx:[],props:a,update:ne,not_equal:s,bound:jt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:jt(),dirty:o,skip_bound:!1,root:e.target||l.$$.root};r&&r(c.root);let f=!1;if(c.ctx=t?t(n,e.props||{},(d,m,...u)=>{const h=u.length?u[0]:m;return c.ctx&&s(c.ctx[d],c.ctx[d]=h)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](h),f&&Ui(n,d)),m}):[],c.update(),f=!0,oe(c.before_update),c.fragment=i?i(c.ctx):!1,e.target){if(e.hydrate){const d=ki(e.target);c.fragment&&c.fragment.l(d),d.forEach(K)}else c.fragment&&c.fragment.c();e.intro&&re(n.$$.fragment),Qe(n,e.target,e.anchor,e.customElement),Ut()}Te(l)}class Ne{$destroy(){et(this,1),this.$destroy=ne}$on(e,t){if(!Ln(t))return ne;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const s=i.indexOf(t);s!==-1&&i.splice(s,1)}}$set(e){this.$$set&&!vi(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Yn=window.Lute.New();function se(...n){console.debug(`[DailyNoteToday][DEBUG] ${n}`)}function de(...n){console.log(`[DailyNoteToday][INFO] ${n}`)}function Ee(...n){console.error(`[DailyNoteToday][ERROR] ${n}`)}function Li(...n){console.warn(`[DailyNoteToday][WARN] ${n}`)}let N;function Hi(n){N=n}let tt;function Fi(n){tt=n}let Ge;function Yi(n){Ge=n}let Wn;function Wi(n){Wn=n}function Kt(n,e){return n.length>e?n.slice(0,e)+"...":n}function Zt(n,e){let t=[];for(let i=0;i<n.length;i+=e)t.push(n.slice(i,i+e));return t.join(`
`)}function Gi(n){let e=n.slice(0,4),t=n.slice(4,6),i=n.slice(6,8),s=n.slice(8,10),a=n.slice(10,12),r=n.slice(12,14);return`${e}-${t}-${i} ${s}:${a}:${r}`}function ji(n){return!!(n&&n instanceof HTMLElement&&n.dataset.type&&n.dataset.nodeId&&/^\d{14}-[0-9a-z]{7}$/.test(n.dataset.nodeId))}function zi(){const n=document.getSelection();let e=n==null?void 0:n.focusNode;for(;e&&(!(e instanceof HTMLElement)||!ji(e));)e=e.parentElement;return e}class Vi{constructor(){I(this,"Timer",{});I(this,"DefaultTimer",null)}getTimer(e){return e?this.Timer[e]:this.DefaultTimer}setTimer(e,t){t?this.Timer[t]=e:this.DefaultTimer=e}clearTimer(e){let t=this.getTimer(e);t&&(clearTimeout(t),this.setTimer(null,e))}debounce(e,t=20,i){return(...a)=>{this.clearTimer(i);let r=setTimeout(()=>e(...a),t);this.setTimer(r,i)}}}const qi=new Vi;class Ki{constructor(){I(this,"events",{});I(this,"EventUpdateAll","UpdateAll");I(this,"EventSetting","UpdateSetting");I(this,"EventSettingLoaded","SettingLoaded")}subscribe(e,t){e in this.events?this.events[e].push(t):this.events[e]=[t]}unSubscribe(e,t){if(e in this.events){let i=this.events[e].indexOf(t);i>=0&&this.events[e].splice(i,1)}}publish(e,t){this.events[e]&&this.events[e].forEach(i=>i(t))}}const X=new Ki;async function ee(n,e){let t=await F.fetchSyncPost(n,e);return t.code===0?t.data:null}async function $e(n){return ee("/api/query/sql",{stmt:n})}async function Gn(){return ee("/api/notebook/lsNotebooks","")}async function Zi(n,e,t){return ee("/api/filetree/createDocWithMd",{notebook:n,path:e,markdown:t})}async function Ji(n,e){return ee("/api/filetree/createDailyNote",{notebook:n,app:e})}async function Xi(n){return ee("/api/notebook/getNotebookConf",{notebook:n})}async function Qi(n,e,t){return ee("/api/filetree/moveDocs",{fromPaths:n,toNotebook:e,toPath:t})}async function es(n,e,t){return ee("/api/filetree/renameDoc",{notebook:n,path:e,title:t})}async function ts(n,e,t){return ee("/api/filetree/doc2Heading",{srcID:n,targetID:e,after:t})}async function nt(n){let e=`select * from blocks where id ='${n}'`;return(await $e(e))[0]}async function ns(n){return ee("/api/block/getChildBlocks",{id:n})}async function kt(n,e=null,t=null){return ee("/api/block/moveBlock",{id:n,previousID:e,parentID:t})}async function jn(n,e,t){return ee("/api/block/prependBlock",{data:e,parentID:n,dataType:t})}async function zn(n,e,t){return ee("/api/block/appendBlock",{data:e,parentID:n,dataType:t})}async function is(n){return ee("/api/block/deleteBlock",{id:n})}async function ss(n,e,t){return ee("/api/block/updateBlock",{id:n,data:e,dataType:t})}async function Vn(n){return ee("/api/template/renderSprig",{template:n})}async function rs(n){return ee("/api/block/getBlockKramdown",{id:n})}async function Ze(n,e){return ee("/api/attr/setBlockAttrs",{id:n,attrs:e})}async function as(n,e="",t=""){let i={session:e,app:t,reqId:new Date().getTime(),transactions:[{doOperations:[{action:"foldHeading",id:n}],undoOperations:[{action:"unfoldHeading",id:n}]}]};return ee("/api/transactions",i)}async function os(n,e="",t=""){let i={session:e,app:t,reqId:new Date().getTime(),transactions:[{doOperations:[{action:"unfoldHeading",id:n}],undoOperations:[{action:"foldHeading",id:n}]}]};return ee("/api/transactions",i)}class ls{constructor(){I(this,"notebooks");I(this,"default");this.notebooks=[]}get(e){return this.notebooks[e]}set(e,t){this.notebooks[e]=t}find(e){for(const t of this.notebooks)if(t.id===e)return t;return null}[Symbol.iterator](){return this.notebooks[Symbol.iterator]()}async init(e=5,t=1e3){let i=0;for(;i<e;){let s=await Jt();if(s!=null){this.notebooks=s;break}else await new Promise(a=>setTimeout(a,t));i++}this.updateDefault()}async update(){let e=await Jt();this.notebooks=e||[],this.updateDefault()}updateDefault(){let e=G.get("DefaultNotebook");if(e=e.trim(),e!=""){let t=this.find(e);t?this.default=t:this.default=void 0}else this.default=this.get(0);G.save()}}const Q=new ls,Dt='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',cs=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function Jt(){try{let e=(await Gn()).notebooks;e=e.filter(i=>!i.closed&&!cs.has(i.name));let t=e.map(i=>i.name);for(let i of e){let s=await fs(i.id);i.dailynoteSprig=s!=""?s:Dt,i.dailynoteHpath=await Xt(i.dailynoteSprig),i.dailynoteHpath==""&&(Li(`Invalid daily note srpig of ${i.name}`),i.dailynoteSprig=Dt,i.dailynoteHpath=await Xt(Dt)),i.icon==""&&(i.icon="1f5c3")}return se(`Read all notebooks: ${t}`),e}catch(n){return Ee(n),null}}async function Ae(n,e=null){let t=`select * from blocks where type='d' and hpath = '${n}'`;return e!=null&&(t=`select * from blocks where type='d' and hpath = '${n}' and box = '${e.id}'`),await $e(t)}async function us(n){const t=`select distinct id from blocks where id in (${n.map(a=>`'${a}'`).join(",")})`;let i=await $e(t),s=new Set;return i.forEach(a=>{s.add(a.id)}),s}function ds(n){F.openTab({app:Ge,doc:{id:n,action:["cb-get-focus"],zoomIn:!0}})}function Lt(n,e=""){n=n===void 0?new Date:n;let t=n.getFullYear(),i=n.getMonth()+1,s=n.getDate();return`${t}${e}${i<10?"0"+i:i}${e}${s<10?"0"+s:s}`}async function fs(n){return(await Xi(n)).conf.dailyNoteSavePath}async function Xt(n){return await Vn(n)}async function hs(){let n=new Set;Q.notebooks.forEach(i=>{n.add(i.dailynoteHpath)});let e=new Map,t=0;for(const i of n){let s=await Ae(i);if(s.length>0){let a=s.map(r=>r.box);a.forEach(r=>{e.set(r,!0)}),t+=a.length}}return de(`更新日记状态: 当前日记共 ${t} 篇`),e}function qn(n,e){let t=Lt(e),i=`custom-dailynote-${t}`,s={};s[i]=t,Ze(n,s)}async function Kn(n,e){let t=await Zi(n.id,e,"");return de(`创建日记: ${n.name} ${e}`),qn(t),t}async function Zn(n){let e=Ge.appId,t=await Ji(n.id,e);F.showMessage(`${N.Open}: ${n.name}`,2e3,"info"),tt===!0?F.openMobileFileById(Ge,t.id,["cb-get-all"]):F.openTab({app:Ge,doc:{id:t.id,zoomIn:!1}})}async function gs(){if(se("自动开启日记"),tt&&G.get("DisableAutoCreateOnMobile")===!0)return;if(new URL(window.location.href).pathname.startsWith("/stage/build/app/window.html")){se("小窗模式, 无需自动打开日记");return}if(Q.notebooks.length>0&&G.settings.OpenOnStart===!0){let e=G.get("DefaultNotebook"),t=Q.default;if(t)await Zn(t);else{F.confirm(N.Name,`${e} ${N.InvalidDefaultNotebook}`);return}}}async function ps(n,e){var a;F.showMessage("Merge",1e3,"info"),n=n.sort((r,o)=>r.created>=o.created?-1:1);let t=n.pop(),i=await zn(t.id,N.ConflictDiary.HeadingMarkdown,"markdown"),s=(a=i==null?void 0:i[0])==null?void 0:a.doOperations[0].id;if(s===void 0)return Ee("无法获取最新日记的最后一个 block id"),F.showMessage(N.ConflictDiary.fail,2e3,"error"),e(),t;for(let r of n){let o=r.id,l=r.created,c=Gi(l);await es(r.box,r.path,`${r.content} [${c}]`),await ts(o,s,!0),console.log(`Merge doc ${o}`)}return F.showMessage(N.ConflictDiary.success,2e3,"info"),e(),t}function ms(n,e,t){let i=[];for(let r of n){let o=r.id,l=r.created;l=`${l.slice(0,4)}-${l.slice(4,6)}-${l.slice(6,8)} ${l.slice(8,10)}:${l.slice(10,12)}:${l.slice(12,14)}`;let c=r.updated;c=`${c.slice(0,4)}-${c.slice(4,6)}-${c.slice(6,8)} ${c.slice(8,10)}:${c.slice(10,12)}:${c.slice(12,14)}`;let f=`| ${o} | ${r.content} | ${l} | ${c} | ${e.name} |
`;i.push(f)}let s=N.ConflictDiary.part1.join(`
`)+`
`;for(let r of i)s+=r;return s+=`
`+N.ConflictDiary.part2.join(`
`),s=Yn.Md2HTML(s),`
        <div class="b3-typography typofont-1rem"
            style="margin: 0.5rem;"
        >
            ${s}
            ${t?N.ConflictDiary.part3.join(`
`):""}
        </div>
        <div class="fn__flex b3-label" style="border-top: 1px solid var(--b3-theme-surface-lighter);">
            <div class="fn__flex-1"></div>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="merge">
                ${N.ConflictDiary.AutoMerge}
            </button>
        </div>
        `}function ys(n){let e=n.map(i=>i.path);e=e.map(i=>i.slice(0,i.lastIndexOf("/")));let t=!0;for(let i=1;i<e.length;i++)if(e[i]!==e[0]){t=!1;break}return!t}async function _s(){var l;let n=Q.default,e=n.dailynoteHpath,t=await Ae(e,n);if(t.length<=1)return!1;let i=new Set,s=[];if(t.forEach(c=>{i.has(c.id)||(s.push(c),i.add(c.id))}),t=s,t.length<=1)return!1;const a=ys(t);console.warn(`Conflict daily note: ${n.name} ${e}`);const r=ms(t,n,a);let o=new F.Dialog({title:N.Name,content:r,width:tt?"80%":"50%"});return(l=o.element.querySelector("#merge"))==null||l.addEventListener("click",async()=>{ps(t,()=>{o.destroy(),a&&F.showMessage("祖先",1e4,"info")})}),!0}async function ws(n,e){if(typeof n=="string"&&(n=Q.find(n)),n===null)return null;let t=n==null?void 0:n.dailynoteSprig;if(t===void 0)return null;let s=`toDate "2006-01-02" "${Lt(e,"-")}"`;return t=t.replaceAll(/now/g,s),await Vn(t)}async function bs(n,e){let t=await ws(n,e);if(t===null)return null;let i=await Ae(t,n);return{date:e,hpath:t,docs:i.length===0?null:i}}async function Ts(n,e,t,i){if((n==null?void 0:n.dailynoteSprig)===void 0)return[];t=t===void 0?new Date:t,e.setHours(0,0,0,0);let a=new Date(t);a.setHours(0,0,0,0);let r=[];for(;a>=e;)r.push(a),a=new Date(a),a.setDate(a.getDate()-1);let o=r.map(async c=>{let f=await bs(n,c);return i!=null&&i(f),f}),l=await Promise.all(o);return l=l.filter(c=>c.docs!==null),l}async function Jn(n){let e=n==null?void 0:n.dailynoteSprig;if(e==null||e==="")return null;e.startsWith("/")&&(e=e.substring(1));let t=e.split("/"),i="";for(let m=0;m<t.length;m++){let u=t[m];if(u.match("{{")!==null)break;i+=`/${u}`}de(`${n.name} PathPrefix`,i);let s=`
        select * from blocks where box='${n.id}' and hpath like '${i}%' and type='d'
        order by created asc limit 1;`,a=await $e(s);if(a.length===0)return console.warn(`未找到日记本 ${n.name} 的日记`),null;let o=a[0].created,l=o.substring(0,4),c=o.substring(4,6),f=o.substring(6,8);return new Date(`${l}-${c}-${f}`)}async function vs(n,e){return e=e!==void 0?e:await Jn(n),e===null?[]:await Ts(n,e,new Date,async i=>{i.docs!==null&&i.docs.forEach(async s=>{qn(s.id,i.date)})})}function ks(n,e){return n.length>e?n.slice(0,e)+"...":n}class Ht{constructor(e,t,i){I(this,"resvBlockIds");I(this,"dstDocId");I(this,"position");I(this,"retvBlock");this.position=e,this.resvBlockIds=t,this.dstDocId=i}async checkRetv(){let e=`select * from blocks where path like "%${this.dstDocId}%" and name = "Reservation"`,t=await $e(e);return this.retvBlock=t.length>0?t[0]:void 0,t}async insertRetrieve(e){let t;this.position==="bottom"?t=await zn(this.dstDocId,e,"markdown"):t=await jn(this.dstDocId,e,"markdown");let i=t[0].doOperations[0].id;Ze(i,{name:"Reservation",breadcrumb:"true"})}async updateRetrieve(e){ss(this.retvBlock.id,e,"markdown"),Ze(this.retvBlock.id,{name:"Reservation",breadcrumb:"true"})}async retrieveResvBlocks(){let e=[];for(let t of this.resvBlockIds){let i=await nt(t);console.log(t,"-->",i),i?e.push({id:i.id,content:ks(i.content,50)}):e.push({id:t,content:void 0})}return e}async insert(){let e=await this.createContent();this.insertRetrieve(e)}async update(){let e=await this.createContent();this.updateRetrieve(e)}}class Ds extends Ht{createContent(){return`{{${`select * from blocks where id in (${this.resvBlockIds.map(s=>`"${s}"`).join(",")})`}}}`}}class Es extends Ht{async createContent(){let e=await this.retrieveResvBlocks(),t=[];for(let s of e)s.content?t.push(`* [ ] [${s.content}](siyuan://blocks/${s.id})`):t.push(`* [x] \`${s.id}\` not found`);return t.join(`
`)}}class $s extends Ht{async createContent(){let e=await this.retrieveResvBlocks(),t=[];for(let s of e)s.content?t.push(`* [ ] ((${s.id} "${s.content}"))`):t.push(`* [x] \`${s.id}\` not found`);return t.join(`
`)}}function Ss(n,e,t,i){let s;switch(n){case"embed":s=new Ds(e,t,i);break;case"link":s=new Es(e,t,i);break;case"ref":s=new $s(e,t,i);break;default:throw new Error("unknown type")}return s}async function Ms(n){let e="";n==="today"?e="A.value = strftime('%Y%m%d', datetime('now'))":n==="future"&&(e="A.value >= strftime('%Y%m%d', datetime('now'))");let t=`select B.id, B.content, A.value as date from blocks as B inner join attributes as A
        on(A.block_id = B.id and  A.name = 'custom-reservation' and ${e}) order by A.value;`,i=await $e(t);return console.log(i),i}const Os=()=>!!document.getElementById("sidebar"),As=(n,e,t,i)=>{const s=new F.Dialog({title:n,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:Os()?"92vw":"520px"}),a=s.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{i&&i(),s.destroy()}),a[1].addEventListener("click",()=>{t&&t(),s.destroy()});let r=s.element.querySelector(".b3-dialog__container");r.style.maxHeight="50%"};function Xn(n,e){const t=e.replace(/\((?!\?)/g,"(?:");return`${n}${t}\\s{0,5}(?:,?\\s{0,5}${t}){0,10}`}function Ps(n){let e;return n instanceof Array?e=[...n]:n instanceof Map?e=Array.from(n.keys()):e=Object.keys(n),e}function _e(n){return`(?:${Ps(n).sort((t,i)=>i.length-t.length).join("|").replace(/\./g,"\\.")})`}var Qn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ei(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ti={exports:{}};(function(n,e){(function(t,i){n.exports=i()})(Qn,function(){var t=1e3,i=6e4,s=36e5,a="millisecond",r="second",o="minute",l="hour",c="day",f="week",d="month",m="quarter",u="year",h="date",k="Invalid Date",M=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,b=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,q={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(O){var w=["th","st","nd","rd"],y=O%100;return"["+O+(w[(y-20)%10]||w[y]||w[0])+"]"}},x=function(O,w,y){var D=String(O);return!D||D.length>=w?O:""+Array(w+1-D.length).join(y)+O},A={s:x,z:function(O){var w=-O.utcOffset(),y=Math.abs(w),D=Math.floor(y/60),_=y%60;return(w<=0?"+":"-")+x(D,2,"0")+":"+x(_,2,"0")},m:function O(w,y){if(w.date()<y.date())return-O(y,w);var D=12*(y.year()-w.year())+(y.month()-w.month()),_=w.clone().add(D,d),P=y-_<0,R=w.clone().add(D+(P?-1:1),d);return+(-(D+(y-_)/(P?_-R:R-_))||0)},a:function(O){return O<0?Math.ceil(O)||0:Math.floor(O)},p:function(O){return{M:d,y:u,w:f,d:c,D:h,h:l,m:o,s:r,ms:a,Q:m}[O]||String(O||"").toLowerCase().replace(/s$/,"")},u:function(O){return O===void 0}},C="en",T={};T[C]=q;var S=function(O){return O instanceof we},B=function O(w,y,D){var _;if(!w)return C;if(typeof w=="string"){var P=w.toLowerCase();T[P]&&(_=P),y&&(T[P]=y,_=P);var R=w.split("-");if(!_&&R.length>1)return O(R[0])}else{var U=w.name;T[U]=w,_=U}return!D&&_&&(C=_),_||!D&&C},E=function(O,w){if(S(O))return O.clone();var y=typeof w=="object"?w:{};return y.date=O,y.args=arguments,new we(y)},$=A;$.l=B,$.i=S,$.w=function(O,w){return E(O,{locale:w.$L,utc:w.$u,x:w.$x,$offset:w.$offset})};var we=function(){function O(y){this.$L=B(y.locale,null,!0),this.parse(y)}var w=O.prototype;return w.parse=function(y){this.$d=function(D){var _=D.date,P=D.utc;if(_===null)return new Date(NaN);if($.u(_))return new Date;if(_ instanceof Date)return new Date(_);if(typeof _=="string"&&!/Z$/i.test(_)){var R=_.match(M);if(R){var U=R[2]-1||0,H=(R[7]||"0").substring(0,3);return P?new Date(Date.UTC(R[1],U,R[3]||1,R[4]||0,R[5]||0,R[6]||0,H)):new Date(R[1],U,R[3]||1,R[4]||0,R[5]||0,R[6]||0,H)}}return new Date(_)}(y),this.$x=y.x||{},this.init()},w.init=function(){var y=this.$d;this.$y=y.getFullYear(),this.$M=y.getMonth(),this.$D=y.getDate(),this.$W=y.getDay(),this.$H=y.getHours(),this.$m=y.getMinutes(),this.$s=y.getSeconds(),this.$ms=y.getMilliseconds()},w.$utils=function(){return $},w.isValid=function(){return this.$d.toString()!==k},w.isSame=function(y,D){var _=E(y);return this.startOf(D)<=_&&_<=this.endOf(D)},w.isAfter=function(y,D){return E(y)<this.startOf(D)},w.isBefore=function(y,D){return this.endOf(D)<E(y)},w.$g=function(y,D,_){return $.u(y)?this[D]:this.set(_,y)},w.unix=function(){return Math.floor(this.valueOf()/1e3)},w.valueOf=function(){return this.$d.getTime()},w.startOf=function(y,D){var _=this,P=!!$.u(D)||D,R=$.p(y),U=function(be,j){var ce=$.w(_.$u?Date.UTC(_.$y,j,be):new Date(_.$y,j,be),_);return P?ce:ce.endOf(c)},H=function(be,j){return $.w(_.toDate()[be].apply(_.toDate("s"),(P?[0,0,0,0]:[23,59,59,999]).slice(j)),_)},L=this.$W,J=this.$M,ge=this.$D,pe="set"+(this.$u?"UTC":"");switch(R){case u:return P?U(1,0):U(31,11);case d:return P?U(1,J):U(0,J+1);case f:var ve=this.$locale().weekStart||0,le=(L<ve?L+7:L)-ve;return U(P?ge-le:ge+(6-le),J);case c:case h:return H(pe+"Hours",0);case l:return H(pe+"Minutes",1);case o:return H(pe+"Seconds",2);case r:return H(pe+"Milliseconds",3);default:return this.clone()}},w.endOf=function(y){return this.startOf(y,!1)},w.$set=function(y,D){var _,P=$.p(y),R="set"+(this.$u?"UTC":""),U=(_={},_[c]=R+"Date",_[h]=R+"Date",_[d]=R+"Month",_[u]=R+"FullYear",_[l]=R+"Hours",_[o]=R+"Minutes",_[r]=R+"Seconds",_[a]=R+"Milliseconds",_)[P],H=P===c?this.$D+(D-this.$W):D;if(P===d||P===u){var L=this.clone().set(h,1);L.$d[U](H),L.init(),this.$d=L.set(h,Math.min(this.$D,L.daysInMonth())).$d}else U&&this.$d[U](H);return this.init(),this},w.set=function(y,D){return this.clone().$set(y,D)},w.get=function(y){return this[$.p(y)]()},w.add=function(y,D){var _,P=this;y=Number(y);var R=$.p(D),U=function(J){var ge=E(P);return $.w(ge.date(ge.date()+Math.round(J*y)),P)};if(R===d)return this.set(d,this.$M+y);if(R===u)return this.set(u,this.$y+y);if(R===c)return U(1);if(R===f)return U(7);var H=(_={},_[o]=i,_[l]=s,_[r]=t,_)[R]||1,L=this.$d.getTime()+y*H;return $.w(L,this)},w.subtract=function(y,D){return this.add(-1*y,D)},w.format=function(y){var D=this,_=this.$locale();if(!this.isValid())return _.invalidDate||k;var P=y||"YYYY-MM-DDTHH:mm:ssZ",R=$.z(this),U=this.$H,H=this.$m,L=this.$M,J=_.weekdays,ge=_.months,pe=function(j,ce,Me,at){return j&&(j[ce]||j(D,P))||Me[ce].slice(0,at)},ve=function(j){return $.s(U%12||12,j,"0")},le=_.meridiem||function(j,ce,Me){var at=j<12?"AM":"PM";return Me?at.toLowerCase():at},be={YY:String(this.$y).slice(-2),YYYY:$.s(this.$y,4,"0"),M:L+1,MM:$.s(L+1,2,"0"),MMM:pe(_.monthsShort,L,ge,3),MMMM:pe(ge,L),D:this.$D,DD:$.s(this.$D,2,"0"),d:String(this.$W),dd:pe(_.weekdaysMin,this.$W,J,2),ddd:pe(_.weekdaysShort,this.$W,J,3),dddd:J[this.$W],H:String(U),HH:$.s(U,2,"0"),h:ve(1),hh:ve(2),a:le(U,H,!0),A:le(U,H,!1),m:String(H),mm:$.s(H,2,"0"),s:String(this.$s),ss:$.s(this.$s,2,"0"),SSS:$.s(this.$ms,3,"0"),Z:R};return P.replace(b,function(j,ce){return ce||be[j]||R.replace(":","")})},w.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},w.diff=function(y,D,_){var P,R=$.p(D),U=E(y),H=(U.utcOffset()-this.utcOffset())*i,L=this-U,J=$.m(this,U);return J=(P={},P[u]=J/12,P[d]=J,P[m]=J/3,P[f]=(L-H)/6048e5,P[c]=(L-H)/864e5,P[l]=L/s,P[o]=L/i,P[r]=L/t,P)[R]||L,_?J:$.a(J)},w.daysInMonth=function(){return this.endOf(d).$D},w.$locale=function(){return T[this.$L]},w.locale=function(y,D){if(!y)return this.$L;var _=this.clone(),P=B(y,D,!0);return P&&(_.$L=P),_},w.clone=function(){return $.w(this.$d,this)},w.toDate=function(){return new Date(this.valueOf())},w.toJSON=function(){return this.isValid()?this.toISOString():null},w.toISOString=function(){return this.$d.toISOString()},w.toString=function(){return this.$d.toUTCString()},O}(),Ce=we.prototype;return E.prototype=Ce,[["$ms",a],["$s",r],["$m",o],["$H",l],["$W",c],["$M",d],["$y",u],["$D",h]].forEach(function(O){Ce[O[1]]=function(w){return this.$g(w,O[0],O[1])}}),E.extend=function(O,w){return O.$i||(O(w,we,E),O.$i=!0),E},E.locale=B,E.isDayjs=S,E.unix=function(O){return E(1e3*O)},E.en=T[C],E.Ls=T,E.p={},E})})(ti);var Rs=ti.exports;const ae=ei(Rs);function ni(n){return n<100&&(n>50?n=n+1900:n=n+2e3),n}function yt(n,e,t){const i=ae(n);let s=i;s=s.month(t-1),s=s.date(e),s=s.year(i.year());const a=s.add(1,"y"),r=s.add(-1,"y");return Math.abs(a.diff(i))<Math.abs(s.diff(i))?s=a:Math.abs(r.diff(i))<Math.abs(s.diff(i))&&(s=r),s.year()}const ii={sunday:0,sun:0,"sun.":0,monday:1,mon:1,"mon.":1,tuesday:2,tue:2,"tue.":2,wednesday:3,wed:3,"wed.":3,thursday:4,thurs:4,"thurs.":4,thur:4,"thur.":4,thu:4,"thu.":4,friday:5,fri:5,"fri.":5,saturday:6,sat:6,"sat.":6},si={january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12},Se={...si,jan:1,"jan.":1,feb:2,"feb.":2,mar:3,"mar.":3,apr:4,"apr.":4,jun:6,"jun.":6,jul:7,"jul.":7,aug:8,"aug.":8,sep:9,"sep.":9,sept:9,"sept.":9,oct:10,"oct.":10,nov:11,"nov.":11,dec:12,"dec.":12},xt={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12},Ct={first:1,second:2,third:3,fourth:4,fifth:5,sixth:6,seventh:7,eighth:8,ninth:9,tenth:10,eleventh:11,twelfth:12,thirteenth:13,fourteenth:14,fifteenth:15,sixteenth:16,seventeenth:17,eighteenth:18,nineteenth:19,twentieth:20,"twenty first":21,"twenty-first":21,"twenty second":22,"twenty-second":22,"twenty third":23,"twenty-third":23,"twenty fourth":24,"twenty-fourth":24,"twenty fifth":25,"twenty-fifth":25,"twenty sixth":26,"twenty-sixth":26,"twenty seventh":27,"twenty-seventh":27,"twenty eighth":28,"twenty-eighth":28,"twenty ninth":29,"twenty-ninth":29,thirtieth:30,"thirty first":31,"thirty-first":31},ri={second:"second",seconds:"second",minute:"minute",minutes:"minute",hour:"hour",hours:"hour",day:"d",days:"d",week:"week",weeks:"week",month:"month",months:"month",quarter:"quarter",quarters:"quarter",year:"year",years:"year"},_t={s:"second",sec:"second",second:"second",seconds:"second",m:"minute",min:"minute",mins:"minute",minute:"minute",minutes:"minute",h:"hour",hr:"hour",hrs:"hour",hour:"hour",hours:"hour",d:"d",day:"d",days:"d",w:"w",week:"week",weeks:"week",mo:"month",mon:"month",mos:"month",month:"month",months:"month",qtr:"quarter",quarter:"quarter",quarters:"quarter",y:"year",yr:"year",year:"year",years:"year",...ri},ai=`(?:${_e(xt)}|[0-9]+|[0-9]+\\.[0-9]+|half(?:\\s{0,2}an?)?|an?\\b(?:\\s{0,2}few)?|few|several|the|a?\\s{0,2}couple\\s{0,2}(?:of)?)`;function Ns(n){const e=n.toLowerCase();return xt[e]!==void 0?xt[e]:e==="a"||e==="an"||e=="the"?1:e.match(/few/)?3:e.match(/half/)?.5:e.match(/couple/)?2:e.match(/several/)?7:parseFloat(e)}const ht=`(?:${_e(Ct)}|[0-9]{1,2}(?:st|nd|rd|th)?)`;function gt(n){let e=n.toLowerCase();return Ct[e]!==void 0?Ct[e]:(e=e.replace(/(?:st|nd|rd|th)$/i,""),parseInt(e))}const Ft="(?:[1-9][0-9]{0,3}\\s{0,2}(?:BE|AD|BC|BCE|CE)|[1-2][0-9]{3}|[5-9][0-9])";function Yt(n){if(/BE/i.test(n))return n=n.replace(/BE/i,""),parseInt(n)-543;if(/BCE?/i.test(n))return n=n.replace(/BCE?/i,""),-parseInt(n);if(/(AD|CE)/i.test(n))return n=n.replace(/(AD|CE)/i,""),parseInt(n);const e=parseInt(n);return ni(e)}const oi=`(${ai})\\s{0,3}(${_e(_t)})`,Qt=new RegExp(oi,"i"),xs=`(${ai})\\s{0,3}(${_e(ri)})`,it=Xn("(?:(?:about|around)\\s{0,3})?",oi),wt=Xn("(?:(?:about|around)\\s{0,3})?",xs);function st(n){const e={};let t=n,i=Qt.exec(t);for(;i;)Cs(e,i),t=t.substring(i[0].length).trim(),i=Qt.exec(t);return e}function Cs(n,e){const t=Ns(e[1]),i=_t[e[2].toLowerCase()];n[i]=t}var li={exports:{}};(function(n,e){(function(t,i){n.exports=i()})(Qn,function(){var t="month",i="quarter";return function(s,a){var r=a.prototype;r.quarter=function(c){return this.$utils().u(c)?Math.ceil((this.month()+1)/3):this.month(this.month()%3+3*(c-1))};var o=r.add;r.add=function(c,f){return c=Number(c),this.$utils().p(f)===i?this.add(3*c,t):o.bind(this)(c,f)};var l=r.startOf;r.startOf=function(c,f){var d=this.$utils(),m=!!d.u(f)||f;if(d.p(c)===i){var u=this.quarter()-1;return m?this.month(3*u).startOf(t).startOf("day"):this.month(3*u+2).endOf(t).endOf("day")}return l.bind(this)(c,f)}}})})(li);var Is=li.exports;const Bs=ei(Is);function Us(n,e){e=e.add(1,"day"),je(n,e),bt(n,e)}function xe(n,e){n.assign("day",e.date()),n.assign("month",e.month()+1),n.assign("year",e.year())}function ci(n,e){n.assign("hour",e.hour()),n.assign("minute",e.minute()),n.assign("second",e.second()),n.assign("millisecond",e.millisecond()),n.get("hour")<12?n.assign("meridiem",W.AM):n.assign("meridiem",W.PM)}function je(n,e){n.imply("day",e.date()),n.imply("month",e.month()+1),n.imply("year",e.year())}function bt(n,e){n.imply("hour",e.hour()),n.imply("minute",e.minute()),n.imply("second",e.second()),n.imply("millisecond",e.millisecond())}const Ls={ACDT:630,ACST:570,ADT:-180,AEDT:660,AEST:600,AFT:270,AKDT:-480,AKST:-540,ALMT:360,AMST:-180,AMT:-240,ANAST:720,ANAT:720,AQTT:300,ART:-180,AST:-240,AWDT:540,AWST:480,AZOST:0,AZOT:-60,AZST:300,AZT:240,BNT:480,BOT:-240,BRST:-120,BRT:-180,BST:60,BTT:360,CAST:480,CAT:120,CCT:390,CDT:-300,CEST:120,CET:{timezoneOffsetDuringDst:2*60,timezoneOffsetNonDst:60,dstStart:n=>en(n,me.MARCH,te.SUNDAY,2),dstEnd:n=>en(n,me.OCTOBER,te.SUNDAY,3)},CHADT:825,CHAST:765,CKT:-600,CLST:-180,CLT:-240,COT:-300,CST:-360,CT:{timezoneOffsetDuringDst:-5*60,timezoneOffsetNonDst:-6*60,dstStart:n=>ke(n,me.MARCH,te.SUNDAY,2,2),dstEnd:n=>ke(n,me.NOVEMBER,te.SUNDAY,1,2)},CVT:-60,CXT:420,ChST:600,DAVT:420,EASST:-300,EAST:-360,EAT:180,ECT:-300,EDT:-240,EEST:180,EET:120,EGST:0,EGT:-60,EST:-300,ET:{timezoneOffsetDuringDst:-4*60,timezoneOffsetNonDst:-5*60,dstStart:n=>ke(n,me.MARCH,te.SUNDAY,2,2),dstEnd:n=>ke(n,me.NOVEMBER,te.SUNDAY,1,2)},FJST:780,FJT:720,FKST:-180,FKT:-240,FNT:-120,GALT:-360,GAMT:-540,GET:240,GFT:-180,GILT:720,GMT:0,GST:240,GYT:-240,HAA:-180,HAC:-300,HADT:-540,HAE:-240,HAP:-420,HAR:-360,HAST:-600,HAT:-90,HAY:-480,HKT:480,HLV:-210,HNA:-240,HNC:-360,HNE:-300,HNP:-480,HNR:-420,HNT:-150,HNY:-540,HOVT:420,ICT:420,IDT:180,IOT:360,IRDT:270,IRKST:540,IRKT:540,IRST:210,IST:330,JST:540,KGT:360,KRAST:480,KRAT:480,KST:540,KUYT:240,LHDT:660,LHST:630,LINT:840,MAGST:720,MAGT:720,MART:-510,MAWT:300,MDT:-360,MESZ:120,MEZ:60,MHT:720,MMT:390,MSD:240,MSK:180,MST:-420,MT:{timezoneOffsetDuringDst:-6*60,timezoneOffsetNonDst:-7*60,dstStart:n=>ke(n,me.MARCH,te.SUNDAY,2,2),dstEnd:n=>ke(n,me.NOVEMBER,te.SUNDAY,1,2)},MUT:240,MVT:300,MYT:480,NCT:660,NDT:-90,NFT:690,NOVST:420,NOVT:360,NPT:345,NST:-150,NUT:-660,NZDT:780,NZST:720,OMSST:420,OMST:420,PDT:-420,PET:-300,PETST:720,PETT:720,PGT:600,PHOT:780,PHT:480,PKT:300,PMDT:-120,PMST:-180,PONT:660,PST:-480,PT:{timezoneOffsetDuringDst:-7*60,timezoneOffsetNonDst:-8*60,dstStart:n=>ke(n,me.MARCH,te.SUNDAY,2,2),dstEnd:n=>ke(n,me.NOVEMBER,te.SUNDAY,1,2)},PWT:540,PYST:-180,PYT:-240,RET:240,SAMT:240,SAST:120,SBT:660,SCT:240,SGT:480,SRT:-180,SST:-660,TAHT:-600,TFT:300,TJT:300,TKT:780,TLT:540,TMT:300,TVT:720,ULAT:480,UTC:0,UYST:-120,UYT:-180,UZT:300,VET:-210,VLAST:660,VLAT:660,VUT:660,WAST:120,WAT:60,WEST:60,WESZ:60,WET:0,WEZ:0,WFT:720,WGST:-120,WGT:-180,WIB:420,WIT:540,WITA:480,WST:780,WT:0,YAKST:600,YAKT:600,YAPT:600,YEKST:360,YEKT:360};function ke(n,e,t,i,s=0){let a=0,r=0;for(;r<i;)a++,new Date(n,e-1,a).getDay()===t&&r++;return new Date(n,e-1,a,s)}function en(n,e,t,i=0){const s=t===0?7:t,a=new Date(n,e-1+1,1,12),r=a.getDay()===0?7:a.getDay();let o;return r===s?o=7:r<s?o=7+r-s:o=r-s,a.setDate(a.getDate()-o),new Date(n,e-1,a.getDate(),i)}function ui(n,e,t={}){if(n==null)return null;if(typeof n=="number")return n;const i=t[n]??Ls[n];return i==null?null:typeof i=="number"?i:e==null?null:ae(e).isAfter(i.dstStart(e.getFullYear()))&&!ae(e).isAfter(i.dstEnd(e.getFullYear()))?i.timezoneOffsetDuringDst:i.timezoneOffsetNonDst}ae.extend(Bs);class di{constructor(e){e=e??new Date,e instanceof Date?this.instant=e:(this.instant=e.instant??new Date,this.timezoneOffset=ui(e.timezone,this.instant))}getDateWithAdjustedTimezone(){return new Date(this.instant.getTime()+this.getSystemTimezoneAdjustmentMinute(this.instant)*6e4)}getSystemTimezoneAdjustmentMinute(e,t){(!e||e.getTime()<0)&&(e=new Date);const i=-e.getTimezoneOffset(),s=t??this.timezoneOffset??i;return i-s}}class V{constructor(e,t){if(this.reference=e,this.knownValues={},this.impliedValues={},t)for(const s in t)this.knownValues[s]=t[s];const i=ae(e.instant);this.imply("day",i.date()),this.imply("month",i.month()+1),this.imply("year",i.year()),this.imply("hour",12),this.imply("minute",0),this.imply("second",0),this.imply("millisecond",0)}get(e){return e in this.knownValues?this.knownValues[e]:e in this.impliedValues?this.impliedValues[e]:null}isCertain(e){return e in this.knownValues}getCertainComponents(){return Object.keys(this.knownValues)}imply(e,t){return e in this.knownValues?this:(this.impliedValues[e]=t,this)}assign(e,t){return this.knownValues[e]=t,delete this.impliedValues[e],this}delete(e){delete this.knownValues[e],delete this.impliedValues[e]}clone(){const e=new V(this.reference);e.knownValues={},e.impliedValues={};for(const t in this.knownValues)e.knownValues[t]=this.knownValues[t];for(const t in this.impliedValues)e.impliedValues[t]=this.impliedValues[t];return e}isOnlyDate(){return!this.isCertain("hour")&&!this.isCertain("minute")&&!this.isCertain("second")}isOnlyTime(){return!this.isCertain("weekday")&&!this.isCertain("day")&&!this.isCertain("month")}isOnlyWeekdayComponent(){return this.isCertain("weekday")&&!this.isCertain("day")&&!this.isCertain("month")}isDateWithUnknownYear(){return this.isCertain("month")&&!this.isCertain("year")}isValidDate(){const e=this.dateWithoutTimezoneAdjustment();return!(e.getFullYear()!==this.get("year")||e.getMonth()!==this.get("month")-1||e.getDate()!==this.get("day")||this.get("hour")!=null&&e.getHours()!=this.get("hour")||this.get("minute")!=null&&e.getMinutes()!=this.get("minute"))}toString(){return`[ParsingComponents {knownValues: ${JSON.stringify(this.knownValues)}, impliedValues: ${JSON.stringify(this.impliedValues)}}, reference: ${JSON.stringify(this.reference)}]`}dayjs(){return ae(this.date())}date(){const e=this.dateWithoutTimezoneAdjustment(),t=this.reference.getSystemTimezoneAdjustmentMinute(e,this.get("timezoneOffset"));return new Date(e.getTime()+t*6e4)}dateWithoutTimezoneAdjustment(){const e=new Date(this.get("year"),this.get("month")-1,this.get("day"),this.get("hour"),this.get("minute"),this.get("second"),this.get("millisecond"));return e.setFullYear(this.get("year")),e}static createRelativeFromReference(e,t){let i=ae(e.instant);for(const a in t)i=i.add(t[a],a);const s=new V(e);return t.hour||t.minute||t.second?(ci(s,i),xe(s,i),e.timezoneOffset!==null&&s.assign("timezoneOffset",-e.instant.getTimezoneOffset())):(bt(s,i),e.timezoneOffset!==null&&s.imply("timezoneOffset",-e.instant.getTimezoneOffset()),t.d?(s.assign("day",i.date()),s.assign("month",i.month()+1),s.assign("year",i.year())):(t.week&&s.imply("weekday",i.day()),s.imply("day",i.date()),t.month?(s.assign("month",i.month()+1),s.assign("year",i.year())):(s.imply("month",i.month()+1),t.year?s.assign("year",i.year()):s.imply("year",i.year())))),s}}class rt{constructor(e,t,i,s,a){this.reference=e,this.refDate=e.instant,this.index=t,this.text=i,this.start=s||new V(e),this.end=a}clone(){const e=new rt(this.reference,this.index,this.text);return e.start=this.start?this.start.clone():null,e.end=this.end?this.end.clone():null,e}date(){return this.start.date()}toString(){return`[ParsingResult {index: ${this.index}, text: '${this.text}', ...}]`}}class ue{constructor(){this.cachedInnerPattern=null,this.cachedPattern=null}patternLeftBoundary(){return"(\\W|^)"}pattern(e){const t=this.innerPattern(e);return t==this.cachedInnerPattern?this.cachedPattern:(this.cachedPattern=new RegExp(`${this.patternLeftBoundary()}${t.source}`,t.flags),this.cachedInnerPattern=t,this.cachedPattern)}extract(e,t){const i=t[1]??"";t.index=t.index+i.length,t[0]=t[0].substring(i.length);for(let s=2;s<t.length;s++)t[s-1]=t[s];return this.innerExtract(e,t)}}const Hs=new RegExp(`(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${it})(?=\\W|$)`,"i"),Fs=new RegExp(`(?:within|in|for)\\s*(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${it})(?=\\W|$)`,"i"),Ys=new RegExp(`(?:within|in|for)\\s*(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${wt})(?=\\W|$)`,"i");class Ws extends ue{constructor(e){super(),this.strictMode=e}innerPattern(e){return this.strictMode?Ys:e.option.forwardDate?Hs:Fs}innerExtract(e,t){const i=st(t[1]);return V.createRelativeFromReference(e.reference,i)}}const Gs=new RegExp(`(?:on\\s{0,3})?(${ht})(?:\\s{0,3}(?:to|\\-|\\–|until|through|till)?\\s{0,3}(${ht}))?(?:-|/|\\s{0,3}(?:of)?\\s{0,3})(${_e(Se)})(?:(?:-|/|,?\\s{0,3})(${Ft}(?![^\\s]\\d)))?(?=\\W|$)`,"i"),tn=1,nn=2,js=3,sn=4;class zs extends ue{innerPattern(){return Gs}innerExtract(e,t){const i=e.createParsingResult(t.index,t[0]),s=Se[t[js].toLowerCase()],a=gt(t[tn]);if(a>31)return t.index=t.index+t[tn].length,null;if(i.start.assign("month",s),i.start.assign("day",a),t[sn]){const r=Yt(t[sn]);i.start.assign("year",r)}else{const r=yt(e.refDate,a,s);i.start.imply("year",r)}if(t[nn]){const r=gt(t[nn]);i.end=i.start.clone(),i.end.assign("day",r)}return i}}const Vs=new RegExp(`(${_e(Se)})(?:-|/|\\s*,?\\s*)(${ht})(?!\\s*(?:am|pm))\\s*(?:(?:to|\\-)\\s*(${ht})\\s*)?(?:(?:-|/|\\s*,?\\s*)(${Ft}))?(?=\\W|$)(?!\\:\\d)`,"i"),qs=1,Ks=2,rn=3,an=4;class Zs extends ue{innerPattern(){return Vs}innerExtract(e,t){const i=Se[t[qs].toLowerCase()],s=gt(t[Ks]);if(s>31)return null;const a=e.createParsingComponents({day:s,month:i});if(t[an]){const l=Yt(t[an]);a.assign("year",l)}else{const l=yt(e.refDate,s,i);a.imply("year",l)}if(!t[rn])return a;const r=gt(t[rn]),o=e.createParsingResult(t.index,t[0]);return o.start=a,o.end=a.clone(),o.end.assign("day",r),o}}const Js=new RegExp(`((?:in)\\s*)?(${_e(Se)})\\s*(?:[,-]?\\s*(${Ft})?)?(?=[^\\s\\w]|\\s+[^0-9]|\\s+$|$)`,"i"),Xs=1,Qs=2,on=3;class er extends ue{innerPattern(){return Js}innerExtract(e,t){const i=t[Qs].toLowerCase();if(t[0].length<=3&&!si[i])return null;const s=e.createParsingResult(t.index+(t[Xs]||"").length,t.index+t[0].length);s.start.imply("day",1);const a=Se[i];if(s.start.assign("month",a),t[on]){const r=Yt(t[on]);s.start.assign("year",r)}else{const r=yt(e.refDate,1,a);s.start.imply("year",r)}return s}}const tr=new RegExp(`([0-9]{4})[\\.\\/\\s](?:(${_e(Se)})|([0-9]{1,2}))[\\.\\/\\s]([0-9]{1,2})(?=\\W|$)`,"i"),nr=1,ir=2,ln=3,sr=4;class rr extends ue{innerPattern(){return tr}innerExtract(e,t){const i=t[ln]?parseInt(t[ln]):Se[t[ir].toLowerCase()];if(i<1||i>12)return null;const s=parseInt(t[nr]);return{day:parseInt(t[sr]),month:i,year:s}}}const ar=new RegExp("([0-9]|0[1-9]|1[012])/([0-9]{4})","i"),or=1,lr=2;class cr extends ue{innerPattern(){return ar}innerExtract(e,t){const i=parseInt(t[lr]),s=parseInt(t[or]);return e.createParsingComponents().imply("day",1).assign("month",s).assign("year",i)}}function ur(n,e,t,i){return new RegExp(`${n}${e}(\\d{1,4})(?:(?:\\.|:|：)(\\d{1,2})(?:(?::|：)(\\d{2})(?:\\.(\\d{1,6}))?)?)?(?:\\s*(a\\.m\\.|p\\.m\\.|am?|pm?))?${t}`,i)}function dr(n,e){return new RegExp(`^(${n})(\\d{1,4})(?:(?:\\.|\\:|\\：)(\\d{1,2})(?:(?:\\.|\\:|\\：)(\\d{1,2})(?:\\.(\\d{1,6}))?)?)?(?:\\s*(a\\.m\\.|p\\.m\\.|am?|pm?))?${e}`,"i")}const cn=2,Be=3,ot=4,lt=5,Ye=6;class fr{constructor(e=!1){this.cachedPrimaryPrefix=null,this.cachedPrimarySuffix=null,this.cachedPrimaryTimePattern=null,this.cachedFollowingPhase=null,this.cachedFollowingSuffix=null,this.cachedFollowingTimePatten=null,this.strictMode=e}patternFlags(){return"i"}primaryPatternLeftBoundary(){return"(^|\\s|T|\\b)"}primarySuffix(){return"(?=\\W|$)"}followingSuffix(){return"(?=\\W|$)"}pattern(e){return this.getPrimaryTimePatternThroughCache()}extract(e,t){const i=this.extractPrimaryTimeComponents(e,t);if(!i)return t.index+=t[0].length,null;const s=t.index+t[1].length,a=t[0].substring(t[1].length),r=e.createParsingResult(s,a,i);t.index+=t[0].length;const o=e.text.substring(t.index),c=this.getFollowingTimePatternThroughCache().exec(o);return a.match(/^\d{3,4}/)&&c&&c[0].match(/^\s*([+-])\s*\d{2,4}$/)?null:!c||c[0].match(/^\s*([+-])\s*\d{3,4}$/)?this.checkAndReturnWithoutFollowingPattern(r):(r.end=this.extractFollowingTimeComponents(e,c,r),r.end&&(r.text+=c[0]),this.checkAndReturnWithFollowingPattern(r))}extractPrimaryTimeComponents(e,t,i=!1){const s=e.createParsingComponents();let a=0,r=null,o=parseInt(t[cn]);if(o>100){if(this.strictMode||t[Be]!=null)return null;a=o%100,o=Math.floor(o/100)}if(o>24)return null;if(t[Be]!=null){if(t[Be].length==1&&!t[Ye])return null;a=parseInt(t[Be])}if(a>=60)return null;if(o>12&&(r=W.PM),t[Ye]!=null){if(o>12)return null;const l=t[Ye][0].toLowerCase();l=="a"&&(r=W.AM,o==12&&(o=0)),l=="p"&&(r=W.PM,o!=12&&(o+=12))}if(s.assign("hour",o),s.assign("minute",a),r!==null?s.assign("meridiem",r):o<12?s.imply("meridiem",W.AM):s.imply("meridiem",W.PM),t[lt]!=null){const l=parseInt(t[lt].substring(0,3));if(l>=1e3)return null;s.assign("millisecond",l)}if(t[ot]!=null){const l=parseInt(t[ot]);if(l>=60)return null;s.assign("second",l)}return s}extractFollowingTimeComponents(e,t,i){const s=e.createParsingComponents();if(t[lt]!=null){const l=parseInt(t[lt].substring(0,3));if(l>=1e3)return null;s.assign("millisecond",l)}if(t[ot]!=null){const l=parseInt(t[ot]);if(l>=60)return null;s.assign("second",l)}let a=parseInt(t[cn]),r=0,o=-1;if(t[Be]!=null?r=parseInt(t[Be]):a>100&&(r=a%100,a=Math.floor(a/100)),r>=60||a>24)return null;if(a>=12&&(o=W.PM),t[Ye]!=null){if(a>12)return null;const l=t[Ye][0].toLowerCase();l=="a"&&(o=W.AM,a==12&&(a=0,s.isCertain("day")||s.imply("day",s.get("day")+1))),l=="p"&&(o=W.PM,a!=12&&(a+=12)),i.start.isCertain("meridiem")||(o==W.AM?(i.start.imply("meridiem",W.AM),i.start.get("hour")==12&&i.start.assign("hour",0)):(i.start.imply("meridiem",W.PM),i.start.get("hour")!=12&&i.start.assign("hour",i.start.get("hour")+12)))}return s.assign("hour",a),s.assign("minute",r),o>=0?s.assign("meridiem",o):i.start.isCertain("meridiem")&&i.start.get("hour")>12?i.start.get("hour")-12>a?s.imply("meridiem",W.AM):a<=12&&(s.assign("hour",a+12),s.assign("meridiem",W.PM)):a>12?s.imply("meridiem",W.PM):a<=12&&s.imply("meridiem",W.AM),s.date().getTime()<i.start.date().getTime()&&s.imply("day",s.get("day")+1),s}checkAndReturnWithoutFollowingPattern(e){if(e.text.match(/^\d$/)||e.text.match(/^\d\d\d+$/)||e.text.match(/\d[apAP]$/))return null;const t=e.text.match(/[^\d:.](\d[\d.]+)$/);if(t){const i=t[1];if(this.strictMode||i.includes(".")&&!i.match(/\d(\.\d{2})+$/)||parseInt(i)>24)return null}return e}checkAndReturnWithFollowingPattern(e){if(e.text.match(/^\d+-\d+$/))return null;const t=e.text.match(/[^\d:.](\d[\d.]+)\s*-\s*(\d[\d.]+)$/);if(t){if(this.strictMode)return null;const i=t[1],s=t[2];if(s.includes(".")&&!s.match(/\d(\.\d{2})+$/))return null;const a=parseInt(s),r=parseInt(i);if(a>24||r>24)return null}return e}getPrimaryTimePatternThroughCache(){const e=this.primaryPrefix(),t=this.primarySuffix();return this.cachedPrimaryPrefix===e&&this.cachedPrimarySuffix===t?this.cachedPrimaryTimePattern:(this.cachedPrimaryTimePattern=ur(this.primaryPatternLeftBoundary(),e,t,this.patternFlags()),this.cachedPrimaryPrefix=e,this.cachedPrimarySuffix=t,this.cachedPrimaryTimePattern)}getFollowingTimePatternThroughCache(){const e=this.followingPhase(),t=this.followingSuffix();return this.cachedFollowingPhase===e&&this.cachedFollowingSuffix===t?this.cachedFollowingTimePatten:(this.cachedFollowingTimePatten=dr(e,t),this.cachedFollowingPhase=e,this.cachedFollowingSuffix=t,this.cachedFollowingTimePatten)}}class hr extends fr{constructor(e){super(e)}followingPhase(){return"\\s*(?:\\-|\\–|\\~|\\〜|to|until|through|till|\\?)\\s*"}primaryPrefix(){return"(?:(?:at|from)\\s*)??"}primarySuffix(){return"(?:\\s*(?:o\\W*clock|at\\s*night|in\\s*the\\s*(?:morning|afternoon)))?(?!/)(?=\\W|$)"}extractPrimaryTimeComponents(e,t){const i=super.extractPrimaryTimeComponents(e,t);if(i){if(t[0].endsWith("night")){const s=i.get("hour");s>=6&&s<12?(i.assign("hour",i.get("hour")+12),i.assign("meridiem",W.PM)):s<6&&i.assign("meridiem",W.AM)}if(t[0].endsWith("afternoon")){i.assign("meridiem",W.PM);const s=i.get("hour");s>=0&&s<=6&&i.assign("hour",i.get("hour")+12)}t[0].endsWith("morning")&&(i.assign("meridiem",W.AM),i.get("hour")<12&&i.assign("hour",i.get("hour")))}return i}}function Wt(n){const e={};for(const t in n)e[t]=-n[t];return e}function gr(n,e){const t=n.clone();let i=n.dayjs();for(const s in e)i=i.add(e[s],s);return("day"in e||"d"in e||"week"in e||"month"in e||"year"in e)&&(t.imply("day",i.date()),t.imply("month",i.month()+1),t.imply("year",i.year())),("second"in e||"minute"in e||"hour"in e)&&(t.imply("second",i.second()),t.imply("minute",i.minute()),t.imply("hour",i.hour())),t}const pr=new RegExp(`(${it})\\s{0,5}(?:ago|before|earlier)(?=\\W|$)`,"i"),mr=new RegExp(`(${wt})\\s{0,5}(?:ago|before|earlier)(?=\\W|$)`,"i");class yr extends ue{constructor(e){super(),this.strictMode=e}innerPattern(){return this.strictMode?mr:pr}innerExtract(e,t){const i=st(t[1]),s=Wt(i);return V.createRelativeFromReference(e.reference,s)}}const _r=new RegExp(`(${it})\\s{0,5}(?:later|after|from now|henceforth|forward|out)(?=(?:\\W|$))`,"i"),wr=new RegExp("("+wt+")(later|from now)(?=(?:\\W|$))","i"),br=1;class Tr extends ue{constructor(e){super(),this.strictMode=e}innerPattern(){return this.strictMode?wr:_r}innerExtract(e,t){const i=st(t[br]);return V.createRelativeFromReference(e.reference,i)}}class vr{refine(e,t){return t.filter(i=>this.isValid(e,i))}}class Tt{refine(e,t){if(t.length<2)return t;const i=[];let s=t[0],a=null;for(let r=1;r<t.length;r++){a=t[r];const o=e.text.substring(s.index+s.text.length,a.index);if(!this.shouldMergeResults(o,s,a,e))i.push(s),s=a;else{const l=s,c=a,f=this.mergeResults(o,l,c,e);e.debug(()=>{console.log(`${this.constructor.name} merged ${l} and ${c} into ${f}`)}),s=f}}return s!=null&&i.push(s),i}}class kr extends Tt{shouldMergeResults(e,t,i){return!t.end&&!i.end&&e.match(this.patternBetween())!=null}mergeResults(e,t,i){if(!t.start.isOnlyWeekdayComponent()&&!i.start.isOnlyWeekdayComponent()&&(i.start.getCertainComponents().forEach(a=>{t.start.isCertain(a)||t.start.imply(a,i.start.get(a))}),t.start.getCertainComponents().forEach(a=>{i.start.isCertain(a)||i.start.imply(a,t.start.get(a))})),t.start.date().getTime()>i.start.date().getTime()){let a=t.start.dayjs(),r=i.start.dayjs();i.start.isOnlyWeekdayComponent()&&r.add(7,"days").isAfter(a)?(r=r.add(7,"days"),i.start.imply("day",r.date()),i.start.imply("month",r.month()+1),i.start.imply("year",r.year())):t.start.isOnlyWeekdayComponent()&&a.add(-7,"days").isBefore(r)?(a=a.add(-7,"days"),t.start.imply("day",a.date()),t.start.imply("month",a.month()+1),t.start.imply("year",a.year())):i.start.isDateWithUnknownYear()&&r.add(1,"years").isAfter(a)?(r=r.add(1,"years"),i.start.imply("year",r.year())):t.start.isDateWithUnknownYear()&&a.add(-1,"years").isBefore(r)?(a=a.add(-1,"years"),t.start.imply("year",a.year())):[i,t]=[t,i]}const s=t.clone();return s.start=t.start,s.end=i.start,s.index=Math.min(t.index,i.index),t.index<i.index?s.text=t.text+e+i.text:s.text=i.text+e+t.text,s}}class Dr extends kr{patternBetween(){return/^\s*(to|-|–|until|through|till)\s*$/i}}function un(n,e){const t=n.clone(),i=n.start,s=e.start;if(t.start=dn(i,s),n.end!=null||e.end!=null){const a=n.end==null?n.start:n.end,r=e.end==null?e.start:e.end,o=dn(a,r);if(n.end==null&&o.date().getTime()<t.start.date().getTime()){const l=o.dayjs().add(1,"day");o.isCertain("day")?xe(o,l):je(o,l)}t.end=o}return t}function dn(n,e){const t=n.clone();return e.isCertain("hour")?(t.assign("hour",e.get("hour")),t.assign("minute",e.get("minute")),e.isCertain("second")?(t.assign("second",e.get("second")),e.isCertain("millisecond")?t.assign("millisecond",e.get("millisecond")):t.imply("millisecond",e.get("millisecond"))):(t.imply("second",e.get("second")),t.imply("millisecond",e.get("millisecond")))):(t.imply("hour",e.get("hour")),t.imply("minute",e.get("minute")),t.imply("second",e.get("second")),t.imply("millisecond",e.get("millisecond"))),e.isCertain("timezoneOffset")&&t.assign("timezoneOffset",e.get("timezoneOffset")),e.isCertain("meridiem")?t.assign("meridiem",e.get("meridiem")):e.get("meridiem")!=null&&t.get("meridiem")==null&&t.imply("meridiem",e.get("meridiem")),t.get("meridiem")==W.PM&&t.get("hour")<12&&(e.isCertain("hour")?t.assign("hour",t.get("hour")+12):t.imply("hour",t.get("hour")+12)),t}class Er extends Tt{shouldMergeResults(e,t,i){return(t.start.isOnlyDate()&&i.start.isOnlyTime()||i.start.isOnlyDate()&&t.start.isOnlyTime())&&e.match(this.patternBetween())!=null}mergeResults(e,t,i){const s=t.start.isOnlyDate()?un(t,i):un(i,t);return s.index=t.index,s.text=t.text+e+i.text,s}}class $r extends Er{patternBetween(){return new RegExp("^\\s*(T|at|after|before|on|of|,|-)?\\s*$")}}const Sr=new RegExp("^\\s*,?\\s*\\(?([A-Z]{2,4})\\)?(?=\\W|$)","i");class Mr{constructor(e){this.timezoneOverrides=e}refine(e,t){const i=e.option.timezones??{};return t.forEach(s=>{const a=e.text.substring(s.index+s.text.length),r=Sr.exec(a);if(!r)return;const o=r[1].toUpperCase(),l=s.start.date()??s.refDate??new Date,c={...this.timezoneOverrides,...i},f=ui(o,l,c);if(f==null)return;e.debug(()=>{console.log(`Extracting timezone: '${o}' into: ${f} for: ${s.start}`)});const d=s.start.get("timezoneOffset");d!==null&&f!=d&&(s.start.isCertain("timezoneOffset")||o!=r[1])||s.start.isOnlyDate()&&o!=r[1]||(s.text+=r[0],s.start.isCertain("timezoneOffset")||s.start.assign("timezoneOffset",f),s.end!=null&&!s.end.isCertain("timezoneOffset")&&s.end.assign("timezoneOffset",f))}),t}}const Or=new RegExp("^\\s*(?:\\(?(?:GMT|UTC)\\s?)?([+-])(\\d{1,2})(?::?(\\d{2}))?\\)?","i"),Ar=1,Pr=2,Rr=3;class Nr{refine(e,t){return t.forEach(function(i){if(i.start.isCertain("timezoneOffset"))return;const s=e.text.substring(i.index+i.text.length),a=Or.exec(s);if(!a)return;e.debug(()=>{console.log(`Extracting timezone: '${a[0]}' into : ${i}`)});const r=parseInt(a[Pr]),o=parseInt(a[Rr]||"0");let l=r*60+o;l>14*60||(a[Ar]==="-"&&(l=-l),i.end!=null&&i.end.assign("timezoneOffset",l),i.start.assign("timezoneOffset",l),i.text+=a[0])}),t}}class fn{refine(e,t){if(t.length<2)return t;const i=[];let s=t[0];for(let a=1;a<t.length;a++){const r=t[a];r.index<s.index+s.text.length?r.text.length>s.text.length&&(s=r):(i.push(s),s=r)}return s!=null&&i.push(s),i}}class xr{refine(e,t){return e.option.forwardDate&&t.forEach(function(i){let s=ae(e.refDate);if(i.start.isOnlyTime()&&s.isAfter(i.start.dayjs())&&(s=s.add(1,"day"),je(i.start,s),i.end&&i.end.isOnlyTime()&&(je(i.end,s),i.start.dayjs().isAfter(i.end.dayjs())&&(s=s.add(1,"day"),je(i.end,s)))),i.start.isOnlyWeekdayComponent()&&s.isAfter(i.start.dayjs())&&(s.day()>=i.start.get("weekday")?s=s.day(i.start.get("weekday")+7):s=s.day(i.start.get("weekday")),i.start.imply("day",s.date()),i.start.imply("month",s.month()+1),i.start.imply("year",s.year()),e.debug(()=>{console.log(`Forward weekly adjusted for ${i} (${i.start})`)}),i.end&&i.end.isOnlyWeekdayComponent()&&(s.day()>i.end.get("weekday")?s=s.day(i.end.get("weekday")+7):s=s.day(i.end.get("weekday")),i.end.imply("day",s.date()),i.end.imply("month",s.month()+1),i.end.imply("year",s.year()),e.debug(()=>{console.log(`Forward weekly adjusted for ${i} (${i.end})`)}))),i.start.isDateWithUnknownYear()&&s.isAfter(i.start.dayjs()))for(let a=0;a<3&&s.isAfter(i.start.dayjs());a++)i.start.imply("year",i.start.get("year")+1),e.debug(()=>{console.log(`Forward yearly adjusted for ${i} (${i.start})`)}),i.end&&!i.end.isCertain("year")&&(i.end.imply("year",i.end.get("year")+1),e.debug(()=>{console.log(`Forward yearly adjusted for ${i} (${i.end})`)}))}),t}}class Cr extends vr{constructor(e){super(),this.strictMode=e}isValid(e,t){return t.text.replace(" ","").match(/^\d*(\.\d*)?$/)?(e.debug(()=>{console.log(`Removing unlikely result '${t.text}'`)}),!1):t.start.isValidDate()?t.end&&!t.end.isValidDate()?(e.debug(()=>{console.log(`Removing invalid result: ${t} (${t.end})`)}),!1):this.strictMode?this.isStrictModeValid(e,t):!0:(e.debug(()=>{console.log(`Removing invalid result: ${t} (${t.start})`)}),!1)}isStrictModeValid(e,t){return t.start.isOnlyWeekdayComponent()?(e.debug(()=>{console.log(`(Strict) Removing weekday only component: ${t} (${t.end})`)}),!1):t.start.isOnlyTime()&&(!t.start.isCertain("hour")||!t.start.isCertain("minute"))?(e.debug(()=>{console.log(`(Strict) Removing uncertain time component: ${t} (${t.end})`)}),!1):!0}}const Ir=new RegExp("([0-9]{4})\\-([0-9]{1,2})\\-([0-9]{1,2})(?:T([0-9]{1,2}):([0-9]{1,2})(?::([0-9]{1,2})(?:\\.(\\d{1,4}))?)?(?:Z|([+-]\\d{2}):?(\\d{2})?)?)?(?=\\W|$)","i"),Br=1,Ur=2,Lr=3,hn=4,Hr=5,gn=6,pn=7,mn=8,yn=9;class Fr extends ue{innerPattern(){return Ir}innerExtract(e,t){const i={};if(i.year=parseInt(t[Br]),i.month=parseInt(t[Ur]),i.day=parseInt(t[Lr]),t[hn]!=null)if(i.hour=parseInt(t[hn]),i.minute=parseInt(t[Hr]),t[gn]!=null&&(i.second=parseInt(t[gn])),t[pn]!=null&&(i.millisecond=parseInt(t[pn])),t[mn]==null)i.timezoneOffset=0;else{const s=parseInt(t[mn]);let a=0;t[yn]!=null&&(a=parseInt(t[yn]));let r=s*60;r<0?r-=a:r+=a,i.timezoneOffset=r}return i}}class Yr extends Tt{mergeResults(e,t,i){const s=i.clone();return s.index=t.index,s.text=t.text+e+s.text,s.start.assign("weekday",t.start.get("weekday")),s.end&&s.end.assign("weekday",t.start.get("weekday")),s}shouldMergeResults(e,t,i){return t.start.isOnlyWeekdayComponent()&&!t.start.isCertain("hour")&&i.start.isCertain("day")&&e.match(/^,?\s*$/)!=null}}function Wr(n,e=!1){return n.parsers.unshift(new Fr),n.refiners.unshift(new Yr),n.refiners.unshift(new Nr),n.refiners.unshift(new fn),n.refiners.push(new Mr),n.refiners.push(new fn),n.refiners.push(new xr),n.refiners.push(new Cr(e)),n}function Gr(n){const e=ae(n.instant),t=new V(n,{});return xe(t,e),ci(t,e),n.timezoneOffset!==null&&t.assign("timezoneOffset",e.utcOffset()),t}function jr(n){const e=ae(n.instant),t=new V(n,{});return xe(t,e),bt(t,e),t}function zr(n){return Vr(n,1)}function Vr(n,e){return fi(n,-e)}function qr(n){return fi(n,1)}function fi(n,e){let t=ae(n.instant);const i=new V(n,{});return t=t.add(e,"day"),xe(i,t),bt(i,t),i}function Kr(n,e=22){const t=ae(n.instant),i=new V(n,{});return i.imply("hour",e),i.imply("meridiem",W.PM),xe(i,t),i}function Zr(n,e=20){const t=new V(n,{});return t.imply("meridiem",W.PM),t.imply("hour",e),t}function Jr(n){const e=new V(n,{}),t=ae(n.instant);return t.hour()>2&&Us(e,t),e.assign("hour",0),e.imply("minute",0),e.imply("second",0),e.imply("millisecond",0),e}function Xr(n,e=6){const t=new V(n,{});return t.imply("meridiem",W.AM),t.imply("hour",e),t.imply("minute",0),t.imply("second",0),t.imply("millisecond",0),t}function Qr(n,e=15){const t=new V(n,{});return t.imply("meridiem",W.PM),t.imply("hour",e),t.imply("minute",0),t.imply("second",0),t.imply("millisecond",0),t}function ea(n){const e=new V(n,{});return e.imply("meridiem",W.AM),e.imply("hour",12),e.imply("minute",0),e.imply("second",0),e.imply("millisecond",0),e}const ta=/(now|today|tonight|tomorrow|tmr|tmrw|yesterday|last\s*night)(?=\W|$)/i;class na extends ue{innerPattern(e){return ta}innerExtract(e,t){let i=ae(e.refDate);const s=t[0].toLowerCase(),a=e.createParsingComponents();switch(s){case"now":return Gr(e.reference);case"today":return jr(e.reference);case"yesterday":return zr(e.reference);case"tomorrow":case"tmr":case"tmrw":return qr(e.reference);case"tonight":return Kr(e.reference);default:s.match(/last\s*night/)&&(i.hour()>6&&(i=i.add(-1,"day")),xe(a,i),a.imply("hour",0));break}return a}}const ia=/(?:this)?\s{0,3}(morning|afternoon|evening|night|midnight|midday|noon)(?=\W|$)/i;class sa extends ue{innerPattern(){return ia}innerExtract(e,t){switch(t[1].toLowerCase()){case"afternoon":return Qr(e.reference);case"evening":case"night":return Zr(e.reference);case"midnight":return Jr(e.reference);case"morning":return Xr(e.reference);case"noon":case"midday":return ea(e.reference)}return null}}function ra(n,e,t){const i=n.getDateWithAdjustedTimezone(),s=aa(i,e,t);let a=new V(n);return a=gr(a,{day:s}),a.assign("weekday",e),a}function aa(n,e,t){const i=n.getDay();switch(t){case"this":return dt(n,e);case"last":return hi(n,e);case"next":return i==te.SUNDAY?e==te.SUNDAY?7:e:i==te.SATURDAY?e==te.SATURDAY?7:e==te.SUNDAY?8:1+e:e<i&&e!=te.SUNDAY?dt(n,e):dt(n,e)+7}return oa(n,e)}function oa(n,e){const t=hi(n,e),i=dt(n,e);return i<-t?i:t}function dt(n,e){const t=n.getDay();let i=e-t;return i<0&&(i+=7),i}function hi(n,e){const t=n.getDay();let i=e-t;return i>=0&&(i-=7),i}const la=new RegExp(`(?:(?:\\,|\\(|\\（)\\s*)?(?:on\\s*?)?(?:(this|last|past|next)\\s*)?(${_e(ii)})(?:\\s*(?:\\,|\\)|\\）))?(?:\\s*(this|last|past|next)\\s*week)?(?=\\W|$)`,"i"),ca=1,ua=2,da=3;class fa extends ue{innerPattern(){return la}innerExtract(e,t){const i=t[ua].toLowerCase(),s=ii[i],a=t[ca],r=t[da];let o=a||r;o=o||"",o=o.toLowerCase();let l=null;return o=="last"||o=="past"?l="last":o=="next"?l="next":o=="this"&&(l="this"),ra(e.reference,s,l)}}const ha=new RegExp(`(this|last|past|next|after\\s*this)\\s*(${_e(_t)})(?=\\s*)(?=\\W|$)`,"i"),ga=1,pa=2;class ma extends ue{innerPattern(){return ha}innerExtract(e,t){const i=t[ga].toLowerCase(),s=t[pa].toLowerCase(),a=_t[s];if(i=="next"||i.startsWith("after")){const l={};return l[a]=1,V.createRelativeFromReference(e.reference,l)}if(i=="last"||i=="past"){const l={};return l[a]=-1,V.createRelativeFromReference(e.reference,l)}const r=e.createParsingComponents();let o=ae(e.reference.instant);return s.match(/week/i)?(o=o.add(-o.get("d"),"d"),r.imply("day",o.date()),r.imply("month",o.month()+1),r.imply("year",o.year())):s.match(/month/i)?(o=o.add(-o.date()+1,"d"),r.imply("day",o.date()),r.assign("year",o.year()),r.assign("month",o.month()+1)):s.match(/year/i)&&(o=o.add(-o.date()+1,"d"),o=o.add(-o.month(),"month"),r.imply("day",o.date()),r.imply("month",o.month()+1),r.assign("year",o.year())),r}}class Fe{constructor(e){e=e||gi(),this.parsers=[...e.parsers],this.refiners=[...e.refiners]}clone(){return new Fe({parsers:[...this.parsers],refiners:[...this.refiners]})}parseDate(e,t,i){const s=this.parse(e,t,i);return s.length>0?s[0].start.date():null}parse(e,t,i){const s=new ya(e,t,i);let a=[];return this.parsers.forEach(r=>{const o=Fe.executeParser(s,r);a=a.concat(o)}),a.sort((r,o)=>r.index-o.index),this.refiners.forEach(function(r){a=r.refine(s,a)}),a}static executeParser(e,t){const i=[],s=t.pattern(e),a=e.text;let r=e.text,o=s.exec(r);for(;o;){const l=o.index+a.length-r.length;o.index=l;const c=t.extract(e,o);if(!c){r=a.substring(o.index+1),o=s.exec(r);continue}let f=null;c instanceof rt?f=c:c instanceof V?(f=e.createParsingResult(o.index,o[0]),f.start=c):f=e.createParsingResult(o.index,o[0],c),e.debug(()=>console.log(`${t.constructor.name} extracted result ${f}`)),i.push(f),r=a.substring(l+f.text.length),o=s.exec(r)}return i}}class ya{constructor(e,t,i){this.text=e,this.reference=new di(t),this.option=i??{},this.refDate=this.reference.instant}createParsingComponents(e){return e instanceof V?e:new V(this.reference,e)}createParsingResult(e,t,i,s){const a=typeof t=="string"?t:this.text.substring(e,t),r=i?this.createParsingComponents(i):null,o=s?this.createParsingComponents(s):null;return new rt(this.reference,e,a,r,o)}debug(e){this.option.debug&&(this.option.debug instanceof Function?this.option.debug(e):this.option.debug.debug(e))}}const _a=new RegExp("([^\\d]|^)([0-3]{0,1}[0-9]{1})[\\/\\.\\-]([0-3]{0,1}[0-9]{1})(?:[\\/\\.\\-]([0-9]{4}|[0-9]{2}))?(\\W|$)","i"),ct=1,wa=5,_n=2,wn=3,Et=4;class ba{constructor(e){this.groupNumberMonth=e?wn:_n,this.groupNumberDay=e?_n:wn}pattern(){return _a}extract(e,t){if(t[ct].length==0&&t.index>0&&t.index<e.text.length){const l=e.text[t.index-1];if(l>="0"&&l<="9")return}const i=t.index+t[ct].length,s=t[0].substr(t[ct].length,t[0].length-t[ct].length-t[wa].length);if(s.match(/^\d\.\d$/)||s.match(/^\d\.\d{1,2}\.\d{1,2}\s*$/)||!t[Et]&&t[0].indexOf("/")<0)return;const a=e.createParsingResult(i,s);let r=parseInt(t[this.groupNumberMonth]),o=parseInt(t[this.groupNumberDay]);if((r<1||r>12)&&r>12)if(o>=1&&o<=12&&r<=31)[o,r]=[r,o];else return null;if(o<1||o>31)return null;if(a.start.assign("day",o),a.start.assign("month",r),t[Et]){const l=parseInt(t[Et]),c=ni(l);a.start.assign("year",c)}else{const l=yt(e.refDate,o,r);a.start.imply("year",l)}return a}}const Ta=new RegExp(`(this|last|past|next|after|\\+|-)\\s*(${it})(?=\\W|$)`,"i"),va=new RegExp(`(this|last|past|next|after|\\+|-)\\s*(${wt})(?=\\W|$)`,"i");class ka extends ue{constructor(e=!0){super(),this.allowAbbreviations=e}innerPattern(){return this.allowAbbreviations?Ta:va}innerExtract(e,t){const i=t[1].toLowerCase();let s=st(t[2]);switch(i){case"last":case"past":case"-":s=Wt(s);break}return V.createRelativeFromReference(e.reference,s)}}function bn(n){return n.text.match(/\s+(before|from)$/i)!=null}function Da(n){return n.text.match(/\s+(after|since)$/i)!=null}class Ea extends Tt{patternBetween(){return/^\s*$/i}shouldMergeResults(e,t,i){return!e.match(this.patternBetween())||!bn(t)&&!Da(t)?!1:!!i.start.get("day")&&!!i.start.get("month")&&!!i.start.get("year")}mergeResults(e,t,i){let s=st(t.text);bn(t)&&(s=Wt(s));const a=V.createRelativeFromReference(new di(i.start.date()),s);return new rt(i.reference,t.index,`${t.text}${e}${i.text}`,a)}}const $a=new Fe(gi(!1));new Fe(Gt(!0,!1));new Fe(Gt(!1,!0));function gi(n=!1){const e=Gt(!1,n);return e.parsers.unshift(new na),e.parsers.unshift(new sa),e.parsers.unshift(new er),e.parsers.unshift(new ma),e.parsers.unshift(new ka),e}function Gt(n=!0,e=!1){return Wr({parsers:[new ba(e),new Ws(n),new zs,new Zs,new fa,new rr,new cr,new hr(n),new yr(n),new Tr(n)],refiners:[new Ea,new $r,new Dr]},n)}var W;(function(n){n[n.AM=0]="AM",n[n.PM=1]="PM"})(W||(W={}));var te;(function(n){n[n.SUNDAY=0]="SUNDAY",n[n.MONDAY=1]="MONDAY",n[n.TUESDAY=2]="TUESDAY",n[n.WEDNESDAY=3]="WEDNESDAY",n[n.THURSDAY=4]="THURSDAY",n[n.FRIDAY=5]="FRIDAY",n[n.SATURDAY=6]="SATURDAY"})(te||(te={}));var me;(function(n){n[n.JANUARY=1]="JANUARY",n[n.FEBRUARY=2]="FEBRUARY",n[n.MARCH=3]="MARCH",n[n.APRIL=4]="APRIL",n[n.MAY=5]="MAY",n[n.JUNE=6]="JUNE",n[n.JULY=7]="JULY",n[n.AUGUST=8]="AUGUST",n[n.SEPTEMBER=9]="SEPTEMBER",n[n.OCTOBER=10]="OCTOBER",n[n.NOVEMBER=11]="NOVEMBER",n[n.DECEMBER=12]="DECEMBER"})(me||(me={}));const Sa=$a;function Ma(n,e,t){return Sa.parse(n,e,t)}const Tn="一二三四五六七八九",Oa="一二三四五六七八九十",We={一:1,二:2,三:3,四:4,五:5,六:6,七:7,八:8,九:9,十:10},Aa=[{pattern:new RegExp("(?<![\\d\\.\\-/])(?:(?<year>2\\d{3})\\s?[\\-年\\./]\\s?)?(?:(?<month>0?[1-9]|1[0-2])\\s?[\\-月\\./]\\s?)(?<day>[1-2][0-9]|3[0-1]|0?[1-9])(?:\\s?[日号]|[^\\d\\.\\-/])"),parse(n){let e=n.groups.year,t=n.groups.month,i=n.groups.day;return e||(e=new Date().getFullYear().toString()),[e,t,i]}},{pattern:/(?<prefix>明|大?后)天/,parse(n){console.log(n);let e=new Date;n.groups.prefix==="明"?e.setDate(e.getDate()+1):n.groups.prefix==="后"?e.setDate(e.getDate()+2):n.groups.prefix==="大后"&&e.setDate(e.getDate()+3);let t=e.getFullYear().toString(),i=(e.getMonth()+1).toString(),s=e.getDate().toString();return[t,i,s]}},{pattern:/今[天日]/,parse(n){console.log(n);let e=new Date,t=e.getFullYear().toString(),i=(e.getMonth()+1).toString(),s=e.getDate().toString();return[t,i,s]}},{pattern:/(?<diff>\d+)\s*(?:天[之以]?后|days? later)/,parse(n){let e=new Date,t=parseInt(n.groups.diff);e.setDate(e.getDate()+t);let i=e.getFullYear().toString(),s=(e.getMonth()+1).toString(),a=e.getDate().toString();return[i,s,a]}},{pattern:/(?<next>下个?)?(?:周|星期|礼拜)(?<day>[一二三四五六日天])/,dayMap:{一:1,二:2,三:3,四:4,五:5,六:6,日:7,天:7},parse(n){let e=new Date,t=n.groups.next!==void 0,i=this.dayMap[n.groups.day],s=e.getDay();s=s===0?7:s;let a=(t===!0?7:0)+i-s;a<0&&(a+=7),e.setDate(e.getDate()+a);let r=e.getFullYear().toString(),o=(e.getMonth()+1).toString(),l=e.getDate().toString();return[r,o,l]}},{pattern:new RegExp(`(?<!\\d)(?:(?<year>(?:20)?\\d{2})\\s?年?\\s?)?(?<month>[${Tn}]|十[一二]?)\\s*月\\s*(?<day>三十一?|二?十[${Tn}]?|[${Oa}])\\s*[日号]?`),zn2num(n){if(n.length===1)return We[n];if(n.length===2)return n[0]==="十"?10+We[n[1]]:10*We[n[0]];if(n.length===3)return 10*We[n[0]]+We[n[2]]},parse(n){let e=n.groups.year,t=n.groups.month,i=n.groups.day;return e||(e=new Date().getFullYear().toString()),t=this.zn2num(t).toString(),i=this.zn2num(i).toString(),[e,t,i]}}];async function pi(n){let e=await nt(n),i=(await rs(e.id)).kramdown;i=i.replace(/{: (?:\w+=".+")+}/g,"");let s=null,a,r=null,o=1/0;for(let m of Aa){let u=i.match(m.pattern);if(u&&u.index<o){let[h,k,M]=m.parse(u),b=new Date(`${h}-${k}-${M}`);b.toString()!=="Invalid Date"&&(o=u.index,r=b,s=u)}}if(r)a={text:s[0],index:s.index};else{let m=Ma(i,null,{forwardDate:!0});if(m.length>0){let u=m[0];r=u.start.date(),r.setHours(0,0,0,0),a={text:u.text,index:u.index}}}if(!r){F.showMessage(N.ReserveMenu.Date404,3e3,"error");return}let[l,c,f]=[r.getFullYear(),r.getMonth()+1,r.getDate()],d=new Date;if(d.setHours(0,0,0,0),r<d){F.confirm("Error",`${l}-${c}-${f}: ${N.ReserveMenu.DatePast}`);return}if(G.get("PopupReserveDialog")){let m=Pa(i,a);As(`${N.ReserveMenu.Title}: ${r.toLocaleDateString()}?`,m,()=>vn(n,r))}else vn(n,r)}async function mi(n){let e=fe.findReserved(n);e&&fe.removeReservation(e,n),fe.save(),Ze(n,{"custom-reservation":null,memo:null}),F.showMessage(N.DeReserveMenu.Success,3e3,"info")}function vn(n,e){console.log(n,e),fe.doReserve(e,n),fe.save();let t=fe.dateTemplate(e);Ze(n,{"custom-reservation":t,memo:`${N.ReserveMenu.name} ${t}`}),F.showMessage(`${N.ReserveMenu.Success} ${e.toLocaleDateString()}`,3e3,"info")}function Pa(n,e){function t(a,r,o){let l=a.substring(0,r),c=a.substring(r,r+o),f=a.substring(r+o);return`${l}<span data-type="mark">${c}</span>${f}`}let i=e?`<p>${N.ReserveMenu.Match}: ${e.text}</p>`:"";e&&(n=t(n,e.index,e.text.length));let s=Yn.Md2HTML(n);return s=`
    ${i}
    <div class="b3-typography typofont-1rem"
        style="margin: 0.5rem; box-shadow: 0px 0px 5px var(--b3-theme-on-background);"
    >
        ${s}
    </div>`,s}async function yi(n,e=!1){let t=n.dailynoteHpath,s=(await Ae(t,n))[0].id;Ra(s,e)}async function Ra(n,e=!1){let t=fe.getTodayReservations();if(t.length==0)return;let i=G.get("RetvType"),s=Ss(i,G.get("ResvEmbedAt"),t,n);const r=(await s.checkRetv()).length>0;if(r&&!e){se("今日已经插入过预约了");return}else{t=t.map(c=>`"${c}"`);let o=`select * from blocks where id in (${t.join(",")})`;if((await $e(o)).length===0){F.confirm(N.Name,N.Msg.Resv404);return}r?s.update():s.insert()}}const Na=10;class xa{constructor(e){I(this,"plugin");I(this,"eventBus");I(this,"onSyncEndBindThis",this.onSyncEnd.bind(this));I(this,"flag",{hasOpened:!1,openOnStart:!1,autoOpenAfterSync:!1,isSyncChecked:!1,hasCheckSyncFor:0});I(this,"checkDuplicateDiary_Debounce",null);this.plugin=e,this.eventBus=e.eventBus,this.flag.openOnStart=G.get("OpenOnStart"),this.flag.autoOpenAfterSync=G.get("AutoOpenAfterSync"),this.checkDuplicateDiary_Debounce=qi.debounce(this.checkDuplicateDiary.bind(this),2e3,"CheckDuplicateDiary")}bindSyncEvent(){this.eventBus.on("sync-end",this.onSyncEndBindThis)}unbindSyncEvent(){this.eventBus.off("sync-end",this.onSyncEndBindThis)}async onPluginLoad(){window.siyuan.config.sync.enabled?this.flag.autoOpenAfterSync===!1?(this.bindSyncEvent(),this.tryToOpen()):this.bindSyncEvent():await this.tryToOpen()}async onSyncEnd({detail:e}){console.debug("sync-end",e),this.flag.hasOpened===!1&&this.flag.autoOpenAfterSync===!0&&this.tryToOpen(),this.flag.isSyncChecked||this.checkDuplicateDiary_Debounce()}resetSyncCheckStatus(){this.flag.isSyncChecked=!1,this.flag.hasCheckSyncFor=0,this.flag.hasOpened=!1}async checkDuplicateDiary(){await _s()&&(this.flag.isSyncChecked=!0,this.unbindSyncEvent()),this.flag.hasCheckSyncFor++,this.flag.hasCheckSyncFor>=Na&&(this.flag.isSyncChecked=!0,console.debug("关闭自动检查同步文件"),this.unbindSyncEvent())}async tryToOpen(){this.flag.openOnStart!==!1&&(await gs(),this.flag.hasOpened=!0,setTimeout(()=>{this.checkDuplicateDiary()},1500))}}const $t="DailyNoteToday.json.txt";class Ca{constructor(){I(this,"plugin");I(this,"settings",{OpenOnStart:!0,AutoOpenAfterSync:!1,DefaultNotebook:"",DisableAutoCreateOnMobile:!1,IconPosition:"left",EnableMove:!0,EnableReserve:!0,EnableResvDock:!0,ExpandGutterMenu:!0,PopupReserveDialog:!0,ResvEmbedAt:"top",RetvType:"embed",NotebookBlacklist:{}});X.subscribe(X.EventSetting,e=>{this.set(e.key,e.value),this.save()})}setPlugin(e){this.plugin=e}get(e){var t;return(t=this.settings)==null?void 0:t[e]}set(e,t){if(!(e in this.settings)){Ee(`"${e}" is not a setting`);return}this.settings[e]=t,e==="DefaultNotebook"&&Q.updateDefault()}async load(){let e=await this.plugin.loadData($t);if(e==null||e==null||e=="")de("没有配置文件，使用默认配置"),this.save();else{de(`读入配置文件: ${$t}`),console.log(e),typeof e=="string"&&(e=JSON.parse(e));try{for(let t in e)this.set(t,e[t])}catch(t){Ee(`Setting load error: ${t}`)}this.save()}X.publish(X.EventSettingLoaded,{})}async save(){var s;let e=Q.default;if(!e)return;((s=this.settings.NotebookBlacklist)==null?void 0:s[e.id])===!0&&(this.settings.NotebookBlacklist[e.id]=!1);let i=JSON.stringify(this.settings);de(`写入配置文件: ${i}`),this.plugin.saveData($t,i)}}const G=new Ca,St="Reservation.json";class Ia{constructor(){I(this,"plugin");I(this,"reserved");I(this,"reservations",{OnDate:{}});this.reserved=new Map}updateReserved(){for(let e in this.reservations.OnDate)for(let t of this.reservations.OnDate[e])this.reserved.set(t,e)}findReserved(e){return this.reserved.get(e)}removeReservation(e,t){let i=this.reservations.OnDate[e].indexOf(t);i>=0&&this.reservations.OnDate[e].splice(i,1)}dateTemplate(e){let t=e.getFullYear(),i=e.getMonth()+1,s=e.getDate();return`${t}${i<10?"0"+i:i}${s<10?"0"+s:s}`}setPlugin(e){this.plugin=e}async load(){let e=await this.plugin.loadData(St);if(e==null||e==null||e=="")de("没有预约文件，使用默认配置");else{de(`读入预约文件: ${St}`),console.log(e),typeof e=="string"&&(e=JSON.parse(e));try{for(let t in e)this.reservations[t]=e[t]}catch(t){Ee(`Setting load error: ${t}`)}}await this.syncWithBlock(),this.doPurgeExpired(),this.updateReserved(),this.save()}async syncWithBlock(){let e=await Ms("future");for(let t of e){let i=t.id,s=t.date;s in this.reservations.OnDate||(this.reservations.OnDate[s]=[]),this.reservations.OnDate[s].indexOf(i)<0&&this.reservations.OnDate[s].push(i),this.reserved.set(i,s)}}save(){let e=JSON.stringify(this.reservations);de(`写入预约文件: ${e}`),this.plugin.saveData(St,e)}doReserve(e,t){de(`预约: ${t} 到 ${e}`);let i=this.findReserved(t);i&&(this.removeReservation(i,t),de(`已经预约到 ${i} 的 ${t} , 现在删除原来的预约`));let s=this.dateTemplate(e);s in this.reservations.OnDate||(this.reservations.OnDate[s]=[]),this.reservations.OnDate[s].indexOf(t)<0&&this.reservations.OnDate[s].push(t),this.reserved.set(t,s)}isTodayReserved(){return this.getTodayReservations().length>0}getTodayReservations(){let e=new Date,t=this.dateTemplate(e);return this.reservations.OnDate[t]||[]}doPurgeExpired(){var s;let e=new Date,t=this.dateTemplate(e),i=parseInt(t);for(let a in this.reservations.OnDate)parseInt(a)+2<i&&delete this.reservations.OnDate[a],((s=this.reservations.OnDate[a])==null?void 0:s.length)===0&&delete this.reservations.OnDate[a]}async doPrune(){let e=new Set;for(const a of Object.keys(this.reservations.OnDate))for(const r of this.reservations.OnDate[a])e.add(r);if(e.size==0)return;let t=Array.from(e),i=await us(t);const s=this.reservations.OnDate;for(const a of Object.keys(s)){const r=s[a];s[a]=s[a].filter(o=>i.has(o)),console.log(`Filter ${a}: [${r}] --> [${s[a]}]`)}this.save()}}const fe=new Ia;function kn(n,e,t){const i=n.slice();return i[10]=e[t][0],i[11]=e[t][1],i}function Ba(n){let e,t,i,s=Object.entries(n[2].options),a=[];for(let r=0;r<s.length;r+=1)a[r]=Dn(kn(n,s,r));return{c(){e=v("select");for(let r=0;r<a.length;r+=1)a[r].c();g(e,"class","b3-select fn__flex-center fn__size200"),g(e,"id","iconPosition"),n[0]===void 0&&ft(()=>n[8].call(e))},m(r,o){Z(r,e,o);for(let l=0;l<a.length;l+=1)a[l]&&a[l].m(e,null);Vt(e,n[0],!0),t||(i=[z(e,"change",n[8]),z(e,"change",n[5])],t=!0)},p(r,o){if(o&4){s=Object.entries(r[2].options);let l;for(l=0;l<s.length;l+=1){const c=kn(r,s,l);a[l]?a[l].p(c,o):(a[l]=Dn(c),a[l].c(),a[l].m(e,null))}for(;l<a.length;l+=1)a[l].d(1);a.length=s.length}o&5&&Vt(e,r[0])},d(r){r&&K(e),ze(a,r),t=!1,oe(i)}}}function Ua(n){let e,t=n[2].button+"",i,s,a;return{c(){e=v("button"),i=ye(t),g(e,"class","b3-button b3-button--outline fn__flex-center fn__size200"),g(e,"id",n[3])},m(r,o){Z(r,e,o),p(e,i),s||(a=z(e,"click",n[4]),s=!0)},p(r,o){o&4&&t!==(t=r[2].button+"")&&Ve(i,t),o&8&&g(e,"id",r[3])},d(r){r&&K(e),s=!1,a()}}}function La(n){let e,t,i,s;return{c(){e=v("input"),g(e,"class","b3-text-field fn__flex-center fn__size200"),g(e,"id",n[3]),g(e,"placeholder",t=n[2].placeholder)},m(a,r){Z(a,e,r),zt(e,n[0]),i||(s=[z(e,"input",n[7]),z(e,"change",n[5])],i=!0)},p(a,r){r&8&&g(e,"id",a[3]),r&4&&t!==(t=a[2].placeholder)&&g(e,"placeholder",t),r&5&&e.value!==a[0]&&zt(e,a[0])},d(a){a&&K(e),i=!1,oe(s)}}}function Ha(n){let e,t,i;return{c(){e=v("input"),g(e,"class","b3-switch fn__flex-center"),g(e,"id",n[3]),g(e,"type","checkbox")},m(s,a){Z(s,e,a),e.checked=n[0],t||(i=[z(e,"change",n[6]),z(e,"change",n[5])],t=!0)},p(s,a){a&8&&g(e,"id",s[3]),a&5&&(e.checked=s[0])},d(s){s&&K(e),t=!1,oe(i)}}}function Dn(n){let e,t=n[11]+"",i,s;return{c(){e=v("option"),i=ye(t),e.__value=s=n[10],e.value=e.__value},m(a,r){Z(a,e,r),p(e,i)},p(a,r){r&4&&t!==(t=a[11]+"")&&Ve(i,t),r&4&&s!==(s=a[10])&&(e.__value=s,e.value=e.__value)},d(a){a&&K(e)}}}function Fa(n){let e,t,i,s=n[2].title+"",a,r,o=n[2].text+"",l,c,f;function d(h,k){if(h[1]==="checkbox")return Ha;if(h[1]==="input")return La;if(h[1]==="button")return Ua;if(h[1]==="select")return Ba}let m=d(n),u=m&&m(n);return{c(){e=v("label"),t=v("div"),i=new $i(!1),a=Y(),r=v("div"),l=Y(),c=v("span"),f=Y(),u&&u.c(),i.a=a,g(r,"class","b3-label__text"),g(t,"class","fn__flex-1"),g(c,"class","fn__space"),g(e,"class","fn__flex b3-label")},m(h,k){Z(h,e,k),p(e,t),i.m(s,t),p(t,a),p(t,r),r.innerHTML=o,p(e,l),p(e,c),p(e,f),u&&u.m(e,null)},p(h,[k]){k&4&&s!==(s=h[2].title+"")&&i.p(s),k&4&&o!==(o=h[2].text+"")&&(r.innerHTML=o),m===(m=d(h))&&u?u.p(h,k):(u&&u.d(1),u=m&&m(h),u&&(u.c(),u.m(e,null)))},i:ne,o:ne,d(h){h&&K(e),u&&u.d()}}}function Ya(n,e,t){let{type:i}=e,{content:s}=e,{settingKey:a}=e,{settingValue:r}=e;const o=Bt();function l(){o("click",{key:a})}function c(){X.publish(X.EventSetting,{key:a,value:r})}function f(){r=this.checked,t(0,r),t(2,s)}function d(){r=this.value,t(0,r),t(2,s)}function m(){r=Di(this),t(0,r),t(2,s)}return n.$$set=u=>{"type"in u&&t(1,i=u.type),"content"in u&&t(2,s=u.content),"settingKey"in u&&t(3,a=u.settingKey),"settingValue"in u&&t(0,r=u.settingValue)},[r,i,s,a,l,c,f,d,m]}class Wa extends Ne{constructor(e){super(),Re(this,e,Ya,Fa,Pe,{type:1,content:2,settingKey:3,settingValue:0})}}function En(n,e,t){const i=n.slice();return i[6]=e[t],i}function $n(n,e){let t,i,s;return i=new Wa({props:{type:e[6].type,content:e[6].content,settingKey:e[6].key,settingValue:e[6].value}}),i.$on("click",e[3]),{key:n,first:null,c(){t=It(),mt(i.$$.fragment),this.first=t},m(a,r){Z(a,t,r),Qe(i,a,r),s=!0},p(a,r){e=a;const o={};r&2&&(o.type=e[6].type),r&2&&(o.content=e[6].content),r&2&&(o.settingKey=e[6].key),r&2&&(o.settingValue=e[6].value),i.$set(o)},i(a){s||(re(i.$$.fragment,a),s=!0)},o(a){he(i.$$.fragment,a),s=!1},d(a){a&&K(t),et(i,a)}}}function Ga(n){let e,t=[],i=new Map,s,a,r=n[1];const o=l=>l[6].key;for(let l=0;l<r.length;l+=1){let c=En(n,r,l),f=o(c);i.set(f,t[l]=$n(f,c))}return{c(){e=v("div");for(let l=0;l<t.length;l+=1)t[l].c();g(e,"class",s="config__tab-container "+n[2]),g(e,"data-name",n[0])},m(l,c){Z(l,e,c);for(let f=0;f<t.length;f+=1)t[f]&&t[f].m(e,null);a=!0},p(l,[c]){c&10&&(r=l[1],Je(),t=Fn(t,c,o,1,l,r,i,e,Ii,$n,null,En),Xe()),(!a||c&4&&s!==(s="config__tab-container "+l[2]))&&g(e,"class",s),(!a||c&1)&&g(e,"data-name",l[0])},i(l){if(!a){for(let c=0;c<r.length;c+=1)re(t[c]);a=!0}},o(l){for(let c=0;c<t.length;c+=1)he(t[c]);a=!1},d(l){l&&K(e);for(let c=0;c<t.length;c+=1)t[c].d()}}}function ja(n,e,t){let i,{dataname:s}=e,{settingItems:a}=e,{display:r=!0}=e;const o=Bt();function l({detail:c}){o("click",{key:c.key,dataname:s})}return n.$$set=c=>{"dataname"in c&&t(0,s=c.dataname),"settingItems"in c&&t(1,a=c.settingItems),"display"in c&&t(4,r=c.display)},n.$$.update=()=>{n.$$.dirty&16&&t(2,i=r?"":"fn__none")},[s,a,i,l,r]}class za extends Ne{constructor(e){super(),Re(this,e,ja,Ga,Pe,{dataname:0,settingItems:1,display:4})}}function Sn(n,e,t){const i=n.slice();return i[6]=e[t],i}function Mn(n,e,t){const i=n.slice();return i[9]=e[t],i}function On(n){let e,t,i=N.SettingGroups[n[9]]+"",s,a,r,o;function l(){return n[4](n[9])}return{c(){e=v("li"),t=v("span"),s=ye(i),a=Y(),g(t,"class","b3-list-item__text"),g(e,"data-name","editor"),g(e,"class","b3-list-item svelte-11l5hfi"),qt(e,"b3-list-item--focus",n[9]===n[1])},m(c,f){Z(c,e,f),p(e,t),p(t,s),p(e,a),r||(o=[z(e,"click",l),z(e,"keydown",qa)],r=!0)},p(c,f){n=c,f&6&&qt(e,"b3-list-item--focus",n[9]===n[1])},d(c){c&&K(e),r=!1,oe(o)}}}function An(n){let e,t;return e=new za({props:{dataname:n[6].name,settingItems:n[6].items,display:n[6].name===n[1]}}),e.$on("click",n[3]),{c(){mt(e.$$.fragment)},m(i,s){Qe(e,i,s),t=!0},p(i,s){const a={};s&1&&(a.dataname=i[6].name),s&1&&(a.settingItems=i[6].items),s&3&&(a.display=i[6].name===i[1]),e.$set(a)},i(i){t||(re(e.$$.fragment,i),t=!0)},o(i){he(e.$$.fragment,i),t=!1},d(i){et(e,i)}}}function Va(n){let e,t,i,s,a,r=n[2],o=[];for(let d=0;d<r.length;d+=1)o[d]=On(Mn(n,r,d));let l=n[0],c=[];for(let d=0;d<l.length;d+=1)c[d]=An(Sn(n,l,d));const f=d=>he(c[d],1,1,()=>{c[d]=null});return{c(){e=v("div"),t=v("ul");for(let d=0;d<o.length;d+=1)o[d].c();i=Y(),s=v("div");for(let d=0;d<c.length;d+=1)c[d].c();g(t,"class","b3-tab-bar b3-list b3-list--background svelte-11l5hfi"),g(s,"class","config__tab-wrap"),g(e,"class","fn__flex-1 fn__flex config__panel svelte-11l5hfi")},m(d,m){Z(d,e,m),p(e,t);for(let u=0;u<o.length;u+=1)o[u]&&o[u].m(t,null);p(e,i),p(e,s);for(let u=0;u<c.length;u+=1)c[u]&&c[u].m(s,null);a=!0},p(d,[m]){if(m&6){r=d[2];let u;for(u=0;u<r.length;u+=1){const h=Mn(d,r,u);o[u]?o[u].p(h,m):(o[u]=On(h),o[u].c(),o[u].m(t,null))}for(;u<o.length;u+=1)o[u].d(1);o.length=r.length}if(m&11){l=d[0];let u;for(u=0;u<l.length;u+=1){const h=Sn(d,l,u);c[u]?(c[u].p(h,m),re(c[u],1)):(c[u]=An(h),c[u].c(),re(c[u],1),c[u].m(s,null))}for(Je(),u=l.length;u<c.length;u+=1)f(u);Xe()}},i(d){if(!a){for(let m=0;m<l.length;m+=1)re(c[m]);a=!0}},o(d){c=c.filter(Boolean);for(let m=0;m<c.length;m+=1)he(c[m]);a=!1},d(d){d&&K(e),ze(o,d),ze(c,d)}}}const qa=()=>{};function Ka(n,e,t){let{panels:i}=e,s=i.map(c=>c.name),a=s[0];const r=Bt();function o({detail:c}){r("click",c)}const l=c=>{t(1,a=c)};return n.$$set=c=>{"panels"in c&&t(0,i=c.panels)},[i,a,s,o,l]}class Za extends Ne{constructor(e){super(),Re(this,e,Ka,Va,Pe,{panels:0})}}function Pn(n,e,t){const i=n.slice();return i[11]=e[t],i[12]=e,i[13]=t,i}function Ja(n){return{c:ne,m:ne,p:ne,d:ne}}function Xa(n){let e=[],t=new Map,i,s=n[10];const a=r=>r[11].id;for(let r=0;r<s.length;r+=1){let o=Pn(n,s,r),l=a(o);t.set(l,e[r]=Rn(l,o))}return{c(){for(let r=0;r<e.length;r+=1)e[r].c();i=It()},m(r,o){for(let l=0;l<e.length;l+=1)e[l]&&e[l].m(r,o);Z(r,i,o)},p(r,o){o&14&&(s=r[10],e=Fn(e,o,a,1,r,s,t,i.parentNode,Ci,Rn,i,Pn))},d(r){for(let o=0;o<e.length;o+=1)e[o].d(r);r&&K(i)}}}function Rn(n,e){let t,i,s=to(e[11].icon)+"",a,r,o,l=e[11].name+"",c,f,d,m,u,h;function k(){e[8].call(d,e[11])}return{key:n,first:null,c(){t=v("li"),i=v("span"),a=ye(s),r=Y(),o=v("span"),c=ye(l),f=Y(),d=v("input"),m=Y(),g(i,"class","b3-list-item__icon"),g(o,"class","b3-list-item__text"),g(d,"type","checkbox"),g(d,"class","b3-switch fn__flex-center"),d.__value=e[11].id,d.value=d.__value,g(t,"class","b3-list-item b3-list-item--hide-action"),this.first=t},m(M,b){Z(M,t,b),p(t,i),p(i,a),p(t,r),p(t,o),p(o,c),p(t,f),p(t,d),d.checked=e[1][e[11].id],p(t,m),u||(h=[z(d,"change",k),z(d,"change",e[3])],u=!0)},p(M,b){e=M,b&6&&(d.checked=e[1][e[11].id])},d(M){M&&K(t),u=!1,oe(h)}}}function Qa(n){let e;return{c(){e=ye("Wait...")},m(t,i){Z(t,e,i)},p:ne,d(t){t&&K(e)}}}function eo(n){let e,t,i,s,a,r,o,l,c,f,d,m,u,h,k,M,b,q,x={ctx:n,current:null,token:null,hasCatch:!1,pending:Qa,then:Xa,catch:Ja,value:10};return Ni(n[2](),x),{c(){e=v("div"),t=v("div"),i=v("ul"),s=v("li"),a=ie("svg"),r=ie("use"),o=Y(),l=v("span"),l.textContent=`${N.Blacklist.toggle}`,c=Y(),f=v("input"),d=Y(),x.block.c(),m=Y(),u=v("div"),h=v("div"),k=Y(),M=v("button"),M.textContent=`${N.Blacklist.update}`,De(r,"xlink:href","#iconEdit"),g(a,"class","b3-list-item__graphic"),g(l,"class","b3-list-item__text"),g(f,"type","checkbox"),g(s,"class","b3-list-item b3-list-item--hide-action"),He(s,"border-bottom","1px solid var(--b3-border-color)"),g(t,"class","fn__flex-1 svelte-1rabyea"),He(t,"border-bottom","1px solid var(--b3-border-color)"),g(h,"class","fn__flex-1"),g(M,"class","b3-button b3-button--outline fn__flex-center fn__size200"),g(u,"class","fn__flex b3-label"),g(e,"class","fn__flex-column svelte-1rabyea")},m(A,C){Z(A,e,C),p(e,t),p(t,i),p(i,s),p(s,a),p(a,r),p(s,o),p(s,l),p(s,c),p(s,f),n[7](f),p(i,d),x.block.m(i,x.anchor=null),x.mount=()=>i,x.anchor=null,p(e,m),p(e,u),p(u,h),p(u,k),p(u,M),b||(q=[z(f,"change",n[4]),z(M,"click",n[5])],b=!0)},p(A,[C]){n=A,xi(x,n,C)},i:ne,o:ne,d(A){A&&K(e),n[7](null),x.block.d(),x.token=null,x=null,b=!1,oe(q)}}}function to(n){try{return String.fromCodePoint(parseInt(n,16))}catch{return"📔"}}function no(n,e,t){let{close:i}=e;const s=new Set(["思源笔记用户指南","SiYuan User Guide"]);let a,r=G.get("NotebookBlacklist");async function o(){let h=(await Gn()).notebooks;return h=h.filter(k=>{var M;return!s.has(k.name)&&k.id!==((M=Q.default)==null?void 0:M.id)}),h.forEach(k=>{let M=r==null?void 0:r[k.id];M=M===void 0?!1:M,t(1,r[k.id]=M,r)}),h}function l(){let u=Object.values(r).filter(k=>k).length;const h=Object.keys(r).length;u===h?(t(0,a.checked=!0,a),t(0,a.indeterminate=!1,a)):u===0?(t(0,a.checked=!1,a),t(0,a.indeterminate=!1,a)):(t(0,a.checked=!1,a),t(0,a.indeterminate=!0,a))}function c(){a.checked?Object.keys(r).forEach(h=>{t(1,r[h]=!0,r)}):Object.keys(r).forEach(h=>{t(1,r[h]=!1,r)})}function f(){console.log(r),G.set("NotebookBlacklist",r),i()}function d(u){Ke[u?"unshift":"push"](()=>{a=u,t(0,a)})}function m(u){r[u.id]=this.checked,t(1,r)}return n.$$set=u=>{"close"in u&&t(6,i=u.close)},[a,r,o,l,c,f,i,d,m]}class io extends Ne{constructor(e){super(),Re(this,e,no,eo,Pe,{close:6})}}const so=async()=>{const n=new F.Dialog({title:"Running",content:`
<div class="b3-dialog__content">
    <div id="body" style="padding: 6px 12px; width: 100%;">
        <table id="notebooks" cellpadding="10" style="width: 100%;">
            <thead>
                <tr style="text-align: left;">
                    <th>Notebook</th>
                    <th>Start Date</th>
                    <th>Daily Notes</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>`,width:"50em",height:"25em"});let e=n.element.querySelector(".b3-dialog__container");e.style.maxHeight="50%";let t=n.element.querySelector("#body > table#notebooks");for(let a of Q){if(a.dailynoteSprig===void 0||a.dailynoteSprig==="")continue;let r=await Jn(a),o=document.createElement("tr");o.innerHTML=`<tr style="text-align: left;">
            <td>${a.name}</td>
            <td>${Lt(r,"-")}</td>
            <td>...</td>
        </tr>`,t.appendChild(o);let l=await vs(a,r);o.querySelector("td:nth-child(3)").innerText=`${l.length}`}let i=n.element.querySelector("#body"),s=document.createElement("div");s.innerText="All Done!",s.style.color="var(--b3-theme-primary)",s.style.fontWeight="bold",i.appendChild(s)};function ro(n){let e,t;return e=new Za({props:{panels:n[0]}}),e.$on("click",n[1]),{c(){mt(e.$$.fragment)},m(i,s){Qe(e,i,s),t=!0},p:ne,i(i){t||(re(e.$$.fragment,i),t=!0)},o(i){he(e.$$.fragment,i),t=!1},d(i){et(e,i)}}}function ao(n){let e=N.Setting,t={enable:[{name:"OpenOnStart",type:"checkbox"},{name:"EnableMove",type:"checkbox"},{name:"EnableReserve",type:"checkbox"},{name:"EnableResvDock",type:"checkbox"}],interact:[{name:"IconPosition",type:"select"},{name:"ExpandGutterMenu",type:"checkbox"}],dailynote:[{name:"DefaultNotebook",type:"input"},{name:"NotebookBlacklist",type:"button"},{name:"DisableAutoCreateOnMobile",type:"checkbox"},{name:"SetPastDailyNoteAttr",type:"button"},{name:"AutoOpenAfterSync",type:"checkbox"}],reservation:[{name:"PopupReserveDialog",type:"checkbox"},{name:"ResvEmbedAt",type:"select"},{name:"RetvType",type:"select"}]},i=[];for(let a in t){let r=[];for(let o of t[a])r.push({type:o.type,key:o.name,value:G.get(o.name),content:e[o.name]});i.push({name:a,items:r})}Hn(()=>{console.log("Setting Svelte Mounted")}),Si(()=>{console.log("Setting Svelte Destroyed"),G.save()});function s({detail:a}){console.log(a);let r=a.key;if(r==="NotebookBlacklist"){let o=new F.Dialog({title:N.Blacklist.name,content:'<div id="blacklist" style="height: 100%;"></div>',height:"25rem",width:"30rem"});new io({target:o.element.querySelector("#blacklist"),props:{close:()=>{o.destroy()}}})}else r==="SetPastDailyNoteAttr"&&so()}return[i,s]}class oo extends Ne{constructor(e){super(),Re(this,e,ao,ro,Pe,{})}}function Nn(n,e,t){const i=n.slice();return i[14]=e[t],i}function xn(n){let e,t,i,s,a=n[14].content+"",r,o,l,c,f,d;function m(){return n[13](n[14])}return{c(){var u;e=v("li"),t=v("span"),t.innerHTML='<svg data-id="20230612111658-489nla8" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>',i=Y(),s=v("span"),r=ye(a),o=Y(),He(t,"padding-left","22px"),He(t,"margin-right","2px"),g(t,"class","b3-list-item__toggle fn__hidden"),g(s,"class","b3-list-item__text"),g(e,"class","b3-list-item b3-list-item--hide-action"),g(e,"data-node-id",l=(u=n[14])==null?void 0:u.id),g(e,"data-ref-text",""),g(e,"data-def-id",""),g(e,"data-treetype","bookmark"),g(e,"data-def-path",""),g(e,"title",c=Zt(Kt(n[14].content,50),15))},m(u,h){Z(u,e,h),p(e,t),p(e,i),p(e,s),p(s,r),p(e,o),f||(d=[z(e,"click",m),z(e,"keydown",fo)],f=!0)},p(u,h){var k;n=u,h&2&&a!==(a=n[14].content+"")&&Ve(r,a),h&2&&l!==(l=(k=n[14])==null?void 0:k.id)&&g(e,"data-node-id",l),h&2&&c!==(c=Zt(Kt(n[14].content,50),15))&&g(e,"title",c)},d(u){u&&K(e),f=!1,oe(d)}}}function lo(n){var C;let e,t,i,s,a,r,o,l,c,f,d,m,u=((C=n[1])==null?void 0:C.length)+"",h,k,M,b,q,x=n[1],A=[];for(let T=0;T<x.length;T+=1)A[T]=xn(Nn(n,x,T));return{c(){e=v("li"),t=v("span"),i=ie("svg"),s=ie("use"),a=Y(),r=ie("svg"),o=ie("use"),l=Y(),c=v("span"),f=ye(n[0]),d=Y(),m=v("span"),h=ye(u),k=Y(),M=v("ul");for(let T=0;T<A.length;T+=1)A[T].c();De(s,"xlink:href","#iconRight"),g(i,"data-id","Doing0"),g(i,"class",n[4]),He(t,"padding-left","4px"),He(t,"margin-right","2px"),g(t,"class","b3-list-item__toggle b3-list-item__toggle--hl"),De(o,"xlink:href","#iconHistory"),g(r,"class","b3-list-item__graphic"),g(c,"class","b3-list-item__text"),g(c,"style",n[6]),g(m,"class","counter b3-list-item__action b3-tooltips b3-tooltips__w"),g(m,"aria-label",N.DockReserve.PopupResv),g(e,"class","b3-list-item b3-list-item--hide-action"),g(e,"data-treetype","bookmark"),g(e,"data-type","undefined"),g(e,"data-subtype","undefined"),g(M,"class",n[5])},m(T,S){Z(T,e,S),p(e,t),p(t,i),p(i,s),p(e,a),p(e,r),p(r,o),p(e,l),p(e,c),p(c,f),p(e,d),p(e,m),p(m,h),n[11](e),Z(T,k,S),Z(T,M,S);for(let B=0;B<A.length;B+=1)A[B]&&A[B].m(M,null);b||(q=[z(m,"click",n[10]),z(m,"keydown",co),z(e,"click",n[12]),z(e,"keydown",uo)],b=!0)},p(T,[S]){var B;if(S&16&&g(i,"class",T[4]),S&1&&Ve(f,T[0]),S&64&&g(c,"style",T[6]),S&2&&u!==(u=((B=T[1])==null?void 0:B.length)+"")&&Ve(h,u),S&130){x=T[1];let E;for(E=0;E<x.length;E+=1){const $=Nn(T,x,E);A[E]?A[E].p($,S):(A[E]=xn($),A[E].c(),A[E].m(M,null))}for(;E<A.length;E+=1)A[E].d(1);A.length=x.length}S&32&&g(M,"class",T[5])},i:ne,o:ne,d(T){T&&K(e),n[11](null),T&&K(k),T&&K(M),ze(A,T),b=!1,oe(q)}}}const co=()=>{},uo=()=>{},fo=()=>{};function ho(n,e,t){let{sectionTitle:i=""}=e,{blocks:s=[]}=e,{isExpanded:a=!1}=e,r;function o(b){t(9,a=b===void 0?!a:b)}let l="b3-list-item__arrow",c="fn__none",f="";async function d(b){console.log("clickItem",b),b&&ds(b)}function m(b){b.stopPropagation();const q=document.body.clientWidth,x=r.getBoundingClientRect(),A=x.right>q/2;Wn.addFloatLayer({ids:s.map(B=>B.id),x:0,y:0});const C=window.siyuan.blockPanels,T=C[C.length-1],S=T==null?void 0:T.element;A?(S.style.top=`${x.bottom+10}px`,S.style.left="",S.style.right=`${q-x.right}px`):S.style.top=`${x.bottom+10}px`}const u=b=>m(b);function h(b){Ke[b?"unshift":"push"](()=>{r=b,t(3,r)})}const k=()=>o(),M=b=>d(b==null?void 0:b.id);return n.$$set=b=>{"sectionTitle"in b&&t(0,i=b.sectionTitle),"blocks"in b&&t(1,s=b.blocks),"isExpanded"in b&&t(9,a=b.isExpanded)},n.$$.update=()=>{if(n.$$.dirty&512&&(a?(t(4,l="b3-list-item__arrow b3-list-item__arrow--open"),t(5,c="")):(t(4,l="b3-list-item__arrow"),t(5,c="fn__none"))),n.$$.dirty&1){let b=new Date,q=b.getFullYear(),x=b.getMonth()+1,A=b.getDate(),C=`${q}-${x<10?"0"+x:x}-${A<10?"0"+A:A}`;i===C?t(6,f="color: var(--b3-font-color1); font-weight: bold;"):t(6,f="")}},[i,s,o,r,l,c,f,d,m,a,u,h,k,M]}class go extends Ne{constructor(e){super(),Re(this,e,ho,lo,Pe,{sectionTitle:0,blocks:1,isExpanded:9,toggleExpand:2})}get toggleExpand(){return this.$$.ctx[2]}}function Cn(n,e,t){const i=n.slice();return i[11]=e[t],i[12]=e,i[13]=t,i}function po(n){let e,t,i=n[1],s=[];for(let r=0;r<i.length;r+=1)s[r]=In(Cn(n,i,r));const a=r=>he(s[r],1,1,()=>{s[r]=null});return{c(){for(let r=0;r<s.length;r+=1)s[r].c();e=It()},m(r,o){for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(r,o);Z(r,e,o),t=!0},p(r,o){if(o&3){i=r[1];let l;for(l=0;l<i.length;l+=1){const c=Cn(r,i,l);s[l]?(s[l].p(c,o),re(s[l],1)):(s[l]=In(c),s[l].c(),re(s[l],1),s[l].m(e.parentNode,e))}for(Je(),l=i.length;l<s.length;l+=1)a(l);Xe()}},i(r){if(!t){for(let o=0;o<i.length;o+=1)re(s[o]);t=!0}},o(r){s=s.filter(Boolean);for(let o=0;o<s.length;o+=1)he(s[o]);t=!1},d(r){ze(s,r),r&&K(e)}}}function mo(n){let e;return{c(){e=v("li"),e.textContent=`${N.DockReserve.emptyContent}`,g(e,"class","b3-list--empty")},m(t,i){Z(t,e,i)},p:ne,i:ne,o:ne,d(t){t&&K(e)}}}function In(n){let e,t,i;function s(r){n[10](r,n[13])}let a={sectionTitle:n[11].date,blocks:n[11].blocks};return n[0][n[13]]!==void 0&&(a.isExpanded=n[0][n[13]]),e=new go({props:a}),Ke.push(()=>Bi(e,"isExpanded",s)),{c(){mt(e.$$.fragment)},m(r,o){Qe(e,r,o),i=!0},p(r,o){n=r;const l={};o&2&&(l.sectionTitle=n[11].date),o&2&&(l.blocks=n[11].blocks),!t&&o&1&&(t=!0,l.isExpanded=n[0][n[13]],Ai(()=>t=!1)),e.$set(l)},i(r){i||(re(e.$$.fragment,r),i=!0)},o(r){he(e.$$.fragment,r),i=!1},d(r){et(e,r)}}}function yo(n){let e,t,i,s,a,r,o=n[2].title+"",l,c,f,d,m,u,h,k,M,b,q,x,A,C,T,S,B,E,$,we,Ce,O,w,y,D,_,P,R,U,H,L,J,ge,pe;const ve=[mo,po],le=[];function be(j,ce){return j[1].length===0?0:1}return H=be(n),L=le[H]=ve[H](n),{c(){e=v("div"),t=v("div"),i=v("div"),s=ie("svg"),a=ie("use"),r=Y(),l=ye(o),c=Y(),f=v("span"),d=Y(),m=v("span"),u=Y(),h=v("span"),k=ie("svg"),M=ie("use"),b=Y(),q=v("span"),x=Y(),A=v("span"),C=ie("svg"),T=ie("use"),S=Y(),B=v("span"),E=Y(),$=v("span"),we=ie("svg"),Ce=ie("use"),O=Y(),w=v("span"),y=Y(),D=v("span"),_=ie("svg"),P=ie("use"),R=Y(),U=v("div"),L.c(),De(a,"xlink:href","#iconBookmark"),g(s,"class","block__logoicon"),g(i,"class","block__logo"),g(f,"class","fn__flex-1"),g(m,"class","fn__space"),De(M,"xlink:href","#iconRefresh"),g(k,"class",""),g(h,"data-type","refresh"),g(h,"class","block__icon b3-tooltips b3-tooltips__sw"),g(h,"aria-label",n[2].refresh),g(q,"class","fn__space"),De(T,"xlink:href","#iconExpand"),g(A,"data-type","expand"),g(A,"class","block__icon b3-tooltips b3-tooltips__sw"),g(A,"aria-label",n[2].expand+" Ctrl+↓"),g(B,"class","fn__space"),De(Ce,"xlink:href","#iconContract"),g(we,"class",""),g($,"data-type","collapse"),g($,"class","block__icon b3-tooltips b3-tooltips__sw"),g($,"aria-label",n[2].collapse+" Ctrl+↑"),g(w,"class","fn__space"),De(P,"xlink:href","#iconMin"),g(_,"class",""),g(D,"data-type","min"),g(D,"class","block__icon b3-tooltips b3-tooltips__sw"),g(D,"aria-label",n[2].min+" Ctrl+W"),g(t,"class","block__icons"),g(U,"class","fn__flex-1"),g(e,"class","fn__flex-1 fn__flex-column file-tree layout__tab")},m(j,ce){Z(j,e,ce),p(e,t),p(t,i),p(i,s),p(s,a),p(i,r),p(i,l),p(t,c),p(t,f),p(t,d),p(t,m),p(t,u),p(t,h),p(h,k),p(k,M),p(t,b),p(t,q),p(t,x),p(t,A),p(A,C),p(C,T),p(t,S),p(t,B),p(t,E),p(t,$),p($,we),p(we,Ce),p(t,O),p(t,w),p(t,y),p(t,D),p(D,_),p(_,P),p(e,R),p(e,U),le[H].m(U,null),J=!0,ge||(pe=[z(h,"click",n[7]),z(h,"keydown",n[6]),z(A,"click",n[8]),z(A,"keydown",n[6]),z($,"click",n[9]),z($,"keydown",n[6])],ge=!0)},p(j,[ce]){let Me=H;H=be(j),H===Me?le[H].p(j,ce):(Je(),he(le[Me],1,1,()=>{le[Me]=null}),Xe(),L=le[H],L?L.p(j,ce):(L=le[H]=ve[H](j),L.c()),re(L,1),L.m(U,null))},i(j){J||(re(L),J=!0)},o(j){he(L),J=!1},d(j){j&&K(e),le[H].d(),ge=!1,oe(pe)}}}function _o(n,e,t){let i=[],s=[],a=N.DockReserve;function r(){for(let h=0;h<i.length;h++)t(0,i[h]=!0,i)}function o(){for(let h=0;h<i.length;h++)t(0,i[h]=!1,i)}async function l(){let h=Object.entries(fe.reservations.OnDate),k=h.length,M=[];for(let C=0;C<k;C++){let S=h[C][1];M=M.concat(S)}let b=`select id, content, root_id from blocks where id in (${M.map(C=>`'${C}'`).join(",")})`,q=await $e(b);if(q===null){t(1,s=[]);return}let x={};q.forEach(C=>{x[C.id]={content:C.content,doc:C.root_id}}),t(0,i=new Array(k).fill(!1));let A=[];for(let C=0;C<k;C++){let T=h[C],S=[];T[1].forEach(B=>{var E,$;B in x&&S.push({id:B,content:(E=x[B])==null?void 0:E.content,doc:($=x[B])==null?void 0:$.doc})}),A.push({date:`${T[0].slice(0,4)}-${T[0].slice(4,6)}-${T[0].slice(6,8)}`,blocks:S})}t(1,s=A.filter(C=>C.blocks.length>0))}const c=()=>{};Hn(()=>{l()});const f=()=>l(),d=()=>r(),m=()=>o();function u(h,k){n.$$.not_equal(i[k],h)&&(i[k]=h,t(0,i))}return[i,s,a,r,o,l,c,f,d,m,u]}class wo extends Ne{constructor(e){super(),Re(this,e,_o,yo,Pe,{})}}const _i={icon32:'<svg t="1684051396086" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5307" width="32" height="32"><path d="M832 42.666667a128 128 0 0 1 128 128v682.666666a128 128 0 0 1-128 128H277.333333a128.042667 128.042667 0 0 1-126.229333-106.666666H202.666667a96 96 0 0 0 4.522666-191.893334L202.666667 682.666667H149.333333v-74.666667h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 512a96 96 0 0 0-91.477334-95.893333L202.666667 416H149.333333V341.333333h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 245.333333a96 96 0 0 0-91.477334-95.893333L202.666667 149.333333H151.104A128.042667 128.042667 0 0 1 277.333333 42.666667h554.666667zM202.666667 746.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m605.866666-445.866667a64 64 0 0 0-90.517333 0L411.413333 607.445333a42.666667 42.666667 0 0 0-12.117333 24.448l-8.64 63.829334a21.333333 21.333333 0 0 0 24.32 23.957333l62.869333-9.472a42.666667 42.666667 0 0 0 23.829334-12.010667l306.837333-306.858666a64 64 0 0 0 0-90.496zM202.666667 480a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m0-266.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z" fill="" p-id="5308"></path></svg>',icon16:'<svg t="1684846685600" class="b3-menu__icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9077" width="16" height="16"><path d="M832 42.666667a128 128 0 0 1 128 128v682.666666a128 128 0 0 1-128 128H277.333333a128.042667 128.042667 0 0 1-126.229333-106.666666H202.666667a96 96 0 0 0 4.522666-191.893334L202.666667 682.666667H149.333333v-74.666667h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 512a96 96 0 0 0-91.477334-95.893333L202.666667 416H149.333333V341.333333h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 245.333333a96 96 0 0 0-91.477334-95.893333L202.666667 149.333333H151.104A128.042667 128.042667 0 0 1 277.333333 42.666667h554.666667zM202.666667 746.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m605.866666-445.866667a64 64 0 0 0-90.517333 0L411.413333 607.445333a42.666667 42.666667 0 0 0-12.117333 24.448l-8.64 63.829334a21.333333 21.333333 0 0 0 24.32 23.957333l62.869333-9.472a42.666667 42.666667 0 0 0 23.829334-12.010667l306.837333-306.858666a64 64 0 0 0 0-90.496zM202.666667 480a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m0-266.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z" fill="" p-id="9078"></path></svg>'};let Mt,Ot;class bo{constructor(e){I(this,"plugin");I(this,"ele");I(this,"iconStatus");I(this,"onProtyleLoadedBindThis",this.onProtyleLoaded.bind(this));this.plugin=e,Mt=t=>this.contextMenu(t),Ot=()=>this.updateDailyNoteStatus(),this.iconStatus=new Map,X.subscribe("moveBlocks",Ot),X.subscribe(X.EventSettingLoaded,()=>{this.addTopBarIcon()})}startMonitorDailyNoteForReservation(){fe.isTodayReserved&&(this.plugin.eventBus.on("loaded-protyle-static",this.onProtyleLoadedBindThis),setTimeout(()=>{this.plugin.eventBus.off("loaded-protyle-static",this.onProtyleLoadedBindThis)},1e3*60*2))}release(){this.ele.removeEventListener("contextmenu",Mt),X.unSubscribe("moveBlocks",Ot),this.ele.remove(),this.ele=null,this.plugin.eventBus.off("loaded-protyle-static",this.onProtyleLoadedBindThis),se("TopBarIcon released")}addTopBarIcon(){console.log("addTopBarIcon"),this.ele=this.plugin.addTopBar({icon:_i.icon32,title:N.Name,position:G.get("IconPosition"),callback:()=>{this.showMenu()}}),this.ele.addEventListener("contextmenu",Mt),this.updateDailyNoteStatus()}contextMenu(e){e.preventDefault();let t=new F.Menu("dntoday-config");t.addItem({label:N.Setting.name,icon:"iconSettings",click:()=>{X.publish("OpenSetting","")}}),t.addItem({label:N.ContextMenu.PruneResv,icon:"iconTrashcan",click:async()=>{await fe.doPrune(),F.showMessage(N.Msg.PruneResv)}}),t.addItem({label:N.Setting.update.title,icon:"iconRefresh",click:()=>{X.publish(X.EventUpdateAll,"")}});let i=this.ele.getBoundingClientRect();const s=G.get("IconPosition")==="right";t.open({x:s?i.right:i.left,y:i.bottom,isLeft:s}),e.stopPropagation()}async showMenu(){await this.updateDailyNoteStatus();let e=new F.Menu("dntoday-menu"),t=this.createMenuItems();for(let s of t)e.addItem(s);let i=this.ele.getBoundingClientRect();if(i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),tt)e.fullscreen();else{const s=G.get("IconPosition")==="right";e.open({x:s?i.right:i.left,y:i.bottom,isLeft:s})}}createMenuItems(){let e=G.get("NotebookBlacklist"),t=[];for(let i of Q){let s=e==null?void 0:e[i.id];if(s=s===void 0?!1:s,s===!0)continue;let a={label:i.name,icon:this.iconStatus.get(i.id),click:async()=>Zn(i)};t.push(a)}return t}async onProtyleLoaded({detail:e}){var o;console.debug(e);const t=e.protyle,i=t.block;if(i.id!=i.rootID||!((o=t==null?void 0:t.model)==null?void 0:o.headElement)||t.notebookId!==Q.default.id)return;const r=async(l,c=1)=>{if(c>3)return;se("检查",l);const f=await nt(l);if(f===void 0){console.warn(`New opened docId ${l} undefined`),setTimeout(()=>r(l,c++),1e3*c);return}Q.default.dailynoteHpath===f.hpath&&(se("Got Today's daily note"),this.plugin.eventBus.off("loaded-protyle-static",this.onProtyleLoadedBindThis),await yi(Q.default,!0))};se("打开新的文档, 2s后检查",i.id),setTimeout(()=>r(i.id),1e3*2)}async updateDailyNoteStatus(){let e=await hs();Q.notebooks.forEach(t=>{e.get(t.id)?this.iconStatus.set(t.id,"iconSelect"):this.iconStatus.set(t.id,"")})}}async function To(n,e){let t=await nt(n);if(t==null){Ee(`Block ${n} not found`);return}let i=e.dailynoteHpath,s=await Ae(i,e),a;if(s!=null&&s.length>0?a=s[0].id:(a=await Kn(e,i),F.showMessage(`${N.Create}: ${e.name}`,2500,"info")),se(`Call 移动块: ${t.id} --> ${a}`),t.type==="i"){let o=(await jn(a,"* ","markdown"))[0].doOperations[0].id;await kt(t.id,null,o),se(`移动列表项 ${t.id} --> ${o}`);let c=(await ns(o))[1];await is(c.id)}else if(t.type==="h"){let o=document.querySelector(`#layouts div.protyle-content div[data-node-id="${t.id}"]`).getAttribute("fold");o!="1"&&await as(t.id),await kt(t.id,null,a),o!="1"&&setTimeout(()=>{os(t.id)},500)}else await kt(t.id,null,a);F.showMessage(`${t.id} ${N.MoveMenu.Move} ${e.name}`,2500,"info")}async function vo(n,e){let t=await nt(n);if(t===null){Ee(`Document ${n} not found`);return}let i=t.path,s=t.hpath,a=e.dailynoteHpath;for(let l of Q)if(l.dailynoteHpath===s){Ee("不可以移动日记!"),F.showMessage(N.MoveMenu.NotMoveDiary,2500,"error");return}let r=await Ae(a,e);console.log("日记路径:",r),r!=null&&r.length>0||(await Kn(e,a),r=await Ae(a,e),F.showMessage(`${N.Create}: ${e.name}`,2500,"info"));let o=r[0].path;Qi([i],e.id,o)}function ko(n){try{return`<span class="b3-menu__icon">${String.fromCodePoint(parseInt(n,16))}</span>`}catch{return'<span class="b3-menu__icon"> </span>'}}function Bn(n,e="block"){let t=[],i=G.get("NotebookBlacklist");for(let s of Q){let a=i==null?void 0:i[s.id];if(a=a===void 0?!1:a,a===!0)continue;let r={label:s.name,iconHTML:ko(s.icon),click:async()=>{e==="block"?(de(`Move block ${n} to ${s.id} [${s.name}]`),await To(n,s),X.publish("moveBlocks","")):(await vo(n,s),X.publish("moveBlocks",""))}};t.push(r)}return t}let At,Pt;class Do{constructor(e){I(this,"menuItems",[]);I(this,"eventBus");At=t=>this.onBlockGutterClicked(t),Pt=t=>this.onDocGutterClicked(t),this.eventBus=e,e.on("click-blockicon",At),e.on("click-editortitleicon",Pt)}release(){this.eventBus.off("click-blockicon",At),this.eventBus.off("click-editortitleicon",Pt)}onBlockGutterClicked({detail:e}){if(e.blockElements.length>1)return;let t=e.menu,i=e.blockElements[0],s=i.getAttribute("data-node-id"),a=i.attributes.getNamedItem("custom-reservation"),r=[];if(console.log(e),G.get("EnableReserve")===!0&&(a?r.push({label:N.DeReserveMenu.name,icon:"iconClose",click:()=>mi(s)}):r.push({label:N.ReserveMenu.name,icon:"iconHistory",click:()=>pi(s)})),G.get("EnableMove")===!0){let o=Bn(s);r.push({label:N.MoveMenu.Move,type:"submenu",icon:"iconMove",submenu:o})}r.length>0&&(G.get("ExpandGutterMenu")===!0?r.forEach(l=>{t.addItem(l)}):t.addItem({iconHTML:_i.icon16,label:N.Name,type:"submenu",submenu:r}))}onDocGutterClicked({detail:e}){console.log(e);let t=e.data.id;if(t===void 0)return;let i=e.menu,s=Bn(t,"doc");i.addItem({label:N.MoveMenu.Move,type:"submenu",icon:"iconMove",submenu:s})}}class Eo extends F.Plugin{constructor(){super(...arguments);I(this,"version");I(this,"upToDate",null);I(this,"enableBlockIconClickEvent",!1);I(this,"isMobile",!1);I(this,"toolbarItem");I(this,"gutterMenu");I(this,"startupHandler")}async onload(){se("Plugin load");let t=performance.now();const i=F.getFrontend();this.isMobile=i==="mobile"||i==="browser-mobile",Fi(this.isMobile),Hi(this.i18n),Yi(this.app),Wi(this),G.setPlugin(this),fe.setPlugin(this),this.initPluginUI(),await Promise.all([fe.load(),G.load(),Q.init()]),this.initBlockIconClickEvent(),this.initUpToDate(),X.subscribe(X.EventUpdateAll,()=>{this.updateAll()}),this.startupHandler=new xa(this),this.toolbarItem.startMonitorDailyNoteForReservation(),this.startupHandler.onPluginLoad();let s=performance.now();se(`启动耗时: ${s-t} ms`)}initPluginUI(){this.addCommand({langKey:"reserve",hotkey:"⌥⇧R",editorCallback:async()=>{let t=zi();if(t){let i=t.getAttribute("data-type");if(i==="NodeParagraph"){let r=t==null?void 0:t.parentElement;i=r==null?void 0:r.getAttribute("data-type"),i==="NodeListItem"&&(t=r)}const s=t.getAttribute("data-node-id");let a=t.attributes.getNamedItem("custom-reservation");G.get("EnableReserve")===!0&&(a?mi(s):pi(s))}}}),this.toolbarItem=new bo(this),X.subscribe(X.EventSettingLoaded,this.onSettingLoaded.bind(this)),X.subscribe("OpenSetting",this.openSetting.bind(this))}initUpToDate(){this.upToDate=null,this.startUpdateOnNextDay()}initBlockIconClickEvent(){(G.get("EnableMove")===!0||G.get("EnableReserve")===!0)&&(se("添加块菜单项目"),this.enableBlockIconClickEvent=!0,this.gutterMenu=new Do(this.eventBus))}onSettingLoaded(){G.get("EnableResvDock")===!0&&this.addDock({config:{position:"RightBottom",size:{width:250,height:0},icon:"iconHistory",title:this.i18n.DockReserve.arial,show:!1},data:{text:"This is my custom dock"},type:"dock_tab",init(){this.element.innerHTML='<div id="ShowResv"/>',new wo({target:this.element.querySelector("#ShowResv")})},destroy(){console.log("destroy dock:")}})}async updateAll(){se("updateAll"),await Q.update(),this.toolbarItem.updateDailyNoteStatus(),yi(Q.default,!0),F.showMessage(this.i18n.UpdateAll,2500,"info")}openSetting(){let t=new F.Dialog({title:`${this.i18n.Name}`,content:'<div id="SettingPanel" style="height: 100%"></div>',width:"50%",height:"27rem",destroyCallback:s=>{console.log("destroyCallback",s),i.$destroy()}}),i=new oo({target:t.element.querySelector("#SettingPanel")})}startUpdateOnNextDay(){let t=new Date,i=new Date;i.setDate(t.getDate()+1),i.setHours(0,0,0,0);let s=i.getTime()-t.getTime();this.upToDate=setTimeout(this.updateOnNewDay.bind(this),s),de(`当前时间: ${t}, 下次更新时间: ${i}, ${s} ms 后更新`)}async updateOnNewDay(){await Q.update(),this.toolbarItem.updateDailyNoteStatus(),this.startUpdateOnNextDay();let t=new Date;t.toDateString();let i=`${this.i18n.NewDay[0]} ${t.toLocaleDateString()} ${this.i18n.NewDay[1]}`;this.startupHandler.resetSyncCheckStatus(),F.showMessage(i,5e3,"info")}onunload(){se("Plugin unload"),this.toolbarItem.release(),G.save(),fe.save(),this.upToDate&&(se(`清理定时器 ${this.upToDate}`),clearTimeout(this.upToDate),this.upToDate=null),this.enableBlockIconClickEvent&&this.gutterMenu.release()}}module.exports=Eo;
