"use strict";var Ri=Object.defineProperty;var Ni=(n,e,t)=>e in n?Ri(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var I=(n,e,t)=>(Ni(n,typeof e!="symbol"?e+"":e,t),t);const H=require("siyuan");function ne(){}function Pi(n){return!!n&&(typeof n=="object"||typeof n=="function")&&typeof n.then=="function"}function Gn(n){return n()}function Zt(){return Object.create(null)}function ae(n){n.forEach(Gn)}function jn(n){return typeof n=="function"}function Ae(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function xi(n){return Object.keys(n).length===0}function p(n,e){n.appendChild(e)}function J(n,e,t){n.insertBefore(e,t||null)}function K(n){n.parentNode&&n.parentNode.removeChild(n)}function je(n,e){for(let t=0;t<n.length;t+=1)n[t]&&n[t].d(e)}function v(n){return document.createElement(n)}function ie(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}function me(n){return document.createTextNode(n)}function Y(){return me(" ")}function Ht(){return me("")}function z(n,e,t,i){return n.addEventListener(e,t,i),()=>n.removeEventListener(e,t,i)}function g(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function De(n,e,t){n.setAttributeNS("http://www.w3.org/1999/xlink",e,t)}function Ci(n){return Array.from(n.childNodes)}function ze(n,e){e=""+e,n.wholeText!==e&&(n.data=e)}function Jt(n,e){n.value=e??""}function Ue(n,e,t,i){t===null?n.style.removeProperty(e):n.style.setProperty(e,t,i?"important":"")}function Xt(n,e,t){for(let i=0;i<n.options.length;i+=1){const s=n.options[i];if(s.__value===e){s.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function Ii(n){const e=n.querySelector(":checked");return e&&e.__value}function Qt(n,e,t){n.classList[t?"add":"remove"](e)}function Bi(n,e,{bubbles:t=!1,cancelable:i=!1}={}){const s=document.createEvent("CustomEvent");return s.initCustomEvent(n,t,i,e),s}class Ui{constructor(e=!1){this.is_svg=!1,this.is_svg=e,this.e=this.n=null}c(e){this.h(e)}m(e,t,i=null){this.e||(this.is_svg?this.e=ie(t.nodeName):this.e=v(t.nodeType===11?"TEMPLATE":t.nodeName),this.t=t.tagName!=="TEMPLATE"?t:t.content,this.c(e)),this.i(i)}h(e){this.e.innerHTML=e,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(e){for(let t=0;t<this.n.length;t+=1)J(this.t,this.n[t],e)}p(e){this.d(),this.h(e),this.i(this.a)}d(){this.n.forEach(K)}}let Ve;function we(n){Ve=n}function ft(){if(!Ve)throw new Error("Function called outside component initialization");return Ve}function zn(n){ft().$$.on_mount.push(n)}function Li(n){ft().$$.on_destroy.push(n)}function Ft(){const n=ft();return(e,t,{cancelable:i=!1}={})=>{const s=n.$$.callbacks[e];if(s){const r=Bi(e,t,{cancelable:i});return s.slice().forEach(a=>{a.call(n,r)}),!r.defaultPrevented}return!0}}const Ie=[],qe=[];let Be=[];const Nt=[],Hi=Promise.resolve();let Pt=!1;function Fi(){Pt||(Pt=!0,Hi.then(Yt))}function ct(n){Be.push(n)}function Yi(n){Nt.push(n)}const Tt=new Set;let xe=0;function Yt(){if(xe!==0)return;const n=Ve;do{try{for(;xe<Ie.length;){const e=Ie[xe];xe++,we(e),Wi(e.$$)}}catch(e){throw Ie.length=0,xe=0,e}for(we(null),Ie.length=0,xe=0;qe.length;)qe.pop()();for(let e=0;e<Be.length;e+=1){const t=Be[e];Tt.has(t)||(Tt.add(t),t())}Be.length=0}while(Ie.length);for(;Nt.length;)Nt.pop()();Pt=!1,Tt.clear(),we(n)}function Wi(n){if(n.fragment!==null){n.update(),ae(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(ct)}}function Gi(n){const e=[],t=[];Be.forEach(i=>n.indexOf(i)===-1?e.push(i):t.push(i)),t.forEach(i=>i()),Be=e}const ot=new Set;let Se;function Ke(){Se={r:0,c:[],p:Se}}function Ze(){Se.r||ae(Se.c),Se=Se.p}function se(n,e){n&&n.i&&(ot.delete(n),n.i(e))}function de(n,e,t,i){if(n&&n.o){if(ot.has(n))return;ot.add(n),Se.c.push(()=>{ot.delete(n),i&&(t&&n.d(1),i())}),n.o(e)}else i&&i()}function ji(n,e){const t=e.token={};function i(s,r,a,o){if(e.token!==t)return;e.resolved=o;let l=e.ctx;a!==void 0&&(l=l.slice(),l[a]=o);const c=s&&(e.current=s)(l);let f=!1;e.block&&(e.blocks?e.blocks.forEach((d,m)=>{m!==r&&d&&(Ke(),de(d,1,1,()=>{e.blocks[m]===d&&(e.blocks[m]=null)}),Ze())}):e.block.d(1),c.c(),se(c,1),c.m(e.mount(),e.anchor),f=!0),e.block=c,e.blocks&&(e.blocks[r]=c),f&&Yt()}if(Pi(n)){const s=ft();if(n.then(r=>{we(s),i(e.then,1,e.value,r),we(null)},r=>{if(we(s),i(e.catch,2,e.error,r),we(null),!e.hasCatch)throw r}),e.current!==e.pending)return i(e.pending,0),!0}else{if(e.current!==e.then)return i(e.then,1,e.value,n),!0;e.resolved=n}}function zi(n,e,t){const i=e.slice(),{resolved:s}=n;n.current===n.then&&(i[n.value]=s),n.current===n.catch&&(i[n.error]=s),n.block.p(i,t)}function Vi(n,e){n.d(1),e.delete(n.key)}function qi(n,e){de(n,1,1,()=>{e.delete(n.key)})}function Vn(n,e,t,i,s,r,a,o,l,c,f,d){let m=n.length,u=r.length,h=m;const D={};for(;h--;)D[n[h].key]=h;const M=[],w=new Map,q=new Map,x=[];for(h=u;h--;){const S=d(s,r,h),B=t(S);let $=a.get(B);$?i&&x.push(()=>$.p(S,e)):($=c(B,S),$.c()),w.set(B,M[h]=$),B in D&&q.set(B,Math.abs(h-D[B]))}const R=new Set,C=new Set;function T(S){se(S,1),S.m(o,f),a.set(S.key,S),f=S.first,u--}for(;m&&u;){const S=M[u-1],B=n[m-1],$=S.key,E=B.key;S===B?(f=S.first,m--,u--):w.has(E)?!a.has($)||R.has($)?T(S):C.has(E)?m--:q.get($)>q.get(E)?(C.add($),T(S)):(R.add(E),m--):(l(B,a),m--)}for(;m--;){const S=n[m];w.has(S.key)||l(S,a)}for(;u;)T(M[u-1]);return ae(x),M}function Ki(n,e,t){const i=n.$$.props[e];i!==void 0&&(n.$$.bound[i]=t,t(n.$$.ctx[i]))}function ht(n){n&&n.c()}function Je(n,e,t,i){const{fragment:s,after_update:r}=n.$$;s&&s.m(e,t),i||ct(()=>{const a=n.$$.on_mount.map(Gn).filter(jn);n.$$.on_destroy?n.$$.on_destroy.push(...a):ae(a),n.$$.on_mount=[]}),r.forEach(ct)}function Xe(n,e){const t=n.$$;t.fragment!==null&&(Gi(t.after_update),ae(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Zi(n,e){n.$$.dirty[0]===-1&&(Ie.push(n),Fi(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function Oe(n,e,t,i,s,r,a,o=[-1]){const l=Ve;we(n);const c=n.$$={fragment:null,ctx:[],props:r,update:ne,not_equal:s,bound:Zt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:Zt(),dirty:o,skip_bound:!1,root:e.target||l.$$.root};a&&a(c.root);let f=!1;if(c.ctx=t?t(n,e.props||{},(d,m,...u)=>{const h=u.length?u[0]:m;return c.ctx&&s(c.ctx[d],c.ctx[d]=h)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](h),f&&Zi(n,d)),m}):[],c.update(),f=!0,ae(c.before_update),c.fragment=i?i(c.ctx):!1,e.target){if(e.hydrate){const d=Ci(e.target);c.fragment&&c.fragment.l(d),d.forEach(K)}else c.fragment&&c.fragment.c();e.intro&&se(n.$$.fragment),Je(n,e.target,e.anchor,e.customElement),Yt()}we(l)}class Re{$destroy(){Xe(this,1),this.$destroy=ne}$on(e,t){if(!jn(t))return ne;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const s=i.indexOf(t);s!==-1&&i.splice(s,1)}}$set(e){this.$$set&&!xi(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}class Ji{constructor(){I(this,"events",{});I(this,"EventUpdateAll","UpdateAll");I(this,"EventSetting","UpdateSetting");I(this,"EventSettingLoaded","SettingLoaded")}subscribe(e,t){e in this.events?this.events[e].push(t):this.events[e]=[t]}unSubscribe(e,t){if(e in this.events){let i=this.events[e].indexOf(t);i>=0&&this.events[e].splice(i,1)}}publish(e,t){this.events[e]&&this.events[e].forEach(i=>i(t))}}const Q=new Ji;async function Z(n,e){let t=await H.fetchSyncPost(n,e);return t.code===0?t.data:null}async function pe(n){return Z("/api/query/sql",{stmt:n})}async function qn(){return Z("/api/notebook/lsNotebooks","")}async function Kn(n,e,t){return Z("/api/filetree/createDocWithMd",{notebook:n,path:e,markdown:t})}async function Xi(n,e){return Z("/api/filetree/createDailyNote",{notebook:n,app:e})}async function Qi(n){return Z("/api/notebook/getNotebookConf",{notebook:n})}async function Zn(n,e,t){return Z("/api/filetree/moveDocs",{fromPaths:n,toNotebook:e,toPath:t})}async function xt(n,e){return Z("/api/filetree/removeDoc",{notebook:n,path:e})}async function Jn(n,e,t){return Z("/api/filetree/renameDoc",{notebook:n,path:e,title:t})}async function Xn(n,e,t){return Z("/api/filetree/doc2Heading",{srcID:n,targetID:e,after:t})}async function gt(n){let e=`select * from blocks where id ='${n}'`;return(await pe(e))[0]}async function es(n){return Z("/api/block/getTreeStat",{id:n})}async function ts(n){return Z("/api/block/getChildBlocks",{id:n})}async function vt(n,e=null,t=null){return Z("/api/block/moveBlock",{id:n,previousID:e,parentID:t})}async function Qn(n,e,t){return Z("/api/block/prependBlock",{data:e,parentID:n,dataType:t})}async function Wt(n,e,t){return Z("/api/block/appendBlock",{data:e,parentID:n,dataType:t})}async function ns(n){return Z("/api/block/deleteBlock",{id:n})}async function is(n,e,t){return Z("/api/block/updateBlock",{id:n,data:e,dataType:t})}async function ei(n){return Z("/api/template/renderSprig",{template:n})}async function ss(n){return Z("/api/block/getBlockKramdown",{id:n})}async function Me(n,e){return Z("/api/attr/setBlockAttrs",{id:n,attrs:e})}async function rs(n){return Z("/api/attr/getBlockAttrs",{id:n})}async function as(n,e="",t=""){let i={session:e,app:t,reqId:new Date().getTime(),transactions:[{doOperations:[{action:"foldHeading",id:n}],undoOperations:[{action:"unfoldHeading",id:n}]}]};return Z("/api/transactions",i)}async function os(n,e="",t=""){let i={session:e,app:t,reqId:new Date().getTime(),transactions:[{doOperations:[{action:"unfoldHeading",id:n}],undoOperations:[{action:"foldHeading",id:n}]}]};return Z("/api/transactions",i)}class ls{constructor(){I(this,"notebooks");I(this,"default");this.notebooks=[]}get(e){return this.notebooks[e]}set(e,t){this.notebooks[e]=t}find(e){for(const t of this.notebooks)if(t.id===e)return t;return null}[Symbol.iterator](){return this.notebooks[Symbol.iterator]()}async init(e=5,t=1e3){let i=0;for(;i<e;){let s=await nn();if(s!=null){this.notebooks=s;break}else await new Promise(r=>setTimeout(r,t));i++}this.updateDefault()}async update(){let e=await nn();this.notebooks=e||[],this.updateDefault()}updateDefault(){let e=G.get("DefaultNotebook");if(e=e.trim(),e!=""){let t=this.find(e);t?this.default=t:this.default=void 0}else this.default=this.get(0)}}const ee=new ls,ti=window.Lute.New();async function cs(n,e,t){let i=1,s=null;for(;i<=t;){if(s=await n(),s)return console.debug(`[${i} / ${t}] Success ${n.name}`),s;console.debug(`[${i} / ${t}] Wait ${e}ms and retry ${n.name}`),await new Promise(r=>setTimeout(r,e)),i++}return console.warn(`[${i} / ${t}] Reach max times ${n.name}`),s}let O;function us(n){O=n}let Qe;function ds(n){Qe=n}let We;function fs(n){We=n}let ni;function hs(n){ni=n}function en(n,e){return n.length>e?n.slice(0,e)+"...":n}function tn(n,e){let t=[];for(let i=0;i<n.length;i+=e)t.push(n.slice(i,i+e));return t.join(`
`)}function ii(n){let e=n.slice(0,4),t=n.slice(4,6),i=n.slice(6,8),s=n.slice(8,10),r=n.slice(10,12),a=n.slice(12,14);return`${e}-${t}-${i} ${s}:${r}:${a}`}function gs(n){return!!(n&&n instanceof HTMLElement&&n.dataset.type&&n.dataset.nodeId&&/^\d{14}-[0-9a-z]{7}$/.test(n.dataset.nodeId))}function ms(){const n=document.getSelection();let e=n==null?void 0:n.focusNode;for(;e&&(!(e instanceof HTMLElement)||!gs(e));)e=e.parentElement;return e}class ps{constructor(){I(this,"Timer",{});I(this,"DefaultTimer",null)}getTimer(e){return e?this.Timer[e]:this.DefaultTimer}setTimer(e,t){t?this.Timer[t]=e:this.DefaultTimer=e}clearTimer(e){let t=this.getTimer(e);t&&(clearTimeout(t),this.setTimer(null,e))}debounce(e,t=20,i){return(...r)=>{this.clearTimer(i);let a=setTimeout(()=>e(...r),t);this.setTimer(a,i)}}}const ys=new ps,_s='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',bs=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function nn(){try{let e=(await qn()).notebooks;e=e.filter(i=>!i.closed&&!bs.has(i.name));let t=e.map(i=>i.name);for(let i of e){let s=await vs(i.id);i.dailynoteSprig=s!=""?s:_s,i.dailynoteHpath=await ks(i.dailynoteSprig);const r=await Ds(i.id);if(r.length>0){const a=r[0];i.dailyNoteDocId=a.id,i.dailynoteHpath=a.hpath}r.length>1&&H.showMessage(`Warning: More than one daily-notes are founded in ${i.name}`,5,"error"),i.icon==""&&(i.icon="1f5c3")}return console.debug(`Read all notebooks: ${t}`),e}catch(n){return console.error(n),null}}async function Le(n,e=null){let t=`select * from blocks where type='d' and hpath = '${n}'`;return e!=null&&(t=`select * from blocks where type='d' and hpath = '${n}' and box = '${e.id}'`),await pe(t)}async function ws(n){const t=`select distinct id from blocks where id in (${n.map(r=>`'${r}'`).join(",")})`;let i=await pe(t),s=new Set;return i.forEach(r=>{s.add(r.id)}),s}function Ts(n){H.openTab({app:We,doc:{id:n,action:["cb-get-focus"],zoomIn:!0}})}function mt(n,e=""){n=n===void 0?new Date:n;let t=n.getFullYear(),i=n.getMonth()+1,s=n.getDate();return`${t}${e}${i<10?"0"+i:i}${e}${s<10?"0"+s:s}`}async function vs(n){return(await Qi(n)).conf.dailyNoteSavePath}async function Ds(n){const t=`
    select distinct B.* from blocks as B join attributes as A
    on B.id = A.block_id
    where A.name = 'custom-dailynote-${mt(new Date)}' and B.box = '${n}'
    `;return await pe(t)}async function ks(n){return await ei(n)}async function $s(){let n=new Set;ee.notebooks.forEach(i=>{n.add(i.dailynoteHpath)});let e=new Map,t=0;for(const i of n){let s=await Le(i);if(s.length>0){let r=s.map(a=>a.box);r.forEach(a=>{e.set(a,!0)}),t+=r.length}}return console.log(`更新日记状态: 当前日记共 ${t} 篇`),e}function si(n,e){let t=mt(e),i=`custom-dailynote-${t}`,s={};s[i]=t,Me(n,s)}async function ri(n,e){let t=await Kn(n.id,e,"");return console.log(`创建日记: ${n.name} ${e}`),si(t),n.dailyNoteDocId=t,t}async function Ct(n){let e=We.appId,t=await Xi(n.id,e);t&&(n.dailyNoteDocId=t==null?void 0:t.id),H.showMessage(`${O.Open}: ${n.name}`,2e3,"info"),Qe===!0?H.openMobileFileById(We,t.id,["cb-get-all"]):H.openTab({app:We,doc:{id:t.id,zoomIn:!1}})}async function Es(){if(console.debug("自动开启日记"),Qe&&G.get("DisableAutoCreateOnMobile")===!0)return;if(new URL(window.location.href).pathname.startsWith("/stage/build/app/window.html")){console.debug("小窗模式, 无需自动打开日记");return}if(ee.notebooks.length>0&&G.settings.OpenOnStart===!0){let e=G.get("DefaultNotebook"),t=ee.default;if(t)await Ct(t);else{H.confirm(O.Name,`${e} ${O.InvalidDefaultNotebook}`);return}}}async function Ss(n,e){var s;H.showMessage("Merging",1e3,"info");let t=await Wt(n.id,O.ConflictDiary.HeadingMarkdown,"markdown"),i=(s=t==null?void 0:t[0])==null?void 0:s.doOperations[0].id;if(i===void 0)return console.error("无法获取最新日记的最后一个 block id"),!1;for(let r of e){let a=r.id,o=r.created,l=ii(o);await Jn(r.box,r.path,`${r.content} [${l}]`),await Xn(a,i,!0),console.debug(`Merge doc ${a}`)}return!0}async function Ms(n,e){H.showMessage("Deleting",1e3,"info");let t=[];for(let i of e)t.push(xt(i.box,i.path)),console.debug(`Remove doc ${i.id}`);return await Promise.all(t),!0}async function As(n,e){var s;H.showMessage("Smart Merging",1e3,"info");let t=await Wt(n.id,O.ConflictDiary.HeadingMarkdown,"markdown"),i=(s=t==null?void 0:t[0])==null?void 0:s.doOperations[0].id;if(i===void 0)return console.error("无法获取最新日记的最后一个 block id"),!1;for(let r of e){let a=r.id,o=r.created,l=r.updated,c=await es(a),f=!0;if(Object.keys(c).forEach(m=>{c[m]!=0&&(f=!1)}),f){await xt(r.box,r.path),console.debug(`Remove empty doc ${a}`);continue}if(c.refCount==0&&c.linkCount==0&&parseInt(o)+3>=parseInt(l))await xt(r.box,r.path),console.debug(`Remove not modified doc ${a} ${o} ${l}`);else{let m=ii(o);await Jn(r.box,r.path,`${r.content} [${m}]`),await Xn(a,i,!0),console.debug(`Merge doc ${a}`)}}return!0}const Os=async(n,e)=>{let t=await rs(n.id),i={};for(let s in t)e.test(s)&&(i[s]="");Me(n.id,i)},Rs=async n=>{const e=`
    select B.* from blocks as B join attributes as A
    on A.block_id = B.id
    where B.box = '${n.box}' and B.type = 'd' and A.name = 'custom-dn-trash-bin'
    `;let t=await pe(e),i;if(t.length===0){let a,o=n.hpath.split("/").filter(l=>l!=="");if(o.length===0)return console.error("无法获取回收站日记本的路径"),null;o.length===1?a="/trash-bin":a=`/${o[0]}/trash-bin`,i=await Kn(n.box,a,O.TrashBinDocContent),await new Promise(l=>setTimeout(l,1e3)),await Me(i,{"custom-dn-trash-bin":"true"})}else i=t[0].id;console.debug(`Get trash bin doc, id=${i}`);let s=null;return s=await cs(async()=>Z("/api/block/getBlockInfo",{id:i}),1e3,5),s};async function Ns(n,e){let t=await Rs(n);if(!t||!t.box||!t.path)return console.error("Can not get trash bin doc"),!1;let i=[];return e.forEach(s=>{i.push(s.path),Os(s,/custom-dailynote-\d+/)}),Zn(i,t.box,t.path),!0}const Dt={AllMerge:Ss,DeleteDup:Ms,SmartMerge:As,TrashDup:Ns};function Ps(n,e,t){let i=[];n.forEach((o,l)=>{let c=o.id,f=o.created;f=`${f.slice(0,4)}-${f.slice(4,6)}-${f.slice(6,8)} ${f.slice(8,10)}:${f.slice(10,12)}:${f.slice(12,14)}`;let d=o.updated;d=`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)} ${d.slice(8,10)}:${d.slice(10,12)}:${d.slice(12,14)}`;let m=[c,o.content,f,d,e.name];l===n.length-1&&(m=m.map(h=>`**${h}**`));let u=m.join(" | ")+` |
`;i.push(u)});let s=O.ConflictDiary.part1.join(`
`)+`
`;for(let o of i)s+=o;s+=`
`+O.ConflictDiary.part2.join(`
`),s=ti.Md2HTML(s);const r=O.Setting.AutoHandleDuplicateMethod.options;return`
        <div class="b3-typography typofont-1rem"
            style="margin: 0.5rem; flex: 1;"
        >
            ${s}
            ${t?O.ConflictDiary.part3.join(`
`):""}
        </div>
        <div class="b3-dialog__action">
            <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--text" data-method="AllMerge">${r.AllMerge}</button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--text" data-method="SmartMerge">${r.SmartMerge}</button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--text" data-method="DeleteDup">${r.DeleteDup}</button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--text" data-method="TrashDup">${r.TrashDup}</button>
        </div>
        `}function xs(n){let e=n.map(i=>i.path);e=e.map(i=>i.slice(0,i.lastIndexOf("/")));let t=!0;for(let i=1;i<e.length;i++)if(e[i]!==e[0]){t=!1;break}return!t}const Cs=async(n,e)=>{n=n.sort((r,a)=>r.created>=a.created?-1:1);let t=n.pop();e=e||G.get("AutoHandleDuplicateMethod"),console.debug(`Handle duplicate method: ${e}`),await((Dt==null?void 0:Dt[e])||((...r)=>(console.error(`No such method: ${e}`),!1)))(t,n)?H.showMessage(O.ConflictDiary.success,2e3,"info"):H.showMessage(O.ConflictDiary.fail,2e3,"error")};async function Is(){var l;let n=ee.default,e=n.dailynoteHpath,t=await Le(e,n);if(t.length<=1)return!1;let i=new Set,s=[];if(t.forEach(c=>{i.has(c.id)||(s.push(c),i.add(c.id))}),t=s,t.length<=1)return!1;t=t.sort((c,f)=>c.created>=f.created?-1:1);const r=xs(t);console.warn(`Conflict daily note: ${n.name} ${e}`);const a=Ps(t,n,r);let o=new H.Dialog({title:O.Name,content:a,width:Qe?"90%":"47rem"});return(l=o.element.querySelector(".b3-dialog__action"))==null||l.addEventListener("click",async c=>{let f=c.target;if(!f||!f.classList.contains("b3-button"))return;if(f.classList.contains("b3-button--cancel")){o.destroy();return}let d=f.dataset.method;await Cs(t,d),o.destroy()}),!0}async function Bs(n,e){if(typeof n=="string"&&(n=ee.find(n)),n===null)return null;let t=n==null?void 0:n.dailynoteSprig;if(t===void 0)return null;let s=`toDate "2006-01-02" "${mt(e,"-")}"`;return t=t.replaceAll(/now/g,s),await ei(t)}async function Us(n,e){let t=await Bs(n,e);if(t===null)return null;let i=await Le(t,n);return{date:e,hpath:t,docs:i.length===0?null:i}}async function Ls(n,e,t,i){if((n==null?void 0:n.dailynoteSprig)===void 0)return[];t=t===void 0?new Date:t,e.setHours(0,0,0,0);let r=new Date(t);r.setHours(0,0,0,0);let a=[];for(;r>=e;)a.push(r),r=new Date(r),r.setDate(r.getDate()-1);let o=a.map(async c=>{let f=await Us(n,c);return i!=null&&i(f),f}),l=await Promise.all(o);return l=l.filter(c=>c.docs!==null),l}async function ai(n){let e=n==null?void 0:n.dailynoteSprig;if(e==null||e==="")return null;e.startsWith("/")&&(e=e.substring(1));let t=e.split("/"),i="";for(let m=0;m<t.length;m++){let u=t[m];if(u.match("{{")!==null)break;i+=`/${u}`}let s=`
        select * from blocks where box='${n.id}' and hpath like '${i}%' and type='d'
        order by created asc limit 1;`,r=await pe(s);if(r.length===0)return console.warn(`未找到日记本 ${n.name} 的日记`),null;let o=r[0].created,l=o.substring(0,4),c=o.substring(4,6),f=o.substring(6,8);return new Date(`${l}-${c}-${f}`)}async function Hs(n,e){return e=e!==void 0?e:await ai(n),e===null?[]:await Ls(n,e,new Date,async i=>{i.docs!==null&&i.docs.forEach(async s=>{si(s.id,i.date)})})}function Fs(n,e){return n.length>e?n.slice(0,e)+"...":n}class Gt{constructor(e,t,i){I(this,"resvBlockIds");I(this,"dstDocId");I(this,"position");I(this,"retvBlock");this.position=e,this.resvBlockIds=t,this.dstDocId=i}async checkRetv(){let e=`select * from blocks where path like "%${this.dstDocId}%" and name = "Reservation"`,t=await pe(e);return this.retvBlock=t.length>0?t[0]:void 0,t}async insertRetrieve(e){let t;this.position==="bottom"?t=await Wt(this.dstDocId,e,"markdown"):t=await Qn(this.dstDocId,e,"markdown");let i=t[0].doOperations[0].id;Me(i,{name:"Reservation",breadcrumb:"true"})}async updateRetrieve(e){is(this.retvBlock.id,e,"markdown"),Me(this.retvBlock.id,{name:"Reservation",breadcrumb:"true"})}async retrieveResvBlocks(){let e=[];for(let t of this.resvBlockIds){let i=await gt(t);i?e.push({id:i.id,content:Fs(i.content,50)}):e.push({id:t,content:void 0})}return e}async insert(){let e=await this.createContent();this.insertRetrieve(e)}async update(){let e=await this.createContent();this.updateRetrieve(e)}}class Ys extends Gt{createContent(){return`{{${`select * from blocks where id in (${this.resvBlockIds.map(s=>`"${s}"`).join(",")})`}}}`}}class Ws extends Gt{async createContent(){let e=await this.retrieveResvBlocks(),t=[];for(let s of e)s.content?t.push(`* [ ] [${s.content}](siyuan://blocks/${s.id})`):t.push(`* [x] \`${s.id}\` not found`);return t.join(`
`)}}class Gs extends Gt{async createContent(){let e=await this.retrieveResvBlocks(),t=[];for(let s of e)s.content?t.push(`* [ ] ((${s.id} "${s.content}"))`):t.push(`* [x] \`${s.id}\` not found`);return t.join(`
`)}}function js(n,e,t,i){let s;switch(n){case"embed":s=new Ys(e,t,i);break;case"link":s=new Ws(e,t,i);break;case"ref":s=new Gs(e,t,i);break;default:throw new Error("unknown type")}return s}async function zs(n){let e="";n==="today"?e="A.value = strftime('%Y%m%d', datetime('now'))":n==="future"&&(e="A.value >= strftime('%Y%m%d', datetime('now'))");let t=`select B.id, B.content, A.value as date from blocks as B inner join attributes as A
        on(A.block_id = B.id and  A.name = 'custom-reservation' and ${e}) order by A.value;`,i=await pe(t);return console.debug(i),i}const Vs=()=>!!document.getElementById("sidebar"),qs=(n,e,t,i)=>{const s=new H.Dialog({title:n,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:Vs()?"92vw":"520px"}),r=s.element.querySelectorAll(".b3-button");r[0].addEventListener("click",()=>{i&&i(),s.destroy()}),r[1].addEventListener("click",()=>{t&&t(),s.destroy()});let a=s.element.querySelector(".b3-dialog__container");a.style.maxHeight="50%"};function oi(n,e){const t=e.replace(/\((?!\?)/g,"(?:");return`${n}${t}\\s{0,5}(?:,?\\s{0,5}${t}){0,10}`}function Ks(n){let e;return n instanceof Array?e=[...n]:n instanceof Map?e=Array.from(n.keys()):e=Object.keys(n),e}function ye(n){return`(?:${Ks(n).sort((t,i)=>i.length-t.length).join("|").replace(/\./g,"\\.")})`}var li=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ci(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ui={exports:{}};(function(n,e){(function(t,i){n.exports=i()})(li,function(){var t=1e3,i=6e4,s=36e5,r="millisecond",a="second",o="minute",l="hour",c="day",f="week",d="month",m="quarter",u="year",h="date",D="Invalid Date",M=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,w=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,q={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(A){var b=["th","st","nd","rd"],y=A%100;return"["+A+(b[(y-20)%10]||b[y]||b[0])+"]"}},x=function(A,b,y){var k=String(A);return!k||k.length>=b?A:""+Array(b+1-k.length).join(y)+A},R={s:x,z:function(A){var b=-A.utcOffset(),y=Math.abs(b),k=Math.floor(y/60),_=y%60;return(b<=0?"+":"-")+x(k,2,"0")+":"+x(_,2,"0")},m:function A(b,y){if(b.date()<y.date())return-A(y,b);var k=12*(y.year()-b.year())+(y.month()-b.month()),_=b.clone().add(k,d),N=y-_<0,P=b.clone().add(k+(N?-1:1),d);return+(-(k+(y-_)/(N?_-P:P-_))||0)},a:function(A){return A<0?Math.ceil(A)||0:Math.floor(A)},p:function(A){return{M:d,y:u,w:f,d:c,D:h,h:l,m:o,s:a,ms:r,Q:m}[A]||String(A||"").toLowerCase().replace(/s$/,"")},u:function(A){return A===void 0}},C="en",T={};T[C]=q;var S=function(A){return A instanceof _e},B=function A(b,y,k){var _;if(!b)return C;if(typeof b=="string"){var N=b.toLowerCase();T[N]&&(_=N),y&&(T[N]=y,_=N);var P=b.split("-");if(!_&&P.length>1)return A(P[0])}else{var U=b.name;T[U]=b,_=U}return!k&&_&&(C=_),_||!k&&C},$=function(A,b){if(S(A))return A.clone();var y=typeof b=="object"?b:{};return y.date=A,y.args=arguments,new _e(y)},E=R;E.l=B,E.i=S,E.w=function(A,b){return $(A,{locale:b.$L,utc:b.$u,x:b.$x,$offset:b.$offset})};var _e=function(){function A(y){this.$L=B(y.locale,null,!0),this.parse(y)}var b=A.prototype;return b.parse=function(y){this.$d=function(k){var _=k.date,N=k.utc;if(_===null)return new Date(NaN);if(E.u(_))return new Date;if(_ instanceof Date)return new Date(_);if(typeof _=="string"&&!/Z$/i.test(_)){var P=_.match(M);if(P){var U=P[2]-1||0,F=(P[7]||"0").substring(0,3);return N?new Date(Date.UTC(P[1],U,P[3]||1,P[4]||0,P[5]||0,P[6]||0,F)):new Date(P[1],U,P[3]||1,P[4]||0,P[5]||0,P[6]||0,F)}}return new Date(_)}(y),this.$x=y.x||{},this.init()},b.init=function(){var y=this.$d;this.$y=y.getFullYear(),this.$M=y.getMonth(),this.$D=y.getDate(),this.$W=y.getDay(),this.$H=y.getHours(),this.$m=y.getMinutes(),this.$s=y.getSeconds(),this.$ms=y.getMilliseconds()},b.$utils=function(){return E},b.isValid=function(){return this.$d.toString()!==D},b.isSame=function(y,k){var _=$(y);return this.startOf(k)<=_&&_<=this.endOf(k)},b.isAfter=function(y,k){return $(y)<this.startOf(k)},b.isBefore=function(y,k){return this.endOf(k)<$(y)},b.$g=function(y,k,_){return E.u(y)?this[k]:this.set(_,y)},b.unix=function(){return Math.floor(this.valueOf()/1e3)},b.valueOf=function(){return this.$d.getTime()},b.startOf=function(y,k){var _=this,N=!!E.u(k)||k,P=E.p(y),U=function(be,j){var le=E.w(_.$u?Date.UTC(_.$y,j,be):new Date(_.$y,j,be),_);return N?le:le.endOf(c)},F=function(be,j){return E.w(_.toDate()[be].apply(_.toDate("s"),(N?[0,0,0,0]:[23,59,59,999]).slice(j)),_)},L=this.$W,X=this.$M,fe=this.$D,he="set"+(this.$u?"UTC":"");switch(P){case u:return N?U(1,0):U(31,11);case d:return N?U(1,X):U(0,X+1);case f:var Te=this.$locale().weekStart||0,oe=(L<Te?L+7:L)-Te;return U(N?fe-oe:fe+(6-oe),X);case c:case h:return F(he+"Hours",0);case l:return F(he+"Minutes",1);case o:return F(he+"Seconds",2);case a:return F(he+"Milliseconds",3);default:return this.clone()}},b.endOf=function(y){return this.startOf(y,!1)},b.$set=function(y,k){var _,N=E.p(y),P="set"+(this.$u?"UTC":""),U=(_={},_[c]=P+"Date",_[h]=P+"Date",_[d]=P+"Month",_[u]=P+"FullYear",_[l]=P+"Hours",_[o]=P+"Minutes",_[a]=P+"Seconds",_[r]=P+"Milliseconds",_)[N],F=N===c?this.$D+(k-this.$W):k;if(N===d||N===u){var L=this.clone().set(h,1);L.$d[U](F),L.init(),this.$d=L.set(h,Math.min(this.$D,L.daysInMonth())).$d}else U&&this.$d[U](F);return this.init(),this},b.set=function(y,k){return this.clone().$set(y,k)},b.get=function(y){return this[E.p(y)]()},b.add=function(y,k){var _,N=this;y=Number(y);var P=E.p(k),U=function(X){var fe=$(N);return E.w(fe.date(fe.date()+Math.round(X*y)),N)};if(P===d)return this.set(d,this.$M+y);if(P===u)return this.set(u,this.$y+y);if(P===c)return U(1);if(P===f)return U(7);var F=(_={},_[o]=i,_[l]=s,_[a]=t,_)[P]||1,L=this.$d.getTime()+y*F;return E.w(L,this)},b.subtract=function(y,k){return this.add(-1*y,k)},b.format=function(y){var k=this,_=this.$locale();if(!this.isValid())return _.invalidDate||D;var N=y||"YYYY-MM-DDTHH:mm:ssZ",P=E.z(this),U=this.$H,F=this.$m,L=this.$M,X=_.weekdays,fe=_.months,he=function(j,le,Ee,it){return j&&(j[le]||j(k,N))||Ee[le].slice(0,it)},Te=function(j){return E.s(U%12||12,j,"0")},oe=_.meridiem||function(j,le,Ee){var it=j<12?"AM":"PM";return Ee?it.toLowerCase():it},be={YY:String(this.$y).slice(-2),YYYY:E.s(this.$y,4,"0"),M:L+1,MM:E.s(L+1,2,"0"),MMM:he(_.monthsShort,L,fe,3),MMMM:he(fe,L),D:this.$D,DD:E.s(this.$D,2,"0"),d:String(this.$W),dd:he(_.weekdaysMin,this.$W,X,2),ddd:he(_.weekdaysShort,this.$W,X,3),dddd:X[this.$W],H:String(U),HH:E.s(U,2,"0"),h:Te(1),hh:Te(2),a:oe(U,F,!0),A:oe(U,F,!1),m:String(F),mm:E.s(F,2,"0"),s:String(this.$s),ss:E.s(this.$s,2,"0"),SSS:E.s(this.$ms,3,"0"),Z:P};return N.replace(w,function(j,le){return le||be[j]||P.replace(":","")})},b.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},b.diff=function(y,k,_){var N,P=E.p(k),U=$(y),F=(U.utcOffset()-this.utcOffset())*i,L=this-U,X=E.m(this,U);return X=(N={},N[u]=X/12,N[d]=X,N[m]=X/3,N[f]=(L-F)/6048e5,N[c]=(L-F)/864e5,N[l]=L/s,N[o]=L/i,N[a]=L/t,N)[P]||L,_?X:E.a(X)},b.daysInMonth=function(){return this.endOf(d).$D},b.$locale=function(){return T[this.$L]},b.locale=function(y,k){if(!y)return this.$L;var _=this.clone(),N=B(y,k,!0);return N&&(_.$L=N),_},b.clone=function(){return E.w(this.$d,this)},b.toDate=function(){return new Date(this.valueOf())},b.toJSON=function(){return this.isValid()?this.toISOString():null},b.toISOString=function(){return this.$d.toISOString()},b.toString=function(){return this.$d.toUTCString()},A}(),Pe=_e.prototype;return $.prototype=Pe,[["$ms",r],["$s",a],["$m",o],["$H",l],["$W",c],["$M",d],["$y",u],["$D",h]].forEach(function(A){Pe[A[1]]=function(b){return this.$g(b,A[0],A[1])}}),$.extend=function(A,b){return A.$i||(A(b,_e,$),A.$i=!0),$},$.locale=B,$.isDayjs=S,$.unix=function(A){return $(1e3*A)},$.en=T[C],$.Ls=T,$.p={},$})})(ui);var Zs=ui.exports;const re=ci(Zs);function di(n){return n<100&&(n>50?n=n+1900:n=n+2e3),n}function pt(n,e,t){const i=re(n);let s=i;s=s.month(t-1),s=s.date(e),s=s.year(i.year());const r=s.add(1,"y"),a=s.add(-1,"y");return Math.abs(r.diff(i))<Math.abs(s.diff(i))?s=r:Math.abs(a.diff(i))<Math.abs(s.diff(i))&&(s=a),s.year()}const fi={sunday:0,sun:0,"sun.":0,monday:1,mon:1,"mon.":1,tuesday:2,tue:2,"tue.":2,wednesday:3,wed:3,"wed.":3,thursday:4,thurs:4,"thurs.":4,thur:4,"thur.":4,thu:4,"thu.":4,friday:5,fri:5,"fri.":5,saturday:6,sat:6,"sat.":6},hi={january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12},$e={...hi,jan:1,"jan.":1,feb:2,"feb.":2,mar:3,"mar.":3,apr:4,"apr.":4,jun:6,"jun.":6,jul:7,"jul.":7,aug:8,"aug.":8,sep:9,"sep.":9,sept:9,"sept.":9,oct:10,"oct.":10,nov:11,"nov.":11,dec:12,"dec.":12},It={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12},Bt={first:1,second:2,third:3,fourth:4,fifth:5,sixth:6,seventh:7,eighth:8,ninth:9,tenth:10,eleventh:11,twelfth:12,thirteenth:13,fourteenth:14,fifteenth:15,sixteenth:16,seventeenth:17,eighteenth:18,nineteenth:19,twentieth:20,"twenty first":21,"twenty-first":21,"twenty second":22,"twenty-second":22,"twenty third":23,"twenty-third":23,"twenty fourth":24,"twenty-fourth":24,"twenty fifth":25,"twenty-fifth":25,"twenty sixth":26,"twenty-sixth":26,"twenty seventh":27,"twenty-seventh":27,"twenty eighth":28,"twenty-eighth":28,"twenty ninth":29,"twenty-ninth":29,thirtieth:30,"thirty first":31,"thirty-first":31},gi={second:"second",seconds:"second",minute:"minute",minutes:"minute",hour:"hour",hours:"hour",day:"d",days:"d",week:"week",weeks:"week",month:"month",months:"month",quarter:"quarter",quarters:"quarter",year:"year",years:"year"},yt={s:"second",sec:"second",second:"second",seconds:"second",m:"minute",min:"minute",mins:"minute",minute:"minute",minutes:"minute",h:"hour",hr:"hour",hrs:"hour",hour:"hour",hours:"hour",d:"d",day:"d",days:"d",w:"w",week:"week",weeks:"week",mo:"month",mon:"month",mos:"month",month:"month",months:"month",qtr:"quarter",quarter:"quarter",quarters:"quarter",y:"year",yr:"year",year:"year",years:"year",...gi},mi=`(?:${ye(It)}|[0-9]+|[0-9]+\\.[0-9]+|half(?:\\s{0,2}an?)?|an?\\b(?:\\s{0,2}few)?|few|several|the|a?\\s{0,2}couple\\s{0,2}(?:of)?)`;function Js(n){const e=n.toLowerCase();return It[e]!==void 0?It[e]:e==="a"||e==="an"||e=="the"?1:e.match(/few/)?3:e.match(/half/)?.5:e.match(/couple/)?2:e.match(/several/)?7:parseFloat(e)}const ut=`(?:${ye(Bt)}|[0-9]{1,2}(?:st|nd|rd|th)?)`;function dt(n){let e=n.toLowerCase();return Bt[e]!==void 0?Bt[e]:(e=e.replace(/(?:st|nd|rd|th)$/i,""),parseInt(e))}const jt="(?:[1-9][0-9]{0,3}\\s{0,2}(?:BE|AD|BC|BCE|CE)|[1-2][0-9]{3}|[5-9][0-9])";function zt(n){if(/BE/i.test(n))return n=n.replace(/BE/i,""),parseInt(n)-543;if(/BCE?/i.test(n))return n=n.replace(/BCE?/i,""),-parseInt(n);if(/(AD|CE)/i.test(n))return n=n.replace(/(AD|CE)/i,""),parseInt(n);const e=parseInt(n);return di(e)}const pi=`(${mi})\\s{0,3}(${ye(yt)})`,sn=new RegExp(pi,"i"),Xs=`(${mi})\\s{0,3}(${ye(gi)})`,et=oi("(?:(?:about|around)\\s{0,3})?",pi),_t=oi("(?:(?:about|around)\\s{0,3})?",Xs);function tt(n){const e={};let t=n,i=sn.exec(t);for(;i;)Qs(e,i),t=t.substring(i[0].length).trim(),i=sn.exec(t);return e}function Qs(n,e){const t=Js(e[1]),i=yt[e[2].toLowerCase()];n[i]=t}var yi={exports:{}};(function(n,e){(function(t,i){n.exports=i()})(li,function(){var t="month",i="quarter";return function(s,r){var a=r.prototype;a.quarter=function(c){return this.$utils().u(c)?Math.ceil((this.month()+1)/3):this.month(this.month()%3+3*(c-1))};var o=a.add;a.add=function(c,f){return c=Number(c),this.$utils().p(f)===i?this.add(3*c,t):o.bind(this)(c,f)};var l=a.startOf;a.startOf=function(c,f){var d=this.$utils(),m=!!d.u(f)||f;if(d.p(c)===i){var u=this.quarter()-1;return m?this.month(3*u).startOf(t).startOf("day"):this.month(3*u+2).endOf(t).endOf("day")}return l.bind(this)(c,f)}}})})(yi);var er=yi.exports;const tr=ci(er);function nr(n,e){e=e.add(1,"day"),Ge(n,e),bt(n,e)}function Ne(n,e){n.assign("day",e.date()),n.assign("month",e.month()+1),n.assign("year",e.year())}function _i(n,e){n.assign("hour",e.hour()),n.assign("minute",e.minute()),n.assign("second",e.second()),n.assign("millisecond",e.millisecond()),n.get("hour")<12?n.assign("meridiem",W.AM):n.assign("meridiem",W.PM)}function Ge(n,e){n.imply("day",e.date()),n.imply("month",e.month()+1),n.imply("year",e.year())}function bt(n,e){n.imply("hour",e.hour()),n.imply("minute",e.minute()),n.imply("second",e.second()),n.imply("millisecond",e.millisecond())}const ir={ACDT:630,ACST:570,ADT:-180,AEDT:660,AEST:600,AFT:270,AKDT:-480,AKST:-540,ALMT:360,AMST:-180,AMT:-240,ANAST:720,ANAT:720,AQTT:300,ART:-180,AST:-240,AWDT:540,AWST:480,AZOST:0,AZOT:-60,AZST:300,AZT:240,BNT:480,BOT:-240,BRST:-120,BRT:-180,BST:60,BTT:360,CAST:480,CAT:120,CCT:390,CDT:-300,CEST:120,CET:{timezoneOffsetDuringDst:2*60,timezoneOffsetNonDst:60,dstStart:n=>rn(n,ge.MARCH,te.SUNDAY,2),dstEnd:n=>rn(n,ge.OCTOBER,te.SUNDAY,3)},CHADT:825,CHAST:765,CKT:-600,CLST:-180,CLT:-240,COT:-300,CST:-360,CT:{timezoneOffsetDuringDst:-5*60,timezoneOffsetNonDst:-6*60,dstStart:n=>ve(n,ge.MARCH,te.SUNDAY,2,2),dstEnd:n=>ve(n,ge.NOVEMBER,te.SUNDAY,1,2)},CVT:-60,CXT:420,ChST:600,DAVT:420,EASST:-300,EAST:-360,EAT:180,ECT:-300,EDT:-240,EEST:180,EET:120,EGST:0,EGT:-60,EST:-300,ET:{timezoneOffsetDuringDst:-4*60,timezoneOffsetNonDst:-5*60,dstStart:n=>ve(n,ge.MARCH,te.SUNDAY,2,2),dstEnd:n=>ve(n,ge.NOVEMBER,te.SUNDAY,1,2)},FJST:780,FJT:720,FKST:-180,FKT:-240,FNT:-120,GALT:-360,GAMT:-540,GET:240,GFT:-180,GILT:720,GMT:0,GST:240,GYT:-240,HAA:-180,HAC:-300,HADT:-540,HAE:-240,HAP:-420,HAR:-360,HAST:-600,HAT:-90,HAY:-480,HKT:480,HLV:-210,HNA:-240,HNC:-360,HNE:-300,HNP:-480,HNR:-420,HNT:-150,HNY:-540,HOVT:420,ICT:420,IDT:180,IOT:360,IRDT:270,IRKST:540,IRKT:540,IRST:210,IST:330,JST:540,KGT:360,KRAST:480,KRAT:480,KST:540,KUYT:240,LHDT:660,LHST:630,LINT:840,MAGST:720,MAGT:720,MART:-510,MAWT:300,MDT:-360,MESZ:120,MEZ:60,MHT:720,MMT:390,MSD:240,MSK:180,MST:-420,MT:{timezoneOffsetDuringDst:-6*60,timezoneOffsetNonDst:-7*60,dstStart:n=>ve(n,ge.MARCH,te.SUNDAY,2,2),dstEnd:n=>ve(n,ge.NOVEMBER,te.SUNDAY,1,2)},MUT:240,MVT:300,MYT:480,NCT:660,NDT:-90,NFT:690,NOVST:420,NOVT:360,NPT:345,NST:-150,NUT:-660,NZDT:780,NZST:720,OMSST:420,OMST:420,PDT:-420,PET:-300,PETST:720,PETT:720,PGT:600,PHOT:780,PHT:480,PKT:300,PMDT:-120,PMST:-180,PONT:660,PST:-480,PT:{timezoneOffsetDuringDst:-7*60,timezoneOffsetNonDst:-8*60,dstStart:n=>ve(n,ge.MARCH,te.SUNDAY,2,2),dstEnd:n=>ve(n,ge.NOVEMBER,te.SUNDAY,1,2)},PWT:540,PYST:-180,PYT:-240,RET:240,SAMT:240,SAST:120,SBT:660,SCT:240,SGT:480,SRT:-180,SST:-660,TAHT:-600,TFT:300,TJT:300,TKT:780,TLT:540,TMT:300,TVT:720,ULAT:480,UTC:0,UYST:-120,UYT:-180,UZT:300,VET:-210,VLAST:660,VLAT:660,VUT:660,WAST:120,WAT:60,WEST:60,WESZ:60,WET:0,WEZ:0,WFT:720,WGST:-120,WGT:-180,WIB:420,WIT:540,WITA:480,WST:780,WT:0,YAKST:600,YAKT:600,YAPT:600,YEKST:360,YEKT:360};function ve(n,e,t,i,s=0){let r=0,a=0;for(;a<i;)r++,new Date(n,e-1,r).getDay()===t&&a++;return new Date(n,e-1,r,s)}function rn(n,e,t,i=0){const s=t===0?7:t,r=new Date(n,e-1+1,1,12),a=r.getDay()===0?7:r.getDay();let o;return a===s?o=7:a<s?o=7+a-s:o=a-s,r.setDate(r.getDate()-o),new Date(n,e-1,r.getDate(),i)}function bi(n,e,t={}){if(n==null)return null;if(typeof n=="number")return n;const i=t[n]??ir[n];return i==null?null:typeof i=="number"?i:e==null?null:re(e).isAfter(i.dstStart(e.getFullYear()))&&!re(e).isAfter(i.dstEnd(e.getFullYear()))?i.timezoneOffsetDuringDst:i.timezoneOffsetNonDst}re.extend(tr);class wi{constructor(e){e=e??new Date,e instanceof Date?this.instant=e:(this.instant=e.instant??new Date,this.timezoneOffset=bi(e.timezone,this.instant))}getDateWithAdjustedTimezone(){return new Date(this.instant.getTime()+this.getSystemTimezoneAdjustmentMinute(this.instant)*6e4)}getSystemTimezoneAdjustmentMinute(e,t){(!e||e.getTime()<0)&&(e=new Date);const i=-e.getTimezoneOffset(),s=t??this.timezoneOffset??i;return i-s}}class V{constructor(e,t){if(this.reference=e,this.knownValues={},this.impliedValues={},t)for(const s in t)this.knownValues[s]=t[s];const i=re(e.instant);this.imply("day",i.date()),this.imply("month",i.month()+1),this.imply("year",i.year()),this.imply("hour",12),this.imply("minute",0),this.imply("second",0),this.imply("millisecond",0)}get(e){return e in this.knownValues?this.knownValues[e]:e in this.impliedValues?this.impliedValues[e]:null}isCertain(e){return e in this.knownValues}getCertainComponents(){return Object.keys(this.knownValues)}imply(e,t){return e in this.knownValues?this:(this.impliedValues[e]=t,this)}assign(e,t){return this.knownValues[e]=t,delete this.impliedValues[e],this}delete(e){delete this.knownValues[e],delete this.impliedValues[e]}clone(){const e=new V(this.reference);e.knownValues={},e.impliedValues={};for(const t in this.knownValues)e.knownValues[t]=this.knownValues[t];for(const t in this.impliedValues)e.impliedValues[t]=this.impliedValues[t];return e}isOnlyDate(){return!this.isCertain("hour")&&!this.isCertain("minute")&&!this.isCertain("second")}isOnlyTime(){return!this.isCertain("weekday")&&!this.isCertain("day")&&!this.isCertain("month")}isOnlyWeekdayComponent(){return this.isCertain("weekday")&&!this.isCertain("day")&&!this.isCertain("month")}isDateWithUnknownYear(){return this.isCertain("month")&&!this.isCertain("year")}isValidDate(){const e=this.dateWithoutTimezoneAdjustment();return!(e.getFullYear()!==this.get("year")||e.getMonth()!==this.get("month")-1||e.getDate()!==this.get("day")||this.get("hour")!=null&&e.getHours()!=this.get("hour")||this.get("minute")!=null&&e.getMinutes()!=this.get("minute"))}toString(){return`[ParsingComponents {knownValues: ${JSON.stringify(this.knownValues)}, impliedValues: ${JSON.stringify(this.impliedValues)}}, reference: ${JSON.stringify(this.reference)}]`}dayjs(){return re(this.date())}date(){const e=this.dateWithoutTimezoneAdjustment(),t=this.reference.getSystemTimezoneAdjustmentMinute(e,this.get("timezoneOffset"));return new Date(e.getTime()+t*6e4)}dateWithoutTimezoneAdjustment(){const e=new Date(this.get("year"),this.get("month")-1,this.get("day"),this.get("hour"),this.get("minute"),this.get("second"),this.get("millisecond"));return e.setFullYear(this.get("year")),e}static createRelativeFromReference(e,t){let i=re(e.instant);for(const r in t)i=i.add(t[r],r);const s=new V(e);return t.hour||t.minute||t.second?(_i(s,i),Ne(s,i),e.timezoneOffset!==null&&s.assign("timezoneOffset",-e.instant.getTimezoneOffset())):(bt(s,i),e.timezoneOffset!==null&&s.imply("timezoneOffset",-e.instant.getTimezoneOffset()),t.d?(s.assign("day",i.date()),s.assign("month",i.month()+1),s.assign("year",i.year())):(t.week&&s.imply("weekday",i.day()),s.imply("day",i.date()),t.month?(s.assign("month",i.month()+1),s.assign("year",i.year())):(s.imply("month",i.month()+1),t.year?s.assign("year",i.year()):s.imply("year",i.year())))),s}}class nt{constructor(e,t,i,s,r){this.reference=e,this.refDate=e.instant,this.index=t,this.text=i,this.start=s||new V(e),this.end=r}clone(){const e=new nt(this.reference,this.index,this.text);return e.start=this.start?this.start.clone():null,e.end=this.end?this.end.clone():null,e}date(){return this.start.date()}toString(){return`[ParsingResult {index: ${this.index}, text: '${this.text}', ...}]`}}class ce{constructor(){this.cachedInnerPattern=null,this.cachedPattern=null}patternLeftBoundary(){return"(\\W|^)"}pattern(e){const t=this.innerPattern(e);return t==this.cachedInnerPattern?this.cachedPattern:(this.cachedPattern=new RegExp(`${this.patternLeftBoundary()}${t.source}`,t.flags),this.cachedInnerPattern=t,this.cachedPattern)}extract(e,t){const i=t[1]??"";t.index=t.index+i.length,t[0]=t[0].substring(i.length);for(let s=2;s<t.length;s++)t[s-1]=t[s];return this.innerExtract(e,t)}}const sr=new RegExp(`(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${et})(?=\\W|$)`,"i"),rr=new RegExp(`(?:within|in|for)\\s*(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${et})(?=\\W|$)`,"i"),ar=new RegExp(`(?:within|in|for)\\s*(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${_t})(?=\\W|$)`,"i");class or extends ce{constructor(e){super(),this.strictMode=e}innerPattern(e){return this.strictMode?ar:e.option.forwardDate?sr:rr}innerExtract(e,t){const i=tt(t[1]);return V.createRelativeFromReference(e.reference,i)}}const lr=new RegExp(`(?:on\\s{0,3})?(${ut})(?:\\s{0,3}(?:to|\\-|\\–|until|through|till)?\\s{0,3}(${ut}))?(?:-|/|\\s{0,3}(?:of)?\\s{0,3})(${ye($e)})(?:(?:-|/|,?\\s{0,3})(${jt}(?![^\\s]\\d)))?(?=\\W|$)`,"i"),an=1,on=2,cr=3,ln=4;class ur extends ce{innerPattern(){return lr}innerExtract(e,t){const i=e.createParsingResult(t.index,t[0]),s=$e[t[cr].toLowerCase()],r=dt(t[an]);if(r>31)return t.index=t.index+t[an].length,null;if(i.start.assign("month",s),i.start.assign("day",r),t[ln]){const a=zt(t[ln]);i.start.assign("year",a)}else{const a=pt(e.refDate,r,s);i.start.imply("year",a)}if(t[on]){const a=dt(t[on]);i.end=i.start.clone(),i.end.assign("day",a)}return i}}const dr=new RegExp(`(${ye($e)})(?:-|/|\\s*,?\\s*)(${ut})(?!\\s*(?:am|pm))\\s*(?:(?:to|\\-)\\s*(${ut})\\s*)?(?:(?:-|/|\\s*,?\\s*)(${jt}))?(?=\\W|$)(?!\\:\\d)`,"i"),fr=1,hr=2,cn=3,un=4;class gr extends ce{innerPattern(){return dr}innerExtract(e,t){const i=$e[t[fr].toLowerCase()],s=dt(t[hr]);if(s>31)return null;const r=e.createParsingComponents({day:s,month:i});if(t[un]){const l=zt(t[un]);r.assign("year",l)}else{const l=pt(e.refDate,s,i);r.imply("year",l)}if(!t[cn])return r;const a=dt(t[cn]),o=e.createParsingResult(t.index,t[0]);return o.start=r,o.end=r.clone(),o.end.assign("day",a),o}}const mr=new RegExp(`((?:in)\\s*)?(${ye($e)})\\s*(?:[,-]?\\s*(${jt})?)?(?=[^\\s\\w]|\\s+[^0-9]|\\s+$|$)`,"i"),pr=1,yr=2,dn=3;class _r extends ce{innerPattern(){return mr}innerExtract(e,t){const i=t[yr].toLowerCase();if(t[0].length<=3&&!hi[i])return null;const s=e.createParsingResult(t.index+(t[pr]||"").length,t.index+t[0].length);s.start.imply("day",1);const r=$e[i];if(s.start.assign("month",r),t[dn]){const a=zt(t[dn]);s.start.assign("year",a)}else{const a=pt(e.refDate,1,r);s.start.imply("year",a)}return s}}const br=new RegExp(`([0-9]{4})[\\.\\/\\s](?:(${ye($e)})|([0-9]{1,2}))[\\.\\/\\s]([0-9]{1,2})(?=\\W|$)`,"i"),wr=1,Tr=2,fn=3,vr=4;class Dr extends ce{innerPattern(){return br}innerExtract(e,t){const i=t[fn]?parseInt(t[fn]):$e[t[Tr].toLowerCase()];if(i<1||i>12)return null;const s=parseInt(t[wr]);return{day:parseInt(t[vr]),month:i,year:s}}}const kr=new RegExp("([0-9]|0[1-9]|1[012])/([0-9]{4})","i"),$r=1,Er=2;class Sr extends ce{innerPattern(){return kr}innerExtract(e,t){const i=parseInt(t[Er]),s=parseInt(t[$r]);return e.createParsingComponents().imply("day",1).assign("month",s).assign("year",i)}}function Mr(n,e,t,i){return new RegExp(`${n}${e}(\\d{1,4})(?:(?:\\.|:|：)(\\d{1,2})(?:(?::|：)(\\d{2})(?:\\.(\\d{1,6}))?)?)?(?:\\s*(a\\.m\\.|p\\.m\\.|am?|pm?))?${t}`,i)}function Ar(n,e){return new RegExp(`^(${n})(\\d{1,4})(?:(?:\\.|\\:|\\：)(\\d{1,2})(?:(?:\\.|\\:|\\：)(\\d{1,2})(?:\\.(\\d{1,6}))?)?)?(?:\\s*(a\\.m\\.|p\\.m\\.|am?|pm?))?${e}`,"i")}const hn=2,Ce=3,st=4,rt=5,Fe=6;class Or{constructor(e=!1){this.cachedPrimaryPrefix=null,this.cachedPrimarySuffix=null,this.cachedPrimaryTimePattern=null,this.cachedFollowingPhase=null,this.cachedFollowingSuffix=null,this.cachedFollowingTimePatten=null,this.strictMode=e}patternFlags(){return"i"}primaryPatternLeftBoundary(){return"(^|\\s|T|\\b)"}primarySuffix(){return"(?=\\W|$)"}followingSuffix(){return"(?=\\W|$)"}pattern(e){return this.getPrimaryTimePatternThroughCache()}extract(e,t){const i=this.extractPrimaryTimeComponents(e,t);if(!i)return t.index+=t[0].length,null;const s=t.index+t[1].length,r=t[0].substring(t[1].length),a=e.createParsingResult(s,r,i);t.index+=t[0].length;const o=e.text.substring(t.index),c=this.getFollowingTimePatternThroughCache().exec(o);return r.match(/^\d{3,4}/)&&c&&c[0].match(/^\s*([+-])\s*\d{2,4}$/)?null:!c||c[0].match(/^\s*([+-])\s*\d{3,4}$/)?this.checkAndReturnWithoutFollowingPattern(a):(a.end=this.extractFollowingTimeComponents(e,c,a),a.end&&(a.text+=c[0]),this.checkAndReturnWithFollowingPattern(a))}extractPrimaryTimeComponents(e,t,i=!1){const s=e.createParsingComponents();let r=0,a=null,o=parseInt(t[hn]);if(o>100){if(this.strictMode||t[Ce]!=null)return null;r=o%100,o=Math.floor(o/100)}if(o>24)return null;if(t[Ce]!=null){if(t[Ce].length==1&&!t[Fe])return null;r=parseInt(t[Ce])}if(r>=60)return null;if(o>12&&(a=W.PM),t[Fe]!=null){if(o>12)return null;const l=t[Fe][0].toLowerCase();l=="a"&&(a=W.AM,o==12&&(o=0)),l=="p"&&(a=W.PM,o!=12&&(o+=12))}if(s.assign("hour",o),s.assign("minute",r),a!==null?s.assign("meridiem",a):o<12?s.imply("meridiem",W.AM):s.imply("meridiem",W.PM),t[rt]!=null){const l=parseInt(t[rt].substring(0,3));if(l>=1e3)return null;s.assign("millisecond",l)}if(t[st]!=null){const l=parseInt(t[st]);if(l>=60)return null;s.assign("second",l)}return s}extractFollowingTimeComponents(e,t,i){const s=e.createParsingComponents();if(t[rt]!=null){const l=parseInt(t[rt].substring(0,3));if(l>=1e3)return null;s.assign("millisecond",l)}if(t[st]!=null){const l=parseInt(t[st]);if(l>=60)return null;s.assign("second",l)}let r=parseInt(t[hn]),a=0,o=-1;if(t[Ce]!=null?a=parseInt(t[Ce]):r>100&&(a=r%100,r=Math.floor(r/100)),a>=60||r>24)return null;if(r>=12&&(o=W.PM),t[Fe]!=null){if(r>12)return null;const l=t[Fe][0].toLowerCase();l=="a"&&(o=W.AM,r==12&&(r=0,s.isCertain("day")||s.imply("day",s.get("day")+1))),l=="p"&&(o=W.PM,r!=12&&(r+=12)),i.start.isCertain("meridiem")||(o==W.AM?(i.start.imply("meridiem",W.AM),i.start.get("hour")==12&&i.start.assign("hour",0)):(i.start.imply("meridiem",W.PM),i.start.get("hour")!=12&&i.start.assign("hour",i.start.get("hour")+12)))}return s.assign("hour",r),s.assign("minute",a),o>=0?s.assign("meridiem",o):i.start.isCertain("meridiem")&&i.start.get("hour")>12?i.start.get("hour")-12>r?s.imply("meridiem",W.AM):r<=12&&(s.assign("hour",r+12),s.assign("meridiem",W.PM)):r>12?s.imply("meridiem",W.PM):r<=12&&s.imply("meridiem",W.AM),s.date().getTime()<i.start.date().getTime()&&s.imply("day",s.get("day")+1),s}checkAndReturnWithoutFollowingPattern(e){if(e.text.match(/^\d$/)||e.text.match(/^\d\d\d+$/)||e.text.match(/\d[apAP]$/))return null;const t=e.text.match(/[^\d:.](\d[\d.]+)$/);if(t){const i=t[1];if(this.strictMode||i.includes(".")&&!i.match(/\d(\.\d{2})+$/)||parseInt(i)>24)return null}return e}checkAndReturnWithFollowingPattern(e){if(e.text.match(/^\d+-\d+$/))return null;const t=e.text.match(/[^\d:.](\d[\d.]+)\s*-\s*(\d[\d.]+)$/);if(t){if(this.strictMode)return null;const i=t[1],s=t[2];if(s.includes(".")&&!s.match(/\d(\.\d{2})+$/))return null;const r=parseInt(s),a=parseInt(i);if(r>24||a>24)return null}return e}getPrimaryTimePatternThroughCache(){const e=this.primaryPrefix(),t=this.primarySuffix();return this.cachedPrimaryPrefix===e&&this.cachedPrimarySuffix===t?this.cachedPrimaryTimePattern:(this.cachedPrimaryTimePattern=Mr(this.primaryPatternLeftBoundary(),e,t,this.patternFlags()),this.cachedPrimaryPrefix=e,this.cachedPrimarySuffix=t,this.cachedPrimaryTimePattern)}getFollowingTimePatternThroughCache(){const e=this.followingPhase(),t=this.followingSuffix();return this.cachedFollowingPhase===e&&this.cachedFollowingSuffix===t?this.cachedFollowingTimePatten:(this.cachedFollowingTimePatten=Ar(e,t),this.cachedFollowingPhase=e,this.cachedFollowingSuffix=t,this.cachedFollowingTimePatten)}}class Rr extends Or{constructor(e){super(e)}followingPhase(){return"\\s*(?:\\-|\\–|\\~|\\〜|to|until|through|till|\\?)\\s*"}primaryPrefix(){return"(?:(?:at|from)\\s*)??"}primarySuffix(){return"(?:\\s*(?:o\\W*clock|at\\s*night|in\\s*the\\s*(?:morning|afternoon)))?(?!/)(?=\\W|$)"}extractPrimaryTimeComponents(e,t){const i=super.extractPrimaryTimeComponents(e,t);if(i){if(t[0].endsWith("night")){const s=i.get("hour");s>=6&&s<12?(i.assign("hour",i.get("hour")+12),i.assign("meridiem",W.PM)):s<6&&i.assign("meridiem",W.AM)}if(t[0].endsWith("afternoon")){i.assign("meridiem",W.PM);const s=i.get("hour");s>=0&&s<=6&&i.assign("hour",i.get("hour")+12)}t[0].endsWith("morning")&&(i.assign("meridiem",W.AM),i.get("hour")<12&&i.assign("hour",i.get("hour")))}return i}}function Vt(n){const e={};for(const t in n)e[t]=-n[t];return e}function Nr(n,e){const t=n.clone();let i=n.dayjs();for(const s in e)i=i.add(e[s],s);return("day"in e||"d"in e||"week"in e||"month"in e||"year"in e)&&(t.imply("day",i.date()),t.imply("month",i.month()+1),t.imply("year",i.year())),("second"in e||"minute"in e||"hour"in e)&&(t.imply("second",i.second()),t.imply("minute",i.minute()),t.imply("hour",i.hour())),t}const Pr=new RegExp(`(${et})\\s{0,5}(?:ago|before|earlier)(?=\\W|$)`,"i"),xr=new RegExp(`(${_t})\\s{0,5}(?:ago|before|earlier)(?=\\W|$)`,"i");class Cr extends ce{constructor(e){super(),this.strictMode=e}innerPattern(){return this.strictMode?xr:Pr}innerExtract(e,t){const i=tt(t[1]),s=Vt(i);return V.createRelativeFromReference(e.reference,s)}}const Ir=new RegExp(`(${et})\\s{0,5}(?:later|after|from now|henceforth|forward|out)(?=(?:\\W|$))`,"i"),Br=new RegExp("("+_t+")(later|from now)(?=(?:\\W|$))","i"),Ur=1;class Lr extends ce{constructor(e){super(),this.strictMode=e}innerPattern(){return this.strictMode?Br:Ir}innerExtract(e,t){const i=tt(t[Ur]);return V.createRelativeFromReference(e.reference,i)}}class Hr{refine(e,t){return t.filter(i=>this.isValid(e,i))}}class wt{refine(e,t){if(t.length<2)return t;const i=[];let s=t[0],r=null;for(let a=1;a<t.length;a++){r=t[a];const o=e.text.substring(s.index+s.text.length,r.index);if(!this.shouldMergeResults(o,s,r,e))i.push(s),s=r;else{const l=s,c=r,f=this.mergeResults(o,l,c,e);e.debug(()=>{console.log(`${this.constructor.name} merged ${l} and ${c} into ${f}`)}),s=f}}return s!=null&&i.push(s),i}}class Fr extends wt{shouldMergeResults(e,t,i){return!t.end&&!i.end&&e.match(this.patternBetween())!=null}mergeResults(e,t,i){if(!t.start.isOnlyWeekdayComponent()&&!i.start.isOnlyWeekdayComponent()&&(i.start.getCertainComponents().forEach(r=>{t.start.isCertain(r)||t.start.imply(r,i.start.get(r))}),t.start.getCertainComponents().forEach(r=>{i.start.isCertain(r)||i.start.imply(r,t.start.get(r))})),t.start.date().getTime()>i.start.date().getTime()){let r=t.start.dayjs(),a=i.start.dayjs();i.start.isOnlyWeekdayComponent()&&a.add(7,"days").isAfter(r)?(a=a.add(7,"days"),i.start.imply("day",a.date()),i.start.imply("month",a.month()+1),i.start.imply("year",a.year())):t.start.isOnlyWeekdayComponent()&&r.add(-7,"days").isBefore(a)?(r=r.add(-7,"days"),t.start.imply("day",r.date()),t.start.imply("month",r.month()+1),t.start.imply("year",r.year())):i.start.isDateWithUnknownYear()&&a.add(1,"years").isAfter(r)?(a=a.add(1,"years"),i.start.imply("year",a.year())):t.start.isDateWithUnknownYear()&&r.add(-1,"years").isBefore(a)?(r=r.add(-1,"years"),t.start.imply("year",r.year())):[i,t]=[t,i]}const s=t.clone();return s.start=t.start,s.end=i.start,s.index=Math.min(t.index,i.index),t.index<i.index?s.text=t.text+e+i.text:s.text=i.text+e+t.text,s}}class Yr extends Fr{patternBetween(){return/^\s*(to|-|–|until|through|till)\s*$/i}}function gn(n,e){const t=n.clone(),i=n.start,s=e.start;if(t.start=mn(i,s),n.end!=null||e.end!=null){const r=n.end==null?n.start:n.end,a=e.end==null?e.start:e.end,o=mn(r,a);if(n.end==null&&o.date().getTime()<t.start.date().getTime()){const l=o.dayjs().add(1,"day");o.isCertain("day")?Ne(o,l):Ge(o,l)}t.end=o}return t}function mn(n,e){const t=n.clone();return e.isCertain("hour")?(t.assign("hour",e.get("hour")),t.assign("minute",e.get("minute")),e.isCertain("second")?(t.assign("second",e.get("second")),e.isCertain("millisecond")?t.assign("millisecond",e.get("millisecond")):t.imply("millisecond",e.get("millisecond"))):(t.imply("second",e.get("second")),t.imply("millisecond",e.get("millisecond")))):(t.imply("hour",e.get("hour")),t.imply("minute",e.get("minute")),t.imply("second",e.get("second")),t.imply("millisecond",e.get("millisecond"))),e.isCertain("timezoneOffset")&&t.assign("timezoneOffset",e.get("timezoneOffset")),e.isCertain("meridiem")?t.assign("meridiem",e.get("meridiem")):e.get("meridiem")!=null&&t.get("meridiem")==null&&t.imply("meridiem",e.get("meridiem")),t.get("meridiem")==W.PM&&t.get("hour")<12&&(e.isCertain("hour")?t.assign("hour",t.get("hour")+12):t.imply("hour",t.get("hour")+12)),t}class Wr extends wt{shouldMergeResults(e,t,i){return(t.start.isOnlyDate()&&i.start.isOnlyTime()||i.start.isOnlyDate()&&t.start.isOnlyTime())&&e.match(this.patternBetween())!=null}mergeResults(e,t,i){const s=t.start.isOnlyDate()?gn(t,i):gn(i,t);return s.index=t.index,s.text=t.text+e+i.text,s}}class Gr extends Wr{patternBetween(){return new RegExp("^\\s*(T|at|after|before|on|of|,|-)?\\s*$")}}const jr=new RegExp("^\\s*,?\\s*\\(?([A-Z]{2,4})\\)?(?=\\W|$)","i");class zr{constructor(e){this.timezoneOverrides=e}refine(e,t){const i=e.option.timezones??{};return t.forEach(s=>{const r=e.text.substring(s.index+s.text.length),a=jr.exec(r);if(!a)return;const o=a[1].toUpperCase(),l=s.start.date()??s.refDate??new Date,c={...this.timezoneOverrides,...i},f=bi(o,l,c);if(f==null)return;e.debug(()=>{console.log(`Extracting timezone: '${o}' into: ${f} for: ${s.start}`)});const d=s.start.get("timezoneOffset");d!==null&&f!=d&&(s.start.isCertain("timezoneOffset")||o!=a[1])||s.start.isOnlyDate()&&o!=a[1]||(s.text+=a[0],s.start.isCertain("timezoneOffset")||s.start.assign("timezoneOffset",f),s.end!=null&&!s.end.isCertain("timezoneOffset")&&s.end.assign("timezoneOffset",f))}),t}}const Vr=new RegExp("^\\s*(?:\\(?(?:GMT|UTC)\\s?)?([+-])(\\d{1,2})(?::?(\\d{2}))?\\)?","i"),qr=1,Kr=2,Zr=3;class Jr{refine(e,t){return t.forEach(function(i){if(i.start.isCertain("timezoneOffset"))return;const s=e.text.substring(i.index+i.text.length),r=Vr.exec(s);if(!r)return;e.debug(()=>{console.log(`Extracting timezone: '${r[0]}' into : ${i}`)});const a=parseInt(r[Kr]),o=parseInt(r[Zr]||"0");let l=a*60+o;l>14*60||(r[qr]==="-"&&(l=-l),i.end!=null&&i.end.assign("timezoneOffset",l),i.start.assign("timezoneOffset",l),i.text+=r[0])}),t}}class pn{refine(e,t){if(t.length<2)return t;const i=[];let s=t[0];for(let r=1;r<t.length;r++){const a=t[r];a.index<s.index+s.text.length?a.text.length>s.text.length&&(s=a):(i.push(s),s=a)}return s!=null&&i.push(s),i}}class Xr{refine(e,t){return e.option.forwardDate&&t.forEach(function(i){let s=re(e.refDate);if(i.start.isOnlyTime()&&s.isAfter(i.start.dayjs())&&(s=s.add(1,"day"),Ge(i.start,s),i.end&&i.end.isOnlyTime()&&(Ge(i.end,s),i.start.dayjs().isAfter(i.end.dayjs())&&(s=s.add(1,"day"),Ge(i.end,s)))),i.start.isOnlyWeekdayComponent()&&s.isAfter(i.start.dayjs())&&(s.day()>=i.start.get("weekday")?s=s.day(i.start.get("weekday")+7):s=s.day(i.start.get("weekday")),i.start.imply("day",s.date()),i.start.imply("month",s.month()+1),i.start.imply("year",s.year()),e.debug(()=>{console.log(`Forward weekly adjusted for ${i} (${i.start})`)}),i.end&&i.end.isOnlyWeekdayComponent()&&(s.day()>i.end.get("weekday")?s=s.day(i.end.get("weekday")+7):s=s.day(i.end.get("weekday")),i.end.imply("day",s.date()),i.end.imply("month",s.month()+1),i.end.imply("year",s.year()),e.debug(()=>{console.log(`Forward weekly adjusted for ${i} (${i.end})`)}))),i.start.isDateWithUnknownYear()&&s.isAfter(i.start.dayjs()))for(let r=0;r<3&&s.isAfter(i.start.dayjs());r++)i.start.imply("year",i.start.get("year")+1),e.debug(()=>{console.log(`Forward yearly adjusted for ${i} (${i.start})`)}),i.end&&!i.end.isCertain("year")&&(i.end.imply("year",i.end.get("year")+1),e.debug(()=>{console.log(`Forward yearly adjusted for ${i} (${i.end})`)}))}),t}}class Qr extends Hr{constructor(e){super(),this.strictMode=e}isValid(e,t){return t.text.replace(" ","").match(/^\d*(\.\d*)?$/)?(e.debug(()=>{console.log(`Removing unlikely result '${t.text}'`)}),!1):t.start.isValidDate()?t.end&&!t.end.isValidDate()?(e.debug(()=>{console.log(`Removing invalid result: ${t} (${t.end})`)}),!1):this.strictMode?this.isStrictModeValid(e,t):!0:(e.debug(()=>{console.log(`Removing invalid result: ${t} (${t.start})`)}),!1)}isStrictModeValid(e,t){return t.start.isOnlyWeekdayComponent()?(e.debug(()=>{console.log(`(Strict) Removing weekday only component: ${t} (${t.end})`)}),!1):t.start.isOnlyTime()&&(!t.start.isCertain("hour")||!t.start.isCertain("minute"))?(e.debug(()=>{console.log(`(Strict) Removing uncertain time component: ${t} (${t.end})`)}),!1):!0}}const ea=new RegExp("([0-9]{4})\\-([0-9]{1,2})\\-([0-9]{1,2})(?:T([0-9]{1,2}):([0-9]{1,2})(?::([0-9]{1,2})(?:\\.(\\d{1,4}))?)?(?:Z|([+-]\\d{2}):?(\\d{2})?)?)?(?=\\W|$)","i"),ta=1,na=2,ia=3,yn=4,sa=5,_n=6,bn=7,wn=8,Tn=9;class ra extends ce{innerPattern(){return ea}innerExtract(e,t){const i={};if(i.year=parseInt(t[ta]),i.month=parseInt(t[na]),i.day=parseInt(t[ia]),t[yn]!=null)if(i.hour=parseInt(t[yn]),i.minute=parseInt(t[sa]),t[_n]!=null&&(i.second=parseInt(t[_n])),t[bn]!=null&&(i.millisecond=parseInt(t[bn])),t[wn]==null)i.timezoneOffset=0;else{const s=parseInt(t[wn]);let r=0;t[Tn]!=null&&(r=parseInt(t[Tn]));let a=s*60;a<0?a-=r:a+=r,i.timezoneOffset=a}return i}}class aa extends wt{mergeResults(e,t,i){const s=i.clone();return s.index=t.index,s.text=t.text+e+s.text,s.start.assign("weekday",t.start.get("weekday")),s.end&&s.end.assign("weekday",t.start.get("weekday")),s}shouldMergeResults(e,t,i){return t.start.isOnlyWeekdayComponent()&&!t.start.isCertain("hour")&&i.start.isCertain("day")&&e.match(/^,?\s*$/)!=null}}function oa(n,e=!1){return n.parsers.unshift(new ra),n.refiners.unshift(new aa),n.refiners.unshift(new Jr),n.refiners.unshift(new pn),n.refiners.push(new zr),n.refiners.push(new pn),n.refiners.push(new Xr),n.refiners.push(new Qr(e)),n}function la(n){const e=re(n.instant),t=new V(n,{});return Ne(t,e),_i(t,e),n.timezoneOffset!==null&&t.assign("timezoneOffset",e.utcOffset()),t}function ca(n){const e=re(n.instant),t=new V(n,{});return Ne(t,e),bt(t,e),t}function ua(n){return da(n,1)}function da(n,e){return Ti(n,-e)}function fa(n){return Ti(n,1)}function Ti(n,e){let t=re(n.instant);const i=new V(n,{});return t=t.add(e,"day"),Ne(i,t),bt(i,t),i}function ha(n,e=22){const t=re(n.instant),i=new V(n,{});return i.imply("hour",e),i.imply("meridiem",W.PM),Ne(i,t),i}function ga(n,e=20){const t=new V(n,{});return t.imply("meridiem",W.PM),t.imply("hour",e),t}function ma(n){const e=new V(n,{}),t=re(n.instant);return t.hour()>2&&nr(e,t),e.assign("hour",0),e.imply("minute",0),e.imply("second",0),e.imply("millisecond",0),e}function pa(n,e=6){const t=new V(n,{});return t.imply("meridiem",W.AM),t.imply("hour",e),t.imply("minute",0),t.imply("second",0),t.imply("millisecond",0),t}function ya(n,e=15){const t=new V(n,{});return t.imply("meridiem",W.PM),t.imply("hour",e),t.imply("minute",0),t.imply("second",0),t.imply("millisecond",0),t}function _a(n){const e=new V(n,{});return e.imply("meridiem",W.AM),e.imply("hour",12),e.imply("minute",0),e.imply("second",0),e.imply("millisecond",0),e}const ba=/(now|today|tonight|tomorrow|tmr|tmrw|yesterday|last\s*night)(?=\W|$)/i;class wa extends ce{innerPattern(e){return ba}innerExtract(e,t){let i=re(e.refDate);const s=t[0].toLowerCase(),r=e.createParsingComponents();switch(s){case"now":return la(e.reference);case"today":return ca(e.reference);case"yesterday":return ua(e.reference);case"tomorrow":case"tmr":case"tmrw":return fa(e.reference);case"tonight":return ha(e.reference);default:s.match(/last\s*night/)&&(i.hour()>6&&(i=i.add(-1,"day")),Ne(r,i),r.imply("hour",0));break}return r}}const Ta=/(?:this)?\s{0,3}(morning|afternoon|evening|night|midnight|midday|noon)(?=\W|$)/i;class va extends ce{innerPattern(){return Ta}innerExtract(e,t){switch(t[1].toLowerCase()){case"afternoon":return ya(e.reference);case"evening":case"night":return ga(e.reference);case"midnight":return ma(e.reference);case"morning":return pa(e.reference);case"noon":case"midday":return _a(e.reference)}return null}}function Da(n,e,t){const i=n.getDateWithAdjustedTimezone(),s=ka(i,e,t);let r=new V(n);return r=Nr(r,{day:s}),r.assign("weekday",e),r}function ka(n,e,t){const i=n.getDay();switch(t){case"this":return lt(n,e);case"last":return vi(n,e);case"next":return i==te.SUNDAY?e==te.SUNDAY?7:e:i==te.SATURDAY?e==te.SATURDAY?7:e==te.SUNDAY?8:1+e:e<i&&e!=te.SUNDAY?lt(n,e):lt(n,e)+7}return $a(n,e)}function $a(n,e){const t=vi(n,e),i=lt(n,e);return i<-t?i:t}function lt(n,e){const t=n.getDay();let i=e-t;return i<0&&(i+=7),i}function vi(n,e){const t=n.getDay();let i=e-t;return i>=0&&(i-=7),i}const Ea=new RegExp(`(?:(?:\\,|\\(|\\（)\\s*)?(?:on\\s*?)?(?:(this|last|past|next)\\s*)?(${ye(fi)})(?:\\s*(?:\\,|\\)|\\）))?(?:\\s*(this|last|past|next)\\s*week)?(?=\\W|$)`,"i"),Sa=1,Ma=2,Aa=3;class Oa extends ce{innerPattern(){return Ea}innerExtract(e,t){const i=t[Ma].toLowerCase(),s=fi[i],r=t[Sa],a=t[Aa];let o=r||a;o=o||"",o=o.toLowerCase();let l=null;return o=="last"||o=="past"?l="last":o=="next"?l="next":o=="this"&&(l="this"),Da(e.reference,s,l)}}const Ra=new RegExp(`(this|last|past|next|after\\s*this)\\s*(${ye(yt)})(?=\\s*)(?=\\W|$)`,"i"),Na=1,Pa=2;class xa extends ce{innerPattern(){return Ra}innerExtract(e,t){const i=t[Na].toLowerCase(),s=t[Pa].toLowerCase(),r=yt[s];if(i=="next"||i.startsWith("after")){const l={};return l[r]=1,V.createRelativeFromReference(e.reference,l)}if(i=="last"||i=="past"){const l={};return l[r]=-1,V.createRelativeFromReference(e.reference,l)}const a=e.createParsingComponents();let o=re(e.reference.instant);return s.match(/week/i)?(o=o.add(-o.get("d"),"d"),a.imply("day",o.date()),a.imply("month",o.month()+1),a.imply("year",o.year())):s.match(/month/i)?(o=o.add(-o.date()+1,"d"),a.imply("day",o.date()),a.assign("year",o.year()),a.assign("month",o.month()+1)):s.match(/year/i)&&(o=o.add(-o.date()+1,"d"),o=o.add(-o.month(),"month"),a.imply("day",o.date()),a.imply("month",o.month()+1),a.assign("year",o.year())),a}}class He{constructor(e){e=e||Di(),this.parsers=[...e.parsers],this.refiners=[...e.refiners]}clone(){return new He({parsers:[...this.parsers],refiners:[...this.refiners]})}parseDate(e,t,i){const s=this.parse(e,t,i);return s.length>0?s[0].start.date():null}parse(e,t,i){const s=new Ca(e,t,i);let r=[];return this.parsers.forEach(a=>{const o=He.executeParser(s,a);r=r.concat(o)}),r.sort((a,o)=>a.index-o.index),this.refiners.forEach(function(a){r=a.refine(s,r)}),r}static executeParser(e,t){const i=[],s=t.pattern(e),r=e.text;let a=e.text,o=s.exec(a);for(;o;){const l=o.index+r.length-a.length;o.index=l;const c=t.extract(e,o);if(!c){a=r.substring(o.index+1),o=s.exec(a);continue}let f=null;c instanceof nt?f=c:c instanceof V?(f=e.createParsingResult(o.index,o[0]),f.start=c):f=e.createParsingResult(o.index,o[0],c),e.debug(()=>console.log(`${t.constructor.name} extracted result ${f}`)),i.push(f),a=r.substring(l+f.text.length),o=s.exec(a)}return i}}class Ca{constructor(e,t,i){this.text=e,this.reference=new wi(t),this.option=i??{},this.refDate=this.reference.instant}createParsingComponents(e){return e instanceof V?e:new V(this.reference,e)}createParsingResult(e,t,i,s){const r=typeof t=="string"?t:this.text.substring(e,t),a=i?this.createParsingComponents(i):null,o=s?this.createParsingComponents(s):null;return new nt(this.reference,e,r,a,o)}debug(e){this.option.debug&&(this.option.debug instanceof Function?this.option.debug(e):this.option.debug.debug(e))}}const Ia=new RegExp("([^\\d]|^)([0-3]{0,1}[0-9]{1})[\\/\\.\\-]([0-3]{0,1}[0-9]{1})(?:[\\/\\.\\-]([0-9]{4}|[0-9]{2}))?(\\W|$)","i"),at=1,Ba=5,vn=2,Dn=3,kt=4;class Ua{constructor(e){this.groupNumberMonth=e?Dn:vn,this.groupNumberDay=e?vn:Dn}pattern(){return Ia}extract(e,t){if(t[at].length==0&&t.index>0&&t.index<e.text.length){const l=e.text[t.index-1];if(l>="0"&&l<="9")return}const i=t.index+t[at].length,s=t[0].substr(t[at].length,t[0].length-t[at].length-t[Ba].length);if(s.match(/^\d\.\d$/)||s.match(/^\d\.\d{1,2}\.\d{1,2}\s*$/)||!t[kt]&&t[0].indexOf("/")<0)return;const r=e.createParsingResult(i,s);let a=parseInt(t[this.groupNumberMonth]),o=parseInt(t[this.groupNumberDay]);if((a<1||a>12)&&a>12)if(o>=1&&o<=12&&a<=31)[o,a]=[a,o];else return null;if(o<1||o>31)return null;if(r.start.assign("day",o),r.start.assign("month",a),t[kt]){const l=parseInt(t[kt]),c=di(l);r.start.assign("year",c)}else{const l=pt(e.refDate,o,a);r.start.imply("year",l)}return r}}const La=new RegExp(`(this|last|past|next|after|\\+|-)\\s*(${et})(?=\\W|$)`,"i"),Ha=new RegExp(`(this|last|past|next|after|\\+|-)\\s*(${_t})(?=\\W|$)`,"i");class Fa extends ce{constructor(e=!0){super(),this.allowAbbreviations=e}innerPattern(){return this.allowAbbreviations?La:Ha}innerExtract(e,t){const i=t[1].toLowerCase();let s=tt(t[2]);switch(i){case"last":case"past":case"-":s=Vt(s);break}return V.createRelativeFromReference(e.reference,s)}}function kn(n){return n.text.match(/\s+(before|from)$/i)!=null}function Ya(n){return n.text.match(/\s+(after|since)$/i)!=null}class Wa extends wt{patternBetween(){return/^\s*$/i}shouldMergeResults(e,t,i){return!e.match(this.patternBetween())||!kn(t)&&!Ya(t)?!1:!!i.start.get("day")&&!!i.start.get("month")&&!!i.start.get("year")}mergeResults(e,t,i){let s=tt(t.text);kn(t)&&(s=Vt(s));const r=V.createRelativeFromReference(new wi(i.start.date()),s);return new nt(i.reference,t.index,`${t.text}${e}${i.text}`,r)}}const Ga=new He(Di(!1));new He(qt(!0,!1));new He(qt(!1,!0));function Di(n=!1){const e=qt(!1,n);return e.parsers.unshift(new wa),e.parsers.unshift(new va),e.parsers.unshift(new _r),e.parsers.unshift(new xa),e.parsers.unshift(new Fa),e}function qt(n=!0,e=!1){return oa({parsers:[new Ua(e),new or(n),new ur,new gr,new Oa,new Dr,new Sr,new Rr(n),new Cr(n),new Lr(n)],refiners:[new Wa,new Gr,new Yr]},n)}var W;(function(n){n[n.AM=0]="AM",n[n.PM=1]="PM"})(W||(W={}));var te;(function(n){n[n.SUNDAY=0]="SUNDAY",n[n.MONDAY=1]="MONDAY",n[n.TUESDAY=2]="TUESDAY",n[n.WEDNESDAY=3]="WEDNESDAY",n[n.THURSDAY=4]="THURSDAY",n[n.FRIDAY=5]="FRIDAY",n[n.SATURDAY=6]="SATURDAY"})(te||(te={}));var ge;(function(n){n[n.JANUARY=1]="JANUARY",n[n.FEBRUARY=2]="FEBRUARY",n[n.MARCH=3]="MARCH",n[n.APRIL=4]="APRIL",n[n.MAY=5]="MAY",n[n.JUNE=6]="JUNE",n[n.JULY=7]="JULY",n[n.AUGUST=8]="AUGUST",n[n.SEPTEMBER=9]="SEPTEMBER",n[n.OCTOBER=10]="OCTOBER",n[n.NOVEMBER=11]="NOVEMBER",n[n.DECEMBER=12]="DECEMBER"})(ge||(ge={}));const ja=Ga;function za(n,e,t){return ja.parse(n,e,t)}const $n="一二三四五六七八九",Va="一二三四五六七八九十",Ye={一:1,二:2,三:3,四:4,五:5,六:6,七:7,八:8,九:9,十:10},qa=[{pattern:new RegExp("(?<![\\d\\.\\-/])(?:(?<year>2\\d{3})\\s?[\\-年\\./]\\s?)?(?:(?<month>0?[1-9]|1[0-2])\\s?[\\-月\\./]\\s?)(?<day>[1-2][0-9]|3[0-1]|0?[1-9])(?:\\s?[日号]|[^\\d\\.\\-/])"),parse(n){let e=n.groups.year,t=n.groups.month,i=n.groups.day;return e||(e=new Date().getFullYear().toString()),[e,t,i]}},{pattern:/(?<prefix>明|大?后)天/,parse(n){let e=new Date;n.groups.prefix==="明"?e.setDate(e.getDate()+1):n.groups.prefix==="后"?e.setDate(e.getDate()+2):n.groups.prefix==="大后"&&e.setDate(e.getDate()+3);let t=e.getFullYear().toString(),i=(e.getMonth()+1).toString(),s=e.getDate().toString();return[t,i,s]}},{pattern:/今[天日]/,parse(n){let e=new Date,t=e.getFullYear().toString(),i=(e.getMonth()+1).toString(),s=e.getDate().toString();return[t,i,s]}},{pattern:/(?<diff>\d+)\s*(?:天[之以]?后|days? later)/,parse(n){let e=new Date,t=parseInt(n.groups.diff);e.setDate(e.getDate()+t);let i=e.getFullYear().toString(),s=(e.getMonth()+1).toString(),r=e.getDate().toString();return[i,s,r]}},{pattern:/(?<next>下个?)?(?:周|星期|礼拜)(?<day>[一二三四五六日天])/,dayMap:{一:1,二:2,三:3,四:4,五:5,六:6,日:7,天:7},parse(n){let e=new Date,t=n.groups.next!==void 0,i=this.dayMap[n.groups.day],s=e.getDay();s=s===0?7:s;let r=(t===!0?7:0)+i-s;r<0&&(r+=7),e.setDate(e.getDate()+r);let a=e.getFullYear().toString(),o=(e.getMonth()+1).toString(),l=e.getDate().toString();return[a,o,l]}},{pattern:new RegExp(`(?<!\\d)(?:(?<year>(?:20)?\\d{2})\\s?年?\\s?)?(?<month>[${$n}]|十[一二]?)\\s*月\\s*(?<day>三十一?|二?十[${$n}]?|[${Va}])\\s*[日号]?`),zn2num(n){if(n.length===1)return Ye[n];if(n.length===2)return n[0]==="十"?10+Ye[n[1]]:10*Ye[n[0]];if(n.length===3)return 10*Ye[n[0]]+Ye[n[2]]},parse(n){let e=n.groups.year,t=n.groups.month,i=n.groups.day;return e||(e=new Date().getFullYear().toString()),t=this.zn2num(t).toString(),i=this.zn2num(i).toString(),[e,t,i]}}];async function ki(n){let e=await gt(n),i=(await ss(e.id)).kramdown;i=i.replace(/{: (?:\w+=".+")+}/g,"");let s=null,r,a=null,o=1/0;for(let m of qa){let u=i.match(m.pattern);if(u&&u.index<o){let[h,D,M]=m.parse(u),w=new Date(`${h}-${D}-${M}`);w.toString()!=="Invalid Date"&&(o=u.index,a=w,s=u)}}if(a)r={text:s[0],index:s.index};else{let m=za(i,null,{forwardDate:!0});if(m.length>0){let u=m[0];a=u.start.date(),a.setHours(0,0,0,0),r={text:u.text,index:u.index}}}if(!a){H.showMessage(O.ReserveMenu.Date404,3e3,"error");return}let[l,c,f]=[a.getFullYear(),a.getMonth()+1,a.getDate()],d=new Date;if(d.setHours(0,0,0,0),a<d){H.confirm("Error",`${l}-${c}-${f}: ${O.ReserveMenu.DatePast}`);return}if(G.get("PopupReserveDialog")){let m=Ka(i,r);qs(`${O.ReserveMenu.Title}: ${a.toLocaleDateString()}?`,m,()=>En(n,a))}else En(n,a)}async function $i(n){let e=ue.findReserved(n);e&&ue.removeReservation(e,n),ue.save(),Me(n,{"custom-reservation":null,memo:null}),H.showMessage(O.DeReserveMenu.Success,3e3,"info")}function En(n,e){console.debug("Do reservation",n,e),ue.doReserve(e,n),ue.save();let t=ue.dateTemplate(e);Me(n,{"custom-reservation":t,memo:`${O.ReserveMenu.name} ${t}`}),H.showMessage(`${O.ReserveMenu.Success} ${e.toLocaleDateString()}`,3e3,"info")}function Ka(n,e){function t(r,a,o){let l=r.substring(0,a),c=r.substring(a,a+o),f=r.substring(a+o);return`${l}<span data-type="mark">${c}</span>${f}`}let i=e?`<p>${O.ReserveMenu.Match}: ${e.text}</p>`:"";e&&(n=t(n,e.index,e.text.length));let s=ti.Md2HTML(n);return s=`
    ${i}
    <div class="b3-typography typofont-1rem"
        style="margin: 0.5rem; box-shadow: 0px 0px 5px var(--b3-theme-on-background);"
    >
        ${s}
    </div>`,s}async function Ei(n,e=!1){let t=n==null?void 0:n.dailyNoteDocId;return t?(Za(t,e),!0):!1}async function Za(n,e=!1){let t=ue.getTodayReservations();if(t.length==0)return;let i=G.get("RetvType"),s=js(i,G.get("ResvEmbedAt"),t,n);const a=(await s.checkRetv()).length>0;if(a&&!e){console.debug("今日已经插入过预约了");return}else{t=t.map(c=>`"${c}"`);let o=`select * from blocks where id in (${t.join(",")})`;if((await pe(o)).length===0){H.confirm(O.Name,O.Msg.Resv404);return}a?s.update():s.insert()}}const Ut="daily-note-today-dynamic-style-sheet",Lt=n=>{let e=document.getElementById(Ut);e===null&&(e=document.createElement("style"),e.id=Ut,document.head.appendChild(e)),e.innerHTML=n},Ja=()=>{let n=document.getElementById(Ut);n!==null&&n.remove()},Xa=10;class Qa{constructor(e){I(this,"plugin");I(this,"eventBus");I(this,"onSyncEndBindThis",this.onSyncEnd.bind(this));I(this,"flag",{hasOpened:!1,openOnStart:!1,autoOpenAfterSync:!1,isSyncChecked:!1,hasCheckSyncFor:0,hasAutoInsertResv:!1});I(this,"checkDuplicateDiary_Debounce",null);this.plugin=e,this.eventBus=e.eventBus,this.flag.openOnStart=G.get("OpenOnStart"),this.flag.autoOpenAfterSync=G.get("AutoOpenAfterSync"),this.checkDuplicateDiary_Debounce=ys.debounce(this.checkDuplicateDiary.bind(this),2e3,"CheckDuplicateDiary")}bindSyncEvent(){this.eventBus.on("sync-end",this.onSyncEndBindThis)}unbindSyncEvent(){this.eventBus.off("sync-end",this.onSyncEndBindThis)}async onPluginLoad(){this.updateResvIconStyle(),window.siyuan.config.sync.enabled?this.flag.autoOpenAfterSync===!1?(this.bindSyncEvent(),await this.tryAutoOpenDN()):this.bindSyncEvent():await this.tryAutoOpenDN()}async onSyncEnd({detail:e}){console.debug("on-sync-end"),this.flag.hasOpened===!1&&this.flag.autoOpenAfterSync===!0&&this.tryAutoOpenDN(),this.flag.isSyncChecked||this.checkDuplicateDiary_Debounce()}resetStatusFlag(){this.flag.isSyncChecked=!1,this.flag.hasCheckSyncFor=0,this.flag.hasOpened=!1,this.flag.hasAutoInsertResv=!1}updateResvIconStyle(){G.get("HighlightResv")&&(ue.isTodayReserved()?Lt(`
                span[data-type="siyuan-dailynote-todaydock_tab"][data-title="${this.plugin.i18n.DockReserve.arial}"] {
                    background-color: var(--b3-theme-primary-lightest);
                }
            `):Lt(""))}async checkDuplicateDiary(){await Is()&&(this.flag.isSyncChecked=!0,this.unbindSyncEvent()),this.flag.hasCheckSyncFor++,this.flag.hasCheckSyncFor>=Xa&&(this.flag.isSyncChecked=!0,console.debug("关闭自动检查同步文件"),this.unbindSyncEvent())}async tryAutoOpenDN(){this.flag.openOnStart!==!1&&(await Es(),this.flag.hasOpened=!0,setTimeout(()=>{this.tryAutoInsertResv(),this.checkDuplicateDiary()},1500))}async tryAutoInsertResv(){if(this.flag.hasAutoInsertResv===!0||!ue.isTodayReserved())return;Ei(ee.default)&&(this.flag.hasAutoInsertResv=!0)}}const $t="DailyNoteToday.json.txt";class eo{constructor(){I(this,"plugin");I(this,"settings",{OpenOnStart:!0,AutoOpenAfterSync:!1,DefaultNotebook:"",DisableAutoCreateOnMobile:!1,IconPosition:"left",EnableMove:!0,EnableReserve:!0,EnableResvDock:!0,ExpandGutterMenu:!0,PopupReserveDialog:!0,ResvEmbedAt:"top",RetvType:"embed",NotebookBlacklist:{},HighlightResv:!0,AutoHandleDuplicate:!1,AutoHandleDuplicateMethod:"AllMerge"});Q.subscribe(Q.EventSetting,e=>{this.set(e.key,e.value),this.save()})}setPlugin(e){this.plugin=e}get(e){var t;return(t=this.settings)==null?void 0:t[e]}set(e,t){if(!(e in this.settings)){console.error(`"${e}" is not a setting`);return}this.settings[e]=t,e==="DefaultNotebook"&&ee.updateDefault()}async load(){let e=await this.plugin.loadData($t);if(e==null||e==null||e=="")console.debug("没有配置文件，使用默认配置"),this.save();else{console.log(`读入配置文件: ${$t}`),console.log(e),typeof e=="string"&&(e=JSON.parse(e));try{for(let t in e)this.set(t,e[t])}catch(t){console.error(`Setting load error: ${t}`)}this.save()}Q.publish(Q.EventSettingLoaded,{})}async save(){var s;let e=ee.default;if(!e)return;((s=this.settings.NotebookBlacklist)==null?void 0:s[e.id])===!0&&(this.settings.NotebookBlacklist[e.id]=!1);let i=JSON.stringify(this.settings);console.debug(`写入配置文件: ${i}`),this.plugin.saveData($t,i)}}const G=new eo,Et="Reservation.json";class to{constructor(){I(this,"plugin");I(this,"reserved");I(this,"reservations",{OnDate:{}});this.reserved=new Map}updateReserved(){for(let e in this.reservations.OnDate)for(let t of this.reservations.OnDate[e])this.reserved.set(t,e)}findReserved(e){return this.reserved.get(e)}removeReservation(e,t){let i=this.reservations.OnDate[e].indexOf(t);i>=0&&this.reservations.OnDate[e].splice(i,1)}dateTemplate(e){let t=e.getFullYear(),i=e.getMonth()+1,s=e.getDate();return`${t}${i<10?"0"+i:i}${s<10?"0"+s:s}`}setPlugin(e){this.plugin=e}async load(){let e=await this.plugin.loadData(Et);if(e==null||e==null||e=="")console.debug("没有预约文件，使用默认配置");else{console.log(`读入预约文件: ${Et}`),console.log(e),typeof e=="string"&&(e=JSON.parse(e));try{for(let t in e)this.reservations[t]=e[t]}catch(t){console.error(`Setting load error: ${t}`)}}await this.syncWithBlock(),this.doPurgeExpired(),this.updateReserved(),this.save()}async syncWithBlock(){let e=await zs("future");for(let t of e){let i=t.id,s=t.date;s in this.reservations.OnDate||(this.reservations.OnDate[s]=[]),this.reservations.OnDate[s].indexOf(i)<0&&this.reservations.OnDate[s].push(i),this.reserved.set(i,s)}}save(){let e=JSON.stringify(this.reservations);console.debug(`写入预约文件: ${e}`),this.plugin.saveData(Et,e)}doReserve(e,t){console.debug(`预约: ${t} 到 ${e}`);let i=this.findReserved(t);i&&(this.removeReservation(i,t),console.debug(`已经预约到 ${i} 的 ${t} , 现在删除原来的预约`));let s=this.dateTemplate(e);s in this.reservations.OnDate||(this.reservations.OnDate[s]=[]),this.reservations.OnDate[s].indexOf(t)<0&&this.reservations.OnDate[s].push(t),this.reserved.set(t,s)}isTodayReserved(){return this.getTodayReservations().length>0}getTodayReservations(){let e=new Date,t=this.dateTemplate(e);return this.reservations.OnDate[t]||[]}doPurgeExpired(){var s;let e=new Date,t=this.dateTemplate(e),i=parseInt(t);for(let r in this.reservations.OnDate)parseInt(r)+2<i&&delete this.reservations.OnDate[r],((s=this.reservations.OnDate[r])==null?void 0:s.length)===0&&delete this.reservations.OnDate[r]}async doPrune(){let e=new Set;for(const r of Object.keys(this.reservations.OnDate))for(const a of this.reservations.OnDate[r])e.add(a);if(e.size==0)return;let t=Array.from(e),i=await ws(t);const s=this.reservations.OnDate;for(const r of Object.keys(s)){const a=s[r];s[r]=s[r].filter(o=>i.has(o)),console.debug(`Filter ${r}: [${a}] --> [${s[r]}]`)}this.save()}}const ue=new to;function Sn(n,e,t){const i=n.slice();return i[10]=e[t][0],i[11]=e[t][1],i}function no(n){let e,t,i,s=Object.entries(n[2].options),r=[];for(let a=0;a<s.length;a+=1)r[a]=Mn(Sn(n,s,a));return{c(){e=v("select");for(let a=0;a<r.length;a+=1)r[a].c();g(e,"class","b3-select fn__flex-center fn__size200"),g(e,"id","iconPosition"),n[0]===void 0&&ct(()=>n[8].call(e))},m(a,o){J(a,e,o);for(let l=0;l<r.length;l+=1)r[l]&&r[l].m(e,null);Xt(e,n[0],!0),t||(i=[z(e,"change",n[8]),z(e,"change",n[5])],t=!0)},p(a,o){if(o&4){s=Object.entries(a[2].options);let l;for(l=0;l<s.length;l+=1){const c=Sn(a,s,l);r[l]?r[l].p(c,o):(r[l]=Mn(c),r[l].c(),r[l].m(e,null))}for(;l<r.length;l+=1)r[l].d(1);r.length=s.length}o&5&&Xt(e,a[0])},d(a){a&&K(e),je(r,a),t=!1,ae(i)}}}function io(n){let e,t=n[2].button+"",i,s,r;return{c(){e=v("button"),i=me(t),g(e,"class","b3-button b3-button--outline fn__flex-center fn__size200"),g(e,"id",n[3])},m(a,o){J(a,e,o),p(e,i),s||(r=z(e,"click",n[4]),s=!0)},p(a,o){o&4&&t!==(t=a[2].button+"")&&ze(i,t),o&8&&g(e,"id",a[3])},d(a){a&&K(e),s=!1,r()}}}function so(n){let e,t,i,s;return{c(){e=v("input"),g(e,"class","b3-text-field fn__flex-center fn__size200"),g(e,"id",n[3]),g(e,"placeholder",t=n[2].placeholder)},m(r,a){J(r,e,a),Jt(e,n[0]),i||(s=[z(e,"input",n[7]),z(e,"change",n[5])],i=!0)},p(r,a){a&8&&g(e,"id",r[3]),a&4&&t!==(t=r[2].placeholder)&&g(e,"placeholder",t),a&5&&e.value!==r[0]&&Jt(e,r[0])},d(r){r&&K(e),i=!1,ae(s)}}}function ro(n){let e,t,i;return{c(){e=v("input"),g(e,"class","b3-switch fn__flex-center"),g(e,"id",n[3]),g(e,"type","checkbox")},m(s,r){J(s,e,r),e.checked=n[0],t||(i=[z(e,"change",n[6]),z(e,"change",n[5])],t=!0)},p(s,r){r&8&&g(e,"id",s[3]),r&5&&(e.checked=s[0])},d(s){s&&K(e),t=!1,ae(i)}}}function Mn(n){let e,t=n[11]+"",i,s;return{c(){e=v("option"),i=me(t),e.__value=s=n[10],e.value=e.__value},m(r,a){J(r,e,a),p(e,i)},p(r,a){a&4&&t!==(t=r[11]+"")&&ze(i,t),a&4&&s!==(s=r[10])&&(e.__value=s,e.value=e.__value)},d(r){r&&K(e)}}}function ao(n){let e,t,i,s=n[2].title+"",r,a,o=n[2].text+"",l,c,f;function d(h,D){if(h[1]==="checkbox")return ro;if(h[1]==="input")return so;if(h[1]==="button")return io;if(h[1]==="select")return no}let m=d(n),u=m&&m(n);return{c(){e=v("label"),t=v("div"),i=new Ui(!1),r=Y(),a=v("div"),l=Y(),c=v("span"),f=Y(),u&&u.c(),i.a=r,g(a,"class","b3-label__text"),g(t,"class","fn__flex-1"),g(c,"class","fn__space"),g(e,"class","fn__flex b3-label")},m(h,D){J(h,e,D),p(e,t),i.m(s,t),p(t,r),p(t,a),a.innerHTML=o,p(e,l),p(e,c),p(e,f),u&&u.m(e,null)},p(h,[D]){D&4&&s!==(s=h[2].title+"")&&i.p(s),D&4&&o!==(o=h[2].text+"")&&(a.innerHTML=o),m===(m=d(h))&&u?u.p(h,D):(u&&u.d(1),u=m&&m(h),u&&(u.c(),u.m(e,null)))},i:ne,o:ne,d(h){h&&K(e),u&&u.d()}}}function oo(n,e,t){let{type:i}=e,{content:s}=e,{settingKey:r}=e,{settingValue:a}=e;const o=Ft();function l(){o("click",{key:r})}function c(){Q.publish(Q.EventSetting,{key:r,value:a})}function f(){a=this.checked,t(0,a),t(2,s)}function d(){a=this.value,t(0,a),t(2,s)}function m(){a=Ii(this),t(0,a),t(2,s)}return n.$$set=u=>{"type"in u&&t(1,i=u.type),"content"in u&&t(2,s=u.content),"settingKey"in u&&t(3,r=u.settingKey),"settingValue"in u&&t(0,a=u.settingValue)},[a,i,s,r,l,c,f,d,m]}class lo extends Re{constructor(e){super(),Oe(this,e,oo,ao,Ae,{type:1,content:2,settingKey:3,settingValue:0})}}function An(n,e,t){const i=n.slice();return i[6]=e[t],i}function On(n,e){let t,i,s;return i=new lo({props:{type:e[6].type,content:e[6].content,settingKey:e[6].key,settingValue:e[6].value}}),i.$on("click",e[3]),{key:n,first:null,c(){t=Ht(),ht(i.$$.fragment),this.first=t},m(r,a){J(r,t,a),Je(i,r,a),s=!0},p(r,a){e=r;const o={};a&2&&(o.type=e[6].type),a&2&&(o.content=e[6].content),a&2&&(o.settingKey=e[6].key),a&2&&(o.settingValue=e[6].value),i.$set(o)},i(r){s||(se(i.$$.fragment,r),s=!0)},o(r){de(i.$$.fragment,r),s=!1},d(r){r&&K(t),Xe(i,r)}}}function co(n){let e,t=[],i=new Map,s,r,a=n[1];const o=l=>l[6].key;for(let l=0;l<a.length;l+=1){let c=An(n,a,l),f=o(c);i.set(f,t[l]=On(f,c))}return{c(){e=v("div");for(let l=0;l<t.length;l+=1)t[l].c();g(e,"class",s="config__tab-container "+n[2]),g(e,"data-name",n[0])},m(l,c){J(l,e,c);for(let f=0;f<t.length;f+=1)t[f]&&t[f].m(e,null);r=!0},p(l,[c]){c&10&&(a=l[1],Ke(),t=Vn(t,c,o,1,l,a,i,e,qi,On,null,An),Ze()),(!r||c&4&&s!==(s="config__tab-container "+l[2]))&&g(e,"class",s),(!r||c&1)&&g(e,"data-name",l[0])},i(l){if(!r){for(let c=0;c<a.length;c+=1)se(t[c]);r=!0}},o(l){for(let c=0;c<t.length;c+=1)de(t[c]);r=!1},d(l){l&&K(e);for(let c=0;c<t.length;c+=1)t[c].d()}}}function uo(n,e,t){let i,{dataname:s}=e,{settingItems:r}=e,{display:a=!0}=e;const o=Ft();function l({detail:c}){o("click",{key:c.key,dataname:s})}return n.$$set=c=>{"dataname"in c&&t(0,s=c.dataname),"settingItems"in c&&t(1,r=c.settingItems),"display"in c&&t(4,a=c.display)},n.$$.update=()=>{n.$$.dirty&16&&t(2,i=a?"":"fn__none")},[s,r,i,l,a]}class fo extends Re{constructor(e){super(),Oe(this,e,uo,co,Ae,{dataname:0,settingItems:1,display:4})}}function Rn(n,e,t){const i=n.slice();return i[6]=e[t],i}function Nn(n,e,t){const i=n.slice();return i[9]=e[t],i}function Pn(n){let e,t,i=O.SettingGroups[n[9]]+"",s,r,a,o;function l(){return n[4](n[9])}return{c(){e=v("li"),t=v("span"),s=me(i),r=Y(),g(t,"class","b3-list-item__text"),g(e,"data-name","editor"),g(e,"class","b3-list-item svelte-11l5hfi"),Qt(e,"b3-list-item--focus",n[9]===n[1])},m(c,f){J(c,e,f),p(e,t),p(t,s),p(e,r),a||(o=[z(e,"click",l),z(e,"keydown",go)],a=!0)},p(c,f){n=c,f&6&&Qt(e,"b3-list-item--focus",n[9]===n[1])},d(c){c&&K(e),a=!1,ae(o)}}}function xn(n){let e,t;return e=new fo({props:{dataname:n[6].name,settingItems:n[6].items,display:n[6].name===n[1]}}),e.$on("click",n[3]),{c(){ht(e.$$.fragment)},m(i,s){Je(e,i,s),t=!0},p(i,s){const r={};s&1&&(r.dataname=i[6].name),s&1&&(r.settingItems=i[6].items),s&3&&(r.display=i[6].name===i[1]),e.$set(r)},i(i){t||(se(e.$$.fragment,i),t=!0)},o(i){de(e.$$.fragment,i),t=!1},d(i){Xe(e,i)}}}function ho(n){let e,t,i,s,r,a=n[2],o=[];for(let d=0;d<a.length;d+=1)o[d]=Pn(Nn(n,a,d));let l=n[0],c=[];for(let d=0;d<l.length;d+=1)c[d]=xn(Rn(n,l,d));const f=d=>de(c[d],1,1,()=>{c[d]=null});return{c(){e=v("div"),t=v("ul");for(let d=0;d<o.length;d+=1)o[d].c();i=Y(),s=v("div");for(let d=0;d<c.length;d+=1)c[d].c();g(t,"class","b3-tab-bar b3-list b3-list--background svelte-11l5hfi"),g(s,"class","config__tab-wrap"),g(e,"class","fn__flex-1 fn__flex config__panel svelte-11l5hfi")},m(d,m){J(d,e,m),p(e,t);for(let u=0;u<o.length;u+=1)o[u]&&o[u].m(t,null);p(e,i),p(e,s);for(let u=0;u<c.length;u+=1)c[u]&&c[u].m(s,null);r=!0},p(d,[m]){if(m&6){a=d[2];let u;for(u=0;u<a.length;u+=1){const h=Nn(d,a,u);o[u]?o[u].p(h,m):(o[u]=Pn(h),o[u].c(),o[u].m(t,null))}for(;u<o.length;u+=1)o[u].d(1);o.length=a.length}if(m&11){l=d[0];let u;for(u=0;u<l.length;u+=1){const h=Rn(d,l,u);c[u]?(c[u].p(h,m),se(c[u],1)):(c[u]=xn(h),c[u].c(),se(c[u],1),c[u].m(s,null))}for(Ke(),u=l.length;u<c.length;u+=1)f(u);Ze()}},i(d){if(!r){for(let m=0;m<l.length;m+=1)se(c[m]);r=!0}},o(d){c=c.filter(Boolean);for(let m=0;m<c.length;m+=1)de(c[m]);r=!1},d(d){d&&K(e),je(o,d),je(c,d)}}}const go=()=>{};function mo(n,e,t){let{panels:i}=e,s=i.map(c=>c.name),r=s[0];const a=Ft();function o({detail:c}){a("click",c)}const l=c=>{t(1,r=c)};return n.$$set=c=>{"panels"in c&&t(0,i=c.panels)},[i,r,s,o,l]}class po extends Re{constructor(e){super(),Oe(this,e,mo,ho,Ae,{panels:0})}}function Cn(n,e,t){const i=n.slice();return i[11]=e[t],i[12]=e,i[13]=t,i}function yo(n){return{c:ne,m:ne,p:ne,d:ne}}function _o(n){let e=[],t=new Map,i,s=n[10];const r=a=>a[11].id;for(let a=0;a<s.length;a+=1){let o=Cn(n,s,a),l=r(o);t.set(l,e[a]=In(l,o))}return{c(){for(let a=0;a<e.length;a+=1)e[a].c();i=Ht()},m(a,o){for(let l=0;l<e.length;l+=1)e[l]&&e[l].m(a,o);J(a,i,o)},p(a,o){o&14&&(s=a[10],e=Vn(e,o,r,1,a,s,t,i.parentNode,Vi,In,i,Cn))},d(a){for(let o=0;o<e.length;o+=1)e[o].d(a);a&&K(i)}}}function In(n,e){let t,i,s=To(e[11].icon)+"",r,a,o,l=e[11].name+"",c,f,d,m,u,h;function D(){e[8].call(d,e[11])}return{key:n,first:null,c(){t=v("li"),i=v("span"),r=me(s),a=Y(),o=v("span"),c=me(l),f=Y(),d=v("input"),m=Y(),g(i,"class","b3-list-item__icon"),g(o,"class","b3-list-item__text"),g(d,"type","checkbox"),g(d,"class","b3-switch fn__flex-center"),d.__value=e[11].id,d.value=d.__value,g(t,"class","b3-list-item b3-list-item--hide-action"),this.first=t},m(M,w){J(M,t,w),p(t,i),p(i,r),p(t,a),p(t,o),p(o,c),p(t,f),p(t,d),d.checked=e[1][e[11].id],p(t,m),u||(h=[z(d,"change",D),z(d,"change",e[3])],u=!0)},p(M,w){e=M,w&6&&(d.checked=e[1][e[11].id])},d(M){M&&K(t),u=!1,ae(h)}}}function bo(n){let e;return{c(){e=me("Wait...")},m(t,i){J(t,e,i)},p:ne,d(t){t&&K(e)}}}function wo(n){let e,t,i,s,r,a,o,l,c,f,d,m,u,h,D,M,w,q,x={ctx:n,current:null,token:null,hasCatch:!1,pending:bo,then:_o,catch:yo,value:10};return ji(n[2](),x),{c(){e=v("div"),t=v("div"),i=v("ul"),s=v("li"),r=ie("svg"),a=ie("use"),o=Y(),l=v("span"),l.textContent=`${O.Blacklist.toggle}`,c=Y(),f=v("input"),d=Y(),x.block.c(),m=Y(),u=v("div"),h=v("div"),D=Y(),M=v("button"),M.textContent=`${O.Blacklist.update}`,De(a,"xlink:href","#iconEdit"),g(r,"class","b3-list-item__graphic"),g(l,"class","b3-list-item__text"),g(f,"type","checkbox"),g(s,"class","b3-list-item b3-list-item--hide-action"),Ue(s,"border-bottom","1px solid var(--b3-border-color)"),g(t,"class","fn__flex-1 svelte-1rabyea"),Ue(t,"border-bottom","1px solid var(--b3-border-color)"),g(h,"class","fn__flex-1"),g(M,"class","b3-button b3-button--outline fn__flex-center fn__size200"),g(u,"class","fn__flex b3-label"),g(e,"class","fn__flex-column svelte-1rabyea")},m(R,C){J(R,e,C),p(e,t),p(t,i),p(i,s),p(s,r),p(r,a),p(s,o),p(s,l),p(s,c),p(s,f),n[7](f),p(i,d),x.block.m(i,x.anchor=null),x.mount=()=>i,x.anchor=null,p(e,m),p(e,u),p(u,h),p(u,D),p(u,M),w||(q=[z(f,"change",n[4]),z(M,"click",n[5])],w=!0)},p(R,[C]){n=R,zi(x,n,C)},i:ne,o:ne,d(R){R&&K(e),n[7](null),x.block.d(),x.token=null,x=null,w=!1,ae(q)}}}function To(n){try{return String.fromCodePoint(parseInt(n,16))}catch{return"📔"}}function vo(n,e,t){let{close:i}=e;const s=new Set(["思源笔记用户指南","SiYuan User Guide"]);let r,a=G.get("NotebookBlacklist");async function o(){let h=(await qn()).notebooks;return h=h.filter(D=>{var M;return!s.has(D.name)&&D.id!==((M=ee.default)==null?void 0:M.id)}),h.forEach(D=>{let M=a==null?void 0:a[D.id];M=M===void 0?!1:M,t(1,a[D.id]=M,a)}),h}function l(){let u=Object.values(a).filter(D=>D).length;const h=Object.keys(a).length;u===h?(t(0,r.checked=!0,r),t(0,r.indeterminate=!1,r)):u===0?(t(0,r.checked=!1,r),t(0,r.indeterminate=!1,r)):(t(0,r.checked=!1,r),t(0,r.indeterminate=!0,r))}function c(){r.checked?Object.keys(a).forEach(h=>{t(1,a[h]=!0,a)}):Object.keys(a).forEach(h=>{t(1,a[h]=!1,a)})}function f(){console.log(a),G.set("NotebookBlacklist",a),i()}function d(u){qe[u?"unshift":"push"](()=>{r=u,t(0,r)})}function m(u){a[u.id]=this.checked,t(1,a)}return n.$$set=u=>{"close"in u&&t(6,i=u.close)},[r,a,o,l,c,f,i,d,m]}class Do extends Re{constructor(e){super(),Oe(this,e,vo,wo,Ae,{close:6})}}const ko=async()=>{const n=new H.Dialog({title:"Running",content:`
<div class="b3-dialog__content">
    <div id="body" style="padding: 6px 12px; width: 100%;">
        <table id="notebooks" cellpadding="10" style="width: 100%;">
            <thead>
                <tr style="text-align: left;">
                    <th>Notebook</th>
                    <th>Start Date</th>
                    <th>Daily Notes</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>`,width:"50em",height:"25em"});let e=n.element.querySelector(".b3-dialog__container");e.style.maxHeight="50%";let t=n.element.querySelector("#body > table#notebooks");for(let r of ee){if(r.dailynoteSprig===void 0||r.dailynoteSprig==="")continue;let a=await ai(r),o=document.createElement("tr");o.innerHTML=`<tr style="text-align: left;">
            <td>${r.name}</td>
            <td>${mt(a,"-")}</td>
            <td>...</td>
        </tr>`,t.appendChild(o);let l=await Hs(r,a);o.querySelector("td:nth-child(3)").innerText=`${l.length}`}let i=n.element.querySelector("#body"),s=document.createElement("div");s.innerText="All Done!",s.style.color="var(--b3-theme-primary)",s.style.fontWeight="bold",i.appendChild(s)};function $o(n){let e,t;return e=new po({props:{panels:n[0]}}),e.$on("click",n[1]),{c(){ht(e.$$.fragment)},m(i,s){Je(e,i,s),t=!0},p:ne,i(i){t||(se(e.$$.fragment,i),t=!0)},o(i){de(e.$$.fragment,i),t=!1},d(i){Xe(e,i)}}}function Eo(n){let e=O.Setting,t={enable:[{name:"OpenOnStart",type:"checkbox"},{name:"EnableMove",type:"checkbox"},{name:"EnableReserve",type:"checkbox"},{name:"EnableResvDock",type:"checkbox"}],interact:[{name:"IconPosition",type:"select"},{name:"ExpandGutterMenu",type:"checkbox"}],dailynote:[{name:"DefaultNotebook",type:"input"},{name:"NotebookBlacklist",type:"button"},{name:"DisableAutoCreateOnMobile",type:"checkbox"},{name:"SetPastDailyNoteAttr",type:"button"},{name:"AutoOpenAfterSync",type:"checkbox"}],reservation:[{name:"PopupReserveDialog",type:"checkbox"},{name:"ResvEmbedAt",type:"select"},{name:"RetvType",type:"select"},{name:"HighlightResv",type:"checkbox"}]},i=[];for(let r in t){let a=[];for(let o of t[r])a.push({type:o.type,key:o.name,value:G.get(o.name),content:e[o.name]});i.push({name:r,items:a})}zn(()=>{console.log("Setting Svelte Mounted")}),Li(()=>{console.log("Setting Svelte Destroyed"),G.save()});function s({detail:r}){console.log(r);let a=r.key;if(a==="NotebookBlacklist"){let o=new H.Dialog({title:O.Blacklist.name,content:'<div id="blacklist" style="height: 100%;"></div>',height:"25rem",width:"30rem"});new Do({target:o.element.querySelector("#blacklist"),props:{close:()=>{o.destroy()}}})}else a==="SetPastDailyNoteAttr"&&ko()}return[i,s]}class So extends Re{constructor(e){super(),Oe(this,e,Eo,$o,Ae,{})}}function Bn(n,e,t){const i=n.slice();return i[14]=e[t],i}function Un(n){let e,t,i,s,r=n[14].content+"",a,o,l,c,f,d;function m(){return n[13](n[14])}return{c(){var u;e=v("li"),t=v("span"),t.innerHTML='<svg data-id="20230612111658-489nla8" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>',i=Y(),s=v("span"),a=me(r),o=Y(),Ue(t,"padding-left","22px"),Ue(t,"margin-right","2px"),g(t,"class","b3-list-item__toggle fn__hidden"),g(s,"class","b3-list-item__text"),g(e,"class","b3-list-item b3-list-item--hide-action"),g(e,"data-node-id",l=(u=n[14])==null?void 0:u.id),g(e,"data-ref-text",""),g(e,"data-def-id",""),g(e,"data-treetype","bookmark"),g(e,"data-def-path",""),g(e,"title",c=tn(en(n[14].content,50),15))},m(u,h){J(u,e,h),p(e,t),p(e,i),p(e,s),p(s,a),p(e,o),f||(d=[z(e,"click",m),z(e,"keydown",Ro)],f=!0)},p(u,h){var D;n=u,h&2&&r!==(r=n[14].content+"")&&ze(a,r),h&2&&l!==(l=(D=n[14])==null?void 0:D.id)&&g(e,"data-node-id",l),h&2&&c!==(c=tn(en(n[14].content,50),15))&&g(e,"title",c)},d(u){u&&K(e),f=!1,ae(d)}}}function Mo(n){var C;let e,t,i,s,r,a,o,l,c,f,d,m,u=((C=n[1])==null?void 0:C.length)+"",h,D,M,w,q,x=n[1],R=[];for(let T=0;T<x.length;T+=1)R[T]=Un(Bn(n,x,T));return{c(){e=v("li"),t=v("span"),i=ie("svg"),s=ie("use"),r=Y(),a=ie("svg"),o=ie("use"),l=Y(),c=v("span"),f=me(n[0]),d=Y(),m=v("span"),h=me(u),D=Y(),M=v("ul");for(let T=0;T<R.length;T+=1)R[T].c();De(s,"xlink:href","#iconRight"),g(i,"data-id","Doing0"),g(i,"class",n[4]),Ue(t,"padding-left","4px"),Ue(t,"margin-right","2px"),g(t,"class","b3-list-item__toggle b3-list-item__toggle--hl"),De(o,"xlink:href","#iconHistory"),g(a,"class","b3-list-item__graphic"),g(c,"class","b3-list-item__text"),g(c,"style",n[6]),g(m,"class","counter b3-list-item__action b3-tooltips b3-tooltips__w"),g(m,"aria-label",O.DockReserve.PopupResv),g(e,"class","b3-list-item b3-list-item--hide-action"),g(e,"data-treetype","bookmark"),g(e,"data-type","undefined"),g(e,"data-subtype","undefined"),g(M,"class",n[5])},m(T,S){J(T,e,S),p(e,t),p(t,i),p(i,s),p(e,r),p(e,a),p(a,o),p(e,l),p(e,c),p(c,f),p(e,d),p(e,m),p(m,h),n[11](e),J(T,D,S),J(T,M,S);for(let B=0;B<R.length;B+=1)R[B]&&R[B].m(M,null);w||(q=[z(m,"click",n[10]),z(m,"keydown",Ao),z(e,"click",n[12]),z(e,"keydown",Oo)],w=!0)},p(T,[S]){var B;if(S&16&&g(i,"class",T[4]),S&1&&ze(f,T[0]),S&64&&g(c,"style",T[6]),S&2&&u!==(u=((B=T[1])==null?void 0:B.length)+"")&&ze(h,u),S&130){x=T[1];let $;for($=0;$<x.length;$+=1){const E=Bn(T,x,$);R[$]?R[$].p(E,S):(R[$]=Un(E),R[$].c(),R[$].m(M,null))}for(;$<R.length;$+=1)R[$].d(1);R.length=x.length}S&32&&g(M,"class",T[5])},i:ne,o:ne,d(T){T&&K(e),n[11](null),T&&K(D),T&&K(M),je(R,T),w=!1,ae(q)}}}const Ao=()=>{},Oo=()=>{},Ro=()=>{};function No(n,e,t){let{sectionTitle:i=""}=e,{blocks:s=[]}=e,{isExpanded:r=!1}=e,a;function o(w){t(9,r=w===void 0?!r:w)}let l="b3-list-item__arrow",c="fn__none",f="";async function d(w){console.log("clickItem",w),w&&Ts(w)}function m(w){w.stopPropagation();const q=document.body.clientWidth,x=a.getBoundingClientRect(),R=x.right>q/2;ni.addFloatLayer({ids:s.map(B=>B.id),x:0,y:0});const C=window.siyuan.blockPanels,T=C[C.length-1],S=T==null?void 0:T.element;R?(S.style.top=`${x.bottom+10}px`,S.style.left="",S.style.right=`${q-x.right}px`):S.style.top=`${x.bottom+10}px`}const u=w=>m(w);function h(w){qe[w?"unshift":"push"](()=>{a=w,t(3,a)})}const D=()=>o(),M=w=>d(w==null?void 0:w.id);return n.$$set=w=>{"sectionTitle"in w&&t(0,i=w.sectionTitle),"blocks"in w&&t(1,s=w.blocks),"isExpanded"in w&&t(9,r=w.isExpanded)},n.$$.update=()=>{if(n.$$.dirty&512&&(r?(t(4,l="b3-list-item__arrow b3-list-item__arrow--open"),t(5,c="")):(t(4,l="b3-list-item__arrow"),t(5,c="fn__none"))),n.$$.dirty&1){let w=new Date,q=w.getFullYear(),x=w.getMonth()+1,R=w.getDate(),C=`${q}-${x<10?"0"+x:x}-${R<10?"0"+R:R}`;i===C?t(6,f="color: var(--b3-font-color1); font-weight: bold;"):t(6,f="")}},[i,s,o,a,l,c,f,d,m,r,u,h,D,M]}class Po extends Re{constructor(e){super(),Oe(this,e,No,Mo,Ae,{sectionTitle:0,blocks:1,isExpanded:9,toggleExpand:2})}get toggleExpand(){return this.$$.ctx[2]}}function Ln(n,e,t){const i=n.slice();return i[11]=e[t],i[12]=e,i[13]=t,i}function xo(n){let e,t,i=n[1],s=[];for(let a=0;a<i.length;a+=1)s[a]=Hn(Ln(n,i,a));const r=a=>de(s[a],1,1,()=>{s[a]=null});return{c(){for(let a=0;a<s.length;a+=1)s[a].c();e=Ht()},m(a,o){for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(a,o);J(a,e,o),t=!0},p(a,o){if(o&3){i=a[1];let l;for(l=0;l<i.length;l+=1){const c=Ln(a,i,l);s[l]?(s[l].p(c,o),se(s[l],1)):(s[l]=Hn(c),s[l].c(),se(s[l],1),s[l].m(e.parentNode,e))}for(Ke(),l=i.length;l<s.length;l+=1)r(l);Ze()}},i(a){if(!t){for(let o=0;o<i.length;o+=1)se(s[o]);t=!0}},o(a){s=s.filter(Boolean);for(let o=0;o<s.length;o+=1)de(s[o]);t=!1},d(a){je(s,a),a&&K(e)}}}function Co(n){let e;return{c(){e=v("li"),e.textContent=`${O.DockReserve.emptyContent}`,g(e,"class","b3-list--empty")},m(t,i){J(t,e,i)},p:ne,i:ne,o:ne,d(t){t&&K(e)}}}function Hn(n){let e,t,i;function s(a){n[10](a,n[13])}let r={sectionTitle:n[11].date,blocks:n[11].blocks};return n[0][n[13]]!==void 0&&(r.isExpanded=n[0][n[13]]),e=new Po({props:r}),qe.push(()=>Ki(e,"isExpanded",s)),{c(){ht(e.$$.fragment)},m(a,o){Je(e,a,o),i=!0},p(a,o){n=a;const l={};o&2&&(l.sectionTitle=n[11].date),o&2&&(l.blocks=n[11].blocks),!t&&o&1&&(t=!0,l.isExpanded=n[0][n[13]],Yi(()=>t=!1)),e.$set(l)},i(a){i||(se(e.$$.fragment,a),i=!0)},o(a){de(e.$$.fragment,a),i=!1},d(a){Xe(e,a)}}}function Io(n){let e,t,i,s,r,a,o=n[2].title+"",l,c,f,d,m,u,h,D,M,w,q,x,R,C,T,S,B,$,E,_e,Pe,A,b,y,k,_,N,P,U,F,L,X,fe,he;const Te=[Co,xo],oe=[];function be(j,le){return j[1].length===0?0:1}return F=be(n),L=oe[F]=Te[F](n),{c(){e=v("div"),t=v("div"),i=v("div"),s=ie("svg"),r=ie("use"),a=Y(),l=me(o),c=Y(),f=v("span"),d=Y(),m=v("span"),u=Y(),h=v("span"),D=ie("svg"),M=ie("use"),w=Y(),q=v("span"),x=Y(),R=v("span"),C=ie("svg"),T=ie("use"),S=Y(),B=v("span"),$=Y(),E=v("span"),_e=ie("svg"),Pe=ie("use"),A=Y(),b=v("span"),y=Y(),k=v("span"),_=ie("svg"),N=ie("use"),P=Y(),U=v("div"),L.c(),De(r,"xlink:href","#iconBookmark"),g(s,"class","block__logoicon"),g(i,"class","block__logo"),g(f,"class","fn__flex-1"),g(m,"class","fn__space"),De(M,"xlink:href","#iconRefresh"),g(D,"class",""),g(h,"data-type","refresh"),g(h,"class","block__icon b3-tooltips b3-tooltips__sw"),g(h,"aria-label",n[2].refresh),g(q,"class","fn__space"),De(T,"xlink:href","#iconExpand"),g(R,"data-type","expand"),g(R,"class","block__icon b3-tooltips b3-tooltips__sw"),g(R,"aria-label",n[2].expand+" Ctrl+↓"),g(B,"class","fn__space"),De(Pe,"xlink:href","#iconContract"),g(_e,"class",""),g(E,"data-type","collapse"),g(E,"class","block__icon b3-tooltips b3-tooltips__sw"),g(E,"aria-label",n[2].collapse+" Ctrl+↑"),g(b,"class","fn__space"),De(N,"xlink:href","#iconMin"),g(_,"class",""),g(k,"data-type","min"),g(k,"class","block__icon b3-tooltips b3-tooltips__sw"),g(k,"aria-label",n[2].min+" Ctrl+W"),g(t,"class","block__icons"),g(U,"class","fn__flex-1"),g(e,"class","fn__flex-1 fn__flex-column file-tree layout__tab")},m(j,le){J(j,e,le),p(e,t),p(t,i),p(i,s),p(s,r),p(i,a),p(i,l),p(t,c),p(t,f),p(t,d),p(t,m),p(t,u),p(t,h),p(h,D),p(D,M),p(t,w),p(t,q),p(t,x),p(t,R),p(R,C),p(C,T),p(t,S),p(t,B),p(t,$),p(t,E),p(E,_e),p(_e,Pe),p(t,A),p(t,b),p(t,y),p(t,k),p(k,_),p(_,N),p(e,P),p(e,U),oe[F].m(U,null),X=!0,fe||(he=[z(h,"click",n[7]),z(h,"keydown",n[6]),z(R,"click",n[8]),z(R,"keydown",n[6]),z(E,"click",n[9]),z(E,"keydown",n[6])],fe=!0)},p(j,[le]){let Ee=F;F=be(j),F===Ee?oe[F].p(j,le):(Ke(),de(oe[Ee],1,1,()=>{oe[Ee]=null}),Ze(),L=oe[F],L?L.p(j,le):(L=oe[F]=Te[F](j),L.c()),se(L,1),L.m(U,null))},i(j){X||(se(L),X=!0)},o(j){de(L),X=!1},d(j){j&&K(e),oe[F].d(),fe=!1,ae(he)}}}function Bo(n,e,t){let i=[],s=[],r=O.DockReserve;function a(){for(let h=0;h<i.length;h++)t(0,i[h]=!0,i)}function o(){for(let h=0;h<i.length;h++)t(0,i[h]=!1,i)}async function l(){let h=Object.entries(ue.reservations.OnDate),D=h.length,M=[];for(let C=0;C<D;C++){let S=h[C][1];M=M.concat(S)}let w=`select id, content, root_id from blocks where id in (${M.map(C=>`'${C}'`).join(",")})`,q=await pe(w);if(q===null){t(1,s=[]);return}let x={};q.forEach(C=>{x[C.id]={content:C.content,doc:C.root_id}}),t(0,i=new Array(D).fill(!1));let R=[];for(let C=0;C<D;C++){let T=h[C],S=[];T[1].forEach(B=>{var $,E;B in x&&S.push({id:B,content:($=x[B])==null?void 0:$.content,doc:(E=x[B])==null?void 0:E.doc})}),R.push({date:`${T[0].slice(0,4)}-${T[0].slice(4,6)}-${T[0].slice(6,8)}`,blocks:S})}t(1,s=R.filter(C=>C.blocks.length>0))}const c=()=>{};zn(()=>{l()});const f=()=>l(),d=()=>a(),m=()=>o();function u(h,D){n.$$.not_equal(i[D],h)&&(i[D]=h,t(0,i))}return[i,s,r,a,o,l,c,f,d,m,u]}class Uo extends Re{constructor(e){super(),Oe(this,e,Bo,Io,Ae,{})}}const Si={icon32:'<svg t="1684051396086" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5307" width="32" height="32"><path d="M832 42.666667a128 128 0 0 1 128 128v682.666666a128 128 0 0 1-128 128H277.333333a128.042667 128.042667 0 0 1-126.229333-106.666666H202.666667a96 96 0 0 0 4.522666-191.893334L202.666667 682.666667H149.333333v-74.666667h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 512a96 96 0 0 0-91.477334-95.893333L202.666667 416H149.333333V341.333333h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 245.333333a96 96 0 0 0-91.477334-95.893333L202.666667 149.333333H151.104A128.042667 128.042667 0 0 1 277.333333 42.666667h554.666667zM202.666667 746.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m605.866666-445.866667a64 64 0 0 0-90.517333 0L411.413333 607.445333a42.666667 42.666667 0 0 0-12.117333 24.448l-8.64 63.829334a21.333333 21.333333 0 0 0 24.32 23.957333l62.869333-9.472a42.666667 42.666667 0 0 0 23.829334-12.010667l306.837333-306.858666a64 64 0 0 0 0-90.496zM202.666667 480a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m0-266.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z" fill="" p-id="5308"></path></svg>',icon16:'<svg t="1684846685600" class="b3-menu__icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9077" width="16" height="16"><path d="M832 42.666667a128 128 0 0 1 128 128v682.666666a128 128 0 0 1-128 128H277.333333a128.042667 128.042667 0 0 1-126.229333-106.666666H202.666667a96 96 0 0 0 4.522666-191.893334L202.666667 682.666667H149.333333v-74.666667h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 512a96 96 0 0 0-91.477334-95.893333L202.666667 416H149.333333V341.333333h53.333334a96 96 0 0 0 95.893333-91.477333L298.666667 245.333333a96 96 0 0 0-91.477334-95.893333L202.666667 149.333333H151.104A128.042667 128.042667 0 0 1 277.333333 42.666667h554.666667zM202.666667 746.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m605.866666-445.866667a64 64 0 0 0-90.517333 0L411.413333 607.445333a42.666667 42.666667 0 0 0-12.117333 24.448l-8.64 63.829334a21.333333 21.333333 0 0 0 24.32 23.957333l62.869333-9.472a42.666667 42.666667 0 0 0 23.829334-12.010667l306.837333-306.858666a64 64 0 0 0 0-90.496zM202.666667 480a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z m0-266.666667a32 32 0 0 1 0 64h-106.666667a32 32 0 0 1 0-64h106.666667z" fill="" p-id="9078"></path></svg>'};let St,Mt;class Lo{constructor(e){I(this,"plugin");I(this,"ele");I(this,"iconStatus");this.plugin=e,St=t=>this.contextMenu(t),Mt=()=>this.updateDailyNoteStatus(),this.iconStatus=new Map,Q.subscribe("moveBlocks",Mt),Q.subscribe(Q.EventSettingLoaded,()=>{this.addTopBarIcon()})}release(){this.ele.removeEventListener("contextmenu",St),Q.unSubscribe("moveBlocks",Mt),this.ele.remove(),this.ele=null,console.debug("TopBarIcon released")}addTopBarIcon(){this.ele=this.plugin.addTopBar({icon:Si.icon32,title:O.Name,position:G.get("IconPosition"),callback:()=>{this.showMenu()}}),this.ele.addEventListener("contextmenu",St),this.updateDailyNoteStatus()}contextMenu(e){e.preventDefault();let t=new H.Menu("dntoday-config");t.addItem({label:O.Setting.name,icon:"iconSettings",click:()=>{Q.publish("OpenSetting","")}}),t.addItem({label:O.ContextMenu.PruneResv,icon:"iconTrashcan",click:async()=>{await ue.doPrune(),H.showMessage(O.Msg.PruneResv)}}),t.addItem({label:O.Setting.update.title,icon:"iconRefresh",click:()=>{Q.publish(Q.EventUpdateAll,"")}});let i=this.ele.getBoundingClientRect();const s=G.get("IconPosition")==="right";t.open({x:s?i.right:i.left,y:i.bottom,isLeft:s}),e.stopPropagation()}async showMenu(){await this.updateDailyNoteStatus();let e=new H.Menu("dntoday-menu"),t=this.createMenuItems();for(let s of t)e.addItem(s);let i=this.ele.getBoundingClientRect();if(i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),Qe)e.fullscreen();else{const s=G.get("IconPosition")==="right";e.open({x:s?i.right:i.left,y:i.bottom,isLeft:s})}}createMenuItems(){let e=G.get("NotebookBlacklist"),t=[];for(let i of ee){let s=e==null?void 0:e[i.id];if(s=s===void 0?!1:s,s===!0)continue;let r={label:i.name,icon:this.iconStatus.get(i.id),click:async()=>{i.id===ee.default.id?(await Ct(i),this.plugin.routineHandler.tryAutoInsertResv()):Ct(i)}};t.push(r)}return t}async updateDailyNoteStatus(){let e=await $s();ee.notebooks.forEach(t=>{e.get(t.id)?this.iconStatus.set(t.id,"iconSelect"):this.iconStatus.set(t.id,"")})}}async function Ho(n,e){let t=await gt(n);if(t==null){console.error(`Block ${n} not found`);return}let i=e.dailynoteHpath,s=await Le(i,e),r;if(s!=null&&s.length>0?r=s[0].id:(r=await ri(e,i),H.showMessage(`${O.Create}: ${e.name}`,2500,"info")),console.debug(`Call 移动块: ${t.id} --> ${r}`),t.type==="i"){let o=(await Qn(r,"* ","markdown"))[0].doOperations[0].id;await vt(t.id,null,o),console.debug(`移动列表项 ${t.id} --> ${o}`);let c=(await ts(o))[1];await ns(c.id)}else if(t.type==="h"){let o=document.querySelector(`#layouts div.protyle-content div[data-node-id="${t.id}"]`).getAttribute("fold");o!="1"&&await as(t.id),await vt(t.id,null,r),o!="1"&&setTimeout(()=>{os(t.id)},500)}else await vt(t.id,null,r);H.showMessage(`${t.id} ${O.MoveMenu.Move} ${e.name}`,2500,"info")}async function Fo(n,e){let t=await gt(n);if(t===null){console.error(`Document ${n} not found`);return}let i=t.path,s=t.hpath,r=e.dailynoteHpath;for(let l of ee)if(l.dailynoteHpath===s){console.error("不可以移动日记!"),H.showMessage(O.MoveMenu.NotMoveDiary,2500,"error");return}let a=await Le(r,e);console.debug("日记路径:",a),a!=null&&a.length>0||(await ri(e,r),a=await Le(r,e),H.showMessage(`${O.Create}: ${e.name}`,2500,"info"));let o=a[0].path;Zn([i],e.id,o)}function Yo(n){let e=parseInt(n,16);return Number.isNaN(e)?`<span class="b3-menu__icon"> <img class="" src="/emojis/${n}"> </span>`:`<span class="b3-menu__icon">${String.fromCodePoint(e)}</span>`}function Fn(n,e="block"){let t=[],i=G.get("NotebookBlacklist");for(let s of ee){let r=i==null?void 0:i[s.id];if(r=r===void 0?!1:r,r===!0)continue;let a={label:s.name,iconHTML:Yo(s.icon),click:async()=>{e==="block"?(console.log(`Move block ${n} to ${s.id} [${s.name}]`),await Ho(n,s),Q.publish("moveBlocks","")):(await Fo(n,s),Q.publish("moveBlocks",""))}};t.push(a)}return t}let At,Ot;class Wo{constructor(e){I(this,"menuItems",[]);I(this,"eventBus");At=t=>this.onBlockGutterClicked(t),Ot=t=>this.onDocGutterClicked(t),this.eventBus=e,e.on("click-blockicon",At),e.on("click-editortitleicon",Ot)}release(){this.eventBus.off("click-blockicon",At),this.eventBus.off("click-editortitleicon",Ot)}onBlockGutterClicked({detail:e}){if(e.blockElements.length>1)return;let t=e.menu,i=e.blockElements[0],s=i.getAttribute("data-node-id"),r=i.attributes.getNamedItem("custom-reservation"),a=[];if(G.get("EnableReserve")===!0&&(r?a.push({label:O.DeReserveMenu.name,icon:"iconClose",click:()=>$i(s)}):a.push({label:O.ReserveMenu.name,icon:"iconHistory",click:()=>ki(s)})),G.get("EnableMove")===!0){let o=Fn(s);a.push({label:O.MoveMenu.Move,type:"submenu",icon:"iconMove",submenu:o})}a.length>0&&(G.get("ExpandGutterMenu")===!0?a.forEach(l=>{t.addItem(l)}):t.addItem({iconHTML:Si.icon16,label:O.Name,type:"submenu",submenu:a}))}onDocGutterClicked({detail:e}){let t=e.data.id;if(t===void 0)return;let i=e.menu,s=Fn(t,"doc");i.addItem({label:O.MoveMenu.Move,type:"submenu",icon:"iconMove",submenu:s})}}var Kt={},ke={};Object.defineProperty(ke,"__esModule",{value:!0});ke.showChangeLog=ke.TypoDialog=ke.getFile=void 0;const Go=H;async function jo(n,e){const t={method:"POST"};return e&&(t.body=JSON.stringify(e)),await(await fetch(n,t)).text()}async function Mi(n){let e={path:n},t="/api/file/getFile";try{return await jo(t,e)}catch{return null}}ke.getFile=Mi;class Ai extends Go.Dialog{constructor(t){super(t);I(this,"eleContainer");this.eleContainer=this.element.querySelector(".b3-dialog__container")}setSize(t){let i=this.element.querySelector(".b3-dialog__container");i.style.width=t.width??i.style.width,i.style.height=t.height??i.style.height}setFont(t){let i=this.element.querySelector("#dialogContent");i.style.fontSize=t}}ke.TypoDialog=Ai;function zo(n,e,t){return new Ai({title:n,content:`
        <div id="dialog" class="b3-typography" style="margin: 2rem; font-size: 1rem">
            <div id="dialogContent" style="font-size: 1rem">
                ${e}
            </div>
        </div>`,width:t,height:"50%"})}let Rt={zh_CN:"zh_CN",zh_CHT:"zh_CN",en_US:"en_US",es_ES:"en_US",fr_FR:"en_US"};async function Vo(n,e,t,i){var s,r;try{let a=e.match(/\d+\.\d+\.\d+/g);if(a===null){console.log(`Failed to parse plugin version: ${e}`);return}let o=a[0],l=(r=(s=window==null?void 0:window.siyuan)==null?void 0:s.config)==null?void 0:r.lang;if(l===void 0){console.log("Get Lang error");return}if(i===void 0)i=Rt;else for(let h in Rt)i[h]===void 0&&(i[h]=Rt[h]);l=i[l]??l,t===void 0?t=`i18n/CHANGELOG-${l}-${o}.md`:t=t.replace(/\${lang}/g,l).replace(/\${(?:ver|version)}/g,o);const c=`/data/plugins/${n}/${t}`;let f=await Mi(c);if(f.match(/"code":404/g)!==null){console.log(`Faild to find changelog file: ${c}`);return}let u=window.Lute.New().Md2HTML(f);return zo(`${n} v${e}`,u,"60%")}catch(a){console.log("showChangeLog error:",a)}}ke.showChangeLog=Vo;Object.defineProperty(Kt,"__esModule",{value:!0});var Oi=Kt.changelog=void 0;const Yn=ke,Wn="PluginVersion";async function qo(n,e,t){const i=`/data/plugins/${n.name}/plugin.json`;let s={VersionChanged:void 0,OldVersion:void 0,NewVersion:void 0,Dialog:void 0};try{let r=await(0,Yn.getFile)(i);if(r===null)return s;r=JSON.parse(r);let a=r.version;console.log(`${n.name} Ver: ${a}`);let o=await n.loadData(Wn);s.OldVersion=o,s.NewVersion=a,s.VersionChanged=!1,a!==o&&(s.VersionChanged=!0,console.log(`${n.name} got new version: ${o} -> ${a}`),n.saveData(Wn,a),s.Dialog=await(0,Yn.showChangeLog)(n.name,a,e,t))}catch(r){console.error(`Setting load error: ${r}`)}return s}Oi=Kt.changelog=qo;class Ko extends H.Plugin{constructor(){super(...arguments);I(this,"version");I(this,"upToDate",null);I(this,"enableBlockIconClickEvent",!1);I(this,"isMobile",!1);I(this,"toolbarItem");I(this,"gutterMenu");I(this,"routineHandler")}async onload(){console.debug("Plugin load");let t=performance.now();const i=H.getFrontend();this.isMobile=i==="mobile"||i==="browser-mobile",ds(this.isMobile),us(this.i18n),fs(this.app),hs(this),G.setPlugin(this),ue.setPlugin(this),this.initPluginUI(),await Promise.all([ue.load(),G.load(),ee.init()]),this.initBlockIconClickEvent(),this.initUpToDate(),Q.subscribe(Q.EventUpdateAll,()=>{this.updateAll()}),Lt(""),this.routineHandler=new Qa(this),this.routineHandler.onPluginLoad();let s=performance.now();console.debug(`启动耗时: ${s-t} ms`);let r=await Oi(this,"i18n/CHANGELOG.md");if(r!=null&&r.Dialog){let a=r.Dialog;a.setSize({width:"50rem",height:"42rem"}),a.setFont("1.2rem")}}initPluginUI(){this.addCommand({langKey:"reserve",hotkey:"⌥⇧R",editorCallback:async()=>{let t=ms();if(t){let i=t.getAttribute("data-type");if(i==="NodeParagraph"){let a=t==null?void 0:t.parentElement;i=a==null?void 0:a.getAttribute("data-type"),i==="NodeListItem"&&(t=a)}const s=t.getAttribute("data-node-id");let r=t.attributes.getNamedItem("custom-reservation");G.get("EnableReserve")===!0&&(r?$i(s):ki(s))}}}),this.toolbarItem=new Lo(this),Q.subscribe(Q.EventSettingLoaded,this.onSettingLoaded.bind(this)),Q.subscribe("OpenSetting",this.openSetting.bind(this))}initUpToDate(){this.upToDate=null,this.startUpdateOnNextDay()}initBlockIconClickEvent(){(G.get("EnableMove")===!0||G.get("EnableReserve")===!0)&&(console.debug("添加块菜单项目"),this.enableBlockIconClickEvent=!0,this.gutterMenu=new Wo(this.eventBus))}onSettingLoaded(){G.get("EnableResvDock")===!0&&this.addDock({config:{position:"RightBottom",size:{width:250,height:0},icon:"iconHistory",title:this.i18n.DockReserve.arial,show:!1},data:{text:"This is my custom dock"},type:"dock_tab",init(){this.element.innerHTML='<div id="ShowResv"/>',new Uo({target:this.element.querySelector("#ShowResv")})}})}async updateAll(){console.debug("updateAll"),await ee.update(),this.toolbarItem.updateDailyNoteStatus(),Ei(ee.default,!0),H.showMessage(this.i18n.UpdateAll,2500,"info")}openSetting(){let t=new H.Dialog({title:`${this.i18n.Name}`,content:'<div id="SettingPanel" style="height: 100%"></div>',width:"50%",height:"27rem",destroyCallback:()=>{i.$destroy()}}),i=new So({target:t.element.querySelector("#SettingPanel")})}startUpdateOnNextDay(){let t=new Date,i=new Date;i.setDate(t.getDate()+1),i.setHours(0,0,0,0);let s=i.getTime()-t.getTime();this.upToDate=setTimeout(this.updateOnNewDay.bind(this),s),console.log(`当前时间: ${t}, 下次更新时间: ${i}, ${s} ms 后更新`)}async updateOnNewDay(){await ee.update(),this.toolbarItem.updateDailyNoteStatus(),this.startUpdateOnNextDay();let t=new Date;t.toDateString();let i=`${this.i18n.NewDay[0]} ${t.toLocaleDateString()} ${this.i18n.NewDay[1]}`;this.routineHandler.resetStatusFlag(),this.routineHandler.updateResvIconStyle(),H.showMessage(i,5e3,"info")}onunload(){console.debug("Plugin unload"),Ja(),this.toolbarItem.release(),this.upToDate&&(console.debug(`清理定时器 ${this.upToDate}`),clearTimeout(this.upToDate),this.upToDate=null),this.enableBlockIconClickEvent&&this.gutterMenu.release()}}module.exports=Ko;
