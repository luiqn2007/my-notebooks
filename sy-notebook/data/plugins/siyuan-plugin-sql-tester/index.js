"use strict";var st=Object.defineProperty;var ot=(e,t,n)=>t in e?st(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var q=(e,t,n)=>(ot(e,typeof t!="symbol"?t+"":t,n),n);const rt=require("siyuan");class O{static init(t){if(!t)throw new Error("block manager must init with plugin parameter");this.plugin=t,t.eventBus.on("loaded-protyle",()=>this.handleChange()),t.eventBus.on("ws-main",()=>this.handleChange())}static load(t){this.blockConstructors.set(t.type,t)}static build(t,n){console.log(this.blockConstructors);const l=this.blockConstructors.get(t);if(!l)throw new Error(`Block type ${t} is not loaded by custom block manager`);const s=new l({plugin:this.plugin}),{id:o,content:i}=s._onBuild(t,n);return{id:o,content:i}}static buildBlock(t,n){const{id:l,content:s}=this.build(t,n),o=new Date,i=`${o.getFullYear()}${o.getMonth()}${o.getDay()}${o.getHours()}${o.getMinutes()}${o.getSeconds()}`;return`${s}
{: id="${l}" updated="${i}"}
`}static handleChange(){document.querySelectorAll("protyle-html").forEach(n=>{if(this.protyles.has(n)||!(n.getAttribute("data-content").indexOf(`data-plugin="${this.plugin.name}"`)>=0))return;const i=n.shadowRoot.querySelector(`div[data-plugin="${this.plugin.name}"]`);if(i){const u=i.getAttribute("data-custom-block-id");this.protyles.set(n,u);let a=this.blocks.get(u);if(a)return;const r=i.getAttribute("data-type"),f=this.blockConstructors.get(r);if(!r)return;let c=i.getAttribute("data-custom-block-data");c=c?JSON.parse(decodeURI(c)):{},a=new f({plugin:this.plugin}),this.blocks.set(u,a),a.onMount&&a.onMount(i,c),i.setAttribute("style","cursor: initial;"),f.css&&i.insertAdjacentHTML("afterbegin",`<style>${f.css}</style>`),i.addEventListener("DOMNodeRemoved",()=>{this.blocks.delete(u),this.protyles.delete(n),this.blocks.delete(u),a.onDestroyed()})}})}}q(O,"blocks",new Map),q(O,"protyles",new Map),q(O,"blockConstructors",new Map);class ct{constructor(t){q(this,"el",null);this.plugin=t.plugin}_onBuild(t,n){const l=window.Lute.NewNodeID(),s=n?JSON.stringify(n):"{}",o=`<div><div data-custom-block-id="${l}" data-custom-block-data="${encodeURI(s)}" data-type="${t}" data-plugin="${this.plugin.name}"></div></div>`;return{id:l,content:o}}}var P={CustomBlockManager:O,CustomBlock:ct};function S(){}function et(e){return e()}function U(){return Object.create(null)}function N(e){e.forEach(et)}function nt(e){return typeof e=="function"}function it(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function ut(e){return Object.keys(e).length===0}function h(e,t){e.appendChild(t)}function k(e,t,n){e.insertBefore(t,n||null)}function y(e){e.parentNode&&e.parentNode.removeChild(e)}function L(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function b(e){return document.createElement(e)}function A(e){return document.createTextNode(e)}function E(){return A(" ")}function T(e,t,n,l){return e.addEventListener(t,n,l),()=>e.removeEventListener(t,n,l)}function $(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function at(e){return Array.from(e.childNodes)}function z(e,t){t=""+t,e.data!==t&&(e.data=t)}function W(e,t){e.value=t??""}function Q(e,t,n,l){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,l?"important":"")}let B;function M(e){B=e}function ft(){if(!B)throw new Error("Function called outside component initialization");return B}function dt(e){ft().$$.on_mount.push(e)}const x=[],D=[];let C=[];const Y=[],ht=Promise.resolve();let I=!1;function _t(){I||(I=!0,ht.then(lt))}function H(e){C.push(e)}const j=new Set;let v=0;function lt(){if(v!==0)return;const e=B;do{try{for(;v<x.length;){const t=x[v];v++,M(t),gt(t.$$)}}catch(t){throw x.length=0,v=0,t}for(M(null),x.length=0,v=0;D.length;)D.pop()();for(let t=0;t<C.length;t+=1){const n=C[t];j.has(n)||(j.add(n),n())}C.length=0}while(x.length);for(;Y.length;)Y.pop()();I=!1,j.clear(),M(e)}function gt(e){if(e.fragment!==null){e.update(),N(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(H)}}function pt(e){const t=[],n=[];C.forEach(l=>e.indexOf(l)===-1?t.push(l):n.push(l)),n.forEach(l=>l()),C=t}const bt=new Set;function mt(e,t){e&&e.i&&(bt.delete(e),e.i(t))}function yt(e,t,n,l){const{fragment:s,after_update:o}=e.$$;s&&s.m(t,n),l||H(()=>{const i=e.$$.on_mount.map(et).filter(nt);e.$$.on_destroy?e.$$.on_destroy.push(...i):N(i),e.$$.on_mount=[]}),o.forEach(H)}function kt(e,t){const n=e.$$;n.fragment!==null&&(pt(n.after_update),N(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function wt(e,t){e.$$.dirty[0]===-1&&(x.push(e),_t(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function qt(e,t,n,l,s,o,i,u=[-1]){const a=B;M(e);const r=e.$$={fragment:null,ctx:[],props:o,update:S,not_equal:s,bound:U(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(a?a.$$.context:[])),callbacks:U(),dirty:u,skip_bound:!1,root:t.target||a.$$.root};i&&i(r.root);let f=!1;if(r.ctx=n?n(e,t.props||{},(c,_,...m)=>{const g=m.length?m[0]:_;return r.ctx&&s(r.ctx[c],r.ctx[c]=g)&&(!r.skip_bound&&r.bound[c]&&r.bound[c](g),f&&wt(e,c)),_}):[],r.update(),f=!0,N(r.before_update),r.fragment=l?l(r.ctx):!1,t.target){if(t.hydrate){const c=at(t.target);r.fragment&&r.fragment.l(c),c.forEach(y)}else r.fragment&&r.fragment.c();t.intro&&mt(e.$$.fragment),yt(e,t.target,t.anchor,t.customElement),lt()}M(a)}class St{$destroy(){kt(this,1),this.$destroy=S}$on(t,n){if(!nt(n))return S;const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(n),()=>{const s=l.indexOf(n);s!==-1&&l.splice(s,1)}}$set(t){this.$$set&&!ut(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function G(e,t,n){const l=e.slice();return l[15]=t[n],l}function K(e,t,n){const l=e.slice();return l[18]=t[n],l}function V(e,t,n){const l=e.slice();return l[18]=t[n],l}function $t(e){let t;return{c(){t=b("span"),t.textContent="No result."},m(n,l){k(n,t,l)},p:S,d(n){n&&y(t)}}}function vt(e){let t,n,l,s,o=e[6],i=[];for(let r=0;r<o.length;r+=1)i[r]=X(V(e,o,r));let u=e[0],a=[];for(let r=0;r<u.length;r+=1)a[r]=tt(G(e,u,r));return{c(){t=b("table"),n=b("thead");for(let r=0;r<i.length;r+=1)i[r].c();l=E(),s=b("tbody");for(let r=0;r<a.length;r+=1)a[r].c()},m(r,f){k(r,t,f),h(t,n);for(let c=0;c<i.length;c+=1)i[c]&&i[c].m(n,null);h(t,l),h(t,s);for(let c=0;c<a.length;c+=1)a[c]&&a[c].m(s,null)},p(r,f){if(f&64){o=r[6];let c;for(c=0;c<o.length;c+=1){const _=V(r,o,c);i[c]?i[c].p(_,f):(i[c]=X(_),i[c].c(),i[c].m(n,null))}for(;c<i.length;c+=1)i[c].d(1);i.length=o.length}if(f&65){u=r[0];let c;for(c=0;c<u.length;c+=1){const _=G(r,u,c);a[c]?a[c].p(_,f):(a[c]=tt(_),a[c].c(),a[c].m(s,null))}for(;c<a.length;c+=1)a[c].d(1);a.length=u.length}},d(r){r&&y(t),L(i,r),L(a,r)}}}function xt(e){let t,n,l;return{c(){t=b("span"),n=A("Request failed: "),l=A(e[2])},m(s,o){k(s,t,o),h(t,n),h(t,l)},p(s,o){o&4&&z(l,s[2])},d(s){s&&y(t)}}}function Ct(e){let t;return{c(){t=b("span"),t.textContent="Requesting"},m(n,l){k(n,t,l)},p:S,d(n){n&&y(t)}}}function X(e){let t,n=e[18]+"",l;return{c(){t=b("th"),l=A(n)},m(s,o){k(s,t,o),h(t,l)},p(s,o){o&64&&n!==(n=s[18]+"")&&z(l,n)},d(s){s&&y(t)}}}function Z(e){let t,n=e[15][e[18]]+"",l;return{c(){t=b("th"),l=A(n)},m(s,o){k(s,t,o),h(t,l)},p(s,o){o&65&&n!==(n=s[15][s[18]]+"")&&z(l,n)},d(s){s&&y(t)}}}function tt(e){let t,n,l=e[6],s=[];for(let o=0;o<l.length;o+=1)s[o]=Z(K(e,l,o));return{c(){t=b("tr");for(let o=0;o<s.length;o+=1)s[o].c();n=E()},m(o,i){k(o,t,i);for(let u=0;u<s.length;u+=1)s[u]&&s[u].m(t,null);h(t,n)},p(o,i){if(i&65){l=o[6];let u;for(u=0;u<l.length;u+=1){const a=K(o,l,u);s[u]?s[u].p(a,i):(s[u]=Z(a),s[u].c(),s[u].m(t,n))}for(;u<s.length;u+=1)s[u].d(1);s.length=l.length}},d(o){o&&y(t),L(s,o)}}}function Et(e){let t,n,l,s,o,i,u,a,r,f,c;function _(p,w){return p[3]?Ct:p[4]?xt:p[0].length>0?vt:$t}let m=_(e),g=m(e);return{c(){t=b("div"),n=b("style"),l=E(),s=b("div"),o=b("input"),i=E(),u=b("button"),u.textContent="Execute",a=E(),r=b("div"),g.c(),$(n,"id","sql-tester-style"),$(o,"class","b3-text-field fn__block"),$(u,"class","b3-button b3-button--outline fn__flex-center fn__size200"),Q(u,"margin","20px 0"),$(s,"class","sql-tester-input"),$(r,"class","sql-tester-result protyle-wysiwyg"),Q(r,"padding","0"),$(t,"class","sql-tester")},m(p,w){k(p,t,w),h(t,n),e[10](n),h(t,l),h(t,s),h(s,o),W(o,e[1]),h(s,i),h(s,u),h(t,a),h(t,r),g.m(r,null),f||(c=[T(o,"input",e[11]),T(o,"keyup",e[12]),T(u,"click",e[13])],f=!0)},p(p,[w]){w&2&&o.value!==p[1]&&W(o,p[1]),m===(m=_(p))&&g?g.p(p,w):(g.d(1),g=m(p),g&&(g.c(),g.m(r,null)))},i:S,o:S,d(p){p&&y(t),e[10](null),g.d(),f=!1,N(c)}}}function Mt(e,t,n){let l,s="select * from blocks where false",o="",i=[],u=!1,a=!1,r,{style:f=""}=t;dt(()=>{f&&fetch(`/stage/build/app/${f}`).then(d=>d.text()).then(d=>{n(5,r.innerHTML=d,r)})});const c=d=>{d.code==="Enter"&&_(s)},_=async d=>{if(d)try{n(3,u=!0),n(4,a=!1),n(2,o=""),n(0,i=[]);const R=await(await fetch("/api/query/sql",{method:"POST",body:JSON.stringify({stmt:d})})).json();R.code?(n(2,o=R.msg),n(4,a=!0)):n(0,i=R.data)}catch(F){n(2,o=String(F)),n(4,a=!0)}finally{n(3,u=!1)}};function m(d){D[d?"unshift":"push"](()=>{r=d,n(5,r)})}function g(){s=this.value,n(1,s)}const p=d=>c(d),w=()=>_(s);return e.$$set=d=>{"style"in d&&n(9,f=d.style)},e.$$.update=()=>{e.$$.dirty&1&&n(6,l=i[0]?Object.keys(i[0]).filter(d=>d!=="ial"):[])},[i,s,o,u,a,r,l,c,_,f,m,g,p,w]}class At extends St{constructor(t){super(),qt(this,t,Mt,Et,it,{style:9})}}const Bt=`.sql-tester-result,.sql-tester-result table{width:100%;overflow:auto}
`;class J extends P.CustomBlock{onMount(t){let n="";const l=document.querySelectorAll('link[rel="stylesheet"]');for(const s of l){const o=s.getAttribute("href");o.startsWith("base.")&&o.endsWith(".css")&&(n=o)}new At({target:t,props:{style:n}})}}q(J,"type","SqlTesterBlock"),q(J,"css",Bt);class Nt extends rt.Plugin{async onload(){P.CustomBlockManager.init(this),P.CustomBlockManager.load(J),this.protyleSlash=[{filter:["sql","插入SQL测试器","crsqlcsq"],html:`<div class="b3-list-item__first"><span class="b3-list-item__text">${this.i18n.insertSqlTester}</span></div>`,id:"insertSqlTester",callback(t){const n=P.CustomBlockManager.buildBlock("SqlTesterBlock",{});t.insert(n)}}]}}module.exports=Nt;
