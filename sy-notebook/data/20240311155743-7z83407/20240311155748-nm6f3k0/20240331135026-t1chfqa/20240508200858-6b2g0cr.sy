{"ID":"20240508200858-6b2g0cr","Spec":"1","Type":"NodeDocument","Properties":{"icon":"spring.png","id":"20240508200858-6b2g0cr","title":"响应式操作 MongoDB","type":"doc","updated":"20240509145948"},"Children":[{"ID":"20240508201059-xkhk16p","Type":"NodeParagraph","Properties":{"id":"20240508201059-xkhk16p","updated":"20240508201059"},"Children":[{"Type":"NodeText","Data":"传统 SQL 数据库通常使用声明式的查询方式，而 NoSQL 提供响应式驱动。这里使用 MongoDB。"}]},{"ID":"20240509144150-r28ak58","Type":"NodeParagraph","Properties":{"id":"20240509144150-r28ak58","style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);","updated":"20240509144418"},"Children":[{"Type":"NodeText","Data":"依赖：响应式 MongoDB 数据库驱动 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"org.mongodb:mongodb-driver-reactivestreams"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240509145301-qi49l6q","Type":"NodeParagraph","Properties":{"id":"20240509145301-qi49l6q","updated":"20240509145412"},"Children":[{"Type":"NodeText","Data":"MongoDB 的配置使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"com.mongodb.reactivestreams"},{"Type":"NodeText","Data":"​ 包的对象，创建 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ReactiveMongoTemplate"},{"Type":"NodeText","Data":"​ 用于操作数据库"}]},{"ID":"20240509144532-a3algwy","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240509144532-a3algwy","updated":"20240509145327"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"import com.mongodb.reactivestreams.client.MongoClient;\nimport com.mongodb.reactivestreams.client.MongoClients;\n\n@Bean\npublic MongoClient mongoClient() {\n    return MongoClients.create(\"mongodb://localhost\");\n}\n@Bean\npublic ReactiveMongoTemplate reactiveMongoTemplate(MongoClient mongoClient) {\n    ReactiveMongoDatabaseFactory factory = new SimpleReactiveMongoDatabaseFactory(mongoClient, \"test\" /*数据库名*/);\n    return new ReactiveMongoTemplate(factory);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240509145243-9tizgsv","Type":"NodeParagraph","Properties":{"id":"20240509145243-9tizgsv"},"Children":[{"Type":"NodeText","Data":"使用 SpringData 时，使 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Repository"},{"Type":"NodeText","Data":"​ 类接口继承自 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ReactiveMongoRepository"},{"Type":"NodeText","Data":"​，返回 RxJava 的对象类型"}]},{"ID":"20240509143348-0pge2hx","Type":"NodeParagraph","Properties":{"id":"20240509143348-0pge2hx","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240509143408"},"Children":[{"Type":"NodeText","Data":"响应式数据库编程暂不支持 Querydsl"}]},{"ID":"20240508201059-o80s7u8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240508201059-o80s7u8","updated":"20240508202242"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"public interface BankAccountRepository extends ReactiveMongoRepository\u003cBankAccountDetails, String\u003e {\n\n    Single\u003cLong\u003e countByBalance(float balance);\n\n    Flowable\u003cBankAccountDetails\u003e removeByBalance(float balanceAmount);\n\n    @Query(\"{'balance' : {'$lte':  ?0}}\")\n    Flowable\u003cBankAccountDetails\u003e findByCustomQuery(int balanceAmount);\n}\n\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240509142848-w2cw8rk","Type":"NodeParagraph","Properties":{"id":"20240509142848-w2cw8rk","style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);","updated":"20240509143346"},"Children":[{"Type":"NodeText","Data":"如果没有返回值，则返回 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"Completable"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​；如果原本返回值为 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"Optional"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​，则返回 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"MayBe"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240508201059-s1yfwje","Type":"NodeParagraph","Properties":{"id":"20240508201059-s1yfwje","updated":"20240508201059"},"Children":[{"Type":"NodeText","Data":"也可以使用 Reactor 替代 RxJava，返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Mono"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Flux"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240508201059-qgu53ix","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240508201059-qgu53ix","updated":"20240508202228"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"public interface BankAccountRepository extends ReactiveMongoRepository\u003cBankAccountDetails, String\u003e {\n\n    Mono\u003cLong\u003e countByBalance(float balance);\n\n    Flux\u003cBankAccountDetails\u003e removeByBalance(float balanceAmount);\n\n    @Query(\"{'balance' : {'$lte':  ?0}}\")\n    Flux\u003cBankAccountDetails\u003e findByCustomQuery(int balanceAmount);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240508201059-hnxc4qd","Type":"NodeParagraph","Properties":{"id":"20240508201059-hnxc4qd","style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);","updated":"20240509143121"},"Children":[{"Type":"NodeText","Data":"如果没有返回值，则返回 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"Mono\u0026lt;Void\u0026gt;"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​；如果原本返回值为 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"Optional"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​，返回 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"Mono"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240508201059-06r1jzv","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240508201059-06r1jzv","updated":"20240509142904"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"public interface BankAccountRepositoryCustom {\n\n    Mono\u003cVoid\u003e addFixedDeposit(String bankAccountId, int amount);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240508201059-1m8texd","Type":"NodeParagraph","Properties":{"id":"20240508201059-1m8texd","updated":"20240508201059"},"Children":[{"Type":"NodeText","Data":"自定义函数可以通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ReactiveMongoTemplate"},{"Type":"NodeText","Data":"​ 操作数据库"}]},{"ID":"20240508201059-e0a02ae","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240508201059-e0a02ae","updated":"20240509144558"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@Autowired\nprivate ReactiveMongoTemplate template;\n\n@Override\npublic Mono\u003cVoid\u003e addFixedDeposit(String bankAccountId, int amount) {\n    return template.findById(bankAccountId, BankAccountDetails.class)\n            .map(bankAccount -\u003e addFd(bankAccount, amount).subscribe())\n            .then();\n}\n\nprivate Mono\u003cBankAccountDetails\u003e addFd(BankAccountDetails bankAccount, int amount) {\n    if (bankAccount.getBalance() \u003c amount) {\n        throw new IllegalArgumentException(\"Not enough money on account\");\n    }\n  \n    FixedDepositDetails fixedDepositDetails = new FixedDepositDetails();\n    fixedDepositDetails.setFdAmount(amount);\n  \n    bankAccount.getFixedDeposits().add(fixedDepositDetails);\n    bankAccount.setBalance(bankAccount.getBalance() - amount);\n    return template.save(bankAccount);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240508205729-4crths1","Type":"NodeParagraph","Properties":{"id":"20240508205729-4crths1","updated":"20240509143639"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"@EnableReactiveMongoRepositories"},{"Type":"NodeText","Data":"​ 替代  "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EnableJpaRepositories"},{"Type":"NodeText","Data":"​ 注解"}]},{"ID":"20240509143639-a7rof43","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240509143639-a7rof43","updated":"20240509143646"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@EnableReactiveMongoRepositories(\"com.example.webflux.repository\")\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240509143646-dvwlm9q","Type":"NodeParagraph","Properties":{"id":"20240509143646-dvwlm9q","updated":"20240509145930"},"Children":[{"Type":"NodeText","Data":"如果使用 RxJava，可以使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rxjava-adapter"},{"Type":"NodeText","Data":"​ 库的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RxJava3Adapter"},{"Type":"NodeText","Data":"​ 中的工具方法将 Reactor 的类转换成 RxJava 的类"}]},{"ID":"20240509145931-5tc3uyu","Type":"NodeParagraph","Properties":{"id":"20240509145931-5tc3uyu","style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);","updated":"20240509145948"},"Children":[{"Type":"NodeText","Data":"依赖："},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);"},"TextMarkType":"code","TextMarkTextContent":"io.projectreactor.addons:reactor-adapter"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);\"}"},{"Type":"NodeText","Data":"​"}]}]}