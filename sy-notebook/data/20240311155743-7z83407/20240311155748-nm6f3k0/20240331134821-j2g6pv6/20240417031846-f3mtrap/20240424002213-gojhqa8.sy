{"ID":"20240424002213-gojhqa8","Spec":"1","Type":"NodeDocument","Properties":{"icon":"spring.png","id":"20240424002213-gojhqa8","title":"数据验证","type":"doc","updated":"20240425133105"},"Children":[{"ID":"20240424002213-e8ndivd","Type":"NodeParagraph","Properties":{"id":"20240424002213-e8ndivd","updated":"20240425035204"},"Children":[{"Type":"NodeText","Data":"可以使用 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240331090448-hy2sfqd","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"Spring Validation API"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240331121004-vr1u84f","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"JSR380"},{"Type":"NodeText","Data":"​ 进行模型数据验证。验证结果通过在方法里传入一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Errors"},{"Type":"NodeText","Data":"​ 类型对象收集数据验证结果。"}]},{"ID":"20240425035549-c4aksmj","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240425035549-c4aksmj","updated":"20240425041047"},"Children":[{"Type":"NodeText","Data":"Validator"}]},{"ID":"20240425035613-0kln4m2","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240425035613-0kln4m2","updated":"20240425041047"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"public class FixedDepositValidator implements Validator {\n\n    private static final int MIN_DEPOSIT_ACCOUNT = 1000;\n    private static final int MIN_TENURE = 6;\n  \n    @Override\n    public boolean supports(Class\u003c?\u003e clazz) {\n        return FixedDepositDetails.class.isAssignableFrom(clazz);\n    }\n\n    @Override\n    public void validate(Object target, Errors errors) {\n        FixedDepositDetails fixedDepositDetails = (FixedDepositDetails) target;\n      \n        if (fixedDepositDetails.getDepositAmount() \u003c MIN_DEPOSIT_ACCOUNT) {\n            errors.rejectValue(\"depositAmount\", \"error.depositAmount.less\", \"must be greater than or equal to \" + MIN_DEPOSIT_ACCOUNT);\n        }\n\n        if (fixedDepositDetails.getTenure() \u003c MIN_TENURE) {\n            errors.rejectValue(\"tenure\", \"error.tenure.less\", \"must be greater than or equal to \" + MIN_TENURE);\n        }\n\n        ValidationUtils.rejectIfEmptyOrWhitespace(errors, \"email\", \"error.email.blank\", \"must not be blank\");\n        if (!errors.hasFieldErrors(\"email\") \u0026\u0026 !fixedDepositDetails.getEmail().contains(\"@\")) {\n            errors.rejectValue(\"email\", \"error.email.format\", \"not a well-formed email address\");\n        }\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240425040845-8s7ydwq","Type":"NodeParagraph","Properties":{"id":"20240425040845-8s7ydwq","updated":"20240425041047"},"Children":[{"Type":"NodeText","Data":"Errors："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rejectValue(字段名, 错误码信息的消息键, 若不存在该键则显示的值)"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240425041044-uz45309","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240425041044-uz45309","updated":"20240425041052"},"Children":[{"Type":"NodeText","Data":"JSR 380"}]},{"ID":"20240425041145-qdy5zre","Type":"NodeParagraph","Properties":{"id":"20240425041145-qdy5zre","updated":"20240425133105"},"Children":[{"Type":"NodeText","Data":"在设置好用于校验的注解后，注入一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Validator"},{"Type":"NodeText","Data":"​ 变量即可。也可以给对应参数添加 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"@Valid"},{"Type":"NodeText","Data":"​ 注解。"}]},{"ID":"20240425133051-ghkx51j","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240425133051-ghkx51j","updated":"20240425133052"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@PostMapping(params = \"fdAction=create\")\npublic String openFixedDeposit(@Valid @ModelAttribute(\"newFixedDepositDetails\") FixedDepositDetails fixedDepositDetails,\n                               BindingResult bindingResult, Errors errors,\n                               Model model, SessionStatus sessionStatus) {\n    LOGGER.info(\"openFixedDeposit() called, fixedDepositDetails {}\", fixedDepositDetails);\n    if (bindingResult.hasErrors() || errors.hasErrors()) {\n        errors.addAllErrors(bindingResult);\n        model.addAttribute(\"errors\", errors);\n        LOGGER.error(\"openFixedDeposit() called, errors {}\", errors);\n        return \"createFixedDepositForm\";\n    } else {\n        fixedDepositService.createFixedDeposit(fixedDepositDetails);\n        sessionStatus.setComplete();\n        return \"redirect:/fixedDeposit/list\";\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240425112940-hzhm24n","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240425112940-hzhm24n","updated":"20240425124156"},"Children":[{"Type":"NodeText","Data":"Errors"}]},{"ID":"20240425124157-pfru2ah","Type":"NodeParagraph","Properties":{"id":"20240425124157-pfru2ah","updated":"20240425124316"},"Children":[{"Type":"NodeText","Data":"数据绑定错误的信息存于 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"BindingResult"},{"Type":"NodeText","Data":"​ 中，校验错误结果存于 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Errors"},{"Type":"NodeText","Data":"​ 中，这两个都是 "},{"Type":"NodeTextMark","TextMarkType":"code strong","TextMarkTextContent":"Errors"},{"Type":"NodeText","Data":"​ 对象的实例。"}]},{"ID":"20240425124317-wj9u1ep","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240425124317-wj9u1ep","updated":"20240425124534"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@PostMapping(params = \"fdAction=create\")\npublic String openFixedDeposit(@ModelAttribute(\"newFixedDepositDetails\") \n                               FixedDepositDetails fixedDepositDetails,\n                               BindingResult bindingResult, Errors errors,\n                               Model model, SessionStatus sessionStatus) {\n    LOGGER.info(\"openFixedDeposit() called, fixedDepositDetails {}\", fixedDepositDetails);\n    // 手动校验\n    validator.validate(fixedDepositDetails, errors);\n    if (bindingResult.hasErrors() || errors.hasErrors()) {\n        // 有错误，两个对象都是 Errors，可以合并，方便查询\n        errors.addAllErrors(bindingResult);\n        model.addAttribute(\"errors\", errors);\n        return \"createFixedDepositForm\";\n    } else {\n        fixedDepositService.createFixedDeposit(fixedDepositDetails);\n        sessionStatus.setComplete();\n        return \"redirect:/fixedDeposit/list\";\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240425124546-kznwzax","Type":"NodeParagraph","Properties":{"id":"20240425124546-kznwzax","updated":"20240425124735"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Errors"},{"Type":"NodeText","Data":"​ 类中的错误信息可以通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FieldError#getDefaultMessage"},{"Type":"NodeText","Data":"​ 取得。"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FieldError#toString"},{"Type":"NodeText","Data":"​ 方法则可以获取完整异常"}]},{"ID":"20240425124620-d4eveig","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240425124620-d4eveig","updated":"20240425124741"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"// 只取得错误信息\npublic static String formatErrors(Errors errors, String filedName) {\n    List\u003cFieldError\u003e fieldErrors = errors.getFieldErrors(filedName);\n    FieldError lastError = fieldErrors.get(fieldErrors.size() - 1);\n    return lastError.getDefaultMessage();\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240425124640-ll2o243","Type":"NodeParagraph","Properties":{"id":"20240425124640-ll2o243"}}]}