{"ID":"20240513170803-zodixcc","Spec":"1","Type":"NodeDocument","Properties":{"icon":"opengl.png","id":"20240513170803-zodixcc","title":"实例化渲染","type":"doc","updated":"20240513170843"},"Children":[{"ID":"20240513170809-torr55a","Type":"NodeParagraph","Properties":{"id":"20240513170809-torr55a","updated":"20240513170809"},"Children":[{"Type":"NodeText","Data":"实例化渲染是将多次重复渲染调用整合成一次的功能。"}]},{"ID":"20240513170809-1lfcs9x","Type":"NodeList","ListData":{},"Properties":{"id":"20240513170809-1lfcs9x","updated":"20240513170809"},"Children":[{"ID":"20240513170809-i2vjzk2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240513170809-i2vjzk2","updated":"20240513170809"},"Children":[{"ID":"20240513170809-4okr1qc","Type":"NodeParagraph","Properties":{"id":"20240513170809-4okr1qc","updated":"20240513170809"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"glDrawArrays"},{"Type":"NodeText","Data":"​ 对应 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"glDrawArraysInstanced"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240513170809-q35u381","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240513170809-q35u381","updated":"20240513170809"},"Children":[{"ID":"20240513170809-rciqc6k","Type":"NodeParagraph","Properties":{"id":"20240513170809-rciqc6k","updated":"20240513170809"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"glDrawElements"},{"Type":"NodeText","Data":"​ 对应 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"glDrawArraysInstanced"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20240513170809-aohp2mp","Type":"NodeParagraph","Properties":{"id":"20240513170809-aohp2mp","updated":"20240513170809"},"Children":[{"Type":"NodeText","Data":"当某组图元本身比较简单，但需要重复渲染多次 - 如一片草坪上的若干棵草，需要重复调用多次相同的绘制指令，而区别仅在于位置不同。此时绘制命令的调用开销可能会超过实际绘制的开销。"}]},{"ID":"20240513170809-ngul3uz","Type":"NodeParagraph","Properties":{"id":"20240513170809-ngul3uz","updated":"20240513170809"},"Children":[{"Type":"NodeText","Data":"实例化渲染的着色器中的内置变量 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"gl_InstanceID"},{"Type":"NodeText","Data":"​ 是有意义的，他表示当前绘制的是第 n 组实例。根据这个变量可以对顶点数据进行调整，实现批量渲染。"}]},{"ID":"20240513170809-1me9mah","Type":"NodeParagraph","Properties":{"id":"20240513170809-1me9mah","updated":"20240513170809"},"Children":[{"Type":"NodeText","Data":"如以下顶点着色器中，使用 uniform 传入 100 组偏移量，使用时根据 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"gl_InstanceID"},{"Type":"NodeText","Data":"​ 选择："}]},{"ID":"20240513170809-va7sbvx","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240513170809-va7sbvx","updated":"20240513170823"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z2xzbA=="},{"Type":"NodeCodeBlockCode","Data":"#version 460 core\n\nlayout(location=0) in vec2 position;\n\nuniform vec2 offsets[100];\n\nvoid main() {\n    gl_Position = vec4(position + offset[gl_InstanceID], 0, 1);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240513170809-es9xz6o","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240513170809-es9xz6o","updated":"20240513170809"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"int count = 0;\nfor (int y = -10; y \u003c 10; ++y) {\n\tfor (int x = -10; x \u003c 10; ++x) {\n\t\tfloat off_x = x / 10.0f + 0.1f;\n\t\tfloat off_y = y / 10.0f + 0.1f;\n\t\tchar name[15];\n\t\t// offset[0], offset[1], ...\n\t\tsprintf(name, \"offset[%d]\", count++);\n\t\tGLuint loc = glGetUniformLocation(program, name);\n\t\tglUniform2f(loc, off_x, off_y);\n\t}\n}\n\n// 调用 glDrawArrays(GL_TRIANGLES, 0, 6) 共 100(count) 次\nglDrawArraysInstanced(GL_TRIANGLES, 0, 6, count);\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240513170837-iznllj5","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240513170837-iznllj5","updated":"20240513170839"},"Children":[{"Type":"NodeText","Data":"实例化数组"}]},{"ID":"20240513170843-1cjpvjf","Type":"NodeParagraph","Properties":{"id":"20240513170843-1cjpvjf","updated":"20240513170843"},"Children":[{"Type":"NodeText","Data":"使用 uniform 变量有最大大小限制，有时候无法满足实例化渲染的需求。此时可使用顶点数据，借助缓冲区摆脱大小限制。"}]},{"ID":"20240513170843-5m2saq9","Type":"NodeParagraph","Properties":{"id":"20240513170843-5m2saq9","updated":"20240513170843"},"Children":[{"Type":"NodeText","Data":"在顶点数组对象中，通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"glVertexAttribDivisor"},{"Type":"NodeText","Data":"​ 设置某个顶点对应的值需要根据实例化数量变化。"}]},{"ID":"20240513170843-hjvaiuz","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240513170843-hjvaiuz","updated":"20240513170843"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"glVertexAttribDivisor(index, divison);\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240513170843-lp7ux0j","Type":"NodeList","ListData":{},"Properties":{"id":"20240513170843-lp7ux0j","updated":"20240513170843"},"Children":[{"ID":"20240513170843-8w0k80z","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240513170843-8w0k80z","updated":"20240513170843"},"Children":[{"ID":"20240513170843-7zttbi5","Type":"NodeParagraph","Properties":{"id":"20240513170843-7zttbi5","updated":"20240513170843"},"Children":[{"Type":"NodeText","Data":"index：顶点属性 location 值"}]}]},{"ID":"20240513170843-ys5ehhd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240513170843-ys5ehhd","updated":"20240513170843"},"Children":[{"ID":"20240513170843-fc64v0s","Type":"NodeParagraph","Properties":{"id":"20240513170843-fc64v0s","updated":"20240513170843"},"Children":[{"Type":"NodeText","Data":"division：每隔 division 个实例，向后移动一个值"}]}]}]}]}